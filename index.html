<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è Otomatik Beslenme Planlama Sistemi v2.0</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Sortable.js for drag & drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
            gap: 0;
        }
        
        .sidebar {
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar-header {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            padding: 0;
        }
        
        .sidebar-menu a {
            display: block;
            color: #ecf0f1;
            text-decoration: none;
            padding: 12px 20px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #34495e;
            border-left-color: #3498db;
            color: white;
        }
        
        .sidebar-menu i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            background: white;
            overflow-y: auto;
            position: relative;
        }
        
        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .content-body {
            padding: 30px;
        }
        
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }

        /* Sortable Rules Styling */
        .rules-sortable {
            min-height: 200px;
        }
        
        .rule-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .rule-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        /* Criteria Sortable Styling */
        .criteria-sortable {
            min-height: 300px;
        }
        
        .criteria-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .criteria-checkbox {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .criteria-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
        }
        
        .criteria-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        .criteria-handle {
            cursor: grab;
            color: #6c757d;
            font-size: 18px;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }
        
        .criteria-handle:hover {
            color: var(--primary-color);
            background: #f8f9fa;
        }
        
        .criteria-handle:active {
            cursor: grabbing;
        }
        
        .criteria-priority {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .criteria-content {
            flex: 1;
        }
        
        .criteria-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .criteria-description {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Sortable ghost states */
        .sortable-ghost {
            opacity: 0.5;
            background: #f8f9fa !important;
            border: 2px dashed var(--primary-color) !important;
        }
        
        .sortable-chosen {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }
        
        .sortable-drag {
            background: white !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .rule-item.active {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        
        .rule-priority {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .rule-content {
            flex: 1;
        }
        
        .rule-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        /* Criteria enable/disable states */
        .criteria-enabled {
            opacity: 1 !important;
            background: white !important;
            border: 1px solid #ddd !important;
            transition: all 0.3s ease;
        }
        
        .criteria-disabled {
            opacity: 0.5 !important;
            background: #f0f0f0 !important;
            border: 1px solid #ccc !important;
            transition: all 0.3s ease;
        }
        
        .criteria-disabled .criteria-title {
            color: #999 !important;
        }
        
        .criteria-disabled .criteria-description {
            color: #bbb !important;
        }
        
        .rule-description {
            font-size: 12px;
            color: #6c757d;
        }
        
        .rule-actions {
            display: flex;
            gap: 5px;
        }
        
        .drag-handle {
            color: #6c757d;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }

        /* Hasta Ayarlarƒ± */
        .text-sm {
            font-size: 0.875rem;
        }
        
        .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
        }
        
        .form-label-sm {
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }
        
        /* Disabled input styling */
        .form-control:disabled {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            opacity: 1;
        }
        
        /* Diet card styling */
        .diet-card {
            transition: transform 0.2s ease-in-out;
            border: 1px solid #e0e0e0;
        }
        
        .diet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .diet-card .card-header {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #e0e0e0;
        }
        
        .progress {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 25px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 10px 15px;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
        }
        
        .patient-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .patient-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .patient-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .week-tab {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .week-tab:hover {
            background: #e9ecef;
        }
        
        .week-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .meal-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .meal-table th,
        .meal-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .meal-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .meal-row {
            cursor: pointer;
        }
        
        .meal-row:hover {
            background: #f8f9fa;
        }
        
        .change-meal-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        
        .change-meal-btn:hover {
            background: #f8f9fa;
            color: #5a6fd8;
        }
        
        .daily-totals {
            background: #e8f4f8;
            font-weight: bold;
        }
        
        .weekly-averages {
            background: #d4edda;
            font-weight: bold;
        }
        
        .console-log {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        /* Autocomplete stilleri */
        .autocomplete-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.active {
            background-color: #f8f9fa;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-highlight {
            font-weight: bold;
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }

        .autocomplete-category {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
            margin-left: 8px;
        }
        
        /* GitHub Token Giri≈ü Stilleri */
        .github-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .github-login-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .github-token-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin: 15px 0;
        }
        
        .github-token-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .github-login-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .github-login-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .github-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .github-status.connected {
            border-left: 4px solid #28a745;
        }
        
        .github-status.disconnected {
            border-left: 4px solid #dc3545;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- GitHub Token Giri≈ü Modal -->
    <div id="githubLoginOverlay" class="github-login-overlay">
        <div class="github-login-modal">
            <h3><i class="fab fa-github"></i> GitHub Baƒülantƒ±sƒ±</h3>
            <p>Sistem verilerini GitHub'dan √ßekmek i√ßin GitHub token'ƒ±nƒ±zƒ± girin:</p>
            
            <input type="password" id="githubToken" class="github-token-input" 
                   placeholder="GitHub Personal Access Token">
            
            <div>
                <button onclick="connectGitHub()" class="github-login-btn">
                    <i class="fas fa-link"></i> Baƒülan
                </button>
                <button onclick="testConnection()" class="github-login-btn" style="background: #17a2b8;">
                    <i class="fas fa-vial"></i> Test Et
                </button>
            </div>
            
            <small class="text-muted">
                Token'ƒ±nƒ±z g√ºvenli bir ≈üekilde tarayƒ±cƒ±da saklanacaktƒ±r.
                <br>
                <a href="https://github.com/settings/tokens" target="_blank">
                    <i class="fas fa-external-link-alt"></i> GitHub Token Olu≈ütur
                </a>
            </small>
        </div>
    </div>
    
    <!-- GitHub Baƒülantƒ± Durumu -->
    <div id="githubStatus" class="github-status disconnected hidden">
        <i class="fab fa-github"></i>
        <span id="statusText">Baƒülantƒ± Kesildi</span>
        <button onclick="disconnectGitHub()" class="btn btn-sm btn-outline-danger">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="main-container">
        <!-- Sol Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-utensils"></i> Beslenme Sistemi</h4>
                <small>v2.0</small>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="#" data-page="dashboard" class="active">
                    <i class="fas fa-tachometer-alt"></i> Ana Sayfa
                </a></li>
                <li><a href="#" data-page="diet-config">
                    <i class="fas fa-leaf"></i> Diyet Ayarlarƒ±
                </a></li>
                <li><a href="#" data-page="food-database">
                    <i class="fas fa-utensils"></i> Yemek Veritabanƒ±
                </a></li>
                <li><a href="#" data-page="rules">
                    <i class="fas fa-gavel"></i> Kurallar
                </a></li>
                <li><a href="#" data-page="templates">
                    <i class="fas fa-clipboard-list"></i> ≈ûablonlar
                </a></li>
                <li><a href="#" data-page="users">
                    <i class="fas fa-users"></i> Kullanƒ±cƒ±lar
                </a></li>
                <li><a href="#" data-page="patient-tracking">
                    <i class="fas fa-user-md"></i> Hasta Takibi
                </a></li>
                <li><a href="#" data-page="planning">
                    <i class="fas fa-calendar-alt"></i> Planlama
                </a></li>
                <li><a href="#" data-page="reports">
                    <i class="fas fa-chart-bar"></i> Raporlar
                </a></li>
                <li><a href="#" onclick="loadSystemSettings()">
                    <i class="fas fa-cog"></i> Sistem Ayarlarƒ± & Kriterler
                </a></li>
                <li><a href="#" onclick="loadCriteriaManager()">
                    <i class="fas fa-list-ol"></i> Kriter Y√∂neticisi
                </a></li>
                <li><a href="#" onclick="showGitHubManager()">
                    <i class="fab fa-github"></i> GitHub Y√∂netimi
                </a></li>
            </ul>
        </div>
        
        <!-- Ana ƒ∞√ßerik Alanƒ± -->
        <div class="main-content">
            <div class="content-header">
                <h2 id="page-title">Ana Sayfa</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Anasayfa</a></li>
                        <li class="breadcrumb-item active" id="breadcrumb-current">Dashboard</li>
                    </ol>
                </nav>
            </div>
            
            <div class="content-body">
                <!-- Ana Sayfa -->
                <div id="dashboard" class="page-section active">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card card-custom">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                                    <h4 id="total-patients">0</h4>
                                    <p>Toplam Hasta</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-md fa-3x text-success mb-3"></i>
                                    <h4 id="total-doctors">0</h4>
                                    <p>Toplam Doktor</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-nurse fa-3x text-info mb-3"></i>
                                    <h4 id="total-dietitians">0</h4>
                                    <p>Toplam Diyetisyen</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-check fa-3x text-warning mb-3"></i>
                                    <h4 id="active-plans">0</h4>
                                    <p>Aktif Plan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5><i class="fas fa-info-circle"></i> Sistem Bilgisi</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Versiyon:</strong> 2.0</p>
                            <p><strong>Son G√ºncelleme:</strong> 17.08.2025</p>
                            <p><strong>√ñzellikler:</strong> 13 Fakt√∂rl√º Akƒ±llƒ± Planlama, Haftalƒ±k Takip, Kullanƒ±cƒ± Rolleri</p>
                            <p><strong>Durum:</strong> <span class="badge bg-success">Aktif</span></p>
                        </div>
                    </div>
                    
                    <!-- GitHub Y√∂netim Paneli -->
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5><i class="fab fa-github"></i> GitHub Veri Y√∂netimi</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Repository:</strong> mustafasacar35/lipo_program</p>
                                    <p><strong>Baƒülantƒ± Durumu:</strong> 
                                        <span id="connectionStatus" class="badge bg-secondary">Kontrol Ediliyor...</span>
                                    </p>
                                    <p><strong>Son Senkronizasyon:</strong> 
                                        <span id="lastSync">-</span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button onclick="syncWithGitHub()" class="btn btn-primary btn-sm">
                                            <i class="fas fa-sync-alt"></i> Verileri Yenile
                                        </button>
                                        <button onclick="saveAllDataToGitHub()" class="btn btn-success btn-sm">
                                            <i class="fas fa-upload"></i> T√ºm Verileri Kaydet
                                        </button>
                                        <button onclick="showGitHubFileList()" class="btn btn-info btn-sm">
                                            <i class="fas fa-list"></i> Dosya Listesi
                                        </button>
                                        <button onclick="disconnectGitHub()" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-unlink"></i> Baƒülantƒ±yƒ± Kes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sistem Ayarlarƒ± Sayfasƒ± -->
                <div id="system-settings" class="page-section">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5><i class="fas fa-cogs"></i> Sistem Ayarlarƒ±</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Sol Panel: √ñƒü√ºn Ayarlarƒ± -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-calculator"></i> Hedef Kalori Hesaplama</h6>
                                    <div class="row mb-3">
                                        <div class="col-4">
                                            <label class="form-label">Ya≈ü</label>
                                            <input type="number" class="form-control" id="target-age" value="35" min="18" max="100" oninput="calculateTargetCalories()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">Kilo (kg)</label>
                                            <input type="number" class="form-control" id="target-weight" value="70" min="40" max="200" oninput="calculateTargetCalories()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">Aktivite</label>
                                            <select class="form-control" id="target-activity" onchange="calculateTargetCalories()">
                                                <option value="1.2">Sedanter</option>
                                                <option value="1.375">Hafif Aktif</option>
                                                <option value="1.55" selected>Orta Aktif</option>
                                                <option value="1.725">√áok Aktif</option>
                                                <option value="1.9">A≈üƒ±rƒ± Aktif</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Boy ve Cinsiyet -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Boy (cm)</label>
                                            <input type="number" class="form-control" id="target-height" value="165" min="120" max="230" oninput="calculateTargetCalories()">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Cinsiyet</label>
                                            <select class="form-control" id="target-gender" onchange="calculateTargetCalories()">
                                                <option value="male">Erkek</option>
                                                <option value="female" selected>Kadƒ±n</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Varsayƒ±lan Diyet T√ºr√º</label>
                                        <select class="form-control" id="system-default-diet" onchange="calculateTargetCalories()">
                                            <option value="ketojenik">ü•ë Ketojenik</option>
                                            <option value="lowcarb" selected>ü•© D√º≈ü√ºk Karbonhidrat</option>
                                            <option value="akdeniz">üêü Akdeniz Diyeti</option>
                                            <option value="sporcu">üí™ Sporcu Beslenmesi</option>
                                            <option value="gebelik">ü§± Gebelik Beslenmesi</option>
                                        </select>
                                    </div>
                                    
                                    <div class="alert alert-primary mb-3">
                                        <small><strong>Hedef Kalori:</strong> <span id="calculated-calories">1850</span> kcal/g√ºn</small><br>
                                        <small><strong>Hedef Makrolar:</strong> 
                                            <span id="calculated-carbs">93</span>g K, 
                                            <span id="calculated-protein">139</span>g P, 
                                            <span id="calculated-fat">103</span>g Y
                                        </small>
                                    </div>
                                    
                                    <h6><i class="fas fa-utensils"></i> √ñƒü√ºn Yemek Satƒ±r Sayƒ±larƒ±</h6>
                                    <div class="alert alert-info">
                                        <small><i class="fas fa-info-circle"></i> Her √∂ƒü√ºn i√ßin yemek satƒ±r sayƒ±sƒ±nƒ± belirleyin. "Sabit" deƒüer girdiƒüinizde Min/Max pasif olur.</small>
                                    </div>

                                    <!-- Kahvaltƒ± -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-3">
                                            <label class="form-label mb-0"><strong>üç≥ KAHVALTI</strong></label>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Min</label>
                                            <input type="number" class="form-control form-control-sm" id="breakfast-min" value="2" min="1" max="10" oninput="updateFixedMealButton('breakfast')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Max</label>
                                            <input type="number" class="form-control form-control-sm" id="breakfast-max" value="4" min="1" max="10" oninput="updateFixedMealButton('breakfast')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Sabit</label>
                                            <input type="number" class="form-control form-control-sm" id="breakfast-fixed" placeholder="ƒ∞steƒüe baƒülƒ±" min="1" max="10" oninput="toggleMealRangeInputs('breakfast'); updateFixedMealButton('breakfast')">
                                        </div>
                                    </div>
                                    
                                    <!-- Sabit Yemekler - Kahvaltƒ± -->
                                    <div class="ms-3 mb-3" id="breakfast-fixed-meals-container">
                                        <div class="d-flex align-items-center mb-2">
                                            <small class="text-muted me-2">üìå Sabit Yemekler:</small>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-breakfast-fixed-meal-btn" 
                                                    onclick="addFixedMealRow('breakfast')">
                                                <i class="fas fa-plus"></i> Sabit Yemek Ekle
                                            </button>
                                        </div>
                                        <div id="breakfast-fixed-meals-list"></div>
                                    </div>

                                    <!-- Ara √ñƒü√ºn 1 -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-3">
                                            <label class="form-label mb-0"><strong>ü•§ ARA √ñƒû√úN</strong></label>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Min</label>
                                            <input type="number" class="form-control form-control-sm" id="snack1-min" value="1" min="1" max="5" oninput="updateFixedMealButton('snack1')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Max</label>
                                            <input type="number" class="form-control form-control-sm" id="snack1-max" value="2" min="1" max="5" oninput="updateFixedMealButton('snack1')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Sabit</label>
                                            <input type="number" class="form-control form-control-sm" id="snack1-fixed" placeholder="ƒ∞steƒüe baƒülƒ±" min="1" max="5" oninput="toggleMealRangeInputs('snack1'); updateFixedMealButton('snack1')">
                                        </div>
                                    </div>
                                    
                                    <!-- Sabit Yemekler - Ara √ñƒü√ºn 1 -->
                                    <div class="ms-3 mb-3" id="snack1-fixed-meals-container">
                                        <div class="d-flex align-items-center mb-2">
                                            <small class="text-muted me-2">üìå Sabit Yemekler:</small>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-snack1-fixed-meal-btn" 
                                                    onclick="addFixedMealRow('snack1')">
                                                <i class="fas fa-plus"></i> Sabit Yemek Ekle
                                            </button>
                                        </div>
                                        <div id="snack1-fixed-meals-list"></div>
                                    </div>

                                    <!-- √ñƒüle -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-3">
                                            <label class="form-label mb-0"><strong>üçΩÔ∏è √ñƒûLE</strong></label>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Min</label>
                                            <input type="number" class="form-control form-control-sm" id="lunch-min" value="3" min="1" max="10" oninput="updateFixedMealButton('lunch')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Max</label>
                                            <input type="number" class="form-control form-control-sm" id="lunch-max" value="5" min="1" max="10" oninput="updateFixedMealButton('lunch')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Sabit</label>
                                            <input type="number" class="form-control form-control-sm" id="lunch-fixed" placeholder="ƒ∞steƒüe baƒülƒ±" min="1" max="10" oninput="toggleMealRangeInputs('lunch'); updateFixedMealButton('lunch')">
                                        </div>
                                    </div>
                                    
                                    <!-- Sabit Yemekler - √ñƒüle -->
                                    <div class="ms-3 mb-3" id="lunch-fixed-meals-container">
                                        <div class="d-flex align-items-center mb-2">
                                            <small class="text-muted me-2">üìå Sabit Yemekler:</small>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-lunch-fixed-meal-btn" 
                                                    onclick="addFixedMealRow('lunch')">
                                                <i class="fas fa-plus"></i> Sabit Yemek Ekle
                                            </button>
                                        </div>
                                        <div id="lunch-fixed-meals-list"></div>
                                    </div>

                                    <!-- Ara √ñƒü√ºn 2 -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-3">
                                            <label class="form-label mb-0"><strong>ü•§ ARA √ñƒû√úN</strong></label>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Min</label>
                                            <input type="number" class="form-control form-control-sm" id="snack2-min" value="1" min="1" max="5" oninput="updateFixedMealButton('snack2')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Max</label>
                                            <input type="number" class="form-control form-control-sm" id="snack2-max" value="2" min="1" max="5" oninput="updateFixedMealButton('snack2')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Sabit</label>
                                            <input type="number" class="form-control form-control-sm" id="snack2-fixed" placeholder="ƒ∞steƒüe baƒülƒ±" min="1" max="5" oninput="toggleMealRangeInputs('snack2'); updateFixedMealButton('snack2')">
                                        </div>
                                    </div>
                                    
                                    <!-- Sabit Yemekler - Ara √ñƒü√ºn 2 -->
                                    <div class="ms-3 mb-3" id="snack2-fixed-meals-container">
                                        <div class="d-flex align-items-center mb-2">
                                            <small class="text-muted me-2">üìå Sabit Yemekler:</small>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-snack2-fixed-meal-btn" 
                                                    onclick="addFixedMealRow('snack2')">
                                                <i class="fas fa-plus"></i> Sabit Yemek Ekle
                                            </button>
                                        </div>
                                        <div id="snack2-fixed-meals-list"></div>
                                    </div>

                                    <!-- Ak≈üam -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-3">
                                            <label class="form-label mb-0"><strong>üåô AK≈ûAM</strong></label>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Min</label>
                                            <input type="number" class="form-control form-control-sm" id="dinner-min" value="3" min="1" max="10" oninput="updateFixedMealButton('dinner')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Max</label>
                                            <input type="number" class="form-control form-control-sm" id="dinner-max" value="5" min="1" max="10" oninput="updateFixedMealButton('dinner')">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label-sm">Sabit</label>
                                            <input type="number" class="form-control form-control-sm" id="dinner-fixed" placeholder="ƒ∞steƒüe baƒülƒ±" min="1" max="10" oninput="toggleMealRangeInputs('dinner'); updateFixedMealButton('dinner')">
                                        </div>
                                    </div>
                                    
                                    <!-- Sabit Yemekler - Ak≈üam -->
                                    <div class="ms-3 mb-3" id="dinner-fixed-meals-container">
                                        <div class="d-flex align-items-center mb-2">
                                            <small class="text-muted me-2">üìå Sabit Yemekler:</small>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-dinner-fixed-meal-btn" 
                                                    onclick="addFixedMealRow('dinner')">
                                                <i class="fas fa-plus"></i> Sabit Yemek Ekle
                                            </button>
                                        </div>
                                        <div id="dinner-fixed-meals-list"></div>
                                    </div>
                                    
                                    <h6 class="mt-4"><i class="fas fa-chart-pie"></i> √ñƒü√ºnlerdeki Makro Daƒüƒ±lƒ±mƒ±</h6>
                                    <div class="alert alert-info">
                                        <small><i class="fas fa-info-circle"></i> Her √∂ƒü√ºn√ºn g√ºnl√ºk kaloriden alacaƒüƒ± y√ºzdeyi belirleyin. Sabit satƒ±r sayƒ±sƒ± olan √∂ƒü√ºnler i√ßin % pasif olur.</small>
                                    </div>

                                    <!-- Kahvaltƒ± Makro -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-6">
                                            <label class="form-label mb-0"><strong>üç≥ Kahvaltƒ±</strong></label>
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group">
                                                <input type="number" class="form-control form-control-sm meal-macro-input" 
                                                       id="breakfast-macro" value="25" min="5" max="50" oninput="updateMealMacroTotal()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <small class="text-muted" id="breakfast-calories">463 kcal</small>
                                        </div>
                                    </div>

                                    <!-- Ara √ñƒü√ºn 1 Makro -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-6">
                                            <label class="form-label mb-0"><strong>ü•§ Ara √ñƒü√ºn</strong></label>
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group">
                                                <input type="number" class="form-control form-control-sm meal-macro-input" 
                                                       id="snack1-macro" value="10" min="5" max="25" oninput="updateMealMacroTotal()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <small class="text-muted" id="snack1-calories">185 kcal</small>
                                        </div>
                                    </div>

                                    <!-- √ñƒüle Makro -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-6">
                                            <label class="form-label mb-0"><strong>üçΩÔ∏è √ñƒüle</strong></label>
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group">
                                                <input type="number" class="form-control form-control-sm meal-macro-input" 
                                                       id="lunch-macro" value="30" min="10" max="50" oninput="updateMealMacroTotal()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <small class="text-muted" id="lunch-calories">555 kcal</small>
                                        </div>
                                    </div>

                                    <!-- Ara √ñƒü√ºn 2 Makro -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-6">
                                            <label class="form-label mb-0"><strong>üç™ Ara √ñƒü√ºn</strong></label>
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group">
                                                <input type="number" class="form-control form-control-sm meal-macro-input" 
                                                       id="snack2-macro" value="10" min="5" max="25" oninput="updateMealMacroTotal()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <small class="text-muted" id="snack2-calories">185 kcal</small>
                                        </div>
                                    </div>

                                    <!-- Ak≈üam Makro -->
                                    <div class="row align-items-center mb-3 p-2 border rounded bg-light">
                                        <div class="col-6">
                                            <label class="form-label mb-0"><strong>üåô Ak≈üam</strong></label>
                                        </div>
                                        <div class="col-4">
                                            <div class="input-group">
                                                <input type="number" class="form-control form-control-sm meal-macro-input" 
                                                       id="dinner-macro" value="25" min="10" max="50" oninput="updateMealMacroTotal()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <small class="text-muted" id="dinner-calories">463 kcal</small>
                                        </div>
                                    </div>

                                    <!-- Toplam -->
                                    <div class="row align-items-center mb-3 p-3 border rounded bg-primary text-white">
                                        <div class="col-8">
                                            <strong>üìä TOPLAM</strong>
                                        </div>
                                        <div class="col-4 text-end">
                                            <strong id="meal-macro-total" class="fs-5">100%</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Saƒü Panel: Kural Ayarlarƒ± -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-list-ol"></i> Varsayƒ±lan Kriter Hiyerar≈üisi</h6>
                                    <div class="alert alert-info">
                                        <small><i class="fas fa-info-circle"></i> Kriterler yukarƒ±dan a≈üaƒüƒ±ya √∂ncelik sƒ±rasƒ±na g√∂redir. Drag&drop ile sƒ±ralayabilirsiniz.</small>
                                    </div>
                                    <!-- Aktif hafta se√ßimi (hasta haftalarƒ± ile baƒülamak i√ßin) -->
                                    <div id="criteria-week-controls" class="d-flex align-items-center gap-2 mb-2"></div>
                                    
                                    <div id="default-criteria-hierarchy" class="criteria-sortable">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </div>

                                    <h6 class="mt-4"><i class="fas fa-calculator"></i> Hesaplama Ayarlarƒ±</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Varsayƒ±lan Kalori Hesaplama</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="defaultCalorieMethod" 
                                                   id="defaultHarris" value="harris">
                                            <label class="form-check-label" for="defaultHarris">
                                                Harris-Benedict BMR Form√ºl√º
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="defaultCalorieMethod" 
                                                   id="defaultMifflin" value="mifflin">
                                            <label class="form-check-label" for="defaultMifflin">
                                                Mifflin‚ÄìSt Jeor BMR Form√ºl√º
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="defaultCalorieMethod" 
                                                   id="defaultCustom" value="custom" checked>
                                            <label class="form-check-label" for="defaultCustom">
                                                <strong>√ñzel Form√ºl</strong> (Makro x Katsayƒ± x Aktivite)
                                            </label>
                                        </div>
                                        <!-- Se√ßili y√∂ntem i√ßin form√ºl g√∂sterimi -->
                                        <div id="calorie-formula-box" class="alert alert-secondary py-2 mt-2" style="display: none;">
                                            <small><strong>Form√ºl:</strong> <span id="calorie-formula-text"></span></small>
                                        </div>
                                        <!-- √ñzel Form√ºl Parametreleri -->
                                        <div id="custom-formula-panel" class="mt-3 p-3 border rounded bg-light">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-flask me-2 text-primary"></i>
                                                <strong>√ñzel Form√ºl Parametreleri</strong>
                                                <small class="text-muted ms-2">(Makro katsayƒ±larƒ± ve aktivite √ßarpanlarƒ±)</small>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-12">
                                                    <label class="form-label mb-1">Aktif Diyet ƒ∞√ßin Makro Katsayƒ±larƒ± (kg ba≈üƒ±na gram)</label>
                                                    <!-- √ñnerilen Presetler -->
                                                    <div class="mb-2">
                                                        <div class="btn-group btn-group-sm" role="group" aria-label="√ñnerilen katsayƒ± presetleri">
                                                            <button type="button" class="btn btn-outline-secondary" onclick="applyCoeffPreset('ketojenik')" title="Sadece katsayƒ± alanlarƒ±nƒ± doldurur">ü•ë Ketojenik</button>
                                                            <button type="button" class="btn btn-outline-secondary" onclick="applyCoeffPreset('lowcarb')" title="Sadece katsayƒ± alanlarƒ±nƒ± doldurur">ü•© D√º≈ü√ºk Karb</button>
                                                            <button type="button" class="btn btn-outline-secondary" onclick="applyCoeffPreset('akdeniz')" title="Sadece katsayƒ± alanlarƒ±nƒ± doldurur">üêü Akdeniz</button>
                                                            <button type="button" class="btn btn-outline-secondary" onclick="applyCoeffPreset('sporcu')" title="Sadece katsayƒ± alanlarƒ±nƒ± doldurur">üí™ Sporcu</button>
                                                            <button type="button" class="btn btn-outline-secondary" onclick="applyCoeffPreset('gebelik')" title="Sadece katsayƒ± alanlarƒ±nƒ± doldurur">ü§± Gebelik</button>
                                                        </div>
                                                    </div>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Karb (g/kg)</span>
                                                        <input id="custom-coeff-carbs" type="number" step="0.1" min="0" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">Prot (g/kg)</span>
                                                        <input id="custom-coeff-protein" type="number" step="0.1" min="0" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">Yaƒü (g/kg)</span>
                                                        <input id="custom-coeff-fat" type="number" step="0.1" min="0" class="form-control" oninput="onCustomFormulaChanged()">
                                                    </div>
                                                    <small class="text-muted">Se√ßili diyet t√ºr√º i√ßin uygulanƒ±r.</small>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <label class="form-label mb-1 mb-0">Aktivite √áarpanlarƒ± (1-5)</label>
                                                        <button type="button" class="btn btn-link btn-sm p-0" onclick="applyActivityPreset('general')" title="0.8, 0.9, 1.0, 1.1, 1.2 varsayƒ±lanlarƒ±nƒ± uygula">Varsayƒ±lanlarƒ± Y√ºkle</button>
                                                    </div>
                                                    <div class="input-group input-group-sm mb-1">
                                                        <span class="input-group-text">1</span>
                                                        <input id="custom-act-1" type="number" step="0.1" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">2</span>
                                                        <input id="custom-act-2" type="number" step="0.1" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">3</span>
                                                        <input id="custom-act-3" type="number" step="0.1" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">4</span>
                                                        <input id="custom-act-4" type="number" step="0.1" class="form-control" oninput="onCustomFormulaChanged()">
                                                        <span class="input-group-text">5</span>
                                                        <input id="custom-act-5" type="number" step="0.1" class="form-control" oninput="onCustomFormulaChanged()">
                                                    </div>
                                                    <small class="text-muted">T√ºm diyet t√ºrleri i√ßin aynƒ± aktivite √ßarpanlarƒ± kullanƒ±lƒ±r.</small>
                                                </div>
                                                <div class="col-12 mt-2">
                                                    <div class="alert alert-secondary py-2 mb-0">
                                                        <small><strong>A√ßƒ±klama:</strong> √ñzel form√ºl: (Karb(g)√ó4 + Prot(g)√ó4 + Yaƒü(g)√ó9) √ó Aktivite. Karb/Prot/Yaƒü = Kilo √ó Katsayƒ±. Aktivite seviyesi se√ßimine g√∂re √ßarpan uygulanƒ±r.</small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Dinamik Form√ºl √ñzeti -->
                                                <div class="col-12 mt-2">
                                                    <div id="custom-formula-summary" class="alert alert-light border py-2 mb-0">
                                                        <small>
                                                            <strong>Form√ºl √ñzeti</strong>
                                                            <div class="mt-1">
                                                                <span class="text-muted">Se√ßili Diyet:</span> <span id="summary-diet" class="fw-semibold">-</span>
                                                            </div>
                                                            <div class="mt-1">
                                                                Makrolar: Karb = <em>Kilo</em> √ó <span id="summary-c"></span>, Protein = <em>Kilo</em> √ó <span id="summary-p"></span>, Yaƒü = <em>Kilo</em> √ó <span id="summary-f"></span>
                                                            </div>
                                                            <div class="mt-1">
                                                                Kalori: (Karb √ó <strong>4</strong> + Protein √ó <strong>4</strong> + Yaƒü √ó <strong>9</strong>) √ó <span class="fw-semibold">Aktivite</span>
                                                            </div>
                                                            <div class="mt-1">
                                                                Aktivite √áarpanlarƒ± (1-5): <span id="summary-acts"></span>
                                                            </div>
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Saƒü Alt: Hedef Makrolar -->
                                                <div class="col-12 mt-2">
                                                    <div id="right-macro-breakdown" class="alert alert-primary py-2 mb-0">
                                                        <small>
                                                            <strong>Hedef Kalori:</strong> <span id="right-calculated-calories">-</span> kcal/g√ºn<br>
                                                            <strong>Hedef Makrolar:</strong>
                                                            <span id="right-calculated-carbs">-</span>g K,
                                                            <span id="right-calculated-protein">-</span>g P,
                                                            <span id="right-calculated-fat">-</span>g Y
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <button class="btn btn-primary-custom" onclick="saveSystemSettings()">
                                                <i class="fas fa-save"></i> Sistem Ayarlarƒ±nƒ± Kaydet
                                            </button>
                                            <button class="btn btn-secondary ms-2" onclick="resetSystemSettings()">
                                                <i class="fas fa-undo"></i> Varsayƒ±lana Sƒ±fƒ±rla
                                            </button>
                                            <button class="btn btn-info ms-2" onclick="debugJsonStatus()">
                                                <i class="fas fa-bug"></i> JSON Durum Testi
                                            </button>
                                            <button class="btn btn-warning ms-2" onclick="forceReloadFromJson()">
                                                <i class="fas fa-sync"></i> JSON'dan Zorla Y√ºkle
                                            </button>
                                            </button>
                                        </div>
                                        <div>
                                            <button id="system-json-save-btn" class="btn btn-success me-2" onclick="saveRulesAndCriteriaToJSON()" title="Kurallar ve kriter hiyerar≈üisini JSON dosyalarƒ±na yaz">
                                                <i class="fas fa-database"></i> JSON‚Äôa Kaydet
                                            </button>
                                            <button class="btn btn-outline-secondary me-2" onclick="exportFullBackup()" title="T√ºm verilerin tek JSON yedeƒüini indir">
                                                <i class="fas fa-archive"></i> Tam Yedek Al
                                            </button>
                                            <button class="btn btn-info" onclick="exportSystemSettings()">
                                                <i class="fas fa-download"></i> Ayarlarƒ± Dƒ±≈üa Aktar
                                            </button>
                                            <button class="btn btn-warning ms-2" onclick="importSystemSettings()">
                                                <i class="fas fa-upload"></i> Ayarlarƒ± ƒ∞√ße Aktar
                                            </button>
                                            <button class="btn btn-outline-warning ms-2" onclick="importFullBackup()" title="Daha √∂nce alƒ±nmƒ±≈ü tam yedeƒüi y√ºkle">
                                                <i class="fas fa-file-import"></i> Tam Yedek Y√ºkle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hafta ≈ûablonu D√ºzenleme Bannerƒ± -->
                            <div id="system-week-profile-editing" class="alert alert-warning d-none mt-3">
                                <!-- JS ile doldurulacak -->
                            </div>

                            <!-- Hafta ≈ûablonlarƒ±: Kaydet/G√∂r√ºnt√ºle -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card card-custom">
                                        <div class="card-header card-header-custom">
                                            <h6 class="mb-0"><i class="fas fa-calendar-plus"></i> Hafta ≈ûablonu Kaydet</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-3">
                                                    <label class="form-label mb-1">Hafta No</label>
                                                    <input type="number" min="1" class="form-control" id="week-profile-number" placeholder="√∂rn: 2">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label mb-1">Hafta Adƒ±/ƒ∞zah</label>
                                                    <input type="text" class="form-control" id="week-profile-name" placeholder="√∂rn: Eliminasyon">
                                                </div>
                                                <div class="col-3">
                                                    <button class="btn btn-primary-custom w-100" onclick="saveSystemWeekProfile()">
                                                        <i class="fas fa-save"></i> Kaydet
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="text-muted">Bu, mevcut sistem ayarlarƒ±nƒ±n bir kopyasƒ±nƒ± se√ßili hafta i√ßin ar≈üivler.</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card card-custom">
                                        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-archive"></i> Kayƒ±tlƒ± Hafta ≈ûablonlarƒ±</h6>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="(async () => await listSystemWeekProfiles())()"><i class="fas fa-sync"></i></button>
                                        </div>
                                        <div class="card-body">
                                            <div id="system-week-profiles-list" class="small text-muted">Hen√ºz kayƒ±t yok.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Etkile≈üim Ge√ßmi≈üi -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card card-custom">
                                        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-history"></i> Kriter Etkile≈üim Ge√ßmi≈üi</h6>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="refreshInteractionHistory()">
                                                    <i class="fas fa-sync"></i> Yenile
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="clearInteractionHistory()">
                                                    <i class="fas fa-trash"></i> Temizle
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="interaction-history-container" class="small">
                                                <!-- JS ile doldurulacak -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Diyet Ayarlarƒ± Sayfasƒ± -->
                <div id="diet-config" class="page-section">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-leaf"></i> Diyet Ayarlarƒ±</h5>
                                <button class="btn btn-primary-custom btn-sm" onclick="showAddDietModal()">
                                    <i class="fas fa-plus"></i> Yeni Diyet Ekle
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- √úst ƒ∞statistikler -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center bg-primary text-white">
                                        <div class="card-body">
                                            <h4 id="totalDietsCount" class="mb-0">0</h4>
                                            <small>Toplam Diyet</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-success text-white">
                                        <div class="card-body">
                                            <h4 id="activeDietsCount" class="mb-0">0</h4>
                                            <small>Aktif Diyet</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-secondary text-white">
                                        <div class="card-body">
                                            <h4 id="inactiveDietsCount" class="mb-0">0</h4>
                                            <small>Pasif Diyet</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center bg-info text-white">
                                        <div class="card-body">
                                            <button class="btn btn-light btn-sm" onclick="exportDietsData()">
                                                <i class="fas fa-download"></i> JSON ƒ∞ndir
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Diyet Listesi -->
                            <div class="row" id="diets-grid">
                                <!-- Dinamik olarak doldurulacak -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Yemek Veritabanƒ± Sayfasƒ± -->
                <div id="food-database" class="page-section">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-utensils"></i> Yemek Veritabanƒ±</h5>
                                <div>
                                    <button class="btn btn-primary-custom btn-sm me-2" onclick="document.getElementById('foodsFileInput').click()">
                                        <i class="fas fa-upload"></i> Yemek Veritabanƒ± Y√ºkle
                                    </button>
                                    <input type="file" id="foodsFileInput" accept=".json" style="display:none" onchange="loadFoodsFromFile(event)">
                                    <button class="btn btn-primary-custom btn-sm" onclick="showAddFoodModal()">
                                        <i class="fas fa-plus"></i> Yeni Yemek Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- √úst ƒ∞statistikler -->
                            <div class="row mb-4">
                                <div class="col-md-2">
                                    <div class="card text-center bg-primary text-white">
                                        <div class="card-body">
                                            <h4 id="totalFoodsCount" class="mb-0">0</h4>
                                            <small>Toplam Yemek</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center bg-success text-white">
                                        <div class="card-body">
                                            <h4 id="ketoFoodsCount" class="mb-0">0</h4>
                                            <small>Keto Uygun</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center bg-warning text-white">
                                        <div class="card-body">
                                            <h4 id="lowCarbFoodsCount" class="mb-0">0</h4>
                                            <small>D√º≈ü√ºk Karb</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center bg-info text-white">
                                        <div class="card-body">
                                            <h4 id="mainDishesCount" class="mb-0">0</h4>
                                            <small>Ana Yemek</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center bg-secondary text-white">
                                        <div class="card-body">
                                            <h4 id="drinksCount" class="mb-0">0</h4>
                                            <small>ƒ∞√ßecek</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center bg-danger text-white">
                                        <div class="card-body">
                                            <button class="btn btn-light btn-sm" onclick="exportFoodsData()">
                                                <i class="fas fa-download"></i> JSON ƒ∞ndir
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Arama ve Filtreleme -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <div class="autocomplete-container">
                                            <input type="text" class="form-control" id="foodSearch" placeholder="Yemek ara..." oninput="handleFoodAutocomplete(this, event); filterFoods();" onkeydown="handleAutocompleteKeydown(event)">
                                            <div class="autocomplete-suggestions" id="foodSearch-suggestions"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="categoryFilter" onchange="filterFoods()">
                                        <option value="">T√ºm Kategoriler</option>
                                        <option value="KAHVALTI">Kahvaltƒ±</option>
                                        <option value="OGLE">√ñƒüle</option>
                                        <option value="AKSAM">Ak≈üam</option>
                                        <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                        <option value="TATLILAR">Tatlƒ±lar</option>
                                        <option value="SALATALAR">Salatalar</option>
                                        <option value="CORBALAR">√áorbalar</option>
                                        <option value="EKMEKLER">Ekmekler</option>
                                        <option value="MEYVELER">Meyveler</option>
                                        <option value="TOSTLAR">Tostlar</option>
                                        <option value="KOLLAJEN">Kollajen</option>
                                        <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                        <option value="ICECEK">ƒ∞√ßecek</option>
                                        <option value="DIGER">Diƒüer</option>
                                        <option value="APERATIF">Aperatif</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="roleFilter" onchange="filterFoods()">
                                        <option value="">T√ºm Roller</option>
                                        <option value="mainDish">Ana Yemek</option>
                                        <option value="side">Yan Yemek</option>
                                        <option value="drink">ƒ∞√ßecek</option>
                                        <option value="soup">√áorba</option>
                                        <option value="dessert">Tatlƒ±</option>
                                        <option value="fruit">Meyve</option>
                                        <option value="bread">Ekmek</option>
                                        <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                        <option value="supplement">Ek</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="dietFilter" onchange="filterFoods()">
                                        <option value="">T√ºm Diyetler</option>
                                        <option value="keto">Keto Uygun</option>
                                        <option value="lowcarb">D√º≈ü√ºk Karb</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Temizle
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Yemek Listesi -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 22%; cursor: pointer;" onclick="sortFoodsBy('name')" aria-sort="none">
                                                Yemek Adƒ± <i id="sortIcon-name" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 7%; cursor: pointer;" onclick="sortFoodsBy('calories')" aria-sort="none">
                                                Kalori <i id="sortIcon-calories" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 7%; cursor: pointer;" onclick="sortFoodsBy('protein')" aria-sort="none">
                                                Protein <i id="sortIcon-protein" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 7%; cursor: pointer;" onclick="sortFoodsBy('carbs')" aria-sort="none">
                                                Karb <i id="sortIcon-carbs" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 7%; cursor: pointer;" onclick="sortFoodsBy('fat')" aria-sort="none">
                                                Yaƒü <i id="sortIcon-fat" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 12%; cursor: pointer;" onclick="sortFoodsBy('category')" aria-sort="none">
                                                Kategori <i id="sortIcon-category" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 10%; cursor: pointer;" onclick="sortFoodsBy('role')" aria-sort="none">
                                                Rol <i id="sortIcon-role" class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th style="width: 8%">√ñzellikler</th>
                                            <th style="width: 20%">ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="foods-table-body">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Kural Y√∂neticisi Sayfasƒ± -->
                <div id="rules" class="page-section">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5><i class="fas fa-list-ol"></i> Kurallar Hiyerar≈üisi (√áakƒ±≈ümada √ºstteki kural √∂nceliklidir)</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> √ñnemli Bilgi</h6>
                                <p class="mb-0">Bu sayfada yapƒ±lan deƒüi≈üiklikler <strong>t√ºm sistem</strong> i√ßin ge√ßerlidir. 
                                Mevcut hastalar i√ßin <strong>kendi √∂zel ayarlarƒ±</strong> varsa, o ayarlar √∂ncelikli olacaktƒ±r.</p>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <h6><i class="fas fa-sort"></i> Aktif Kurallar (Drag&Drop ile sƒ±ralayƒ±n)</h6>
                                    
                                    <div id="rules-hierarchy-container" class="rules-sortable border rounded p-3 bg-light">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </div>
                                    
                                    <div class="mt-3 d-flex justify-content-between">
                                        <div>
                                            <button class="btn btn-primary-custom" onclick="saveRulesHierarchy()">
                                                <i class="fas fa-save"></i> Kural Sƒ±rasƒ±nƒ± Kaydet
                                            </button>
                                            <button class="btn btn-secondary ms-2" onclick="resetRulesHierarchy()">
                                                <i class="fas fa-undo"></i> Varsayƒ±lana D√∂n
                                            </button>
                                        </div>
                                        <div>
                                            <button class="btn btn-success me-2" onclick="saveRulesAndCriteriaToJSON()" title="Kurallar ve kriter hiyerar≈üisini JSON dosyalarƒ±na yaz">
                                                <i class="fas fa-database"></i> JSON‚Äôa Kaydet
                                            </button>
                                            <button class="btn btn-info" onclick="previewRulesEffect()">
                                                <i class="fas fa-eye"></i> Etkiyi √ñnizle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kural Motoru -->
                    <div class="card card-custom mt-3">
                        <div class="card-header card-header-custom" style="cursor: pointer;" onclick="toggleRulesEngine()">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-redo-alt me-2"></i> Kural Motoru (Sƒ±klƒ±k & Baƒüƒ±mlƒ±lƒ±k)
                                    <i id="rules-engine-icon" class="fas fa-chevron-down ms-2"></i>
                                </h5>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); exportSystemRulesArchive()" title="Kurallarƒ± JSON olarak indir">
                                        <i class="fas fa-download"></i> JSON ƒ∞ndir
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); document.getElementById('rulesFileInput').click()" title="Kaydedilmi≈ü kurallarƒ± JSON'dan y√ºkle">
                                        <i class="fas fa-upload"></i> JSON Y√ºkle
                                    </button>
                                    <input type="file" id="rulesFileInput" accept="application/json,.json" style="display:none" onchange="handleImportSystemRulesFile(event)">
                                </div>
                            </div>
                        </div>
                        
                        <div id="rules-engine-content" class="card-body" style="display: none;">
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs mb-3" id="rulesEngineTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="frequency-tab" data-bs-toggle="tab" data-bs-target="#frequency-content" type="button" role="tab">
                                        <i class="fas fa-redo-alt"></i> Sƒ±klƒ±k Kurallarƒ±
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dependency-tab" data-bs-toggle="tab" data-bs-target="#dependency-content" type="button" role="tab">
                                        <i class="fas fa-link"></i> Baƒüƒ±mlƒ±lƒ±k Kurallarƒ±
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="lock-tab" data-bs-toggle="tab" data-bs-target="#lock-content" type="button" role="tab">
                                        <i class="fas fa-lock"></i> Kategori Kilidi
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="rulesEngineTabContent">
                                <!-- Sƒ±klƒ±k Kurallarƒ± Tab -->
                                <div class="tab-pane fade show active" id="frequency-content" role="tabpanel">
                                <form id="frequency-rule-form" class="mb-3">
                                    <input type="hidden" id="fr-id">
                                    
                                    <!-- Filtreler -->
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-5">
                                            <label class="form-label mb-1">Yemek Adƒ± (virg√ºlle ayƒ±rƒ±n)</label>
                                            <div class="input-group">
                                                <div class="autocomplete-container">
                                                    <input type="text" class="form-control" id="fr-name-terms" placeholder="√∂rn: tavuk, ƒ±zgara, salata" oninput="handleFoodAutocomplete(this, event)" onkeydown="handleAutocompleteKeydown(event)">
                                                    <div class="autocomplete-suggestions" id="fr-name-terms-suggestions"></div>
                                                </div>
                                                <span class="input-group-text">Baƒüla√ß</span>
                                                <select class="form-select" id="fr-name-mode" style="max-width: 120px;">
                                                    <option value="AND">ve</option>
                                                    <option value="OR">veya</option>
                                                </select>
                                            </div>
                                            <small class="text-muted">Ad alanƒ±nda kelimeleri virg√ºlle girin; baƒüla√ß se√ßimine g√∂re t√ºm√º/anyesi aranƒ±r</small>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label mb-1">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="fr-tag-terms" placeholder="√∂rn: kƒ±rmƒ±zƒ± et, d√º≈ü√ºk karb">
                                                <span class="input-group-text">Baƒüla√ß</span>
                                                <select class="form-select" id="fr-tag-mode" style="max-width: 120px;">
                                                    <option value="AND">ve</option>
                                                    <option value="OR">veya</option>
                                                </select>
                                            </div>
                                            <small class="text-muted">Tag alanƒ±nda virg√ºlle ayƒ±rƒ±n; baƒüla√ß se√ßimine g√∂re t√ºm√º/anyesi aranƒ±r</small>
                                        </div>
                                    </div>
                                
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">Kategoriler</label>
                                        <select multiple class="form-select" id="fr-categories" size="6">
                                            <option value="KAHVALTI">Kahvaltƒ±</option>
                                            <option value="OGLE">√ñƒüle</option>
                                            <option value="AKSAM">Ak≈üam</option>
                                            <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                            <option value="TATLILAR">Tatlƒ±lar</option>
                                            <option value="SALATALAR">Salatalar</option>
                                            <option value="CORBALAR">√áorbalar</option>
                                            <option value="EKMEKLER">Ekmekler</option>
                                            <option value="MEYVELER">Meyveler</option>
                                            <option value="TOSTLAR">Tostlar</option>
                                            <option value="KOLLAJEN">Kollajen</option>
                                            <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                            <option value="ICECEK">ƒ∞√ßecek</option>
                                            <option value="DIGER">Diƒüer</option>
                                            <option value="APERATIF">Aperatif</option>
                                        </select>
                                        <small class="text-muted">Birden fazla se√ßmek i√ßin Ctrl/Cmd</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">Roller</label>
                                        <select multiple class="form-select" id="fr-roles" size="6">
                                            <option value="mainDish">Ana Yemek</option>
                                            <option value="side">Yan Yemek</option>
                                            <option value="drink">ƒ∞√ßecek</option>
                                            <option value="soup">√áorba</option>
                                            <option value="dessert">Tatlƒ±</option>
                                            <option value="fruit">Meyve</option>
                                            <option value="bread">Ekmek</option>
                                            <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                            <option value="supplement">Ek</option>
                                            <option value="vegetable">Sebze</option>
                                            <option value="fat">Yaƒü</option>
                                        </select>
                                        <small class="text-muted">Birden fazla se√ßmek i√ßin Ctrl/Cmd</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">Kapsam</label>
                                        <div class="border rounded p-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="fr-scope" id="fr-scope-meal" value="meal" checked onchange="updateFrequencyLabel()">
                                                <label class="form-check-label" for="fr-scope-meal">√ñƒü√ºn</label>
                                            </div>
                                            <div class="ms-3 mt-1" id="fr-meals">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="fr-meal-breakfast" value="breakfast">
                                                    <label class="form-check-label" for="fr-meal-breakfast">Kahvaltƒ±</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="fr-meal-lunch" value="lunch">
                                                    <label class="form-check-label" for="fr-meal-lunch">√ñƒüle</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="fr-meal-dinner" value="dinner">
                                                    <label class="form-check-label" for="fr-meal-dinner">Ak≈üam</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="fr-meal-snack" value="snack">
                                                    <label class="form-check-label" for="fr-meal-snack">Ara √ñƒü√ºn</label>
                                                </div>
                                            </div>
                                            <div class="form-check mt-1">
                                                <input class="form-check-input" type="radio" name="fr-scope" id="fr-scope-day" value="day" onchange="updateFrequencyLabel()">
                                                <label class="form-check-label" for="fr-scope-day">G√ºn</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="fr-scope" id="fr-scope-week" value="week" onchange="updateFrequencyLabel()">
                                                <label class="form-check-label" for="fr-scope-week">Hafta</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">Sƒ±klƒ±k</label>
                                        <div class="input-group">
                                            <select class="form-select" id="fr-count-type" style="max-width: 140px;">
                                                <option value="max">En √áok</option>
                                                <option value="min">En Az</option>
                                                <option value="fixed">Sabit</option>
                                            </select>
                                            <input type="number" class="form-control" id="fr-count" min="0" step="1" placeholder="adet">
                                        </div>
                                        <small class="text-muted" id="fr-count-help">Se√ßilen kapsama g√∂re adet (√∂rn: √ñƒü√ºn ‚Üí belirttiƒüiniz √∂ƒü√ºnlerde)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">Hafta(lar)</label>
                                        <input type="text" class="form-control" id="fr-weeks" placeholder="√∂rn: 1,2,7-9">
                                        <small class="text-muted">Sayƒ± veya aralƒ±k (virg√ºlle ayƒ±rƒ±n)</small>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end justify-content-end">
                                        <div>
                                            <button type="button" class="btn btn-success me-2" onclick="saveFrequencyRuleFromForm()">
                                                <i class="fas fa-save"></i> Kaydet
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="clearFrequencyRuleForm()">
                                                <i class="fas fa-undo"></i> Temizle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> Kurallarƒ± g√∂rmek ve d√ºzenlemek i√ßin yukarƒ±daki <strong>"Aktif Kurallar"</strong> b√∂l√ºm√ºn√º kullanƒ±n.
                            </div>
                        </div>
                        
                        <!-- Baƒüƒ±mlƒ±lƒ±k Kurallarƒ± Tab -->
                        <div class="tab-pane fade" id="dependency-content" role="tabpanel">
                            <form id="dependency-rule-form" class="mb-3">
                                <input type="hidden" id="dr-id">
                                
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-link"></i> Baƒüƒ±mlƒ±lƒ±k Kuralƒ± Nedir?</h6>
                                    <p class="mb-0">Bir yemek planlanƒ±rken, ba≈üka bir yemeƒüin de yanƒ±nda olmasƒ±nƒ± zorunlu kƒ±lan kuraldƒ±r. 
                                    √ñrnek: "Mayonez" eklenirse, mutlaka "K√∂fte" ile birlikte olmalƒ±. Oran: %40 ‚Üí Her 100 k√∂fte i√ßin 40 mayonez eklenebilir.</p>
                                </div>
                                
                                <!-- Baƒüƒ±mlƒ± Olan (Sol Taraf) -->
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <div class="card border-danger">
                                            <div class="card-header bg-danger text-white">
                                                <h6 class="mb-0"><i class="fas fa-arrow-right"></i> Baƒüƒ±mlƒ± Olan (Tetikleyici)</h6>
                                                <small>Bu yemek planlanƒ±rsa, kar≈üƒ± tarafƒ±n da eklenmesi gerekir</small>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Yemek Adƒ± (virg√ºlle ayƒ±rƒ±n)</label>
                                                    <div class="input-group">
                                                        <div class="autocomplete-container">
                                                            <input type="text" class="form-control" id="dr-dependent-name-terms" placeholder="√∂rn: mayonez, ket√ßap" oninput="handleFoodAutocomplete(this, event)" onkeydown="handleAutocompleteKeydown(event)">
                                                            <div class="autocomplete-suggestions" id="dr-dependent-name-terms-suggestions"></div>
                                                        </div>
                                                        <span class="input-group-text">Baƒüla√ß</span>
                                                        <select class="form-select" id="dr-dependent-name-mode" style="max-width: 120px;">
                                                            <option value="AND">ve</option>
                                                            <option value="OR">veya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="dr-dependent-tag-terms" placeholder="√∂rn: sos, √ße≈üni">
                                                        <span class="input-group-text">Baƒüla√ß</span>
                                                        <select class="form-select" id="dr-dependent-tag-mode" style="max-width: 120px;">
                                                            <option value="AND">ve</option>
                                                            <option value="OR">veya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label mb-1">Kategoriler</label>
                                                        <select multiple class="form-select" id="dr-dependent-categories" size="4">
                                                            <option value="KAHVALTI">Kahvaltƒ±</option>
                                                            <option value="OGLE">√ñƒüle</option>
                                                            <option value="AKSAM">Ak≈üam</option>
                                                            <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                                            <option value="TATLILAR">Tatlƒ±lar</option>
                                                            <option value="SALATALAR">Salatalar</option>
                                                            <option value="CORBALAR">√áorbalar</option>
                                                            <option value="EKMEKLER">Ekmekler</option>
                                                            <option value="MEYVELER">Meyveler</option>
                                                            <option value="TOSTLAR">Tostlar</option>
                                                            <option value="KOLLAJEN">Kollajen</option>
                                                            <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                            <option value="ICECEK">ƒ∞√ßecek</option>
                                                            <option value="DIGER">Diƒüer</option>
                                                            <option value="APERATIF">Aperatif</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label mb-1">Roller</label>
                                                        <select multiple class="form-select" id="dr-dependent-roles" size="4">
                                                            <option value="mainDish">Ana Yemek</option>
                                                            <option value="side">Yan Yemek</option>
                                                            <option value="drink">ƒ∞√ßecek</option>
                                                            <option value="soup">√áorba</option>
                                                            <option value="dessert">Tatlƒ±</option>
                                                            <option value="fruit">Meyve</option>
                                                            <option value="bread">Ekmek</option>
                                                            <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                            <option value="supplement">Ek</option>
                                                            <option value="vegetable">Sebze</option>
                                                            <option value="fat">Yaƒü</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Oran ve Ayarlar (Orta) -->
                                    <div class="col-md-2">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark text-center">
                                                <h6 class="mb-0"><i class="fas fa-percentage"></i> Oran</h6>
                                            </div>
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Baƒüƒ±mlƒ±lƒ±k Oranƒ±</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="dr-ratio" min="1" max="100" value="40">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    <small class="text-muted">Her 100 'baƒüƒ±mlƒ± olunan' i√ßin ka√ß 'baƒüƒ±mlƒ± olan' eklensin</small>
                                                </div>
                                                
                                                <div class="alert alert-success mb-0">
                                                    <small><i class="fas fa-shield-alt"></i> <strong>Zorunlu Kural</strong><br>
                                                    Baƒüƒ±mlƒ± olan yemek sadece baƒüƒ±mlƒ± olunan ile birlikte eklenir</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Baƒüƒ±mlƒ± Olunan (Saƒü Taraf) -->
                                    <div class="col-md-5">
                                        <div class="card border-success">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="mb-0"><i class="fas fa-arrow-left"></i> Baƒüƒ±mlƒ± Olunan (Hedef)</h6>
                                                <small>Sol taraf eklendiƒüinde, bu taraftan da se√ßim yapƒ±lƒ±r</small>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Yemek Adƒ± (virg√ºlle ayƒ±rƒ±n)</label>
                                                    <div class="input-group">
                                                        <div class="autocomplete-container">
                                                            <input type="text" class="form-control" id="dr-target-name-terms" placeholder="√∂rn: k√∂fte, sucuk" oninput="handleFoodAutocomplete(this, event)" onkeydown="handleAutocompleteKeydown(event)">
                                                            <div class="autocomplete-suggestions" id="dr-target-name-terms-suggestions"></div>
                                                        </div>
                                                        <span class="input-group-text">Baƒüla√ß</span>
                                                        <select class="form-select" id="dr-target-name-mode" style="max-width: 120px;">
                                                            <option value="AND">ve</option>
                                                            <option value="OR">veya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="dr-target-tag-terms" placeholder="√∂rn: et, protein">
                                                        <span class="input-group-text">Baƒüla√ß</span>
                                                        <select class="form-select" id="dr-target-tag-mode" style="max-width: 120px;">
                                                            <option value="AND">ve</option>
                                                            <option value="OR">veya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label mb-1">Kategoriler</label>
                                                        <select multiple class="form-select" id="dr-target-categories" size="4">
                                                            <option value="KAHVALTI">Kahvaltƒ±</option>
                                                            <option value="OGLE">√ñƒüle</option>
                                                            <option value="AKSAM">Ak≈üam</option>
                                                            <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                                            <option value="TATLILAR">Tatlƒ±lar</option>
                                                            <option value="SALATALAR">Salatalar</option>
                                                            <option value="CORBALAR">√áorbalar</option>
                                                            <option value="EKMEKLER">Ekmekler</option>
                                                            <option value="MEYVELER">Meyveler</option>
                                                            <option value="TOSTLAR">Tostlar</option>
                                                            <option value="KOLLAJEN">Kollajen</option>
                                                            <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                            <option value="ICECEK">ƒ∞√ßecek</option>
                                                            <option value="DIGER">Diƒüer</option>
                                                            <option value="APERATIF">Aperatif</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label mb-1">Roller</label>
                                                        <select multiple class="form-select" id="dr-target-roles" size="4">
                                                            <option value="mainDish">Ana Yemek</option>
                                                            <option value="side">Yan Yemek</option>
                                                            <option value="drink">ƒ∞√ßecek</option>
                                                            <option value="soup">√áorba</option>
                                                            <option value="dessert">Tatlƒ±</option>
                                                            <option value="fruit">Meyve</option>
                                                            <option value="bread">Ekmek</option>
                                                            <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                            <option value="supplement">Ek</option>
                                                            <option value="vegetable">Sebze</option>
                                                            <option value="fat">Yaƒü</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kaydet Butonlarƒ± -->
                                <div class="row mt-3">
                                    <div class="col-12 d-flex justify-content-end">
                                        <button type="button" class="btn btn-success me-2" onclick="saveDependencyRuleFromForm()">
                                            <i class="fas fa-save"></i> Baƒüƒ±mlƒ±lƒ±k Kuralƒ±nƒ± Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="clearDependencyRuleForm()">
                                            <i class="fas fa-undo"></i> Temizle
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> Baƒüƒ±mlƒ±lƒ±k kurallarƒ±nƒ± g√∂rmek ve d√ºzenlemek i√ßin yukarƒ±daki <strong>"Aktif Kurallar"</strong> b√∂l√ºm√ºn√º kullanƒ±n.
                            </div>
                        </div>
                        
                        <!-- Kategori Kilidi Tab -->
                        <div class="tab-pane fade" id="lock-content" role="tabpanel">
                            <form id="lock-rule-form" class="mb-3">
                                <input type="hidden" id="lr-id">
                                
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-lock"></i> Kategori Kilidi Kuralƒ± Nedir?</h6>
                                    <p class="mb-0">Belirli kategorilerdeki yemeklerin belirlenen s√ºre boyunca sabit kalmasƒ±nƒ± saƒülar. 
                                    √ñrnek: "Ekmek" kategorisi haftalƒ±k kilitlenirse, bir kez "Keten Tohumu Ekmeƒüi" se√ßildikten sonra 
                                    o hafta boyunca sadece "Keten Tohumu Ekmeƒüi" verilebilir.</p>
                                </div>
                                
                                <div class="row g-3">
                                    <!-- Temel Bilgiler -->
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label" for="lr-name">Kural Adƒ± <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="lr-name" placeholder="√∂rn: Ekmek Kategorisi Haftalƒ±k Kilit" required>
                                        </div>
                                    </div>
                                    
                                    <!-- Kategori/Rol Se√ßimi -->
                                    <div class="col-md-6">
                                        <div class="card border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0"><i class="fas fa-target"></i> Kilitlenecek Hedef</h6>
                                                <small>Hangi kategoriler veya roller sabit kalacak</small>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Kategori</label>
                                                    <select class="form-select" id="lr-category" onchange="updateLockTargetInfo(); updateLockDescription();">
                                                        <option value="">Kategori Se√ßin (ƒ∞steƒüe baƒülƒ±)</option>
                                                        <option value="EKMEKLER">Ekmekler</option>
                                                        <option value="MEYVELER">Meyveler</option>
                                                        <option value="SALATALAR">Salatalar</option>
                                                        <option value="CORBALAR">√áorbalar</option>
                                                        <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                                        <option value="TATLILAR">Tatlƒ±lar</option>
                                                        <option value="TOSTLAR">Tostlar</option>
                                                        <option value="ICECEK">ƒ∞√ßecek</option>
                                                        <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                        <option value="DIGER">Diƒüer</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Rol</label>
                                                    <select class="form-select" id="lr-role" onchange="updateLockTargetInfo(); updateLockDescription();">
                                                        <option value="">Rol Se√ßin (ƒ∞steƒüe baƒülƒ±)</option>
                                                        <option value="mainDish">Ana Yemek</option>
                                                        <option value="side">Yan Yemek</option>
                                                        <option value="drink">ƒ∞√ßecek</option>
                                                        <option value="soup">√áorba</option>
                                                        <option value="dessert">Tatlƒ±</option>
                                                        <option value="fruit">Meyve</option>
                                                        <option value="bread">Ekmek</option>
                                                        <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                                        <option value="supplement">Ek</option>
                                                        <option value="vegetable">Sebze</option>
                                                        <option value="fat">Yaƒü</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="alert alert-info mb-0" id="lr-target-info">
                                                    <small><i class="fas fa-info-circle"></i> <strong>Hedef Se√ßimi:</strong><br>
                                                    ‚Ä¢ Sadece kategori: O kategorideki t√ºm yemekler kilitlenir<br>
                                                    ‚Ä¢ Sadece rol: O roldeki t√ºm yemekler kilitlenir<br>
                                                    ‚Ä¢ ƒ∞kisi birden: Hem kategoride hem rolde olan yemekler kilitlenir</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Kilit S√ºresi -->
                                    <div class="col-md-6">
                                        <div class="card border-info h-100">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-clock"></i> Kilit Ayarlarƒ±</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Periyot <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="lr-period" onchange="updateLockDescription()" required>
                                                        <option value="">Periyot Se√ßin</option>
                                                        <option value="daily">G√ºnl√ºk</option>
                                                        <option value="weekly">Haftalƒ±k</option>
                                                        <option value="monthly">Aylƒ±k</option>
                                                    </select>
                                                    <small class="text-muted" id="lr-period-help">
                                                        <strong>Periyot:</strong> Yemeƒüin ne kadar s√ºre sabit kalacaƒüƒ±nƒ± belirler<br>
                                                        ‚Ä¢ G√ºnl√ºk: Her g√ºn yeniden se√ßilebilir<br>
                                                        ‚Ä¢ Haftalƒ±k: Hafta boyunca aynƒ± yemek<br>
                                                        ‚Ä¢ Aylƒ±k: Ay boyunca aynƒ± yemek
                                                    </small>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Kapsam</label>
                                                    <select class="form-select" id="lr-scope" onchange="updateLockDescription()">
                                                        <option value="meal">√ñƒü√ºn Bazlƒ±</option>
                                                        <option value="day">G√ºn Bazlƒ±</option>
                                                        <option value="week">Hafta Bazlƒ±</option>
                                                    </select>
                                                    <small class="text-muted" id="lr-scope-help">
                                                        <strong>Kapsam:</strong> Kilitlemenin hangi seviyede uygulanacaƒüƒ±nƒ± belirler<br>
                                                        ‚Ä¢ √ñƒü√ºn: Sadece o √∂ƒü√ºnde kilitli<br>
                                                        ‚Ä¢ G√ºn: T√ºm g√ºnde kilitli<br>
                                                        ‚Ä¢ Hafta: T√ºm haftada kilitli
                                                    </small>
                                                </div>
                                                
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lr-active" checked>
                                                    <label class="form-check-label" for="lr-active">
                                                        Kural aktif
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- A√ßƒ±klama -->
                                    <div class="col-md-6">
                                        <div class="card border-secondary h-100">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="fas fa-comment"></i> A√ßƒ±klama</h6>
                                            </div>
                                            <div class="card-body">
                                                <textarea class="form-control" id="lr-description" rows="6" 
                                                    placeholder="Bu kuralƒ±n ne i≈üe yaradƒ±ƒüƒ±nƒ± a√ßƒ±klayƒ±n..."></textarea>
                                                
                                                <div class="alert alert-success mt-3 mb-0">
                                                    <small><i class="fas fa-info-circle"></i> <strong>Nasƒ±l √áalƒ±≈üƒ±r?</strong><br>
                                                    ƒ∞lk sefer kategoriden bir yemek se√ßildiƒüinde, belirlenen s√ºre boyunca 
                                                    sadece o yemek verilebilir.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kaydet Butonlarƒ± -->
                                <div class="row mt-3">
                                    <div class="col-12 d-flex justify-content-end">
                                        <button type="button" class="btn btn-success me-2" onclick="saveLockRuleFromForm()">
                                            <i class="fas fa-save"></i> Kategori Kilidi Kuralƒ±nƒ± Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="clearLockRuleForm()">
                                            <i class="fas fa-undo"></i> Temizle
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> Kategori kilidi kurallarƒ±nƒ± g√∂rmek ve d√ºzenlemek i√ßin yukarƒ±daki <strong>"Aktif Kurallar"</strong> b√∂l√ºm√ºn√º kullanƒ±n.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                
                <!-- Hasta Takibi Sayfasƒ± -->
                <div id="patient-tracking" class="page-section">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card card-custom">
                                <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                    <h6><i class="fas fa-users"></i> Hastalar</h6>
                                    <div>
                                        <button class="btn btn-primary btn-sm me-1" onclick="showPatientManagement()" title="Hasta Y√∂netimi">
                                            <i class="fas fa-cogs"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="addNewPatient()" title="Yeni Hasta">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="patients-list">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div id="patient-details" style="display: none;">
                                <!-- Hasta Bilgileri -->
                                <div class="card card-custom">
                                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                        <h6><i class="fas fa-user"></i> Hasta Detaylarƒ±</h6>
                                        <div>
                                            <button class="btn btn-warning btn-sm me-1" onclick="editCurrentPatient()" title="Hasta Bilgilerini D√ºzenle">
                                                <i class="fas fa-edit"></i> D√ºzenle
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteCurrentPatient()" title="Hastayƒ± Sil">
                                                <i class="fas fa-trash"></i> Sil
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="patient-info">
                                            <!-- Se√ßili hasta bilgileri -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Hasta √ñzel Ayarlarƒ± -->
                                <div class="card card-custom">
                                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                        <h6><i class="fas fa-user-cog"></i> Hasta √ñzel Ayarlarƒ±</h6>
                                        <div>
                                            <button class="btn btn-warning btn-sm me-2" onclick="resetToSystemDefaults()">
                                                <i class="fas fa-undo"></i> Sistem Varsayƒ±lanlarƒ±
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="savePatientSettings()">
                                                <i class="fas fa-save"></i> Kaydet
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- √ñƒü√ºn Ayarlarƒ± -->
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-utensils"></i> √ñƒü√ºn Ayarlarƒ±</h6>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Diyet T√ºr√º</label>
                                                    <select class="form-control" id="patient-custom-diet">
                                                        <option value="ketojenik">ü•ë Ketojenik</option>
                                                        <option value="lowcarb">ü•© D√º≈ü√ºk Karbonhidrat</option>
                                                        <option value="akdeniz">üêü Akdeniz Diyeti</option>
                                                        <option value="sporcu">üí™ Sporcu Beslenmesi</option>
                                                        <option value="gebelik">ü§± Gebelik Beslenmesi</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">√ñƒü√ºn Sayƒ±sƒ±</label>
                                                    <select class="form-control" id="patient-meal-count">
                                                        <option value="3">3 √ñƒü√ºn</option>
                                                        <option value="4">4 √ñƒü√ºn</option>
                                                        <option value="5">5 √ñƒü√ºn</option>
                                                        <option value="6">6 √ñƒü√ºn</option>
                                                    </select>
                                                </div>

                                                <h6><i class="fas fa-hashtag"></i> √ñƒü√ºn Satƒ±r Sayƒ±larƒ±</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">Kahvaltƒ±</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-breakfast-lines" min="1" max="8">
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">Ku≈üluk</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-snack1-lines" min="1" max="5">
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">√ñƒüle</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-lunch-lines" min="1" max="8">
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">ƒ∞kindi</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-snack2-lines" min="1" max="5">
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">Ak≈üam</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-dinner-lines" min="1" max="8">
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label text-sm">Gece</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="patient-night-lines" min="1" max="3">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Kural Ayarlarƒ± -->
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-list-ol"></i> Kural Hiyerar≈üisi</h6>
                                                <div class="alert alert-info">
                                                    <small><i class="fas fa-info-circle"></i> Bu hastaya √∂zel kural sƒ±ralamasƒ±</small>
                                                </div>
                                                
                                                <div id="patient-rules-hierarchy" class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;">
                                                    <!-- Hasta √∂zel kural sƒ±ralamasƒ± -->
                                                </div>

                                                <div class="mt-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               id="use-system-rules" checked>
                                                        <label class="form-check-label" for="use-system-rules">
                                                            Sistem varsayƒ±lan kurallarƒ±nƒ± kullan
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <div class="alert alert-success" style="display: none;" id="patient-settings-success">
                                                    <i class="fas fa-check-circle"></i> Hasta ayarlarƒ± ba≈üarƒ±yla kaydedildi!
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Haftalƒ±k Planlar -->
                                <div class="card card-custom">
                                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                        <h6><i class="fas fa-calendar-week"></i> Haftalƒ±k Planlar</h6>
                                        <button class="btn btn-light btn-sm" onclick="addNewWeek()">
                                            <i class="fas fa-plus"></i> Yeni Hafta Ekle
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="weekly-tabs">
                                            <!-- Hafta tablarƒ± -->
                                        </div>
                                        
                                        <div id="weekly-plan-content">
                                            <!-- Se√ßili hafta planƒ± -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="no-patient-selected" class="alert alert-info alert-custom">
                                <i class="fas fa-info-circle"></i> Hasta takibi i√ßin sol panelden bir hasta se√ßiniz.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Kullanƒ±cƒ±lar Sayfasƒ± -->
                <div id="users" class="page-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card card-custom">
                                <div class="card-header card-header-custom">
                                    <h6><i class="fas fa-user-plus"></i> Yeni Kullanƒ±cƒ± Ekle</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Kullanƒ±cƒ± T√ºr√º</label>
                                        <select class="form-control" id="userType" onchange="showUserForm()">
                                            <option value="">Se√ßiniz...</option>
                                            <option value="patient">üë§ Hasta</option>
                                            <option value="doctor">üë®‚Äç‚öïÔ∏è Doktor</option>
                                            <option value="dietitian">üë©‚Äç‚öïÔ∏è Diyetisyen</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Hasta Kayƒ±t Formu -->
                                    <div id="patient-form" style="display: none;">
                                        <h6 class="text-primary mb-3">üë§ Hasta Bilgileri</h6>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Ad *</label>
                                                    <input type="text" class="form-control" id="patientFirstName" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Soyad *</label>
                                                    <input type="text" class="form-control" id="patientLastName" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">Ya≈ü *</label>
                                                    <input type="number" class="form-control" id="patientAge" min="0" max="120" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">Cinsiyet</label>
                                                    <select class="form-control" id="patientGender">
                                                        <option value="kadƒ±n" selected>Kadƒ±n</option>
                                                        <option value="erkek">Erkek</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">Telefon</label>
                                                    <input type="tel" class="form-control" id="patientPhone">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Boy (cm) *</label>
                                                    <input type="number" class="form-control" id="patientHeight" min="100" max="250" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Kilo (kg) *</label>
                                                    <input type="number" step="0.1" class="form-control" id="patientWeight" min="30" max="300" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Aktivite D√ºzeyi (1-5)</label>
                                            <select class="form-control" id="patientActivityLevel" onchange="calculatePatientMacros()">
                                                <option value="1">1 - Sedanter (masa ba≈üƒ± i≈ü)</option>
                                                <option value="2">2 - Az aktif (hafta 1-3 g√ºn egzersiz)</option>
                                                <option value="3" selected>3 - Orta aktif (hafta 3-5 g√ºn egzersiz)</option>
                                                <option value="4">4 - √áok aktif (hafta 6-7 g√ºn egzersiz)</option>
                                                <option value="5">5 - A≈üƒ±rƒ± aktif (g√ºnde 2 kez egzersiz)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Ek Hastalƒ±klar</label>
                                            <textarea class="form-control" id="patientDiseases" rows="2" 
                                                    placeholder="Diyabet, hipertansiyon vb."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Alerjiler</label>
                                            <input type="text" class="form-control" id="patientAllergies" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n (√∂r: s√ºt, fƒ±ndƒ±k)">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Kullandƒ±ƒüƒ± ƒ∞la√ßlar</label>
                                            <textarea class="form-control" id="patientMedications" rows="2" 
                                                    placeholder="ƒ∞la√ß adlarƒ± ve dozlarƒ±"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Sevilen Yemekler</label>
                                            <input type="text" class="form-control" id="patientLikedFoods" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Sevmediƒüi Yemekler</label>
                                            <input type="text" class="form-control" id="patientDislikedFoods" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Notlar</label>
                                            <textarea class="form-control" id="patientNotes" rows="3" 
                                                    placeholder="Ek bilgiler, √∂zel durumlar..."></textarea>
                                        </div>
                                        
                                        <hr>
                                        <h6 class="text-success mb-3">üéØ Diyet Hedefleri</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Diyet T√ºr√º *</label>
                                            <select class="form-control" id="patientDietType" onchange="calculatePatientMacros()">
                                                <option value="">Se√ßiniz...</option>
                                                <option value="ketojenik">ü•ë Ketojenik</option>
                                                <option value="lowcarb">ü•© D√º≈ü√ºk Karbonhidrat</option>
                                                <option value="akdeniz">üêü Akdeniz</option>
                                                <option value="sporcu">üí™ Sporcu Beslenmesi</option>
                                                <option value="gebelik">ü§± Gebelik Beslenmesi</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Kalori Hesaplama Y√∂ntemi</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="calorieMethod" 
                                                       id="calorieMethodCustom" value="custom" checked onchange="calculatePatientMacros()">
                                                <label class="form-check-label" for="calorieMethodCustom">
                                                    <strong>√ñzel Form√ºl</strong> (Makro x Katsayƒ± x Aktivite)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="calorieMethod" 
                                                       id="calorieMethodHarris" value="harris" onchange="calculatePatientMacros()">
                                                <label class="form-check-label" for="calorieMethodHarris">
                                                    Harris-Benedict BMR Form√ºl√º
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label class="form-label">Hedef Karbonhidrat (g)</label>
                                                    <input type="number" class="form-control" id="targetCarbs" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label class="form-label">Hedef Protein (g)</label>
                                                    <input type="number" class="form-control" id="targetProtein" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label class="form-label">Hedef Yaƒü (g)</label>
                                                    <input type="number" class="form-control" id="targetFat" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label class="form-label">Hedef Kalori</label>
                                                    <input type="number" class="form-control" id="targetCalories" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="macro-breakdown" class="alert alert-info" style="display: none;">
                                            <small><i class="fas fa-info-circle"></i> <strong>Hesaplama Detaylarƒ±:</strong> <span id="calculation-details"></span></small>
                                        </div>
                                    </div>
                                    
                                    <!-- Doktor Kayƒ±t Formu -->
                                    <div id="doctor-form" style="display: none;">
                                        <h6 class="text-success mb-3">üë®‚Äç‚öïÔ∏è Doktor Bilgileri</h6>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Ad *</label>
                                                    <input type="text" class="form-control" id="doctorFirstName" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Soyad *</label>
                                                    <input type="text" class="form-control" id="doctorLastName" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Uzmanlƒ±k Alanƒ± *</label>
                                            <select class="form-control" id="doctorSpecialization">
                                                <option value="">Se√ßiniz...</option>
                                                <option value="ƒ∞√ß Hastalƒ±klarƒ±">ƒ∞√ß Hastalƒ±klarƒ±</option>
                                                <option value="Endokrinoloji">Endokrinoloji</option>
                                                <option value="Kardiyoloji">Kardiyoloji</option>
                                                <option value="Gastroenteroloji">Gastroenteroloji</option>
                                                <option value="Genel Pratisyen">Genel Pratisyen</option>
                                                <option value="Diƒüer">Diƒüer</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Lisans Numarasƒ±</label>
                                            <input type="text" class="form-control" id="doctorLicense">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Telefon</label>
                                            <input type="tel" class="form-control" id="doctorPhone">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">E-posta</label>
                                            <input type="email" class="form-control" id="doctorEmail">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Hastane/Klinik</label>
                                            <input type="text" class="form-control" id="doctorHospital">
                                        </div>
                                    </div>
                                    
                                    <!-- Diyetisyen Kayƒ±t Formu -->
                                    <div id="dietitian-form" style="display: none;">
                                        <h6 class="text-info mb-3">üë©‚Äç‚öïÔ∏è Diyetisyen Bilgileri</h6>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Ad *</label>
                                                    <input type="text" class="form-control" id="dietitianFirstName" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Soyad *</label>
                                                    <input type="text" class="form-control" id="dietitianLastName" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Uzmanlƒ±k Alanƒ± *</label>
                                            <select class="form-control" id="dietitianSpecialization">
                                                <option value="">Se√ßiniz...</option>
                                                <option value="Klinik Beslenme">Klinik Beslenme</option>
                                                <option value="Sporcu Beslenmesi">Sporcu Beslenmesi</option>
                                                <option value="Pediatrik Beslenme">Pediatrik Beslenme</option>
                                                <option value="Geriatrik Beslenme">Geriatrik Beslenme</option>
                                                <option value="Beslenme Danƒ±≈ümanlƒ±ƒüƒ±">Beslenme Danƒ±≈ümanlƒ±ƒüƒ±</option>
                                                <option value="Diƒüer">Diƒüer</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Lisans Numarasƒ±</label>
                                            <input type="text" class="form-control" id="dietitianLicense">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Telefon</label>
                                            <input type="tel" class="form-control" id="dietitianPhone">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">E-posta</label>
                                            <input type="email" class="form-control" id="dietitianEmail">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Klinik/Merkez</label>
                                            <input type="text" class="form-control" id="dietitianClinic">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Uzmanlƒ±k Diyet T√ºrleri</label>
                                            <div class="form-check-group">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="dietKeto" value="ketojenik">
                                                    <label class="form-check-label" for="dietKeto">Ketojenik</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="dietLowCarb" value="lowcarb">
                                                    <label class="form-check-label" for="dietLowCarb">D√º≈ü√ºk Karbonhidrat</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="dietMed" value="akdeniz">
                                                    <label class="form-check-label" for="dietMed">Akdeniz</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="dietSport" value="sporcu">
                                                    <label class="form-check-label" for="dietSport">Sporcu</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2" id="form-buttons" style="display: none;">
                                        <button class="btn btn-primary-custom" onclick="saveUser()">
                                            <i class="fas fa-save"></i> Kullanƒ±cƒ±yƒ± Kaydet
                                        </button>
                                        <button class="btn btn-secondary" onclick="resetUserForm()">
                                            <i class="fas fa-times"></i> ƒ∞ptal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card card-custom">
                                <div class="card-header card-header-custom">
                                    <h6><i class="fas fa-users"></i> Kayƒ±tlƒ± Kullanƒ±cƒ±lar</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="userTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="patients-tab" data-bs-toggle="tab" 
                                                    data-bs-target="#patients-content" type="button">
                                                üë§ Hastalar (<span id="patients-count">0</span>)
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="doctors-tab" data-bs-toggle="tab" 
                                                    data-bs-target="#doctors-content" type="button">
                                                üë®‚Äç‚öïÔ∏è Doktorlar (<span id="doctors-count">0</span>)
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="dietitians-tab" data-bs-toggle="tab" 
                                                    data-bs-target="#dietitians-content" type="button">
                                                üë©‚Äç‚öïÔ∏è Diyetisyenler (<span id="dietitians-count">0</span>)
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3" id="userTabContent">
                                        <!-- Hastalar Tab -->
                                        <div class="tab-pane fade show active" id="patients-content">
                                            <div id="patients-table-container">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Ad Soyad</th>
                                                                <th>Kilo</th>
                                                                <th>Boy</th>
                                                                <th>Telefon</th>
                                                                <th>Durum & Diyet</th>
                                                                <th>ƒ∞≈ülemler</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="patients-table-body">
                                                            <!-- Dinamik olarak doldurulacak -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Doktorlar Tab -->
                                        <div class="tab-pane fade" id="doctors-content">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Ad Soyad</th>
                                                            <th>Uzmanlƒ±k</th>
                                                            <th>Telefon</th>
                                                            <th>E-posta</th>
                                                            <th>Durum</th>
                                                            <th>ƒ∞≈ülemler</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="doctors-table-body">
                                                        <!-- Dinamik olarak doldurulacak -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <!-- Diyetisyenler Tab -->
                                        <div class="tab-pane fade" id="dietitians-content">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Ad Soyad</th>
                                                            <th>Uzmanlƒ±k</th>
                                                            <th>Telefon</th>
                                                            <th>E-posta</th>
                                                            <th>Durum</th>
                                                            <th>ƒ∞≈ülemler</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="dietitians-table-body">
                                                        <!-- Dinamik olarak doldurulacak -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Console Log -->
                <div class="card card-custom mt-4">
                    <div class="card-header">
                        <h6><i class="fas fa-terminal"></i> Sistem Loglarƒ±</h6>
                    </div>
                    <div class="card-body">
                        <div id="console-log" class="console-log">
                            <div>üéØ Sistem ba≈ülatƒ±ldƒ± - v2.0</div>
                        </div>
                        
                        <!-- Debug Butonlarƒ± -->
                        <div class="mt-3">
                            <h6>üîß JSON Debug Ara√ßlarƒ±:</h6>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="testJsonLoad()">
                                    üì• JSON Y√ºkleme Test
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="testJsonSave()">
                                    üíæ JSON Kayƒ±t Test
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="showJsonStatus()">
                                    üìä JSON Durum
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="forceReloadFromJson()">
                                    üîÑ JSON'dan Zorla Y√ºkle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // GitHub API Configuration
        const GITHUB_CONFIG = {
            owner: 'mustafasacar35',
            repo: 'lipo_program',
            apiUrl: 'https://api.github.com',
            token: null
        };

        // GitHub Token Management
        function checkGitHubToken() {
            const token = localStorage.getItem('github_token');
            if (token) {
                GITHUB_CONFIG.token = token;
                document.getElementById('githubLoginOverlay').classList.add('hidden');
                updateGitHubStatus(true);
                updateConnectionStatusDisplay();
                loadSystemDataFromGitHub();
            } else {
                document.getElementById('githubLoginOverlay').classList.remove('hidden');
                updateGitHubStatus(false);
                updateConnectionStatusDisplay();
            }
        }

        function connectGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert('L√ºtfen GitHub token girin!');
                return;
            }

            GITHUB_CONFIG.token = token;
            localStorage.setItem('github_token', token);
            
            // Test token
            testConnection().then(success => {
                if (success) {
                    document.getElementById('githubLoginOverlay').classList.add('hidden');
                    updateGitHubStatus(true);
                    loadSystemDataFromGitHub();
                    showNotification('GitHub baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!', 'success');
                } else {
                    localStorage.removeItem('github_token');
                    GITHUB_CONFIG.token = null;
                    showNotification('GitHub token ge√ßersiz!', 'error');
                }
            });
        }

        function disconnectGitHub() {
            localStorage.removeItem('github_token');
            GITHUB_CONFIG.token = null;
            updateGitHubStatus(false);
            document.getElementById('githubLoginOverlay').classList.remove('hidden');
            showNotification('GitHub baƒülantƒ±sƒ± kesildi', 'info');
        }

        async function testConnection() {
            if (!GITHUB_CONFIG.token) {
                return false;
            }

            try {
                const response = await fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    console.log('‚úÖ GitHub baƒülantƒ±sƒ± ba≈üarƒ±lƒ±');
                    return true;
                } else {
                    console.error('‚ùå GitHub baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå GitHub baƒülantƒ± hatasƒ±:', error);
                return false;
            }
        }

        function updateGitHubStatus(connected) {
            const statusElement = document.getElementById('githubStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusElement.classList.remove('disconnected', 'hidden');
                statusElement.classList.add('connected');
                statusText.textContent = 'GitHub Baƒülƒ±';
            } else {
                statusElement.classList.remove('connected');
                statusElement.classList.add('disconnected', 'hidden');
                statusText.textContent = 'Baƒülantƒ± Kesildi';
            }
        }

        // GitHub'dan JSON verilerini √ßekme
        async function fetchGitHubFile(path) {
            if (!GITHUB_CONFIG.token) {
                throw new Error('GitHub token bulunamadƒ±');
            }

            try {
                const response = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }

                const data = await response.json();
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (error) {
                console.error(`‚ùå ${path} dosyasƒ± y√ºklenemedi:`, error);
                throw error;
            }
        }

        // Sistem verilerini GitHub'dan y√ºkle
        async function loadSystemDataFromGitHub() {
            try {
                showNotification('GitHub veriler y√ºkleniyor...', 'info');
                
                // Ana veri dosyalarƒ±nƒ± √ßek
                const promises = [];
                const fileMap = {
                    'meals_new.json': 'meals',
                    'data/patients_list.json': 'patients',
                    'data/doctors_list.json': 'doctors',
                    'data/dietitians_list.json': 'dietitians',
                    'data/rules.json': 'systemRules',
                    'data/system_settings.json': 'systemSettings',
                    'data/diet_config.json': 'dietConfig'
                };

                for (const [filePath, varName] of Object.entries(fileMap)) {
                    promises.push(
                        fetchGitHubFile(filePath)
                            .then(data => ({ varName, data, success: true }))
                            .catch(error => ({ varName, error, success: false }))
                    );
                }

                const results = await Promise.all(promises);
                let successCount = 0;

                results.forEach(result => {
                    if (result.success) {
                        window[result.varName] = result.data;
                        successCount++;
                        console.log(`‚úÖ ${result.varName} y√ºklendi`);
                    } else {
                        console.warn(`‚ö†Ô∏è ${result.varName} y√ºklenemedi:`, result.error.message);
                    }
                });

                // Dashboard sayƒ±larƒ±nƒ± g√ºncelle
                updateDashboardStats();
                
                // ƒ∞lk hastayƒ± otomatik se√ß (currentPatient'ƒ± set et)
                if (window.patients && window.patients.length > 0) {
                    const lastPatientId = localStorage.getItem('currentPatientId');
                    let selectedPatient = null;
                    
                    if (lastPatientId) {
                        selectedPatient = window.patients.find(p => p.id === lastPatientId);
                    }
                    
                    if (!selectedPatient) {
                        selectedPatient = window.patients[0];
                    }
                    
                    if (selectedPatient) {
                        currentPatient = selectedPatient;
                        window.currentPatientId = selectedPatient.id;
                        localStorage.setItem('currentPatientId', selectedPatient.id);
                        console.log('üë§ Otomatik hasta se√ßildi:', selectedPatient.id);
                    }
                }
                
                // Son senkronizasyon zamanƒ±nƒ± kaydet
                localStorage.setItem('lastSync', new Date().toLocaleString('tr-TR'));
                updateLastSyncTime();
                updateConnectionStatusDisplay();
                
                showNotification(`GitHub veriler y√ºklendi! (${successCount}/${results.length})`, 'success');
                console.log(`‚úÖ GitHub verileri y√ºklendi: ${successCount}/${results.length}`);
                
            } catch (error) {
                console.error('‚ùå GitHub verileri y√ºklenirken hata:', error);
                showNotification('GitHub veriler y√ºklenemedi: ' + error.message, 'error');
            }
        }

        // Dashboard istatistiklerini g√ºncelle
        function updateDashboardStats() {
            if (window.patients) {
                document.getElementById('total-patients').textContent = window.patients.length || 0;
            }
            if (window.doctors) {
                document.getElementById('total-doctors').textContent = window.doctors.length || 0;
            }
            if (window.dietitians) {
                document.getElementById('total-dietitians').textContent = window.dietitians.length || 0;
            }
        }

        // Bildirim sistemi
        function showNotification(message, type = 'info') {
            // Mevcut bildirim varsa kaldƒ±r
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 9998;
                min-width: 300px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 5 saniye sonra otomatik kaldƒ±r
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Sayfa y√ºklendiƒüinde GitHub token kontrol√º
        document.addEventListener('DOMContentLoaded', function() {
            checkGitHubToken();
        });

        // Toggle function for rules engine accordion
        function toggleRulesEngine() {
            const content = document.getElementById('rules-engine-content');
            const icon = document.getElementById('rules-engine-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Save dependency rule from form
        function saveDependencyRuleFromForm() {
            console.log('üíæ Baƒüƒ±mlƒ±lƒ±k kuralƒ± kaydediliyor...');
            
            const id = document.getElementById('dr-id').value || (Date.now().toString(36) + Math.random().toString(36).slice(2,6));
            const ratio = parseInt(document.getElementById('dr-ratio').value, 10);
            
            // Baƒüƒ±mlƒ± olan (dependent) filtreleri
            const dependentNames = parseTerms(document.getElementById('dr-dependent-name-terms').value);
            const dependentNameMode = document.getElementById('dr-dependent-name-mode').value;
            const dependentTags = parseTerms(document.getElementById('dr-dependent-tag-terms').value);
            const dependentTagMode = document.getElementById('dr-dependent-tag-mode').value;
            const dependentCategories = collectSelectedOptions(document.getElementById('dr-dependent-categories'));
            const dependentRoles = collectSelectedOptions(document.getElementById('dr-dependent-roles')).map(normalizeRole);
            
            // Baƒüƒ±mlƒ± olunan (target) filtreleri
            const targetNames = parseTerms(document.getElementById('dr-target-name-terms').value);
            const targetNameMode = document.getElementById('dr-target-name-mode').value;
            const targetTags = parseTerms(document.getElementById('dr-target-tag-terms').value);
            const targetTagMode = document.getElementById('dr-target-tag-mode').value;
            const targetCategories = collectSelectedOptions(document.getElementById('dr-target-categories'));
            const targetRoles = collectSelectedOptions(document.getElementById('dr-target-roles')).map(normalizeRole);
            
            // Validasyon
            if (isNaN(ratio) || ratio < 1 || ratio > 100) { 
                try { showToast('Baƒüƒ±mlƒ±lƒ±k oranƒ±nƒ± 1-100 arasƒ±nda girin', 'warning'); } catch(_){ alert('Baƒüƒ±mlƒ±lƒ±k oranƒ±nƒ± 1-100 arasƒ±nda girin'); }
                return; 
            }
            
            // En az bir filtre gerekli
            const hasDependentFilter = dependentNames.length > 0 || dependentTags.length > 0 || dependentCategories.length > 0 || dependentRoles.length > 0;
            const hasTargetFilter = targetNames.length > 0 || targetTags.length > 0 || targetCategories.length > 0 || targetRoles.length > 0;
            
            if (!hasDependentFilter) {
                try { showToast('Baƒüƒ±mlƒ± olan (tetikleyici) taraf i√ßin en az bir filtre belirtin', 'warning'); } catch(_){ alert('Baƒüƒ±mlƒ± olan (tetikleyici) taraf i√ßin en az bir filtre belirtin'); }
                return;
            }
            
            if (!hasTargetFilter) {
                try { showToast('Baƒüƒ±mlƒ± olunan (hedef) taraf i√ßin en az bir filtre belirtin', 'warning'); } catch(_){ alert('Baƒüƒ±mlƒ± olunan (hedef) taraf i√ßin en az bir filtre belirtin'); }
                return;
            }
            
            const rule = {
                id,
                dependent: {
                    names: dependentNames,
                    nameMode: dependentNameMode,
                    tags: dependentTags,
                    tagMode: dependentTagMode,
                    categories: dependentCategories,
                    roles: dependentRoles
                },
                target: {
                    names: targetNames,
                    nameMode: targetNameMode,
                    tags: targetTags,
                    tagMode: targetTagMode,
                    categories: targetCategories,
                    roles: targetRoles
                },
                ratio: ratio
            };
            
            const idx = dependencyRules.findIndex(r => r.id === id);
            if (idx >= 0) {
                dependencyRules[idx] = rule;
            } else {
                dependencyRules.push(rule);
            }
            
            persistDependencyRules();
            
            if (typeof logToConsole === 'function') {
                const action = (idx >= 0) ? 'g√ºncellendi' : 'eklendi';
                logToConsole(`üîó Baƒüƒ±mlƒ±lƒ±k kuralƒ± ${action}: id=${id}, oran=${ratio}%`);
            }
            
            renderRulesHierarchyList();
            enableRulesDragAndDrop();
            clearDependencyRuleForm();
            try { showToast('Baƒüƒ±mlƒ±lƒ±k kuralƒ± kaydedildi', 'success'); } catch(_){ /* no-op */ }
        }

        // Clear dependency rule form
        function clearDependencyRuleForm() {
            document.getElementById('dependency-rule-form').reset();
            document.getElementById('dr-id').value = '';
            document.getElementById('dr-ratio').value = '40';
            console.log('üßπ Baƒüƒ±mlƒ±lƒ±k kuralƒ± formu temizlendi');
        }

        // üîí Lock Rules Management
        function saveLockRuleFromForm() {
            const formData = {
                id: document.getElementById('lr-id').value,
                name: document.getElementById('lr-name').value,
                category: document.getElementById('lr-category').value,
                role: document.getElementById('lr-role').value,
                period: document.getElementById('lr-period').value,
                scope: document.getElementById('lr-scope').value,
                description: document.getElementById('lr-description').value,
                active: document.getElementById('lr-active').checked
            };

            // Validasyon: en az kategori veya rol se√ßilmeli
            if (!formData.name || !formData.period) {
                try { showToast('L√ºtfen kural adƒ± ve periyot alanlarƒ±nƒ± doldurun!', 'warning'); } catch(_){ alert('L√ºtfen kural adƒ± ve periyot alanlarƒ±nƒ± doldurun!'); }
                return;
            }
            
            if (!formData.category && !formData.role) {
                try { showToast('L√ºtfen en az bir kategori veya rol se√ßin!', 'warning'); } catch(_){ alert('L√ºtfen en az bir kategori veya rol se√ßin!'); }
                return;
            }

            if (formData.id) {
                // G√ºncelleme
                const index = lockRules.findIndex(r => r.id === formData.id);
                if (index !== -1) {
                    lockRules[index] = { ...formData, priority: lockRules[index].priority };
                    console.log('üîÑ Kategori kilidi kuralƒ± g√ºncellendi:', formData.name);
                }
            } else {
                // Yeni ekleme
                formData.id = 'lock_' + Date.now();
                formData.priority = lockRules.length + 1;
                lockRules.push(formData);
                console.log('‚úÖ Yeni kategori kilidi kuralƒ± eklendi:', formData.name);
            }

            persistSystemRulesArchive();
            clearLockRuleForm();
            console.log('üîß Debug - Lock rules dizisi:', lockRules);
            console.log('üîß Debug - Lock rules sayƒ±sƒ±:', lockRules.length);
            renderRulesHierarchyList(); // Listeyi g√ºncelle
            enableRulesDragAndDrop(); // Drag-drop'u yeniden aktifle≈ütir
        }

        function clearLockRuleForm() {
            document.getElementById('lock-rule-form').reset();
            document.getElementById('lr-id').value = '';
            document.getElementById('lr-scope').value = 'meal';
            document.getElementById('lr-active').checked = true;
            updateLockTargetInfo(); // Hedef bilgisini g√ºncelle
            updateLockDescription(); // A√ßƒ±klama metnini g√ºncelle
            console.log('üßπ Kategori kilidi kuralƒ± formu temizlendi');
        }

        // üîÑ Periyot deƒüi≈ütiƒüinde label'larƒ± g√ºncelle
        function updatePeriodLabel() {
            const period = document.getElementById('lr-period').value;
            console.log('üìÖ Periyot deƒüi≈ütirildi:', period);
        }

        // üéØ Lock Rules hedef bilgisini g√ºncelle
        function updateLockTargetInfo() {
            const category = document.getElementById('lr-category').value;
            const role = document.getElementById('lr-role').value;
            const infoElement = document.getElementById('lr-target-info');
            
            if (infoElement) {
                let infoText = '<small><i class="fas fa-info-circle"></i> <strong>Hedef Se√ßimi:</strong><br>';
                
                if (category && role) {
                    infoText += `‚Ä¢ <strong>Se√ßili:</strong> "${category}" kategorisinde "${role}" rol√ºndeki yemekler kilitlenecek<br>`;
                    infoText += `‚Ä¢ Sadece her iki ≈üartƒ± da saƒülayan yemekler etkilenir`;
                } else if (category) {
                    infoText += `‚Ä¢ <strong>Se√ßili:</strong> "${category}" kategorisindeki t√ºm yemekler kilitlenecek<br>`;
                    infoText += `‚Ä¢ Bu kategorideki t√ºm roller dahil edilir`;
                } else if (role) {
                    infoText += `‚Ä¢ <strong>Se√ßili:</strong> "${role}" rol√ºndeki t√ºm yemekler kilitlenecek<br>`;
                    infoText += `‚Ä¢ Bu roldeki t√ºm kategoriler dahil edilir`;
                } else {
                    infoText += '‚Ä¢ Hen√ºz kategori veya rol se√ßilmedi<br>';
                    infoText += '‚Ä¢ En az birini se√ßmeniz gerekiyor';
                }
                
                infoText += '</small>';
                infoElement.innerHTML = infoText;
            }
        }

        // üìù Lock Rules a√ßƒ±klama metnini otomatik olu≈ütur
        function updateLockDescription() {
            const category = document.getElementById('lr-category').value;
            const role = document.getElementById('lr-role').value;
            const period = document.getElementById('lr-period').value;
            const scope = document.getElementById('lr-scope').value;
            const descElement = document.getElementById('lr-description');
            
            if (!descElement) return;
            
            // Hedef belirleme
            let target = '';
            if (category && role) {
                const categoryLabel = {
                    'EKMEKLER': 'Ekmekler',
                    'MEYVELER': 'Meyveler', 
                    'SALATALAR': 'Salatalar',
                    'CORBALAR': '√áorbalar',
                    'KURUYEMISLER': 'Kuruyemi≈üler',
                    'TATLILAR': 'Tatlƒ±lar',
                    'TOSTLAR': 'Tostlar',
                    'ICECEK': 'ƒ∞√ßecekler',
                    'ATISTIRMALIK': 'Atƒ±≈ütƒ±rmalƒ±klar',
                    'DIGER': 'Diƒüer'
                }[category] || category;
                
                const roleLabel = {
                    'mainDish': 'Ana Yemek',
                    'side': 'Yan Yemek', 
                    'drink': 'ƒ∞√ßecek',
                    'soup': '√áorba',
                    'dessert': 'Tatlƒ±',
                    'fruit': 'Meyve',
                    'bread': 'Ekmek',
                    'snack': 'Atƒ±≈ütƒ±rmalƒ±k',
                    'supplement': 'Ek',
                    'vegetable': 'Sebze',
                    'fat': 'Yaƒü'
                }[role] || role;
                
                target = `${categoryLabel} kategorisindeki ${roleLabel} rol√ºndeki yemekler`;
            } else if (category) {
                target = {
                    'EKMEKLER': 'Ekmek kategorisindeki t√ºm yemekler',
                    'MEYVELER': 'Meyve kategorisindeki t√ºm yemekler',
                    'SALATALAR': 'Salata kategorisindeki t√ºm yemekler',
                    'CORBALAR': '√áorba kategorisindeki t√ºm yemekler',
                    'KURUYEMISLER': 'Kuruyemi≈ü kategorisindeki t√ºm yemekler',
                    'TATLILAR': 'Tatlƒ± kategorisindeki t√ºm yemekler',
                    'TOSTLAR': 'Tost kategorisindeki t√ºm yemekler',
                    'ICECEK': 'ƒ∞√ßecek kategorisindeki t√ºm yemekler',
                    'ATISTIRMALIK': 'Atƒ±≈ütƒ±rmalƒ±k kategorisindeki t√ºm yemekler',
                    'DIGER': 'Diƒüer kategorisindeki t√ºm yemekler'
                }[category] || `${category} kategorisindeki t√ºm yemekler`;
            } else if (role) {
                target = {
                    'mainDish': 'Ana yemek rol√ºndeki t√ºm yemekler',
                    'side': 'Yan yemek rol√ºndeki t√ºm yemekler',
                    'drink': 'ƒ∞√ßecek rol√ºndeki t√ºm yemekler',
                    'soup': '√áorba rol√ºndeki t√ºm yemekler',
                    'dessert': 'Tatlƒ± rol√ºndeki t√ºm yemekler',
                    'fruit': 'Meyve rol√ºndeki t√ºm yemekler',
                    'bread': 'Ekmek rol√ºndeki t√ºm yemekler',
                    'snack': 'Atƒ±≈ütƒ±rmalƒ±k rol√ºndeki t√ºm yemekler',
                    'supplement': 'Ek rol√ºndeki t√ºm yemekler',
                    'vegetable': 'Sebze rol√ºndeki t√ºm yemekler',
                    'fat': 'Yaƒü rol√ºndeki t√ºm yemekler'
                }[role] || `${role} rol√ºndeki t√ºm yemekler`;
            }
            
            // Periyot belirleme
            const periodLabel = {
                'daily': 'g√ºnl√ºk',
                'weekly': 'haftalƒ±k',
                'monthly': 'aylƒ±k'
            }[period] || 'belirlenen periyotta';
            
            // Kapsam belirleme
            const scopeInfo = {
                'meal': 'aynƒ± √∂ƒü√ºn t√ºrlerinde',
                'day': 'g√ºn√ºn t√ºm √∂ƒü√ºnlerinde', 
                'week': 'haftanƒ±n t√ºm √∂ƒü√ºnlerinde'
            }[scope] || 'belirlenen kapsamda';
            
            // A√ßƒ±klama metni olu≈ütur
            if (target && period) {
                let description = `Bu kural ${target} i√ßin ${periodLabel} kilitleme uygular.\n\n`;
                
                description += `üéØ HEDEF: ${target}\n`;
                description += `üìÖ PERƒ∞YOT: ${periodLabel.charAt(0).toUpperCase() + periodLabel.slice(1)} (${
                    period === 'daily' ? 'her g√ºn yeniden se√ßilebilir' :
                    period === 'weekly' ? 'hafta boyunca aynƒ± yemek' :
                    period === 'monthly' ? 'ay boyunca aynƒ± yemek' : 'belirlenen s√ºre'
                })\n`;
                description += `üéöÔ∏è KAPSAM: ${scopeInfo.charAt(0).toUpperCase() + scopeInfo.slice(1)}\n\n`;
                
                description += `üìã NASIL √áALI≈ûIR:\n`;
                if (period === 'daily') {
                    description += `‚Ä¢ Her g√ºn ilk sefer ${target.toLowerCase()} se√ßildiƒüinde, o g√ºn ${scopeInfo} sadece o yemek verilebilir\n`;
                    description += `‚Ä¢ Ertesi g√ºn yeniden farklƒ± bir yemek se√ßilebilir`;
                } else if (period === 'weekly') {
                    description += `‚Ä¢ Hafta ba≈üƒ±nda ilk sefer ${target.toLowerCase()} se√ßildiƒüinde, o hafta ${scopeInfo} sadece o yemek verilebilir\n`;
                    description += `‚Ä¢ Yeni haftada farklƒ± bir yemek se√ßilebilir`;
                } else if (period === 'monthly') {
                    description += `‚Ä¢ Ay ba≈üƒ±nda ilk sefer ${target.toLowerCase()} se√ßildiƒüinde, o ay ${scopeInfo} sadece o yemek verilebilir\n`;
                    description += `‚Ä¢ Yeni ayda farklƒ± bir yemek se√ßilebilir`;
                }
                
                descElement.value = description;
            } else {
                descElement.value = 'Bu kuralƒ±n detaylƒ± a√ßƒ±klamasƒ± i√ßin kategori/rol ve periyot se√ßimini tamamlayƒ±n.';
            }
        }

        // üîÑ Frequency rules kapsam deƒüi≈ütiƒüinde etiket g√ºncelle
        function updateFrequencyLabel() {
            const scope = document.querySelector('input[name="fr-scope"]:checked')?.value || 'meal';
            const helpElement = document.getElementById('fr-count-help');
            
            if (helpElement) {
                let helpText = 'Se√ßilen kapsama g√∂re adet ';
                
                switch(scope) {
                    case 'meal':
                        helpText += '(√∂rn: 2 sayƒ±/√∂ƒü√ºn ‚Üí belirlenen √∂ƒü√ºnlerde 2 adet)';
                        break;
                    case 'day':
                        helpText += '(√∂rn: 3 sayƒ±/g√ºn ‚Üí her g√ºn 3 adet)';
                        break;
                    case 'week':
                        helpText += '(√∂rn: 7 sayƒ±/hafta ‚Üí her hafta 7 adet)';
                        break;
                    default:
                        helpText += '(se√ßilen kapsama g√∂re)';
                }
                
                helpElement.textContent = helpText;
                console.log('üîÑ Sƒ±klƒ±k etiketi g√ºncellendi:', scope);
            }
        }

        // üîç Yemek Autocomplete Sistemi
        let currentAutocompleteInput = null;
        let selectedSuggestionIndex = -1;

        function handleFoodAutocomplete(input, event) {
            console.log('üöÄ handleFoodAutocomplete √ßaƒürƒ±ldƒ±', {
                inputId: input.id,
                inputValue: `"${input.value}"`,
                eventType: event ? event.type : 'no event'
            });
            
            currentAutocompleteInput = input;
            let query = input.value;
            const suggestionsContainer = document.getElementById(input.id + '-suggestions');
            
            console.log('üì¶ Suggestions container:', {
                containerId: input.id + '-suggestions',
                containerFound: !!suggestionsContainer,
                containerElement: suggestionsContainer
            });
            
            if (!suggestionsContainer) {
                console.error('‚ùå Suggestions container bulunamadƒ±!', input.id + '-suggestions');
                return;
            }
            
            // Virg√ºlden sonrasƒ±nƒ± al (√ßoklu yemek giri≈üi i√ßin)
            const words = query.split(',');
            const currentSearchTerm = words[words.length - 1];
            
            console.log('üîç Raw arama terimi:', `"${currentSearchTerm}"`);
            console.log('üî¢ Yemek veritabanƒ± durumu:', {
                windowFoodsDataExists: !!window.foodsData,
                windowFoodsDataLength: window.foodsData ? window.foodsData.length : 0,
                windowFoodsDataIsArray: Array.isArray(window.foodsData)
            });
            
            // Minimum 1 karakter olmalƒ± (bo≈üluklar dahil)
            if (!currentSearchTerm || currentSearchTerm.trim().length < 1) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // Yemek veritabanƒ±nda arama yap - TRIM YAPMA! 
            const matches = findFoodMatches(currentSearchTerm);
            console.log('üéØ Bulunan e≈üle≈ümeler:', matches.length);
            displayAutocompleteSuggestions(matches, suggestionsContainer, currentSearchTerm, input);
        }

        function findFoodMatches(query) {
            if (!window.foodsData || !Array.isArray(window.foodsData)) {
                return [];
            }
            
            const queryLower = query.toLowerCase().trim();
            if (!queryLower) return [];
            
            const matches = [];
            
            // √áoklu kelime arama: "mer √ß" -> ["mer", "√ß"] - BO≈û KELƒ∞MELERƒ∞ Fƒ∞LTRELE
            const queryWords = queryLower.split(/\s+/).filter(word => word.length >= 1);
            
            // Eƒüer hi√ß kelime yoksa bo≈ü d√∂nd√ºr
            if (queryWords.length === 0) return [];
            
            window.foodsData.forEach(food => {
                if (!food.name) return;
                
                const foodName = food.name.toLowerCase();
                let totalScore = 0;
                let matchCount = 0;
                
                // Her query kelimesi i√ßin yemek adƒ±nda arama yap
                queryWords.forEach(queryWord => {
                    // Bo≈ü veya √ßok kƒ±sa kelimeleri atla
                    if (!queryWord || queryWord.trim().length === 0) return;
                    
                    const score = getSingleWordScore(foodName, queryWord.trim());
                    if (score > 0) {
                        matchCount++;
                        totalScore += score;
                    }
                });
                
                // T√ºm kelimelerin e≈üle≈ümesi i√ßin bonus
                if (matchCount === queryWords.length && queryWords.length > 1) {
                    totalScore += 50; // Tam e≈üle≈üme bonusu
                }
                
                // En az bir kelime e≈üle≈ümesi varsa listeye ekle
                if (matchCount > 0) {
                    matches.push({
                        food: food,
                        score: totalScore + (matchCount * 10), // E≈üle≈üen kelime sayƒ±sƒ± bonusu
                        highlightedName: highlightMultipleWords(food.name, queryWords.filter(w => w.trim().length > 0)),
                        matchedWords: matchCount
                    });
                }
            });
            
            // Skora g√∂re sƒ±rala ve en iyi 15 sonucu d√∂nd√ºr
            return matches
                .sort((a, b) => {
                    // √ñnce e≈üle≈üen kelime sayƒ±sƒ±na g√∂re sƒ±rala
                    if (b.matchedWords !== a.matchedWords) {
                        return b.matchedWords - a.matchedWords;
                    }
                    // Sonra skora g√∂re sƒ±rala
                    return b.score - a.score;
                })
                .slice(0, 15);
        }

        function getSingleWordScore(foodName, queryWord) {
            // √áok kƒ±sa kelimeler i√ßin √∂zel durum (1-2 karakter)
            if (queryWord.length <= 2) {
                // Tam ba≈ülangƒ±√ß e≈üle≈ümesi
                if (foodName.startsWith(queryWord)) return 90;
                
                // Kelime ba≈ülangƒ±cƒ± e≈üle≈ümesi  
                const words = foodName.split(/\s+/);
                for (let word of words) {
                    if (word.startsWith(queryWord)) return 70;
                }
                
                // ƒ∞√ßerik e≈üle≈ümesi (√ßok kƒ±sa kelimeler i√ßin daha esnek)
                if (foodName.includes(queryWord)) return 50;
                
                return 0;
            }
            
            // Normal uzunlukta kelimeler i√ßin (3+ karakter)
            // Tam ba≈ülangƒ±√ß e≈üle≈ümesi en y√ºksek puan
            if (foodName.startsWith(queryWord)) return 100;
            
            // Kelime ba≈ülangƒ±cƒ± e≈üle≈ümesi
            const words = foodName.split(/\s+/);
            for (let word of words) {
                if (word.startsWith(queryWord)) return 80;
            }
            
            // ƒ∞√ßerik e≈üle≈ümesi
            if (foodName.includes(queryWord)) return 60;
            
            // Kƒ±smi karakter e≈üle≈ümeleri (3+ karakter i√ßin)
            if (queryWord.length >= 3) {
                const queryChars = queryWord.split('');
                let matchCount = 0;
                let lastIndex = -1;
                
                for (let char of queryChars) {
                    const index = foodName.indexOf(char, lastIndex + 1);
                    if (index !== -1) {
                        matchCount++;
                        lastIndex = index;
                    } else {
                        break;
                    }
                }
                
                // %70'den fazla karakter e≈üle≈ümesi varsa d√º≈ü√ºk puan ver
                if (matchCount / queryWord.length > 0.7) return 20;
            }
            
            return 0;
        }

        function highlightMultipleWords(text, queryWords) {
            if (!queryWords.length) return text;
            
            let highlightedText = text;
            queryWords.forEach(word => {
                if (word.length >= 1) { // 1 karakterden uzun t√ºm kelimeler vurgulanƒ±r
                    // √ñzel karakterleri escape et
                    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedWord})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                }
            });
            
            return highlightedText;
        }

        function displayAutocompleteSuggestions(matches, container, query, input) {
            console.log('üé® displayAutocompleteSuggestions √ßaƒürƒ±ldƒ±', {
                matchesCount: matches.length,
                containerId: container.id,
                query: `"${query}"`,
                inputId: input.id
            });
            
            if (!matches.length) {
                console.log('‚ùå Hi√ß e≈üle≈üme bulunamadƒ±, container gizleniyor');
                container.style.display = 'none';
                return;
            }
            
            selectedSuggestionIndex = -1;
            
            const html = matches.map((match, index) => {
                const categoryLabel = getCategoryLabel(match.food.category);
                return `
                    <div class="autocomplete-suggestion" data-index="${index}" onclick="selectAutocompleteSuggestion('${match.food.name}', '${input.id}')">
                        ${match.highlightedName}
                        <span class="autocomplete-category">${categoryLabel}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            container.style.display = 'block';
            console.log('‚úÖ Autocomplete suggestions g√∂steriliyor:', {
                htmlLength: html.length,
                containerDisplayed: container.style.display
            });
        }

        function selectAutocompleteSuggestion(foodName, inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const currentValue = input.value;
            const words = currentValue.split(',');
            
            // Son kelimeyi se√ßilen yemek adƒ± ile deƒüi≈ütir
            words[words.length - 1] = ' ' + foodName;
            
            input.value = words.join(',');
            
            // Suggestions'ƒ± gizle
            const suggestionsContainer = document.getElementById(inputId + '-suggestions');
            if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
            }
            
            // ƒ∞mleci sona koy
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
            
            // Eƒüer food search ise filtrelemeyi tetikle
            if (inputId === 'foodSearch') {
                filterFoods();
            }
        }

        function handleAutocompleteKeydown(event) {
            const suggestionsContainer = document.getElementById(event.target.id + '-suggestions');
            if (!suggestionsContainer || suggestionsContainer.style.display === 'none') {
                return;
            }
            
            const suggestions = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');
            if (!suggestions.length) return;
            
            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    updateSelectedSuggestion(suggestions);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSelectedSuggestion(suggestions);
                    break;
                    
                case 'Enter':
                    if (selectedSuggestionIndex >= 0) {
                        event.preventDefault();
                        suggestions[selectedSuggestionIndex].click();
                    }
                    break;
                    
                case 'Escape':
                    suggestionsContainer.style.display = 'none';
                    selectedSuggestionIndex = -1;
                    break;
            }
        }

        function updateSelectedSuggestion(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('active', index === selectedSuggestionIndex);
            });
        }

        function getCategoryLabel(category) {
            const categoryLabels = {
                'KAHVALTI': 'Kahvaltƒ±',
                'OGLE': '√ñƒüle', 
                'AKSAM': 'Ak≈üam',
                'KURUYEMISLER': 'Kuruyemi≈ü',
                'TATLILAR': 'Tatlƒ±',
                'SALATALAR': 'Salata',
                'CORBALAR': '√áorba',
                'EKMEKLER': 'Ekmek',
                'MEYVELER': 'Meyve',
                'TOSTLAR': 'Tost',
                'KOLLAJEN': 'Kollajen',
                'ATISTIRMALIK': 'Atƒ±≈ütƒ±rmalƒ±k',
                'ICECEK': 'ƒ∞√ßecek',
                'DIGER': 'Diƒüer',
                'APERATIF': 'Aperatif'
            };
            return categoryLabels[category] || category || 'Kategori?';
        }

        // Dƒ±≈ü tƒ±klamada suggestions'larƒ± gizle
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(container => {
                    container.style.display = 'none';
                });
            }
        });

        // üÜï Embedded JSON Data - CORS sorununu √ß√∂zmek i√ßin
        const EMBEDDED_DATA = {
            dietConfig: {
                "version": "1.0",
                "lastUpdated": "2025-08-17T00:00:00.000Z",
                "diets": [
                    {
                        "id": "ketojenik",
                        "name": "Ketojenik Diyet",
                        "description": "√áok d√º≈ü√ºk karbonhidrat, y√ºksek yaƒü diyeti",
                        "macroRatios": { "protein": 25, "carbs": 5, "fat": 70 },
                        "macroCoefficients": { "carbs": 0.3, "protein": 0.8, "fat": 1.2 },
                        "calorieMultipliers": { "sedentary": 0.8, "lightlyActive": 0.9, "moderatelyActive": 1.0, "veryActive": 1.1, "extraActive": 1.2 }
                    },
                    {
                        "id": "lowcarb",
                        "name": "D√º≈ü√ºk Karbonhidrat",
                        "description": "Orta seviye karbonhidrat kƒ±sƒ±tlamasƒ±",
                        "macroRatios": { "protein": 30, "carbs": 20, "fat": 50 },
                        "macroCoefficients": { "carbs": 0.6, "protein": 0.8, "fat": 1.2 },
                        "calorieMultipliers": { "sedentary": 0.8, "lightlyActive": 0.9, "moderatelyActive": 1.0, "veryActive": 1.1, "extraActive": 1.2 }
                    },
                    {
                        "id": "akdeniz",
                        "name": "Akdeniz Diyeti",
                        "description": "Dengeli ve saƒülƒ±klƒ± beslenme",
                        "macroRatios": { "protein": 20, "carbs": 45, "fat": 35 },
                        "macroCoefficients": { "carbs": 1.2, "protein": 0.6, "fat": 0.8 },
                        "calorieMultipliers": { "sedentary": 0.8, "lightlyActive": 0.9, "moderatelyActive": 1.0, "veryActive": 1.1, "extraActive": 1.2 }
                    },
                    {
                        "id": "sporcu",
                        "name": "Sporcu Beslenmesi",
                        "description": "Y√ºksek protein ve karbonhidrat",
                        "macroRatios": { "protein": 25, "carbs": 50, "fat": 25 },
                        "macroCoefficients": { "carbs": 1.5, "protein": 1.2, "fat": 0.6 },
                        "calorieMultipliers": { "sedentary": 1.4, "lightlyActive": 1.6, "moderatelyActive": 1.8, "veryActive": 2.0, "extraActive": 2.2 }
                    },
                    {
                        "id": "gebelik",
                        "name": "Gebelik Beslenmesi",
                        "description": "Anne ve bebek saƒülƒ±ƒüƒ± i√ßin √∂zel beslenme",
                        "macroRatios": { "protein": 20, "carbs": 55, "fat": 25 },
                        "macroCoefficients": { "carbs": 1.8, "protein": 0.9, "fat": 0.7 },
                        "calorieMultipliers": { "sedentary": 0.8, "lightlyActive": 0.9, "moderatelyActive": 1.0, "veryActive": 1.1, "extraActive": 1.2 }
                    }
                ]
            },
            
            planningFactors: {
                "version": "1.0",
                "lastUpdated": "2025-08-17T00:00:00.000Z",
                "factors": [
                    { "id": "allergies", "priority": 1, "name": "Alerjiler", "description": "Kesin dƒ±≈ülanmasƒ± gereken besinler", "type": "exclusion", "scope": "global" },
                    { "id": "liked_foods", "priority": 2, "name": "Sevilen Yemekler", "description": "Hastanƒ±n tercih ettiƒüi besinler", "type": "preference", "scope": "meal" },
                    { "id": "medical_conditions", "priority": 3, "name": "Tƒ±bbi Durumlar", "description": "Saƒülƒ±k durumuna g√∂re kƒ±sƒ±tlamalar", "type": "medical", "scope": "global" },
                    { "id": "macro_targets", "priority": 4, "name": "Hedef Makro Deƒüerleri", "description": "Karbonhidrat, protein, yaƒü hedefleri", "type": "nutritional", "scope": "daily" },
                    { "id": "calorie_distribution", "priority": 5, "name": "Kalori Daƒüƒ±lƒ±mƒ±", "description": "√ñƒü√ºnler arasƒ± kalori payla≈üƒ±mƒ±", "type": "nutritional", "scope": "daily" },
                    { "id": "meal_timing", "priority": 6, "name": "√ñƒü√ºn Zamanlamasƒ±", "description": "Hangi saatte ne yenileceƒüi", "type": "timing", "scope": "daily" },
                    { "id": "food_groups", "priority": 7, "name": "Besin Gruplarƒ±", "description": "Protein, sebze, meyve dengeleri", "type": "nutritional", "scope": "meal" },
                    { "id": "portion_sizes", "priority": 8, "name": "Porsiyon B√ºy√ºkl√ºkleri", "description": "Her besinin miktarƒ±", "type": "quantity", "scope": "meal" },
                    { "id": "cooking_methods", "priority": 9, "name": "Pi≈üirme Y√∂ntemleri", "description": "Ha≈ülama, ƒ±zgara, fƒ±rƒ±n tercihleri", "type": "preparation", "scope": "meal" },
                    { "id": "seasonal_foods", "priority": 10, "name": "Mevsimsel Besinler", "description": "Mevsime uygun √ºr√ºn se√ßimi", "type": "seasonal", "scope": "weekly" },
                    { "id": "budget_constraints", "priority": 11, "name": "B√ºt√ße Kƒ±sƒ±tlamalarƒ±", "description": "Ekonomik duruma uygun se√ßimler", "type": "economic", "scope": "weekly" },
                    { "id": "preparation_time", "priority": 12, "name": "Hazƒ±rlƒ±k S√ºresi", "description": "Kolay ve hƒ±zlƒ± hazƒ±rlanan yemekler", "type": "practical", "scope": "meal" },
                    { "id": "repetition_frequency", "priority": 13, "name": "Tekrar Sƒ±klƒ±ƒüƒ±", "description": "Aynƒ± yemeƒüin hangi sƒ±klƒ±kla tekrarlanacaƒüƒ±", "type": "variety", "scope": "weekly" }
                ]
            },
            
            foods: [
                {
                    "name": "Kur≈üun Ge√ßirmez Kahve",
                    "calories": 90,
                    "protein": 0,
                    "carbs": 0,
                    "fat": 10,
                    "maxQuantity": 1,
                    "minQuantity": 0.5,
                    "step": 0.5,
                    "tags": ["kahve", "keto", "kur≈üun ge√ßirmez"],
                    "role": "drink",
                    "mealType": ["breakfast"],
                    "keto": true,
                    "lowcarb": true,
                    "fillerLunch": false,
                    "fillerDinner": false,
                    "category": "KAHVALTI",
                    "portionFixed": false,
                    "multiplier": 1,
                    "seasonRange": "[1,12]",
                    "isReversedSeason": false,
                    "compatibilityTags": null,
                    "incompatibilityTags": null
                },
                {
                    "name": "1 tatlƒ± ka≈üƒ±ƒüƒ± Tereyaƒüƒ±",
                    "calories": 90,
                    "protein": 0,
                    "carbs": 0,
                    "fat": 10,
                    "maxQuantity": 1,
                    "minQuantity": 1,
                    "step": 1,
                    "tags": ["tereyaƒüƒ±", "keto", "yaƒü"],
                    "role": "fat",
                    "mealType": ["breakfast", "lunch", "dinner"],
                    "keto": true,
                    "lowcarb": true,
                    "fillerLunch": false,
                    "fillerDinner": false,
                    "category": "KAHVALTI",
                    "portionFixed": true,
                    "multiplier": 1,
                    "seasonRange": "[1,12]",
                    "isReversedSeason": false,
                    "compatibilityTags": null,
                    "incompatibilityTags": null
                },
                {
                    "name": "Izgara Tavuk G√∂ƒüs√º",
                    "calories": 165,
                    "protein": 31,
                    "carbs": 0,
                    "fat": 3.6,
                    "maxQuantity": 200,
                    "minQuantity": 100,
                    "step": 25,
                    "tags": ["tavuk", "protein", "ƒ±zgara", "ana yemek"],
                    "role": "mainDish",
                    "mealType": ["lunch", "dinner"],
                    "keto": true,
                    "lowcarb": true,
                    "fillerLunch": true,
                    "fillerDinner": true,
                    "category": "OGLE",
                    "portionFixed": false,
                    "multiplier": 1,
                    "seasonRange": "[1,12]",
                    "isReversedSeason": false,
                    "compatibilityTags": ["salata", "sebze", "pirin√ß"],
                    "incompatibilityTags": ["s√ºt √ºr√ºnleri"]
                },
                {
                    "name": "Karƒ±≈üƒ±k Ye≈üil Salata",
                    "calories": 20,
                    "protein": 2,
                    "carbs": 4,
                    "fat": 0.2,
                    "maxQuantity": 150,
                    "minQuantity": 50,
                    "step": 25,
                    "tags": ["salata", "sebze", "ye≈üillik", "vitamin"],
                    "role": "side",
                    "mealType": ["lunch", "dinner"],
                    "keto": true,
                    "lowcarb": true,
                    "fillerLunch": false,
                    "fillerDinner": false,
                    "category": "OGLE",
                    "portionFixed": false,
                    "multiplier": 1,
                    "seasonRange": "[1,12]",
                    "isReversedSeason": false,
                    "compatibilityTags": ["et", "tavuk", "balƒ±k"],
                    "incompatibilityTags": null
                },
                {
                    "name": "Fƒ±ndƒ±k",
                    "calories": 628,
                    "protein": 15,
                    "carbs": 17,
                    "fat": 61,
                    "maxQuantity": 30,
                    "minQuantity": 10,
                    "step": 5,
                    "tags": ["fƒ±ndƒ±k", "kuruyemi≈ü", "keto", "atƒ±≈ütƒ±rmalƒ±k"],
                    "role": "snack",
                    "mealType": ["snack"],
                    "keto": true,
                    "lowcarb": true,
                    "fillerLunch": false,
                    "fillerDinner": false,
                    "category": "APERATIF",
                    "portionFixed": false,
                    "multiplier": 1,
                    "seasonRange": "[1,12]",
                    "isReversedSeason": false,
                    "compatibilityTags": null,
                    "incompatibilityTags": ["fƒ±ndƒ±k alerjisi"]
                }
            ],
            systemSettings: {
                "version": "2.1.0",
                "lastUpdated": "2025-08-19T18:45:58.733Z",
                "systemDefaults": {
                    "dietType": "ketojenik",
                    "defaultCalorieMethod": "custom",
                    "userSettings": {
                        "age": 38,
                        "weight": 75,
                        "activity": "1.375",
                        "targetCalories": 1026
                    },
                    "macroDistribution": {
                        "breakfast": {
                            "carbs": 25,
                            "protein": 25,
                            "fat": 25
                        },
                        "snack1": {
                            "carbs": 5,
                            "protein": 5,
                            "fat": 5
                        },
                        "lunch": {
                            "carbs": 35,
                            "protein": 35,
                            "fat": 35
                        },
                        "snack2": {
                            "carbs": 5,
                            "protein": 5,
                            "fat": 5
                        },
                        "dinner": {
                            "carbs": 30,
                            "protein": 30,
                            "fat": 30
                        }
                    },
                    "mealSettings": {
                        "breakfast": {
                            "min": 2,
                            "max": 4,
                            "fixed": null
                        },
                        "snack1": {
                            "min": 1,
                            "max": 2,
                            "fixed": null
                        },
                        "lunch": {
                            "min": 3,
                            "max": 5,
                            "fixed": null
                        },
                        "snack2": {
                            "min": 1,
                            "max": 2,
                            "fixed": null
                        },
                        "dinner": {
                            "min": 3,
                            "max": 5,
                            "fixed": null
                        }
                    },
                    "criteriaHierarchy": [
                        {
                            "id": "allergies",
                            "priority": 1,
                            "enabled": true
                        },
                        {
                            "id": "medical_conditions",
                            "priority": 2,
                            "enabled": true
                        },
                        {
                            "id": "calorie_distribution",
                            "priority": 3,
                            "enabled": true
                        },
                        {
                            "id": "macro_targets",
                            "priority": 4,
                            "enabled": true
                        },
                        {
                            "id": "liked_foods",
                            "priority": 5,
                            "enabled": true
                        },
                        {
                            "id": "meal_timing",
                            "priority": 6,
                            "enabled": true
                        },
                        {
                            "id": "food_groups",
                            "priority": 7,
                            "enabled": true
                        },
                        {
                            "id": "portion_sizes",
                            "priority": 8,
                            "enabled": true
                        },
                        {
                            "id": "cooking_methods",
                            "priority": 9,
                            "enabled": true
                        },
                        {
                            "id": "seasonal_foods",
                            "priority": 10,
                            "enabled": true
                        },
                        {
                            "id": "budget_constraints",
                            "priority": 11,
                            "enabled": true
                        },
                        {
                            "id": "preparation_time",
                            "priority": 12,
                            "enabled": true
                        },
                        {
                            "id": "repetition_frequency",
                            "priority": 13,
                            "enabled": true
                        }
                    ],
                    "criteriaSettings": {
                        "allergies": true,
                        "medical_conditions": true,
                        "calorie_distribution": true,
                        "macro_targets": true,
                        "liked_foods": true,
                        "meal_timing": true,
                        "food_groups": true,
                        "portion_sizes": true,
                        "cooking_methods": true,
                        "seasonal_foods": true,
                        "budget_constraints": true,
                        "preparation_time": true,
                        "repetition_frequency": true
                    }
                }
            }
        };

        // Fetch API yerine embedded data kullanma fonksiyonu
        async function getEmbeddedData(path) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (path.includes('diet_config.json')) {
                        resolve(EMBEDDED_DATA.dietConfig);
                    } else if (path.includes('planning_factors.json')) {
                        resolve(EMBEDDED_DATA.planningFactors);
                    } else if (path.includes('yemekler_plain.json')) {
                        resolve(EMBEDDED_DATA.foods);
                    } else if (path.includes('system_settings.json')) {
                        console.log('üìÇ EMBEDDED_DATA.systemSettings kullanƒ±lƒ±yor:', EMBEDDED_DATA.systemSettings);
                        resolve(EMBEDDED_DATA.systemSettings);
                    } else {
                        resolve(null);
                    }
                }, 10); // Async davranƒ±≈üƒ±nƒ± sim√ºle et
            });
        }

        // JSON dosyalarƒ±na yazmak i√ßin basit yardƒ±mcƒ±lar (yerel JSON sunucusu √ºzerinden)
        const JSON_SERVER_BASE = window.JSON_SERVER_BASE || 'http://localhost:3000';
        let JSON_SERVER_ENABLED = false; // Sunucu varsa true yapƒ±lƒ±r

        // Sunucu var mƒ± hƒ±zlƒ±ca yokla (zaman a≈üƒ±mƒ± ile)
        async function detectJsonServer() {
            const ctrl = new AbortController();
            const timer = setTimeout(() => ctrl.abort(), 400);
            try {
                const resp = await fetch(`${JSON_SERVER_BASE}/data/patients_list.json`, { method: 'GET', cache: 'no-store', signal: ctrl.signal });
                JSON_SERVER_ENABLED = !!resp && resp.ok;
            } catch (_) {
                JSON_SERVER_ENABLED = false;
            } finally {
                clearTimeout(timer);
                if (typeof logToConsole === 'function') {
                    logToConsole(JSON_SERVER_ENABLED
                        ? `üîå JSON sunucusu algƒ±landƒ±: ${JSON_SERVER_BASE}`
                        : '‚ö†Ô∏è JSON sunucusu kapalƒ±; deƒüi≈üiklikler tarayƒ±cƒ±da (localStorage) saklanacak');
                }
            }
        }

        // Sayfa y√ºklendiƒüinde bir kez kontrol et
        (function initJsonServerProbe(){
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', detectJsonServer, { once: true });
            } else {
                detectJsonServer();
            }
        })();

        async function updateJsonFile(jsonPath, mergeFn) {
            // Sunucu yoksa hi√ß deneme; sessizce ba≈üarƒ±sƒ±z bildir
            if (!JSON_SERVER_ENABLED) return false;
            try {
                const url = `${JSON_SERVER_BASE}${jsonPath.startsWith('/') ? '' : '/'}${jsonPath}`;
                let current = {};
                try {
                    const resp = await fetch(url, { method: 'GET' });
                    if (resp.ok) current = await resp.json();
                } catch (_) { /* Sunucu kapalƒ± olabilir; sessiz ge√ß */ }

                const updated = await mergeFn(current || {});
                const body = JSON.stringify(updated || current || {}, null, 2);

                const saveResp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body
                });
                if (!saveResp.ok) throw new Error(`POST ${jsonPath} ${saveResp.status}`);
                return true;
            } catch (e) {
                // Aƒü hatalarƒ±nƒ± kƒ±s; Network error flood engeli
                if (typeof console !== 'undefined' && console.debug) {
                    console.debug('JSON dosya g√ºncelleme atlandƒ±/ba≈üarƒ±sƒ±z:', jsonPath, e?.message || e);
                }
                return false;
            }
        }

        function downloadJsonFallback(filename, dataObj) {
            try {
                const blob = new Blob([JSON.stringify(dataObj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);
            } catch (_) { /* no-op */ }
        }

        // Sistem ayarlarƒ±nƒ± JSON'a kaydet (localStorage'ƒ±n yerine)
        async function saveSystemSettings() {
            console.log('üîÑ SISTEM AYARLARI KAYDEDILIYOR...');
            if (JSON_SERVER_ENABLED) {
                try {
                    await updateJsonFile('/data/system_settings.json', () => systemSettings);
                    console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Sistem ayarlarƒ± /data/system_settings.json dosyasƒ±na kaydedildi');
                    console.log('üìä Kaydedilen sistem ayarlarƒ± boyutu:', JSON.stringify(systemSettings).length, 'karakter');
                } catch (error) {
                    console.warn('‚ö†Ô∏è JSON kaydetme hatasƒ±, localStorage kullanƒ±lƒ±yor:', error);
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    console.log('üì¶ Fallback: localStorage\'a kaydedildi');
                }
            } else {
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                console.log('üì¶ JSON Server kapalƒ± - localStorage\'a kaydedildi');
            }
        }

        // Kullanƒ±cƒ± verilerini JSON'a kaydet (localStorage'ƒ±n yerine) 
        async function saveUsersData() {
            console.log('üîÑ KULLANICI VERƒ∞LERƒ∞ KAYDEDILIYOR...');
            if (JSON_SERVER_ENABLED) {
                try {
                    // JSON formatƒ±nƒ± hazƒ±rla
                    const dataToSave = {
                        patients: usersData.patients || [],
                        lastPatientId: usersData.patients?.length || 0,
                        metadata: {
                            lastUpdated: new Date().toISOString(),
                            version: "1.0"
                        }
                    };
                    
                    const response = await fetch(`${JSON_SERVER_BASE}/data/patients_list.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave, null, 2)
                    });
                    
                    if (response.ok) {
                        console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Kullanƒ±cƒ± verileri /data/patients_list.json dosyasƒ±na kaydedildi');
                        console.log('üë• Kaydedilen hasta sayƒ±sƒ±:', usersData.patients?.length || 0);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è JSON kaydetme hatasƒ±, localStorage kullanƒ±lƒ±yor:', error);
                    localStorage.setItem('usersData', JSON.stringify(usersData));
                    console.log('üì¶ Fallback: localStorage\'a kaydedildi');
                }
            } else {
                localStorage.setItem('usersData', JSON.stringify(usersData));
                console.log('üì¶ JSON Server kapalƒ± - localStorage\'a kaydedildi');
            }
        }

        // JSON durum testi
        async function debugJsonStatus() {
            console.log('üîç JSON DURUM TESƒ∞ BA≈ûLADI...');
            console.log('=' .repeat(50));
            
            // JSON Server durumu
            console.log('üåê JSON_SERVER_ENABLED:', JSON_SERVER_ENABLED);
            console.log('üîó JSON_SERVER_BASE:', JSON_SERVER_BASE);
            
            // Mevcut veriler
            console.log('üë• Mevcut kullanƒ±cƒ± sayƒ±sƒ± (bellekte):', usersData.patients?.length || 0);
            console.log('‚öôÔ∏è Mevcut sistem ayarlarƒ± boyutu (bellekte):', Object.keys(systemSettings).length);
            
            // JSON dosyalarƒ±nƒ± test et
            try {
                console.log('üì° Fiziksel JSON dosyalarƒ±nƒ± test ediliyor...');
                
                // Hasta listesi testi
                const patientsResponse = await fetch(`${JSON_SERVER_BASE}/data/patients_list.json`);
                if (patientsResponse.ok) {
                    const patientsData = await patientsResponse.json();
                    console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] patients_list.json - Hasta sayƒ±sƒ±:', patientsData.patients?.length || 0);
                    if (patientsData.patients) {
                        patientsData.patients.forEach((p, i) => {
                            console.log(`üë§ ${i+1}: ${p.firstName} ${p.lastName} (${p.id})`);
                        });
                    }
                } else {
                    console.log('‚ùå patients_list.json y√ºklenemedi (HTTP', patientsResponse.status, ')');
                }
                
                // Sistem ayarlarƒ± testi
                const settingsResponse = await fetch(`${JSON_SERVER_BASE}/data/system_settings.json`);
                if (settingsResponse.ok) {
                    const settingsData = await settingsResponse.json();
                    console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] system_settings.json boyutu:', JSON.stringify(settingsData).length, 'karakter');
                    console.log('üìä Hafta ≈üablonu sayƒ±sƒ±:', Object.keys(settingsData.weeklyProfiles || {}).length);
                } else {
                    console.log('‚ùå system_settings.json y√ºklenemedi (HTTP', settingsResponse.status, ')');
                }
                
            } catch (error) {
                console.log('‚ùå JSON test hatasƒ±:', error.message);
            }
            
            console.log('=' .repeat(50));
            console.log('üîç JSON DURUM TESƒ∞ TAMAMLANDI');
        }

        // JSON'dan zorla yeniden y√ºkle
        async function forceReloadFromJson() {
            console.log('üîÑ JSON DOSYALARINDAN ZORLA YENƒ∞DEN Y√úKLEME...');
            console.log('=' .repeat(50));
            
            // Bellekteki verileri temizle
            usersData = {patients: [], doctors: [], dietitians: []};
            systemSettings = {};
            
            // JSON'dan yeniden y√ºkle
            await loadSystemData();
            
            // UI'ƒ± g√ºncelle
            updateDashboardStats();
            loadUsersLists();
            
            console.log('‚úÖ JSON\'dan yeniden y√ºkleme tamamlandƒ±');
            console.log('üë• Yeni hasta sayƒ±sƒ±:', usersData.patients?.length || 0);
            console.log('=' .repeat(50));
        }

        // Basit toast bildirimi (alert yerine)
        function showToast(message, type = 'info') {
            try {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.position = 'fixed';
                    container.style.top = '16px';
                    container.style.right = '16px';
                    container.style.zIndex = '2000';
                    document.body.appendChild(container);
                }
                const box = document.createElement('div');
                box.textContent = message;
                box.style.marginBottom = '8px';
                box.style.padding = '10px 12px';
                box.style.borderRadius = '6px';
                box.style.color = '#fff';
                box.style.boxShadow = '0 2px 10px rgba(0,0,0,.15)';
                const bg = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8';
                box.style.background = bg;
                container.appendChild(box);
                setTimeout(() => { try { box.remove(); } catch(_){} }, 3500);
            } catch (_) { /* no-op */ }
        }

        // Basit Bootstrap onay modali yardimcisi (confirm yerine)
        function showConfirm({ title = 'Onay', message = 'Emin misiniz?', confirmText = 'Evet', cancelText = 'Vazge√ß', variant = 'danger' } = {}) {
            return new Promise((resolve) => {
                try {
                    const modalEl = document.getElementById('confirmModal');
                    if (!modalEl) {
                        const ok = window.confirm(message);
                        resolve(!!ok);
                        return;
                    }
                    const titleEl = modalEl.querySelector('#confirmModalTitle');
                    const msgEl = modalEl.querySelector('#confirmModalMessage');
                    const okBtn = modalEl.querySelector('#confirmModalConfirmBtn');
                    const cancelBtn = modalEl.querySelector('#confirmModalCancelBtn');
                    if (titleEl) titleEl.textContent = title;
                    if (msgEl) msgEl.textContent = message;
                    if (okBtn) {
                        okBtn.textContent = confirmText;
                        okBtn.className = 'btn btn-' + (variant || 'danger');
                    }
                    if (cancelBtn) cancelBtn.textContent = cancelText;
                    const bs = window.bootstrap && window.bootstrap.Modal ? window.bootstrap : null;
                    const modal = bs ? new bs.Modal(modalEl, { backdrop: 'static', keyboard: true }) : null;
                    const cleanup = () => {
                        okBtn?.removeEventListener('click', onOk);
                        cancelBtn?.removeEventListener('click', onCancel);
                        modalEl?.removeEventListener('hidden.bs.modal', onHidden);
                    };
                    const onOk = () => { cleanup(); modal && modal.hide(); resolve(true); };
                    const onCancel = () => { cleanup(); modal && modal.hide(); resolve(false); };
                    const onHidden = () => { cleanup(); resolve(false); };
                    okBtn?.addEventListener('click', onOk);
                    cancelBtn?.addEventListener('click', onCancel);
                    modalEl?.addEventListener('hidden.bs.modal', onHidden);
                    modal ? modal.show() : resolve(!!window.confirm(message));
                } catch (e) {
                    const ok = window.confirm(message);
                    resolve(!!ok);
                }
            });
        }

        // Global Variables
        let systemSettings = {};
        let dietConfig = {};
        let rulesData = {};
        let templatesData = {};
        let usersData = {};
        let currentPatient = null;
        let currentWeek = null;
        let mealsData = [];
        let dietsData = [];
        
        // Varsayƒ±lan diyet verileri
        const defaultDiets = [
            {
                id: 'keto',
                name: 'Ketojenik Diyet',
                code: 'keto',
                icon: 'ü•ë',
                description: 'Y√ºksek yaƒü, d√º≈ü√ºk karbonhidrat diyeti',
                status: 'active',
                macros: { carbs: 5, protein: 20, fat: 75 },
                criteria: {
                    caloriesMin: 1200,
                    caloriesMax: 2000,
                    water: 3.0,
                    mealGap: 4,
                    weightLoss: 0.7
                },
                restrictions: ['sugar', 'bread'],
                notes: 'Ketoz durumu takip edilmeli'
            },
            {
                id: 'lowcarb',
                name: 'D√º≈ü√ºk Karbonhidrat',
                code: 'lowcarb',
                icon: 'ü•©',
                description: 'Orta karbonhidrat, y√ºksek protein diyeti',
                status: 'active',
                macros: { carbs: 20, protein: 30, fat: 50 },
                criteria: {
                    caloriesMin: 1300,
                    caloriesMax: 2200,
                    water: 2.5,
                    mealGap: 3,
                    weightLoss: 0.5
                },
                restrictions: ['sugar'],
                notes: 'Dengeli beslenme odaklƒ±'
            },
            {
                id: 'mediterranean',
                name: 'Akdeniz Diyeti',
                code: 'mediterranean',
                icon: 'üêü',
                description: 'Balƒ±k, zeytinyaƒüƒ± ve sebze aƒüƒ±rlƒ±klƒ± diyet',
                status: 'active',
                macros: { carbs: 45, protein: 20, fat: 35 },
                criteria: {
                    caloriesMin: 1400,
                    caloriesMax: 2300,
                    water: 2.0,
                    mealGap: 3,
                    weightLoss: 0.3
                },
                restrictions: [],
                notes: 'Kalp saƒülƒ±ƒüƒ± i√ßin idealdir'
            }
        ];
        
        // Sayfa y√ºkleme
        document.addEventListener('DOMContentLoaded', async function() {
            logToConsole('üîÑ Sistem y√ºkleniyor...');
            
            // JSON server durumunu kontrol et
            await detectJsonServer();
            
            // Eski localStorage verilerini JSON'a migrate et
            migrateOldDataToJSON();
            
            // JSON verilerini y√ºkle
            await loadSystemData();
            
            // Sistem ayarlarƒ±nƒ± y√ºkle
            loadSavedSystemSettings();
            // √ñzel form√ºl panelini ba≈ülat
            if (typeof initCustomFormulaPanel === 'function') {
                initCustomFormulaPanel();
            }
            
            // Dashboard istatistiklerini g√ºncelle
            updateDashboardStats();
            
            // Kullanƒ±cƒ± listelerini de ba≈ülangƒ±√ßta hazƒ±rla
            loadUsersLists();
            
            // Sidebar men√º olaylarƒ±
            setupSidebarEvents();
            
            // Modal accessibility d√ºzeltmeleri
            setupModalAccessibility();
            
            // Sortable initialization
            initializeSortables();
            
            // UI etiketlerini ba≈ülangƒ±√ßta g√ºncelle
            updateFrequencyLabel();
            updateLockTargetInfo();
            updateLockDescription();
            
            // Initialize interaction history
            setTimeout(() => {
                if (typeof refreshInteractionHistory === 'function') {
                    refreshInteractionHistory();
                }
            }, 500);
            
            // Sabit yemekleri y√ºkle
            await loadFixedMealsFromStorage();
            
            // Sabit yemek butonlarƒ±nƒ± ba≈ülat
            ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'].forEach(mealType => {
                updateFixedMealButton(mealType);
            });
            
            // Otomatik hasta y√ºkleme (≈üimdilik devre dƒ±≈üƒ± - sistem ayarlarƒ±na odaklanƒ±yoruz)
            try {
                /*
                // Eƒüer daha √∂nce bir hasta se√ßilmi≈üse veya ilk hasta varsa
                const lastPatientId = localStorage.getItem('currentPatientId') || window.currentPatientId;
                if (lastPatientId && usersData.patients.some(p => p.id === lastPatientId)) {
                    console.log('üîÑ Otomatik hasta y√ºkleniyor:', lastPatientId);
                    await selectPatient(lastPatientId);
                } else if (usersData.patients && usersData.patients.length > 0) {
                    // ƒ∞lk hastayƒ± otomatik se√ß
                    console.log('üîÑ ƒ∞lk hasta otomatik se√ßiliyor:', usersData.patients[0].id);
                    await selectPatient(usersData.patients[0].id);
                }
                */
                console.log('‚ÑπÔ∏è Otomatik hasta y√ºkleme devre dƒ±≈üƒ± - sistem ayarlarƒ±na odaklanƒ±lƒ±yor');
            } catch (e) {
                console.warn('Otomatik hasta y√ºklemesi ba≈üarƒ±sƒ±z:', e);
            }
            
            logToConsole('‚úÖ Sistem ba≈üarƒ±yla y√ºklendi');
        });
        
        // Sortable √∂zelliklerini initialize et
        function initializeSortables() {
            console.log('üîß Sortable √∂zellikleri initialize ediliyor...');
            
            // Rules hierarchy i√ßin sortable
            const rulesContainer = document.getElementById('rules-hierarchy-container');
            if (rulesContainer && typeof Sortable !== 'undefined') {
                console.log('üîß Rules container i√ßin sortable olu≈üturuluyor');
                new Sortable(rulesContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onStart: function (evt) {
                        console.log('üî∏ Rules drag ba≈üladƒ±:', evt.oldIndex);
                    },
                    onEnd: function (evt) {
                        console.log('üî∏ Rules drag bitti:', evt.oldIndex, '‚Üí', evt.newIndex);
                        if (evt.oldIndex !== evt.newIndex) {
                            console.log('üî∏ Rules sƒ±rasƒ± g√ºncellendi');
                            // Rules sƒ±rasƒ± deƒüi≈üti - burada kaydetme i≈ülemi yapƒ±labilir
                        }
                    }
                });
            } else {
                console.log('‚ùå Rules container bulunamadƒ± veya Sortable.js y√ºklenmemi≈ü');
            }
            
            // Default criteria hierarchy i√ßin sortable
            const criteriaContainer = document.getElementById('default-criteria-hierarchy');
            if (criteriaContainer && typeof Sortable !== 'undefined') {
                console.log('üîß Criteria container i√ßin sortable olu≈üturuluyor');
                
                // Eski sortable instance varsa destroy et
                if (criteriaContainer.sortableInstance) {
                    criteriaContainer.sortableInstance.destroy();
                }
                
                criteriaContainer.sortableInstance = new Sortable(criteriaContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    handle: '.criteria-handle', // Sadece handle alanƒ±ndan s√ºr√ºklenebilir
                    onStart: function (evt) {
                        console.log('üî∏ Criteria drag ba≈üladƒ±:', evt.oldIndex);
                        evt.item.style.opacity = '0.5';
                    },
                    onEnd: function (evt) {
                        console.log('üî∏ Criteria drag bitti:', evt.oldIndex, '‚Üí', evt.newIndex);
                        evt.item.style.opacity = '1';
                        
                        if (evt.oldIndex !== evt.newIndex) {
                            console.log('üî∏ Criteria sƒ±rasƒ± g√ºncellendi');
                            // Priority'leri g√ºncelle
                            refreshCriteriaPriorities();
                            // Sƒ±rayƒ± kaydet
                            saveCriteriaOrder();
                            // Aktif hafta i√ßin de sƒ±rayƒ± kaydet
                            try { persistWeekCriteriaOrderFromDOM(); } catch(_) {}
                        }
                    }
                });
            } else {
                console.log('‚ùå Criteria container bulunamadƒ± veya Sortable.js y√ºklenmemi≈ü');
            }
            
            console.log('‚úÖ Sortable √∂zellikler initialize edildi');
        }
        
        // Criteria sƒ±rasƒ±nƒ± kaydet
        function saveCriteriaOrder() {
            const container = document.getElementById('default-criteria-hierarchy');
            const criteriaItems = container.querySelectorAll('.criteria-item');
            const newOrder = [];
            
            criteriaItems.forEach((item, index) => {
                const criteriaId = item.dataset.criteriaId;
                if (criteriaId) {
                    newOrder.push(criteriaId);
                }
            });
            
            // localStorage'a kaydet
            localStorage.setItem('defaultCriteriaOrder', JSON.stringify(newOrder));
            console.log('üìä Criteria sƒ±rasƒ± kaydedildi:', newOrder);
        }
        
        // Modal eri≈üilebilirlik d√ºzeltmeleri
        function setupModalAccessibility() {
            const modalIds = [
                'foodEditModal',
                'patientManagementModal', 
                'editPatientModal',
                'dietModal',
                'dietEditModal'
            ];

            function setSiblingsInert(activeModal, enable) {
                // Body altƒ±ndaki t√ºm karde≈üleri inert yap; aktif modal ve backdrop hari√ß
                Array.from(document.body.children).forEach(el => {
                    if (el === activeModal || el.classList.contains('modal-backdrop')) return;
                    if (enable) {
                        el.setAttribute('inert', '');
                    } else {
                        el.removeAttribute('inert');
                    }
                });
            }

            const previousFocusByModal = new Map();

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (!modal) return;

                // Temel ARIA
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-modal', 'true');
                modal.removeAttribute('aria-hidden');
                if (!modal.hasAttribute('tabindex')) {
                    modal.setAttribute('tabindex', '-1');
                }

                modal.addEventListener('show.bs.modal', function () {
                    this.removeAttribute('aria-hidden');
                    // Odak modal i√ßine ta≈üƒ±nmadan √∂nce, mevcut odaƒüƒ± kaydet
                    const prev = document.activeElement;
                    if (prev && !this.contains(prev)) {
                        previousFocusByModal.set(this, prev);
                    }
                    logToConsole('Modal a√ßƒ±lƒ±yor: ' + modalId);
                });

                modal.addEventListener('shown.bs.modal', function () {
                    this.removeAttribute('aria-hidden');
                    // ƒ∞lk odaklanabilir elemana odakla
                    const focusable = this.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (focusable) { try { focusable.focus(); } catch (_) {} } else { try { this.focus(); } catch (_) {} }
                    // Odaƒüƒ± modal i√ßine aldƒ±ktan sonra arka planƒ± inert yap
                    setSiblingsInert(this, true);
                    logToConsole('Modal a√ßƒ±ldƒ±: ' + modalId);
                });

                modal.addEventListener('hide.bs.modal', function () {
                    // Kapanƒ±rken modaldaki odaƒüƒ± kaldƒ±r
                    if (this.contains(document.activeElement)) {
                        try { document.activeElement.blur(); } catch (_) {}
                    }
                });

                modal.addEventListener('hidden.bs.modal', function () {
                    // Modal kapandƒ±ktan sonra: modal √ºzerinde aria-hidden kullanma; arka planƒ± geri a√ß
                    this.removeAttribute('aria-hidden');
                    setSiblingsInert(this, false);
                    // √ñnceki odaƒüƒ± geri y√ºkle
                    const prev = previousFocusByModal.get(this);
                    if (prev && document.contains(prev)) {
                        try { prev.focus(); } catch (_) {}
                    }
                    previousFocusByModal.delete(this);
                    logToConsole('Modal kapandƒ±: ' + modalId);
                });

                // Bootstrap'in dinamik olarak aria-hidden eklemesini izle ve g√∂r√ºn√ºrken kaldƒ±r
                const observer = new MutationObserver(() => {
                    if (modal.style.display === 'block' && modal.getAttribute('aria-hidden') === 'true') {
                        modal.removeAttribute('aria-hidden');
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style', 'aria-hidden'] });
            });

            logToConsole('‚úÖ Modal eri≈üilebilirlik sistemi kuruldu');
        }
        
        // Sistem verilerini y√ºkle (JSON tabanlƒ±)
        async function loadSystemData() {
            try {
                console.log('ÔøΩ Sistem verileri JSON dosyalarƒ±ndan y√ºkleniyor...');
                
                // UsersData'yƒ± JSON dosyasƒ±ndan y√ºkle
                try {
                    if (JSON_SERVER_ENABLED) {
                        const response = await fetch(`${JSON_SERVER_BASE}/data/patients_list.json`);
                        if (response.ok) {
                            const jsonData = await response.json();
                            if (jsonData.patients && Array.isArray(jsonData.patients)) {
                                usersData.patients = jsonData.patients;
                                console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Kullanƒ±cƒ± verileri JSON server\'dan y√ºklendi:', jsonData.patients.length, 'hasta');
                                jsonData.patients.forEach((p, i) => {
                                    console.log(`üë§ ${i+1}: ${p.firstName} ${p.lastName} (${p.id})`);
                                });
                            }
                        } else {
                            console.log('‚ùå JSON server\'dan veri y√ºklenemedi (HTTP', response.status, ')');
                        }
                    } else {
                        console.log('‚ö†Ô∏è JSON Server kapalƒ±, localStorage\'dan y√ºkleniyor');
                    }
                } catch (error) {
                    console.warn('JSON y√ºkleme hatasƒ±:', error);
                }
                
                // Fallback olarak localStorage'dan y√ºkle
                if (!usersData.patients || usersData.patients.length === 0) {
                    const localUsersData = JSON.parse(localStorage.getItem('usersData') || 'null');
                    if (localUsersData && localUsersData.patients) {
                        usersData.patients = localUsersData.patients;
                        console.log('üì¶ Kullanƒ±cƒ± verileri localStorage\'dan y√ºklendi:', usersData.patients.length, 'hasta');
                    } else {
                        // Default data kullan
                        usersData.patients = getDefaultUsersData().patients;
                        console.log('üéØ Varsayƒ±lan kullanƒ±cƒ± verileri kullanƒ±ldƒ±');
                    }
                }
                
                // System settings'i JSON dosyasƒ±ndan y√ºkle
                try {
                    if (JSON_SERVER_ENABLED) {
                        const response = await fetch(`${JSON_SERVER_BASE}/data/system_settings.json`);
                        if (response.ok) {
                            const jsonData = await response.json();
                            if (jsonData) {
                                systemSettings = jsonData;
                                console.log('‚úÖ Sistem ayarlarƒ± JSON dosyasƒ±ndan y√ºklendi');
                            }
                        } else {
                            console.log('‚ö†Ô∏è Sistem ayarlarƒ± JSON dosyasƒ± bulunamadƒ±, localStorage kullanƒ±lƒ±yor');
                        }
                    }
                } catch (error) {
                    console.warn('Sistem ayarlarƒ± JSON y√ºkleme hatasƒ±:', error);
                }
                
                // Fallback olarak localStorage'dan sistem ayarlarƒ±nƒ± y√ºkle
                if (!systemSettings || Object.keys(systemSettings).length === 0) {
                    systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || localStorage.getItem('systemSettings') || '{}');
                    console.log('üì¶ Sistem ayarlarƒ± localStorage\'dan y√ºklendi');
                }
                
                // Diƒüer veriler (embedded data kullan)
                dietConfig = EMBEDDED_DATA.dietConfig; // Embedded data kullan
                rulesData = EMBEDDED_DATA.planningFactors; // Embedded data kullan
                templatesData = JSON.parse(localStorage.getItem('templatesData') || '{}');
                
                console.log('‚úÖ Sistem verileri y√ºklendi');
            } catch (error) {
                console.error('Sistem verileri y√ºkleme hatasƒ±:', error);
            }
        }
        
        // Varsayƒ±lan kullanƒ±cƒ± verilerini getir
        function getDefaultUsersData() {
            return {
                "patients": [
                    {
                        "id": "patient_001",
                        "firstName": "Ahmet",
                        "lastName": "Yƒ±lmaz",
                        "age": 35,
                        "gender": "erkek",
                        "phone": "0532 123 4567",
                        "height": 175,
                        "weight": 80,
                        "activityLevel": 3,
                        "dietType": "lowcarb",
                        "status": "aktif",
                        "notes": "Diyabet hastasƒ±",
                        "createdAt": "2025-08-17T10:00:00Z",
                        "updatedAt": "2025-08-17T10:00:00Z"
                    },
                    {
                        "id": "patient_002", 
                        "firstName": "Fatma",
                        "lastName": "Demir",
                        "age": 28,
                        "gender": "kadƒ±n",
                        "phone": "0533 987 6543",
                        "height": 165,
                            "weight": 65,
                            "activityLevel": 4,
                            "dietType": "ketojenik",
                            "status": "aktif",
                            "notes": "Sporcu beslenmesi",
                            "createdAt": "2025-08-17T11:00:00Z",
                            "updatedAt": "2025-08-17T11:00:00Z"
                        },
                        {
                            "id": "patient_003",
                            "firstName": "Mehmet",
                            "lastName": "Kaya",
                            "age": 42,
                            "gender": "erkek",
                            "phone": "0534 555 1234",
                            "height": 180,
                            "weight": 90,
                            "activityLevel": 2,
                            "dietType": "akdeniz",
                            "status": "aktif",
                            "notes": "Hipertansiyon",
                            "createdAt": "2025-08-17T12:00:00Z",
                            "updatedAt": "2025-08-17T12:00:00Z"
                        }
                    ],
                    "doctors": [
                        {
                            "id": "doctor_001",
                            "firstName": "Dr. Ali",
                            "lastName": "√ñzkan",
                            "specialization": "Endokrinoloji",
                            "phone": "0212 123 4567",
                            "email": "ali.ozkan@hastane.com",
                            "status": "aktif"
                        }
                    ],
                    "dietitians": [
                        {
                            "id": "dietitian_001",
                            "firstName": "Ay≈üe",
                            "lastName": "G√ºne≈ü",
                            "specialization": "Spor Beslenmesi",
                            "phone": "0212 987 6543",
                            "email": "ayse.gunes@klinik.com",
                            "status": "aktif"
                        }
                    ],
                    "counters": {
                        "lastPatientId": 3,
                        "lastDoctorId": 1,
                        "lastDietitianId": 1
                    }
                };
            }
        
        // Varsayƒ±lan kullanƒ±cƒ± verilerini getir
        function getDefaultUsersData() {
            return {
                "patients": [
                    {
                        "id": "patient_001",
                        "firstName": "Ahmet",
                        "lastName": "Yƒ±lmaz",
                        "age": 35,
                        "gender": "erkek",
                        "phone": "0532 123 4567",
                        "height": 175,
                        "weight": 80,
                        "activityLevel": 3,
                        "dietType": "lowcarb",
                        "status": "aktif",
                        "notes": "Diyabet hastasƒ±",
                        "createdAt": "2025-08-17T10:00:00Z",
                        "updatedAt": "2025-08-17T10:00:00Z"
                    },
                    {
                        "id": "patient_002", 
                        "firstName": "Fatma",
                        "lastName": "Demir",
                        "age": 28,
                        "gender": "kadƒ±n",
                        "phone": "0533 987 6543",
                        "height": 165,
                        "weight": 65,
                        "activityLevel": 4,
                        "dietType": "ketojenik",
                        "status": "aktif",
                        "notes": "Sporcu beslenmesi",
                        "createdAt": "2025-08-17T11:00:00Z",
                        "updatedAt": "2025-08-17T11:00:00Z"
                    },
                    {
                        "id": "patient_003",
                        "firstName": "Mehmet",
                        "lastName": "Kaya",
                        "age": 42,
                        "gender": "erkek",
                        "phone": "0534 555 1234",
                        "height": 180,
                        "weight": 90,
                        "activityLevel": 2,
                        "dietType": "akdeniz",
                        "status": "aktif",
                        "notes": "Hipertansiyon",
                        "createdAt": "2025-08-17T12:00:00Z",
                        "updatedAt": "2025-08-17T12:00:00Z"
                    }
                ],
                "doctors": [
                    {
                        "id": "doctor_001",
                        "firstName": "Dr. Ali",
                        "lastName": "√ñzkan",
                        "specialization": "Endokrinoloji",
                        "phone": "0212 123 4567",
                        "email": "ali.ozkan@hastane.com",
                        "status": "aktif"
                    }
                ],
                "dietitians": [
                    {
                        "id": "dietitian_001",
                        "firstName": "Ay≈üe",
                        "lastName": "G√ºne≈ü",
                        "specialization": "Spor Beslenmesi",
                        "phone": "0212 987 6543",
                        "email": "ayse.gunes@klinik.com",
                        "status": "aktif"
                    }
                ],
                "counters": {
                    "lastPatientId": 3,
                    "lastDoctorId": 1,
                    "lastDietitianId": 1
                }
            };
        }
                logToConsole(`üìä Y√ºklenen doktor sayƒ±sƒ±: ${usersData?.doctors?.length || 0}`);
                logToConsole(`üìä Y√ºklenen diyetisyen sayƒ±sƒ±: ${usersData?.dietitians?.length || 0}`);
                
        // Test fonksiyonu - Kullanƒ±cƒ±lar tablosunu zorla y√ºkle
        function forceLoadUsersTable() {
            logToConsole('üîß Zorla kullanƒ±cƒ± tablosu y√ºkleme...');
            
            const tbody = document.getElementById('patients-table-body');
            if (!tbody) {
                logToConsole('‚ùå patients-table-body elementi bulunamadƒ±!');
                return;
            }
            
            if (!usersData || !usersData.patients || usersData.patients.length === 0) {
                logToConsole('‚ùå Hasta verisi bulunamadƒ±!');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">‚ùå Hasta verisi y√ºklenemedi</td></tr>';
                return;
            }
            
            let html = '';
            usersData.patients.forEach(patient => {
                html += `
                    <tr>
                        <td><code>${patient.id}</code></td>
                        <td>
                            <strong>${patient.firstName} ${patient.lastName}</strong>
                            <br><small class="text-muted">${patient.age || '-'} ya≈ü</small>
                        </td>
                        <td>${patient.weight || '-'} kg</td>
                        <td>${patient.height || '-'} cm</td>
                        <td>${patient.phone || '-'}</td>
                        <td>
                            <span class="badge bg-success">${patient.status || 'active'}</span>
                            <br><small class="text-muted">${patient.dietType || 'lowcarb'}</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewPatientJSON('${patient.id}')" title="JSON G√∂r√ºnt√ºle">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editPatient('${patient.id}')" title="D√ºzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            logToConsole(`‚úÖ ${usersData.patients.length} hasta zorla y√ºklendi!`);
        }
        
        // Global eri≈üim i√ßin window'a ekle
        window.forceLoadUsersTable = forceLoadUsersTable;
        
        // Global debug fonksiyonlarƒ±
        window.testJsonLoad = debugJsonStatus;
        window.testJsonSave = async function() {
            logToConsole('üîÑ JSON KAYIT TESƒ∞ BA≈ûLADI...');
            await saveUsersData();
            await saveSystemSettings();
            logToConsole('‚úÖ JSON KAYIT TESƒ∞ TAMAMLANDI');
        };
        window.showJsonStatus = debugJsonStatus;
        window.forceReloadFromJson = forceReloadFromJson;
        
        // Global debug verisi
        window.debugData = {
            usersData: usersData,
            systemSettings: systemSettings,
            dietConfig: dietConfig,
            forceLoadUsersTable: forceLoadUsersTable,
            loadPatientsList: loadPatientsList,
            loadPatientTrackingPage: loadPatientTrackingPage
        };
        
        // Global debug fonksiyonu
        window.debugPatientsList = function() {
            logToConsole('üîß DEBUG: Hasta listesi zorla y√ºkleniyor...');
            const container = document.getElementById('patients-list');
            logToConsole(`üìç Container: ${container ? 'VAR' : 'YOK'}`);
            logToConsole(`üìä UsersData: ${usersData ? 'VAR' : 'YOK'}`);
            logToConsole(`üë• Hasta sayƒ±sƒ±: ${usersData?.patients?.length || 0}`);
            
            if (usersData?.patients) {
                usersData.patients.forEach((p, i) => {
                    logToConsole(`üè• ${i+1}: ${p.firstName} ${p.lastName} (${p.id})`);
                });
            }
            
            loadPatientsList();
            return container ? container.innerHTML.length : 0;
        };
        
        // Dashboard istatistiklerini g√ºncelle
        function updateDashboardStats() {
            document.getElementById('total-patients').textContent = usersData.patients?.length || 0;
            document.getElementById('total-doctors').textContent = usersData.doctors?.length || 0;
            document.getElementById('total-dietitians').textContent = usersData.dietitians?.length || 0;
            document.getElementById('active-plans').textContent = '0'; // Hesaplanacak
        }
        
        // Sidebar men√º olaylarƒ±
        function setupSidebarEvents() {
            logToConsole('üîß Sidebar event listeners kuruluyor...');
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            logToConsole(`üìã Bulunan men√º elemanlarƒ±: ${menuItems.length}`);
            
            menuItems.forEach(item => {
                const pageId = item.getAttribute('data-page');
                if (pageId) {
                    logToConsole(`üîó Menu item kuruldu: ${pageId}`);
                }
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    logToConsole(`üñ±Ô∏è Menu tƒ±klandƒ±: ${this.getAttribute('data-page')}`);
                    
                    // Aktif men√ºy√º g√ºncelle
                    menuItems.forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Sayfa i√ßeriƒüini deƒüi≈ütir
                    const pageId = this.getAttribute('data-page');
                    if (pageId) {
                        logToConsole(`üîÑ Sayfa deƒüi≈ütiriliyor: ${pageId}`);
                        showPage(pageId);
                    } else {
                        logToConsole('‚ö†Ô∏è data-page attribute bulunamadƒ±!');
                    }
                });
            });
            
            logToConsole('‚úÖ Sidebar event listeners kuruldu');
        }
        
        // Sayfa g√∂ster/gizle
        function showPage(pageId) {
            logToConsole(`üìÑ showPage √ßaƒürƒ±ldƒ±: ${pageId}`);
            
            // T√ºm sayfalarƒ± gizle
            const pages = document.querySelectorAll('.page-section');
            pages.forEach(page => page.classList.remove('active'));
            
            // ƒ∞lgili sayfayƒ± g√∂ster
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                logToConsole(`‚úÖ Sayfa g√∂sterildi: ${pageId}`);
                
                // Sayfa ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
                updatePageTitle(pageId);
                
                // Sayfa √∂zel y√ºkleme i≈ülemleri
                logToConsole(`üîß √ñzel y√ºkleme kontrol ediliyor: ${pageId}`);
                switch(pageId) {
                    case 'diet-config':
                        logToConsole('üçÉ Diet config y√ºkleniyor...');
                        loadDietConfigPage();
                        break;
                    case 'food-database':
                        logToConsole('üçΩÔ∏è Food database y√ºkleniyor...');
                        loadFoodDatabasePage();
                        break;
                    case 'patient-tracking':
                        logToConsole('üè• Patient tracking y√ºkleniyor...');
                        loadPatientTrackingPage();
                        break;
                    case 'users':
                        logToConsole('üë• Users sayfasƒ± y√ºkleniyor...');
                        loadUsersPage();
                        break;
                    case 'rules':
                        logToConsole('üß© Kurallar sayfasƒ± y√ºkleniyor...');
                        loadRulesPage();
                        break;
                    case 'system-settings':
                        logToConsole('‚öôÔ∏è Sistem ayarlarƒ± y√ºkleniyor...');
                        loadSystemSettingsPage();
                        break;
                    default:
                        logToConsole(`‚ÑπÔ∏è ${pageId} i√ßin √∂zel y√ºkleme yok`);
                }
            } else {
                logToConsole(`‚ùå Sayfa bulunamadƒ±: ${pageId}`);
            }
        }
        
        // Sayfa ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
        function updatePageTitle(pageId) {
            const titles = {
                'dashboard': 'Ana Sayfa',
                'system-settings': 'Sistem Ayarlarƒ± & Kriterler',
                'diet-config': 'Diyet Ayarlarƒ±',
                'food-database': 'Yemek Veritabanƒ±',
                'rules': 'Kurallar',
                'templates': '≈ûablonlar',
                'users': 'Kullanƒ±cƒ±lar',
                'patient-tracking': 'Hasta Takibi',
                'planning': 'Planlama',
                'reports': 'Raporlar',
                'criteria-manager': 'Kriter Y√∂neticisi'
            };
            
            document.getElementById('page-title').textContent = titles[pageId] || 'Bilinmeyen Sayfa';
            document.getElementById('breadcrumb-current').textContent = titles[pageId] || 'Bilinmeyen';
        }
        
        // Sistem ayarlarƒ± sayfasƒ±nƒ± y√ºkle
        async function loadSystemSettingsPage() {
            logToConsole('‚öôÔ∏è Sistem ayarlarƒ± sayfasƒ± y√ºkleniyor...');
            
            // Kayƒ±tlƒ± sistem ayarlarƒ±nƒ± y√ºkle
            loadSavedSystemSettings();
            
            // T√ºm √∂ƒü√ºn input'larƒ±nƒ±n event listener'larƒ±nƒ± kur
            setupMealConfigurationEvents();
            
            // Hedef kaloriyi hesapla ve makro toplamƒ±nƒ± g√ºncelle
            // Kayƒ±tlƒ± deƒüerler varsa y√ºkle
            setTimeout(async () => {
                loadSavedSystemSettings();
                if (typeof initCustomFormulaPanel === 'function') {
                    initCustomFormulaPanel();
                }
                calculateTargetCalories();
                updateMealMacroTotal();
                
                // Fresh hasta verilerini y√ºkle (≈üimdilik devre dƒ±≈üƒ±)
                /*
                try {
                    const lastPatientId = localStorage.getItem('currentPatientId') || window.currentPatientId;
                    if (lastPatientId && JSON_SERVER_ENABLED) {
                        const response = await fetch('http://localhost:3000/data/patients_list.json');
                        if (response.ok) {
                            const data = await response.json();
                            const freshPatient = data.patients.find(p => p.id === lastPatientId);
                            if (freshPatient) {
                                currentPatient = freshPatient;
                                console.log('üîÑ [SETTINGS PAGE] Fresh hasta verisi y√ºklendi:', lastPatientId);
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Sistem ayarlarƒ± sayfasƒ±nda hasta y√ºklenemedi:', e);
                }
                */
                
                // Saƒü panelde kriterler i√ßin hafta baƒülama kontrollerini tazele
                try { await renderCriteriaWeekControls(); } catch(_) {}
                
                // Hafta ≈üablonlarƒ±nƒ± listele - G√ú√áLENDIRILDI
                setTimeout(async () => {
                    console.log('üîÑ [INIT] Hafta ≈üablonlarƒ± initialization ba≈ülƒ±yor...');
                    
                    if (typeof listSystemWeekProfiles === 'function') {
                        await listSystemWeekProfiles();
                        console.log('üìã [INIT] Hafta ≈üablonlarƒ± listelendi');
                    }
                    
                    // Template dropdown'larƒ±nƒ± yenile - KRITIK B√ñL√úM
                    if (typeof renderCriteriaWeekControls === 'function') {
                        await renderCriteriaWeekControls();
                        console.log('üîÑ [INIT] Template dropdown yenilendi');
                        
                        // Dropdown i√ßeriƒüini kontrol et
                        const weekSelect = document.getElementById('criteria-week-select');
                        if (weekSelect) {
                            const options = weekSelect.querySelectorAll('option');
                            console.log(`üîç [INIT] Dropdown se√ßenekleri (${options.length} adet):`, 
                                Array.from(options).map(opt => `${opt.value}: ${opt.textContent}`));
                                
                            // Template se√ßeneklerini filtrele
                            const templateOptions = Array.from(options).filter(opt => opt.value.startsWith('template_'));
                            console.log(`üìã [INIT] Template se√ßenekleri (${templateOptions.length} adet):`,
                                templateOptions.map(opt => opt.value));
                        }
                    }
                    
                    // Etkile≈üim ge√ßmi≈üini y√ºkle
                    if (typeof refreshInteractionHistory === 'function') {
                        refreshInteractionHistory();
                        console.log('üìä [INIT] Etkile≈üim ge√ßmi≈üi y√ºklendi');
                    }
                }, 200);
            }, 100);
            
            logToConsole('‚úÖ Sistem ayarlarƒ± sayfasƒ± y√ºklendi');
        }
        
        // Mevcut UI'den sistem varsayƒ±lanlarƒ±nƒ± topla (hafta ≈üablonu i√ßin kullanƒ±lacak)
        function collectSystemDefaultsFromUI() {
            // Kriter etkinlik durumlarƒ±nƒ± topla
            const criteriaSettings = {};
            document.querySelectorAll('.criteria-item').forEach(item => {
                const criteriaId = item.getAttribute('data-criteria-id');
                const checkbox = item.querySelector('.criteria-checkbox-input');
                if (criteriaId && checkbox) criteriaSettings[criteriaId] = checkbox.checked;
            });

            const userSettings = {
                age: parseInt(document.getElementById('target-age')?.value) || 35,
                weight: parseInt(document.getElementById('target-weight')?.value) || 70,
                activity: document.getElementById('target-activity')?.value || '1.55',
                height: parseInt(document.getElementById('target-height')?.value) || 165,
                gender: document.getElementById('target-gender')?.value || 'female',
                targetCalories: parseInt(document.getElementById('calculated-calories')?.textContent) || 1850
            };

            const macroPercentages = {
                breakfast: parseInt(document.getElementById('breakfast-macro')?.value) || 25,
                snack1: parseInt(document.getElementById('snack1-macro')?.value) || 10,
                lunch: parseInt(document.getElementById('lunch-macro')?.value) || 30,
                snack2: parseInt(document.getElementById('snack2-macro')?.value) || 10,
                dinner: parseInt(document.getElementById('dinner-macro')?.value) || 25
            };

            const getNum = id => parseInt(document.getElementById(id)?.value);
            const mealSettings = {
                breakfast: { min: getNum('breakfast-min') || 2, max: getNum('breakfast-max') || 4, fixed: document.getElementById('breakfast-fixed')?.value ? getNum('breakfast-fixed') : null },
                snack1: { min: getNum('snack1-min') || 1, max: getNum('snack1-max') || 2, fixed: document.getElementById('snack1-fixed')?.value ? getNum('snack1-fixed') : null },
                lunch: { min: getNum('lunch-min') || 3, max: getNum('lunch-max') || 5, fixed: document.getElementById('lunch-fixed')?.value ? getNum('lunch-fixed') : null },
                snack2: { min: getNum('snack2-min') || 1, max: getNum('snack2-max') || 2, fixed: document.getElementById('snack2-fixed')?.value ? getNum('snack2-fixed') : null },
                dinner: { min: getNum('dinner-min') || 3, max: getNum('dinner-max') || 5, fixed: document.getElementById('dinner-fixed')?.value ? getNum('dinner-fixed') : null }
            };

            // √ñzel form√ºl topla
            const collectCustomFormula = () => {
                const getF = id => parseFloat(document.getElementById(id)?.value);
                const obj = {
                    coeff: {
                        carbs: getF('custom-coeff-carbs') || 0.6,
                        protein: getF('custom-coeff-protein') || 0.8,
                        fat: getF('custom-coeff-fat') || 1.0
                    },
                    act: {}
                };
                [1,2,3,4,5].forEach(i => obj.act[i] = getF('custom-act-'+i) || (i===3?1.0:(i<3?0.8+(i-1)*0.1:1.0+(i-3)*0.1)));
                return obj;
            };

            // Criteria hierarchy DOM sƒ±rasƒ±
            const hierarchy = getCriteriaHierarchyFromDOM().map((item, index) => ({
                id: item.id,
                priority: index + 1,
                enabled: criteriaSettings[item.id] !== false
            }));
            
            // Sabit yemekleri topla
            const fixedMeals = JSON.parse(localStorage.getItem('fixedMeals') || '{}');

            return {
                dietType: document.getElementById('system-default-diet')?.value || 'lowcarb',
                defaultCalorieMethod: document.querySelector('input[name="defaultCalorieMethod"]:checked')?.value || 'custom',
                userSettings,
                mealPercentages: macroPercentages,
                customFormula: collectCustomFormula(),
                mealSettings,
                criteriaHierarchy: hierarchy,
                criteriaSettings,
                fixedMeals
            };
        }

        // Kayƒ±tlƒ± sistem ayarlarƒ±nƒ± y√ºkle (√∂ncelik: localStorage v2 > localStorage legacy > embedded)
        async function loadSavedSystemSettings() {
            try {
                // Yardƒ±mcƒ±: systemDefaults'u UI'ye uygula
                const applyDefaultsToUI = (settings) => {
                    if (!settings) return;
                    // Diyet t√ºr√º
                    if (settings.dietType) {
                        const dietSelect = document.getElementById('system-default-diet');
                        if (dietSelect) {
                            dietSelect.value = settings.dietType;
                            logToConsole(`üìä Diyet t√ºr√º y√ºklendi: ${settings.dietType}`);
                        }
                    }
                    // Kalori y√∂ntemi
                    if (settings.defaultCalorieMethod) {
                        const radioElement = document.querySelector(`input[name="defaultCalorieMethod"][value="${settings.defaultCalorieMethod}"]`);
                        if (radioElement) {
                            radioElement.checked = true;
                            logToConsole(`üìä Kalori y√∂ntemi y√ºklendi: ${settings.defaultCalorieMethod}`);
                        }
                    }
                    // Kullanƒ±cƒ± ayarlarƒ±
                    if (settings.userSettings) {
                        logToConsole('üìä UserSettings bulundu:', settings.userSettings);
                        const ageInput = document.getElementById('target-age');
                        const weightInput = document.getElementById('target-weight');
                        const activitySelect = document.getElementById('target-activity');
                        if (ageInput && settings.userSettings.age != null) {
                            ageInput.value = settings.userSettings.age;
                            logToConsole(`‚úÖ Ya≈ü y√ºklendi: ${settings.userSettings.age} (element deƒüeri: ${ageInput.value})`);
                        } else {
                            logToConsole(`‚ùå Ya≈ü y√ºklenemedi - ageInput: ${!!ageInput}, age: ${settings.userSettings?.age}`);
                        }
                        if (weightInput && settings.userSettings.weight != null) {
                            weightInput.value = settings.userSettings.weight;
                            logToConsole(`‚úÖ Kilo y√ºklendi: ${settings.userSettings.weight}`);
                        }
                        const heightInput = document.getElementById('target-height');
                        if (heightInput && settings.userSettings.height != null) {
                            heightInput.value = settings.userSettings.height;
                            logToConsole(`‚úÖ Boy y√ºklendi: ${settings.userSettings.height}`);
                        }
                        const genderSelect = document.getElementById('target-gender');
                        if (genderSelect && settings.userSettings.gender) {
                            genderSelect.value = settings.userSettings.gender;
                            logToConsole(`‚úÖ Cinsiyet y√ºklendi: ${settings.userSettings.gender}`);
                        }
                        if (activitySelect && settings.userSettings.activity != null) {
                            activitySelect.value = settings.userSettings.activity;
                            logToConsole(`‚úÖ Aktivite y√ºklendi: ${settings.userSettings.activity}`);
                        }
                        if (settings.userSettings.targetCalories != null) {
                            const caloriesElement = document.getElementById('calculated-calories');
                            if (caloriesElement) {
                                caloriesElement.textContent = settings.userSettings.targetCalories;
                                logToConsole(`‚úÖ Hedef kalori y√ºklendi: ${settings.userSettings.targetCalories}`);
                            }
                        }
                    }
                    // √ñƒü√ºn y√ºzde daƒüƒ±lƒ±mƒ±
                    if (settings.mealPercentages) {
                        const mp = settings.mealPercentages;
                        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
                        setVal('breakfast-macro', mp.breakfast ?? 25);
                        setVal('snack1-macro', mp.snack1 ?? 10);
                        setVal('lunch-macro', mp.lunch ?? 30);
                        setVal('snack2-macro', mp.snack2 ?? 10);
                        setVal('dinner-macro', mp.dinner ?? 25);
                        setTimeout(() => updateMealMacroTotal(), 100);
                        logToConsole('üìä √ñƒü√ºn y√ºzde daƒüƒ±lƒ±mlarƒ± y√ºklendi', mp);
                    }
                    // √ñƒü√ºn ayarlarƒ±
                    if (settings.mealSettings) {
                        loadMealSettingsToUI(settings.mealSettings);
                    }
                    // Criteria order
                    if (settings.criteriaHierarchy && settings.criteriaHierarchy.length > 0) {
                        const criteriaOrder = settings.criteriaHierarchy.map(c => c.id);
                        localStorage.setItem('defaultCriteriaOrder', JSON.stringify(criteriaOrder));
                        console.log('üìä Criteria hierarchy y√ºklendi');
                    }
                    // Criteria enabled
                    let criteriaSettings = JSON.parse(localStorage.getItem('criteriaSettings') || 'null');
                    if (!criteriaSettings && settings.criteriaSettings) {
                        criteriaSettings = settings.criteriaSettings;
                        localStorage.setItem('criteriaSettings', JSON.stringify(criteriaSettings));
                        console.log('üìä Criteria settings ilk kez ayarlandƒ±');
                    }
                    
                    // Sabit yemekler
                    if (settings.fixedMeals) {
                        localStorage.setItem('fixedMeals', JSON.stringify(settings.fixedMeals));
                        console.log('üìä Sabit yemekler ayarlandƒ±:', settings.fixedMeals);
                        // UI'yi g√ºncelle
                        setTimeout(async () => {
                            await loadFixedMealsFromStorage();
                        }, 100);
                    }
                };

                // 1) localStorage (v2 - tam yapƒ±)
                let lsFullRaw = localStorage.getItem('systemSettings_v2') || localStorage.getItem('systemSettingsFull');
                if (lsFullRaw) {
                    try {
                        const lsFull = JSON.parse(lsFullRaw);
                        const settings = lsFull?.systemDefaults || lsFull;
                        logToConsole('üìÇ localStorage (v2) sistem ayarlarƒ± y√ºkleniyor:', settings);
                        applyDefaultsToUI(settings);
                        // Hafta ≈üablonlarƒ±nƒ± cache'le ve listele
                        try {
                            if (lsFull?.systemDefaults?.weeklyProfiles) {
                                window.__weeklyProfilesCache = lsFull.systemDefaults.weeklyProfiles;
                                if (typeof listSystemWeekProfiles === 'function') {
                                    setTimeout(() => listSystemWeekProfiles(), 50);
                                }
                            }
                        } catch(_) {}
                        setTimeout(() => {
                            calculateTargetCalories();
                            try { toggleCustomFormulaPanel(); } catch(_) {}
                            logToConsole('‚úÖ T√ºm sistem ayarlarƒ± localStorage (v2)\'den y√ºklendi');
                        }, 200);
                        return;
                    } catch (e) {
                        console.warn('localStorage v2 parse hatasƒ±:', e);
                    }
                }

                // 2) localStorage (legacy)
                const savedLegacy = localStorage.getItem('systemSettings');
                if (savedLegacy) {
                    const settingsLegacy = JSON.parse(savedLegacy);
                    logToConsole('üìÇ localStorage (legacy) sistem ayarlarƒ± y√ºkleniyor:', settingsLegacy);
                    if (settingsLegacy.defaultDiet) {
                        const dietSelect = document.getElementById('system-default-diet');
                        if (dietSelect) dietSelect.value = settingsLegacy.defaultDiet;
                    }
                    if (settingsLegacy.defaultCalorieMethod) {
                        const radioElement = document.querySelector(`input[name="defaultCalorieMethod"][value="${settingsLegacy.defaultCalorieMethod}"]`);
                        if (radioElement) radioElement.checked = true;
                    }
                    if (settingsLegacy.mealSettings) {
                        loadMealSettingsToUI(settingsLegacy.mealSettings);
                    } else if (settingsLegacy.mealConfiguration) {
                        loadMealConfigurationToUI(settingsLegacy.mealConfiguration);
                    }
                    if (settingsLegacy.criteriaHierarchy && settingsLegacy.criteriaHierarchy.length > 0) {
                        const criteriaOrder = settingsLegacy.criteriaHierarchy.map(c => c.id);
                        localStorage.setItem('defaultCriteriaOrder', JSON.stringify(criteriaOrder));
                    }
                    setTimeout(() => {
                        calculateTargetCalories();
                        try { toggleCustomFormulaPanel(); } catch(_) {}
                        updateMealMacroTotal();
                    }, 200);
                    return;
                }

                // 3) embedded (fallback)
                const systemSettingsData = await getEmbeddedData('system_settings.json');
                if (systemSettingsData && systemSettingsData.systemDefaults) {
                    logToConsole('üìÇ Embedded JSON\'dan sistem ayarlarƒ± y√ºkleniyor:', systemSettingsData.systemDefaults);
                    applyDefaultsToUI(systemSettingsData.systemDefaults);
                    // Hafta ≈üablonlarƒ±nƒ± cache'le ve listele (embedded kaynaktan)
                    try {
                        if (systemSettingsData.systemDefaults.weeklyProfiles) {
                            window.__weeklyProfilesCache = systemSettingsData.systemDefaults.weeklyProfiles;
                            if (typeof listSystemWeekProfiles === 'function') {
                                setTimeout(() => listSystemWeekProfiles(), 50);
                            }
                        }
                    } catch(_) {}
                    setTimeout(() => {
                        calculateTargetCalories();
                        try { toggleCustomFormulaPanel(); } catch(_) {}
                        logToConsole('‚úÖ T√ºm sistem ayarlarƒ± embedded JSON\'dan y√ºklendi ve hesaplamalar g√ºncellendi');
                    }, 200);
                    return;
                }

                logToConsole('‚ÑπÔ∏è Kayƒ±tlƒ± sistem ayarlarƒ± bulunamadƒ±, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor');
            } catch (error) {
                logToConsole('‚ùå Sistem ayarlarƒ± y√ºkleme hatasƒ±:', error);
            }
        }
        
        // Kriter etkinlik ayarlarƒ±nƒ± y√ºkle ve uygula
        function loadCriteriaEnabledSettings() {
            const savedCriteria = JSON.parse(localStorage.getItem('criteriaSettings') || '{}');
            
            // T√ºm criteria-item elementlerini bul
            const criteriaItems = document.querySelectorAll('.criteria-item');
            
            criteriaItems.forEach(item => {
                const criteriaId = item.getAttribute('data-criteria-id');
                const checkbox = item.querySelector('.criteria-checkbox');
                
                if (criteriaId && checkbox) {
                    // Kayƒ±tlƒ± ayar var mƒ± kontrol et (varsayƒ±lan: true)
                    const isEnabled = savedCriteria.hasOwnProperty(criteriaId) ? savedCriteria[criteriaId] : true;
                    
                    // Checkbox durumunu ayarla
                    checkbox.checked = isEnabled;
                    
                    // Visual feedback uygula
                    if (isEnabled) {
                        item.style.opacity = '1';
                        item.style.background = 'white';
                    } else {
                        item.style.opacity = '0.6';
                        item.style.background = '#f8f9fa';
                    }
                    
                    // Eƒüer kayƒ±t yoksa varsayƒ±lan olarak kaydet
                    if (!savedCriteria.hasOwnProperty(criteriaId)) {
                        savedCriteria[criteriaId] = true;
                    }
                }
            });
            
            // G√ºncellenmi≈ü ayarlarƒ± kaydet
            localStorage.setItem('criteriaSettings', JSON.stringify(savedCriteria));
            
            logToConsole('üéØ Kriter etkinlik ayarlarƒ± y√ºklendi:', savedCriteria);
        }
        
        // Kriter etkinlik ayarlarƒ±nƒ± kaydet
        function saveCriteriaEnabledSettings() {
            const criteriaSettings = {};
            
            // T√ºm criteria-item'lardaki checkbox durumlarƒ±nƒ± topla
            const criteriaItems = document.querySelectorAll('.criteria-item');
            
            criteriaItems.forEach(item => {
                const criteriaId = item.getAttribute('data-criteria-id');
                const checkbox = item.querySelector('.criteria-checkbox');
                
                if (criteriaId && checkbox) {
                    criteriaSettings[criteriaId] = checkbox.checked;
                }
            });
            
            // localStorage'a kaydet
            localStorage.setItem('criteriaSettings', JSON.stringify(criteriaSettings));
            
            logToConsole('üéØ Kriter etkinlik ayarlarƒ± kaydedildi:', criteriaSettings);
        }
        
        // Criteria checkbox event listener'larƒ±nƒ± kur
        function setupCriteriaCheckboxListeners() {
            // DOM'un hazƒ±r olmasƒ±nƒ± bekle
            setTimeout(() => {
                const checkboxes = document.querySelectorAll('.criteria-checkbox-input');
                
                console.log(`üéØ setupCriteriaCheckboxListeners: ${checkboxes.length} checkbox bulundu`);
                
                if (checkboxes.length === 0) {
                    console.warn('‚ö†Ô∏è Hi√ß checkbox bulunamadƒ±! DOM hen√ºz hazƒ±r olmayabilir.');
                    return;
                }
                
                checkboxes.forEach((checkbox, index) => {
                    // Mevcut event listener'larƒ± temizle
                    checkbox.removeEventListener('change', handleCriteriaCheckboxChange);
                    
                    // Yeni listener ekle
                    checkbox.addEventListener('change', handleCriteriaCheckboxChange);
                    
                    const criteriaId = checkbox.getAttribute('data-criteria-id');
                    console.log(`üìã Checkbox ${index}: criteriaId="${criteriaId}", checked=${checkbox.checked}`);
                });
                
                console.log(`‚úÖ ${checkboxes.length} adet criteria checkbox event listener kuruldu`);
            }, 50);
        }
        
        // Criteria checkbox change handler'ƒ± ayrƒ± fonksiyon olarak tanƒ±mla
        async function handleCriteriaCheckboxChange(event) {
            const checkbox = event.target;
            const criteriaId = checkbox.getAttribute('data-criteria-id');
            const isEnabled = checkbox.checked;
            
            console.log(`üîÑ Checkbox deƒüi≈üti: ${criteriaId} = ${isEnabled}`);
            console.log(`üîç Debug - currentPatient:`, currentPatient ? 'Var' : 'Yok');
            console.log(`üîç Debug - currentWeek:`, currentWeek ? `Week ${currentWeek.weekNumber}` : 'Yok');
            
            if (criteriaId) {
                // **YENƒ∞: TEMPLATE-SPECIFIC KAYDETME**
                const templateId = getCurrentTemplateId();
                console.log(`üîç [DEBUG] getCurrentTemplateId() = ${templateId}`);
                console.log(`üîç [DEBUG] criteria-week-select value =`, document.getElementById('criteria-week-select')?.value);
                
                if (templateId) {
                    console.log(`üéØ [TEMPLATE-CRITERIA] ≈ûablon ${templateId} i√ßin ${criteriaId} = ${isEnabled} kaydediliyor...`);
                    
                    // Mevcut t√ºm kriter durumlarƒ±nƒ± topla
                    const allCriteriaStates = {};
                    const allCheckboxes = document.querySelectorAll('.criteria-checkbox-input');
                    allCheckboxes.forEach(cb => {
                        const cbId = cb.getAttribute('data-criteria-id');
                        if (cbId) {
                            allCriteriaStates[cbId] = cb.checked;
                        }
                    });
                    
                    console.log(`üîç [TEMPLATE-CRITERIA] Toplanan criteria states:`, allCriteriaStates);
                    
                    // Template-specific olarak kaydet
                    await saveTemplateSpecificData(templateId, 'criteriaStates', allCriteriaStates);
                    
                    // Genel form kaydetme de tetikle
                    collectAllFormData();
                    return;
                }
                
                // Log interaction with timestamp
                await logCriteriaInteraction(criteriaId, isEnabled);
                
                // SADECE sistem varsayƒ±lanlarƒ±na kaydet (eƒüer hasta/hafta yoksa)
                if (!currentPatient) {
                    toggleCriteriaEnabled(criteriaId, isEnabled);
                    console.log('‚ÑπÔ∏è Hasta bilgisi yok, sadece sistem varsayƒ±lanlarƒ±na kaydedildi');
                    return;
                }
                
                // Eƒüer hasta ve hafta bilgisi varsa, √ñNCE hafta verilerine kaydet
                if (currentPatient && (currentWeek || currentPatient.weeklyPlans)) {
                    try { 
                        // Aktif haftayƒ± bul - √∂nce ≈üablon numarasƒ±ndan
                        let targetWeek = currentWeek;
                        let weekNumber = null;
                        
                        // Eƒüer ge√ßici ≈üablon bilgisi varsa, o haftayƒ± hedefle
                        if (window._tempWeekProfileName) {
                            const match = window._tempWeekProfileName.match(/Hafta (\d+)/);
                            if (match) {
                                weekNumber = parseInt(match[1]);
                            }
                        }
                        
                        // Hafta numarasƒ± belli ise, o haftayƒ± bul veya olu≈ütur
                        if (weekNumber) {
                            targetWeek = currentPatient.weeklyPlans.find(w => w.weekNumber === weekNumber);
                            if (!targetWeek) {
                                // Bu hafta yoksa olu≈ütur
                                targetWeek = {
                                    weekNumber: weekNumber,
                                    description: `Hafta ${weekNumber}`,
                                    criteriaSnapshot: { enabled: {} }
                                };
                                if (!currentPatient.weeklyPlans) currentPatient.weeklyPlans = [];
                                currentPatient.weeklyPlans.push(targetWeek);
                                console.log(`üÜï Yeni hafta olu≈üturuldu: Week ${weekNumber}`);
                            }
                            // currentWeek'i g√ºncelle
                            currentWeek = targetWeek;
                        }
                        
                        // Eƒüer hala targetWeek yoksa, currentWeek'i kullan
                        if (!targetWeek && currentWeek) {
                            targetWeek = currentWeek;
                        }
                        
                        // Eƒüer currentWeek yoksa, ilk haftayƒ± kullan
                        if (!targetWeek && currentPatient.weeklyPlans && currentPatient.weeklyPlans.length > 0) {
                            targetWeek = currentPatient.weeklyPlans[0];
                            currentWeek = targetWeek;
                            console.log(`üîç currentWeek yok, ilk hafta kullanƒ±lƒ±yor: Week ${targetWeek.weekNumber}`);
                        }
                        
                        // Eƒüer hala hafta yoksa, yeni hafta olu≈ütur
                        if (!targetWeek) {
                            if (!currentPatient.weeklyPlans) {
                                currentPatient.weeklyPlans = [];
                            }
                            targetWeek = {
                                weekNumber: 1,
                                description: 'Hafta 1',
                                criteriaSnapshot: { enabled: {} }
                            };
                            currentPatient.weeklyPlans.push(targetWeek);
                            currentWeek = targetWeek;
                            console.log(`üÜï Yeni hafta olu≈üturuldu: Week ${targetWeek.weekNumber}`);
                        }
                        
                        // Hafta'ya criteria snapshot kaydet
                        if (!targetWeek.criteriaSnapshot) {
                            targetWeek.criteriaSnapshot = {};
                        }
                        if (!targetWeek.criteriaSnapshot.enabled) {
                            targetWeek.criteriaSnapshot.enabled = {};
                        }
                        
                        // SADECE bu criteria'nƒ±n durumunu kaydet (diƒüer kriterler deƒüi≈ümesin)
                        targetWeek.criteriaSnapshot.enabled[criteriaId] = isEnabled;
                        
                        // Diƒüer checkbox'larƒ±n mevcut durumlarƒ±nƒ± da koruyalƒ±m
                        const allCheckboxes = document.querySelectorAll('.criteria-checkbox-input');
                        allCheckboxes.forEach(cb => {
                            const cbId = cb.getAttribute('data-criteria-id');
                            if (cbId && cbId !== criteriaId) {
                                // Eƒüer bu kriterin durumu daha √∂nce kaydedilmemi≈üse, mevcut durumu al
                                if (!(cbId in targetWeek.criteriaSnapshot.enabled)) {
                                    targetWeek.criteriaSnapshot.enabled[cbId] = cb.checked;
                                }
                            }
                        });
                        
                        console.log(`üíæ [Week ${targetWeek.weekNumber}] SADECE "${criteriaId}" = ${isEnabled} kaydedildi`);
                        console.log(`üíæ [Week ${targetWeek.weekNumber}] Hafta √∂zel kriter durumlarƒ±:`, targetWeek.criteriaSnapshot.enabled);
                        
                        // Hasta verilerini kaydet
                        const patientId = getCurrentPatientId();
                        if (patientId) {
                            savePatientDetailedData(patientId, currentPatient);
                            console.log(`üíæ Hasta verileri kaydedildi: ${patientId}`);
                        } else {
                            console.warn('‚ö†Ô∏è Patient ID bulunamadƒ±, hafta verileri kaydedilemedi');
                        }
                        
                        // Sistem varsayƒ±lanlarƒ±nƒ± deƒüi≈ütirme, sadece hafta verisini g√ºncelle
                        console.log('‚úÖ Sistem varsayƒ±lanlarƒ± korundu, sadece hafta verisi g√ºncellendi');
                        
                    } catch(e) {
                        console.warn('‚ùå Hafta snapshot kaydetme hatasƒ±:', e);
                    }
                } else {
                    console.log('‚ÑπÔ∏è Hafta bilgisi yok, sadece sistem varsayƒ±lanlarƒ±na kaydedildi');
                    toggleCriteriaEnabled(criteriaId, isEnabled);
                }
            } else {
                console.warn('‚ùå criteriaId bulunamadƒ±:', checkbox);
            }
        }

        // Interactive logging system for criteria changes
        async function logCriteriaInteraction(criteriaId, checked) {
            const timestamp = new Date().toISOString();
            // Aktif hafta numarasƒ±nƒ± daha g√ºvenilir ≈üekilde tespit et
            let currentWeekNumber = 1;
            if (currentWeek && currentWeek.weekNumber) {
                currentWeekNumber = currentWeek.weekNumber;
            } else if (currentPatient && currentPatient.lastSelectedWeek) {
                currentWeekNumber = currentPatient.lastSelectedWeek;
            } else {
                const weekSelect = document.getElementById('criteria-week-select');
                if (weekSelect && weekSelect.value) {
                    currentWeekNumber = parseInt(weekSelect.value) || 1;
                }
            }
            
            const patientId = currentPatient?.id || 'unknown';
            
            // Get existing interaction log from systemSettings_v2
            let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
            if (!systemSettings.interactionLog) {
                systemSettings.interactionLog = [];
            }
            let interactionLog = systemSettings.interactionLog;
            
            // Add new interaction
            const interaction = {
                timestamp,
                patientId,
                weekNumber: currentWeekNumber,
                criteriaId,
                checked,
                action: 'checkbox_click',
                sessionId: getSessionId()
            };
            
            interactionLog.push(interaction);
            
            // Keep only last 100 interactions to prevent storage overflow
            if (interactionLog.length > 100) {
                interactionLog = interactionLog.slice(-100);
            }
            
            // Save to JSON instead of localStorage
            systemSettings.interactionLog = interactionLog;
            await saveSystemSettings();
            
            console.log(`üìù Etkile≈üim kaydedildi (JSON): [${patientId}] Hafta ${currentWeekNumber} - ${criteriaId} = ${checked}`);
        }

        // Get or create session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('nutritionSessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('nutritionSessionId', sessionId);
            }
            return sessionId;
        }
        
        // Criteria visual feedback'i uygula (throttle ile)
        let _applyCriteriaVisualFeedbackTimeout;
        function applyCriteriaVisualFeedback() {
            // Throttle: aynƒ± anda √ßok fazla √ßaƒürƒ± olmasƒ±nƒ± engelle
            if (_applyCriteriaVisualFeedbackTimeout) {
                clearTimeout(_applyCriteriaVisualFeedbackTimeout);
            }
            _applyCriteriaVisualFeedbackTimeout = setTimeout(() => {
                _doApplyCriteriaVisualFeedback();
            }, 50); // 50ms throttle
        }
        
        function _doApplyCriteriaVisualFeedback() {
            // √ñnce ge√ßici olarak ≈üablon verilerini kontrol et
            let savedSettings = {};
            let sourceInfo = '';
            
            // Eƒüer window'da ge√ßici ≈üablon verisi varsa, onu kullan
            if (window._tempWeekProfileCriteria) {
                savedSettings = window._tempWeekProfileCriteria;
                sourceInfo = `ge√ßici ≈üablon ${window._tempWeekProfileName || ''}`;
                console.log(`üéØ ${sourceInfo} kriter durumlarƒ± kullanƒ±lƒ±yor:`, savedSettings);
            }
            // Sonra aktif haftanƒ±n √∂zel kriter durumlarƒ±nƒ± kontrol et
            else if (currentWeek && currentWeek.criteriaSnapshot && currentWeek.criteriaSnapshot.enabled) {
                savedSettings = currentWeek.criteriaSnapshot.enabled;
                sourceInfo = `Hafta ${currentWeek.weekNumber} √∂zel`;
                console.log(`üéØ ${sourceInfo} kriter durumlarƒ± kullanƒ±lƒ±yor:`, savedSettings);
            } 
            else if (currentPatient && currentPatient.weeklyPlans && currentPatient.weeklyPlans.length > 0) {
                // currentWeek yoksa ama patient varsa, ilk haftanƒ±n durumlarƒ±nƒ± kontrol et
                const firstWeek = currentPatient.weeklyPlans[0];
                if (firstWeek && firstWeek.criteriaSnapshot && firstWeek.criteriaSnapshot.enabled) {
                    savedSettings = firstWeek.criteriaSnapshot.enabled;
                    sourceInfo = `ƒ∞lk hafta (${firstWeek.weekNumber}) √∂zel`;
                    console.log(`üéØ ${sourceInfo} kriter durumlarƒ± kullanƒ±lƒ±yor:`, savedSettings);
                } else {
                    // Hafta √∂zel durumlarƒ± yok, sistem varsayƒ±lanlarƒ±nƒ± kullan
                    savedSettings = JSON.parse(localStorage.getItem('criteriaSettings') || '{}');
                    sourceInfo = 'Sistem varsayƒ±lan';
                    console.log(`üéØ ${sourceInfo} kriter durumlarƒ± kullanƒ±lƒ±yor:`, savedSettings);
                }
            } else {
                // Hasta/hafta bilgisi yok, sistem varsayƒ±lanlarƒ±nƒ± kullan
                savedSettings = JSON.parse(localStorage.getItem('criteriaSettings') || '{}');
                sourceInfo = 'Sistem varsayƒ±lan (hasta yok)';
                console.log(`üéØ ${sourceInfo} kriter durumlarƒ± kullanƒ±lƒ±yor:`, savedSettings);
            }
            
            const criteriaItems = document.querySelectorAll('.criteria-item');
            
            // Debug loglarƒ± azaltƒ±ldƒ±
            if (criteriaItems.length === 0) {
                console.log('‚ö†Ô∏è applyCriteriaVisualFeedback: Criteria items bulunamadƒ±');
                return;
            }
            
            let updatedCount = 0;
            
            criteriaItems.forEach((item, index) => {
                const criteriaId = item.getAttribute('data-criteria-id');
                const checkbox = item.querySelector('.criteria-checkbox-input');
                
                if (criteriaId) {
                    const savedValue = savedSettings[criteriaId];
                    const isEnabled = savedValue !== false; // Varsayƒ±lan true
                    
                    // Checkbox durumunu ayarla
                    if (checkbox) {
                        checkbox.checked = isEnabled;
                        updatedCount++;
                    }
                    
                    // Visual feedback - daha belirgin yapƒ±yoruz
                    if (isEnabled) {
                        item.style.opacity = '1';
                        item.style.background = 'white';
                        item.style.border = '1px solid #ddd';
                        item.classList.remove('criteria-disabled');
                        item.classList.add('criteria-enabled');
                    } else {
                        item.style.opacity = '0.5';
                        item.style.background = '#f0f0f0';
                        item.style.border = '1px solid #ccc';
                        item.classList.remove('criteria-enabled');
                        item.classList.add('criteria-disabled');
                    }
                }
            });
            
            console.log(`‚úÖ Criteria visual feedback uygulandƒ± (${sourceInfo}): ${updatedCount} item`);
            
            // Ge√ßici verileri temizle
            if (window._tempWeekProfileCriteria) {
                delete window._tempWeekProfileCriteria;
                delete window._tempWeekProfileName;
            }
        }

        // -- Haftaya baƒülƒ± kriter snapshot yardƒ±mcƒ±larƒ± --
        function getCriteriaEnabledMapFromDOM() {
            const map = {};
            document.querySelectorAll('.criteria-item').forEach(item => {
                const id = item.getAttribute('data-criteria-id');
                const cb = item.querySelector('.criteria-checkbox-input');
                if (id && cb) map[id] = !!cb.checked;
            });
            return map;
        }

        function getCriteriaOrderIdsFromDOM() {
            const cont = document.getElementById('default-criteria-hierarchy');
            if (!cont) return [];
            return [...cont.querySelectorAll('.criteria-item')].map(el => el.getAttribute('data-criteria-id')).filter(Boolean);
        }

        // Aktif haftayƒ± kriter paneli i√ßin tespit et (dropdown > currentWeek > lastSelectedWeek)
        function resolveActiveWeekForCriteriaPanel() {
            try {
                const sel = document.getElementById('criteria-week-select');
                const prefer = sel ? parseInt(sel.value) : (currentWeek?.weekNumber || currentPatient?.lastSelectedWeek);
                const weeks = Array.isArray(currentPatient?.weeklyPlans) ? currentPatient.weeklyPlans : [];
                const wk = weeks.find(w => w.weekNumber === prefer) || weeks[0];
                return wk || null;
            } catch (_) {
                return currentWeek || null;
            }
        }

        function captureCriteriaSnapshotFromDOM() {
            // hierarchy √∂ƒüeleri: {id, priority}
            const order = getCriteriaOrderIdsFromDOM();
            const hierarchy = order.map((id, idx) => ({ id, priority: idx + 1 }));
            const enabled = getCriteriaEnabledMapFromDOM();
            return { hierarchy, enabled };
        }

        function applyCriteriaOrderToDOM(hierarchy) {
            if (!hierarchy || !Array.isArray(hierarchy)) return;
            const cont = document.getElementById('default-criteria-hierarchy');
            if (!cont) return;
            const idToEl = new Map();
            cont.querySelectorAll('.criteria-item').forEach(el => {
                idToEl.set(el.getAttribute('data-criteria-id'), el);
            });
            const orderedIds = hierarchy
                .slice()
                .sort((a,b) => (a.priority||0) - (b.priority||0))
                .map(x => typeof x === 'string' ? x : x.id)
                .filter(Boolean);
            orderedIds.forEach(id => {
                const el = idToEl.get(id);
                if (el) cont.appendChild(el);
            });
            // √ñncelik rozetlerini g√ºncelle
            try { refreshCriteriaPriorities(); } catch(_) {}
        }

        // Genel (Sistem Varsayƒ±lanƒ±) kriterlerini UI'ye uygula
        function applySystemDefaultsCriteriaToUI() {
            try {
                const all = JSON.parse(localStorage.getItem('systemSettings_v2') || localStorage.getItem('systemSettingsFull') || 'null');
                const defaults = all?.systemDefaults || all;
                if (!defaults) return;
                // Sƒ±ra
                if (defaults.criteriaHierarchy) {
                    applyCriteriaOrderToDOM(defaults.criteriaHierarchy);
                    const orderIds = defaults.criteriaHierarchy.map(x => x.id);
                    localStorage.setItem('defaultCriteriaOrder', JSON.stringify(orderIds));
                    localStorage.setItem('criteriaOrder', JSON.stringify(orderIds));
                }
                // Etkinlik durumlarƒ±
                if (defaults.criteriaSettings) {
                    localStorage.setItem('criteriaSettings', JSON.stringify(defaults.criteriaSettings));
                }
                
                // Sabit yemekler (sistem varsayƒ±lanlarƒ±)
                if (defaults.fixedMeals) {
                    console.log('üçΩÔ∏è Sistem varsayƒ±lan sabit yemekleri y√ºkleniyor:', defaults.fixedMeals);
                    localStorage.setItem('fixedMeals', JSON.stringify(defaults.fixedMeals));
                    setTimeout(async () => {
                        await loadFixedMealsFromStorage();
                        console.log('‚úÖ Sistem varsayƒ±lan sabit yemekleri UI\'ye y√ºklendi');
                    }, 100);
                }
                
                applyCriteriaVisualFeedback();
                console.log('‚úÖ Sistem varsayƒ±lan kriterleri UI\'ye uygulandƒ±');
            } catch (e) {
                console.warn('Genel kriterleri uygulama hatasƒ±:', e);
            }
        }

        function applyCurrentWeekCriteriaToUI() {
            // Haftaya √∂zel snapshot'ƒ± uygula; aktif haftayƒ± UI'dan/hastadan √ß√∂z
            const wk = resolveActiveWeekForCriteriaPanel();
            if (!wk) return;
            // currentWeek'e yansƒ±t (tutarlƒ±lƒ±k i√ßin)
            currentWeek = wk;
            if (!wk.criteriaSnapshot) {
                // √ñncelik: uygulanmƒ±≈ü sistem ≈üablonu ‚Üí aksi halde mevcut DOM'dan yakala
                const sysCrit = wk.appliedSystemProfile?.settings?.criteria;
                wk.criteriaSnapshot = sysCrit ? { ...sysCrit } : captureCriteriaSnapshotFromDOM();
                try { console.log(`üÜï [Week ${wk.weekNumber}] criteriaSnapshot ba≈ülatƒ±ldƒ±`); } catch(_) {}
                try {
                    const pid = getCurrentPatientId && getCurrentPatientId();
                    if (pid) savePatientDetailedData(pid, currentPatient);
                } catch(_) {}
            }
            const snap = wk.criteriaSnapshot;
            // Sƒ±ra
            if (snap.hierarchy) {
                applyCriteriaOrderToDOM(snap.hierarchy);
                // localStorage ile de e≈üitle ki diƒüer akƒ±≈ülar bozulmasƒ±n
                const orderIds = snap.hierarchy
                    .slice()
                    .sort((a,b) => (a.priority||0) - (b.priority||0))
                    .map(x => x.id);
                localStorage.setItem('defaultCriteriaOrder', JSON.stringify(orderIds));
                // Eski anahtarƒ±n da uyumu i√ßin
                localStorage.setItem('criteriaOrder', JSON.stringify(orderIds));
            }
            // Etkinlik durumlarƒ±
            if (snap.enabled) {
                localStorage.setItem('criteriaSettings', JSON.stringify(snap.enabled));
            }
            // G√∂rsel/checkbox durumlarƒ±nƒ± uygula
            applyCriteriaVisualFeedback();
        }

        // Sistem Ayarlarƒ± (kriter paneli) i√ßin hafta se√ßim kontrolleri
        async function renderCriteriaWeekControls() {
            const cont = document.getElementById('criteria-week-controls');
            if (!cont) return;
            
            // JSON server'dan sistem ayarlarƒ±nƒ± y√ºkle
            let systemSettings = {};
            if (JSON_SERVER_ENABLED) {
                try {
                    const response = await fetch('http://localhost:3000/data/system_settings.json');
                    if (response.ok) {
                        systemSettings = await response.json();
                        console.log('üîÑ [Fƒ∞Zƒ∞KSEL JSON] Sistem hafta ≈üablonlarƒ± y√ºklendi:', Object.keys(systemSettings.weeklyProfiles || {}));
                    }
                } catch (e) {
                    console.warn('JSON server\'dan sistem ayarlarƒ± y√ºklenemedi, localStorage\'a ge√ßiliyor');
                }
            }
            
            // Fallback: localStorage'dan y√ºkle
            if (!systemSettings.weeklyProfiles) {
                try {
                    systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                    console.log('üîÑ [FALLBACK] Sistem ayarlarƒ± localStorage\'dan y√ºklendi');
                } catch(_) {}
            }
            
            // JSON server'dan t√ºm hasta verilerini y√ºkle (hasta hafta tablarƒ± i√ßin)
            let allPatients = [];
            if (JSON_SERVER_ENABLED) {
                try {
                    const response = await fetch('http://localhost:3000/data/patients_list.json');
                    if (response.ok) {
                        const data = await response.json();
                        allPatients = data.patients || [];
                        console.log('üîÑ [Fƒ∞Zƒ∞KSEL JSON] Hasta hafta tablarƒ± y√ºklendi:', allPatients.length, 'hasta');
                        
                        // Aktif hasta baƒülamƒ±nƒ± g√ºncelle
                        if (currentPatient) {
                            const updatedPatient = allPatients.find(p => p.id === currentPatient.id);
                            if (updatedPatient) {
                                currentPatient = updatedPatient;
                                console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Aktif hasta g√ºncellendi:', currentPatient.id);
                            }
                        } else if (allPatients.length > 0) {
                            // Hasta se√ßili deƒüilse ilk hastayƒ± se√ß
                            currentPatient = allPatients[0];
                            console.log('üîÑ [Fƒ∞Zƒ∞KSEL JSON] ƒ∞lk hasta otomatik se√ßildi:', currentPatient.id);
                        }
                    }
                } catch (e) {
                    console.warn('JSON server\'dan hasta verileri y√ºklenemedi');
                }
            }
            
            // Fallback: localStorage hasta baƒülamƒ± y√ºkleme
            if (!currentPatient && allPatients.length === 0) {
                try {
                    const pid = (typeof getCurrentPatientId === 'function') ? getCurrentPatientId() : (window.currentPatientId || null);
                    if (pid) {
                        const det = (typeof loadPatientDetailedData === 'function') ? loadPatientDetailedData(pid) : null;
                        if (det) {
                            currentPatient = det;
                            console.log('üë§ [FALLBACK] Hasta baƒülamƒ± yerelden y√ºklendi:', pid);
                        }
                    }
                    if (!currentPatient) {
                        // localStorage anahtarlarƒ±nƒ± tara, ilk bulunan detaylƒ± hasta kaydƒ±nƒ± baƒüla
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith('patient_') && k.endsWith('_detailed')) {
                                try {
                                    const obj = JSON.parse(localStorage.getItem(k) || 'null');
                                    if (obj) {
                                        currentPatient = obj;
                                        const guessedId = obj?.personalInfo?.id || obj?.id || null;
                                        if (guessedId) window.currentPatientId = guessedId;
                                        console.log('üë§ [FALLBACK] ƒ∞lk detaylƒ± hasta baƒülandƒ±:', guessedId);
                                        break;
                                    }
                                } catch(_) {}
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Hasta baƒülamƒ± y√ºklenemedi:', e);
                }
            }

            // Sistem hafta ≈üablonlarƒ±nƒ± al
            const weeklyProfiles = systemSettings.weeklyProfiles || {};
            const weekProfileKeys = Object.keys(weeklyProfiles).sort((a,b) => Number(a) - Number(b));

            // Dropdown se√ßeneklerini olu≈ütur
            let options = [`<option value="system">Genel (Sistem Varsayƒ±lanƒ±)</option>`];
            
            // Hasta haftalarƒ±nƒ± ekle (varsa)
            if (currentPatient && Array.isArray(currentPatient.weeklyPlans) && currentPatient.weeklyPlans.length > 0) {
                currentPatient.weeklyPlans.forEach(week => {
                    const desc = week.description || `otomatik olu≈üturulan ba≈ülangƒ±√ß planƒ±`;
                    options.push(`<option value="${week.weekNumber}">Hasta Hafta ${week.weekNumber}: ${desc}</option>`);
                });
            }
            
            // Sistem hafta ≈üablonlarƒ±nƒ± ekle - G√ú√áLENDIRILDI
            if (weekProfileKeys && weekProfileKeys.length > 0) {
                console.log(`üîç [DROPDOWN] ${weekProfileKeys.length} hafta ≈üablonu dropdown'a ekleniyor:`, weekProfileKeys);
                weekProfileKeys.forEach(weekNo => {
                    const profile = weeklyProfiles[weekNo];
                    const name = profile?.name || weekNo.toString();
                    const option = `<option value="template_${weekNo}">≈ûablon Hafta ${weekNo}: ${name}</option>`;
                    options.push(option);
                    console.log(`üìã [DROPDOWN] Template option eklendi: template_${weekNo} - ${name}`);
                });
            } else {
                console.log(`‚ö†Ô∏è [DROPDOWN] Hafta ≈üablonu bulunamadƒ±, sadece sistem ve hasta se√ßenekleri g√∂sterilecek`);
            }

            cont.innerHTML = `
                <label class="form-label mb-0 me-2">Aktif Hafta:</label>
                <select id="criteria-week-select" class="form-select form-select-sm" style="max-width: 320px;">
                    ${options.join('')}
                </select>
                <span id="criteria-scope-badge" class="badge bg-secondary">Kapsam: Genel</span>`;

            const sel = document.getElementById('criteria-week-select');
            if (sel) {
                sel.onchange = async () => {
                    const value = sel.value;
                    const badge = document.getElementById('criteria-scope-badge');
                    
                    // √ñNCEKƒ∞ TEMPLATE'ƒ∞N VERƒ∞LERƒ∞Nƒ∞ KAYDET
                    const previousTemplateId = getCurrentTemplateId();
                    console.log(`üîÑ [TEMPLATE-CHANGE] √ñnceki template: ${previousTemplateId}, Yeni value: ${value}`);
                    
                    if (previousTemplateId) {
                        // √ñnceki template'in kriter durumlarƒ±nƒ± kaydet
                        const allCriteriaStates = {};
                        const allCheckboxes = document.querySelectorAll('.criteria-checkbox-input');
                        allCheckboxes.forEach(cb => {
                            const cbId = cb.getAttribute('data-criteria-id');
                            if (cbId) {
                                allCriteriaStates[cbId] = cb.checked;
                            }
                        });
                        
                        console.log(`üíæ [TEMPLATE-CHANGE] √ñnceki template ${previousTemplateId} kriter durumlarƒ± kaydediliyor:`, allCriteriaStates);
                        await saveTemplateSpecificData(previousTemplateId, 'criteriaStates', allCriteriaStates);
                        
                        // Sabit yemekleri de kaydet
                        await saveFixedMealsToStorage();
                        console.log(`üíæ [TEMPLATE-CHANGE] √ñnceki template ${previousTemplateId} sabit yemekleri kaydedildi`);
                    }
                    
                    if (value === 'system') {
                        try { 
                            // Mevcut sabit yemekleri kaydet
                            await saveFixedMealsToStorage();
                            applySystemDefaultsCriteriaToUI(); 
                            await loadFixedMealsFromStorage(); // Sistem sabit yemeklerini y√ºkle
                            console.log('üçΩÔ∏è [DROPDOWN] Sistem sabit yemekleri y√ºklendi');
                        } catch(_) {}
                        if (badge) badge.textContent = 'Kapsam: Genel';
                    } else if (value.startsWith('template_')) {
                        // ≈ûablon se√ßildi - √∂nce mevcut durumu kaydet
                        try { 
                            await saveFixedMealsToStorage();
                        } catch(_) {}
                        
                        // ‚úÖ √ñNEMLƒ∞: Template uygula (sabit yemekleri de y√ºkler)
                        const weekNo = parseInt(value.replace('template_', ''));
                        await applySystemWeekProfile(weekNo);
                        
                        if (badge) badge.textContent = `Kapsam: ≈ûablon ${weekNo}`;
                    } else {
                        // Hasta haftasƒ± se√ßildi - √∂nce mevcut durumu kaydet
                        try { 
                            await saveFixedMealsToStorage();
                        } catch(_) {}
                        
                        // Hasta haftasƒ± se√ßildi
                        const weekNo = parseInt(value);
                        await selectWeekFromCriteriaPanel(weekNo);
                        if (badge) badge.textContent = `Kapsam: Hasta Hafta ${weekNo}`;
                        
                        // Hasta hafta sabit yemeklerini y√ºkle (selectWeekFromCriteriaPanel'de de var ama double-check)
                        try {
                            await loadFixedMealsFromStorage();
                            console.log(`üçΩÔ∏è [DROPDOWN] Hasta hafta ${weekNo} sabit yemekleri y√ºklendi`);
                        } catch(_) {}
                    }
                };
                
                // ƒ∞lk a√ßƒ±lƒ±≈üta sistem varsayƒ±lanƒ±nƒ± uygula
                try { applySystemDefaultsCriteriaToUI(); } catch(_) {}
            }
        }

        // Kriter panelinden hafta deƒüi≈ütir (sayfayƒ± deƒüi≈ütirmeden)
        async function selectWeekFromCriteriaPanel(weekNumber) {
            if (!currentPatient || !Array.isArray(currentPatient.weeklyPlans)) return;
            const wk = currentPatient.weeklyPlans.find(w=>w.weekNumber===weekNumber);
            if (!wk) return;
            currentWeek = wk;
            currentPatient.lastSelectedWeek = weekNumber;
            const pid = getCurrentPatientId && getCurrentPatientId();
            if (pid) try { await savePatientDetailedData(pid, currentPatient); } catch(_) {}
            
            // Hafta deƒüi≈üiminde sabit yemekleri y√ºkle
            try { 
                await loadFixedMealsFromStorage();
                console.log(`üçΩÔ∏è [KRITER PANEL] Hafta ${weekNumber} sabit yemekleri y√ºklendi`);
            } catch(_) {}
            
            // Haftanƒ±n kriter snapshotƒ±nƒ± UI'ye uygula
            try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
            // Rozeti g√ºncelle
            try { await renderCriteriaWeekControls(); } catch(_) {}
        }

        function persistWeekCriteriaOrderFromDOM() {
            const wk = resolveActiveWeekForCriteriaPanel();
            if (!wk) return;
            wk.criteriaSnapshot = wk.criteriaSnapshot || {};
            const order = getCriteriaOrderIdsFromDOM();
            wk.criteriaSnapshot.hierarchy = order.map((id, idx) => ({ id, priority: idx + 1 }));
            try { console.log(`üíæ [Week ${wk.weekNumber}] Kriter SIRASI kaydedildi:`, order); } catch(_) {}
            // Kaydet
            try {
                const pid = getCurrentPatientId && getCurrentPatientId();
                if (pid) savePatientDetailedData(pid, currentPatient);
            } catch(_) {}
        }

        function saveCriteriaEnabledForCurrentWeek() {
            const wk = resolveActiveWeekForCriteriaPanel();
            if (!wk) return;
            wk.criteriaSnapshot = wk.criteriaSnapshot || {};
            wk.criteriaSnapshot.enabled = getCriteriaEnabledMapFromDOM();
            try { console.log(`üíæ [Week ${wk.weekNumber}] Kriter TIK durumlarƒ± kaydedildi:`, wk.criteriaSnapshot.enabled); } catch(_) {}
            // Kaydet
            try {
                const pid = getCurrentPatientId && getCurrentPatientId();
                if (pid) savePatientDetailedData(pid, currentPatient);
            } catch(_) {}
        }
        
        // Yeni meal settings yapƒ±sƒ±nƒ± UI'ye y√ºkle
        function loadMealSettingsToUI(mealSettings) {
            logToConsole('üìä √ñƒü√ºn ayarlarƒ± y√ºkleniyor:', mealSettings);
            Object.keys(mealSettings).forEach(mealType => {
                const settings = mealSettings[mealType];
                const minInput = document.getElementById(`${mealType}-min`);
                const maxInput = document.getElementById(`${mealType}-max`);
                const fixedInput = document.getElementById(`${mealType}-fixed`);
                
                if (minInput && settings.min !== undefined) {
                    minInput.value = settings.min;
                    logToConsole(`üìä ${mealType} min: ${settings.min}`);
                }
                if (maxInput && settings.max !== undefined) {
                    maxInput.value = settings.max;
                    logToConsole(`üìä ${mealType} max: ${settings.max}`);
                }
                if (fixedInput && settings.fixed !== undefined && settings.fixed !== null) {
                    fixedInput.value = settings.fixed;
                    logToConsole(`üìä ${mealType} fixed: ${settings.fixed}`);
                    toggleMealRangeInputs(mealType);
                } else if (fixedInput) {
                    fixedInput.value = '';
                    toggleMealRangeInputs(mealType);
                }
            });
        }
        
        // √ñƒü√ºn yapƒ±landƒ±rmasƒ±nƒ± UI'ye y√ºkle
        function loadMealConfigurationToUI(mealConfig) {
            Object.keys(mealConfig).forEach(mealType => {
                const config = mealConfig[mealType];
                const fixedInput = document.getElementById(`${mealType}-fixed`);
                const minInput = document.getElementById(`${mealType}-min`);
                const maxInput = document.getElementById(`${mealType}-max`);
                
                if (config.type === 'fixed') {
                    if (fixedInput) fixedInput.value = config.value;
                    toggleMealRangeInputs(mealType);
                } else if (config.type === 'range') {
                    if (minInput) minInput.value = config.min;
                    if (maxInput) maxInput.value = config.max;
                    if (fixedInput) fixedInput.value = '';
                    toggleMealRangeInputs(mealType);
                }
            });
        }
        
        // √ñƒü√ºn yapƒ±landƒ±rma event listener'larƒ±nƒ± kur
        function setupMealConfigurationEvents() {
            const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
            
            mealTypes.forEach(mealType => {
                // Min/max deƒüer deƒüi≈üikliklerini izle
                const minInput = document.getElementById(`${mealType}-min`);
                const maxInput = document.getElementById(`${mealType}-max`);
                
                if (minInput && maxInput) {
                    // Min deƒüeri max'tan b√ºy√ºk olamaz kontrol√º
                    minInput.addEventListener('input', function() {
                        if (parseInt(this.value) > parseInt(maxInput.value)) {
                            maxInput.value = this.value;
                        }
                    });
                    
                    maxInput.addEventListener('input', function() {
                        if (parseInt(this.value) < parseInt(minInput.value)) {
                            minInput.value = this.value;
                        }
                    });
                }
            });
            
            // Kalori hesaplama y√∂ntemi deƒüi≈üikliklerini izle
            const calorieMethodRadios = document.querySelectorAll('input[name="defaultCalorieMethod"]');
            calorieMethodRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    calculateTargetCalories();
                    toggleCustomFormulaPanel();
                    try { updateCalorieMethodFormulaDisplay(); } catch(_){ }
                });
            });
            
            // Diyet t√ºr√º deƒüi≈üikliklerini izle
            const dietSelect = document.getElementById('system-default-diet');
            if (dietSelect) {
                dietSelect.addEventListener('change', () => {
                    // Se√ßilen diyete ait katsayƒ±larƒ± UI'ye y√ºkle
                    try { loadCustomCoefficientsForDiet(dietSelect.value); } catch(_){}
                    // Hesaplama ve √∂zetleri g√ºncelle
                    calculateTargetCalories();
                    try { updateCustomFormulaSummary(); } catch(_){}
                    try { updateRightMacrosFromTop(); } catch(_){}
                });
            }
            
            logToConsole('‚úÖ √ñƒü√ºn yapƒ±landƒ±rma event listener\'larƒ± kuruldu');
            try { updateCalorieMethodFormulaDisplay(); } catch(_){ }
        }

        // Se√ßilen diyete ait katsayƒ±larƒ± UI'ye uygula (√∂ncelik: v2 kayƒ±t > preset)
        function loadCustomCoefficientsForDiet(dietType) {
            const set = (id, val) => { const el = document.getElementById(id); if (el && Number.isFinite(+val)) el.value = val; };
            // v2 kayƒ±tlƒ± katsayƒ±larƒ± dene
            try {
                const v2 = JSON.parse(localStorage.getItem('systemSettings_v2') || 'null');
                const map = v2?.systemDefaults?.customFormula?.coeffByDiet;
                if (map && map[dietType]) {
                    set('custom-coeff-carbs', map[dietType].carbs);
                    set('custom-coeff-protein', map[dietType].protein);
                    set('custom-coeff-fat', map[dietType].fat);
                    return;
                }
            } catch(_){}
            // Kayƒ±t yoksa √∂nerilen presetleri uygula
            const presets = {
                ketojenik: { carbs: 0.3, protein: 0.8, fat: 1.2 },
                lowcarb:   { carbs: 0.6, protein: 0.8, fat: 1.0 },
                akdeniz:   { carbs: 1.2, protein: 0.8, fat: 0.9 },
                sporcu:    { carbs: 1.5, protein: 1.4, fat: 0.7 },
                gebelik:   { carbs: 1.3, protein: 1.0, fat: 0.8 }
            };
            const p = presets[dietType] || presets.lowcarb;
            set('custom-coeff-carbs', p.carbs);
            set('custom-coeff-protein', p.protein);
            set('custom-coeff-fat', p.fat);
        }

        // √ñzel form√ºl paneli ba≈ülangƒ±√ß deƒüerleri (localStorage v2 veya varsayƒ±lanlardan)
        function initCustomFormulaPanel() {
            try {
                // Varsayƒ±lan deƒüerleri ata
                const defaults = {
                    coeff: { carbs: 0.3, protein: 0.8, fat: 1.2 },
                    act: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                };
                // localStorage v2'den dene; yoksa embedded'dan al
                let v2 = null;
                try { v2 = JSON.parse(localStorage.getItem('systemSettings_v2') || 'null'); } catch(_){}
                let sysDef = v2?.systemDefaults || {};
                if (!sysDef.customFormula) {
                    try {
                        const emb = EMBEDDED_DATA?.systemSettings?.systemDefaults || EMBEDDED_DATA?.systemDefaults;
                        if (emb?.customFormula) sysDef = { ...sysDef, customFormula: emb.customFormula };
                    } catch(_){}
                }
                const store = sysDef.customFormula || {};
                const act = store.act || defaults.act;
                const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                // Aktivite √ßarpanlarƒ± (tek set)
                [1,2,3,4,5].forEach(i => setVal('custom-act-' + i, act[i]));
                // Katsayƒ±lar: se√ßili diyete g√∂re map'ten y√ºkle; yoksa preset
                const currentDiet = document.getElementById('system-default-diet')?.value || 'lowcarb';
                try { loadCustomCoefficientsForDiet(currentDiet); } catch(_) {
                    const coeff = store.coeff || defaults.coeff;
                    setVal('custom-coeff-carbs', coeff.carbs);
                    setVal('custom-coeff-protein', coeff.protein);
                    setVal('custom-coeff-fat', coeff.fat);
                }
                // Sporcuya √∂zel alanlar kaldƒ±rƒ±ldƒ±
                toggleCustomFormulaPanel();
                try { updateCustomFormulaSummary(); } catch(_){}
                try { updateRightMacrosFromTop(); } catch(_){}
            } catch (e) { console.warn('initCustomFormulaPanel hata', e); }
        }
        
        // √ñƒü√ºn t√ºrleri listesini y√ºkle
        function loadMealTypesList() {
            const container = document.getElementById('meal-types-list');
            if (!container || !systemSettings.mealStructure) return;
            
            let html = '';
            systemSettings.mealStructure.availableMealTypes.forEach(mealType => {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               ${mealType.active ? 'checked' : ''} 
                               id="meal-${mealType.id}">
                        <label class="form-check-label" for="meal-${mealType.id}">
                            ${mealType.name}
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // √ñƒü√ºn sayƒ± ayarlarƒ±nƒ± y√ºkle
        function loadMealCountsSettings() {
            const container = document.getElementById('meal-counts-settings');
            if (!container || !systemSettings.mealStructure) return;
            
            let html = '';
            Object.keys(systemSettings.mealStructure.defaultMealCounts).forEach(mealId => {
                const settings = systemSettings.mealStructure.defaultMealCounts[mealId];
                const mealName = systemSettings.mealStructure.availableMealTypes
                    .find(m => m.id === mealId)?.name || mealId;
                
                html += `
                    <div class="mb-3">
                        <label class="form-label">${mealName}</label>
                        <div class="row">
                            <div class="col-md-4">
                                <input type="number" class="form-control form-control-sm" 
                                       placeholder="Min" value="${settings.min}" 
                                       id="meal-count-${mealId}-min">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control form-control-sm" 
                                       placeholder="Max" value="${settings.max}" 
                                       id="meal-count-${mealId}-max">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control form-control-sm" 
                                       placeholder="Sabit" value="${settings.fixed || ''}" 
                                       id="meal-count-${mealId}-fixed">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Sistem ≈üablonlarƒ±nƒ± listele
        function loadSystemTemplatesList() {
            const container = document.getElementById('system-templates-list');
            if (!container || !systemSettings.systemTemplates) return;
            
            let html = '';
            systemSettings.systemTemplates.forEach(template => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${template.name}</strong>
                                    <small class="text-muted d-block">${template.description}</small>
                                    <small class="badge bg-info">${template.dietType}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editTemplate('${template.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteTemplate('${template.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Hasta takibi sayfasƒ±nƒ± y√ºkle
        function loadPatientTrackingPage() {
            logToConsole('üë®‚Äç‚öïÔ∏è Hasta takibi sayfasƒ± y√ºkleniyor...');
            
            // Debug: Container kontrol√º
            const container = document.getElementById('patients-list');
            if (!container) {
                logToConsole('‚ùå patients-list container bulunamadƒ±!');
                return;
            }
            
            // üîß √ñNCE VERƒ∞ HAZIRLIiI YAP - Bu satƒ±r √∂nemli!
            // UsersData'nƒ±n hazƒ±r olduƒüundan emin ol
            if (!usersData || !usersData.patients) {
                logToConsole('‚ö†Ô∏è UsersData eksik, yeniden y√ºkleniyor...');
                // Veri hazƒ±rlama i≈ülemini √ßaƒüƒ±r
                loadUsersLists();
                
                // Yine de eksikse localStorage'dan y√ºkle
                if (!usersData || !usersData.patients) {
                    logToConsole('ÔøΩ localStorage\'dan direkt veri y√ºkleme deneniyor...');
                    const savedData = localStorage.getItem('usersData');
                    if (savedData) {
                        try {
                            usersData = JSON.parse(savedData);
                            logToConsole(`‚úÖ localStorage'dan ${usersData.patients?.length || 0} hasta y√ºklendi`);
                        } catch (error) {
                            logToConsole('‚ùå localStorage parse hatasƒ±: ' + error.message);
                            return;
                        }
                    } else {
                        logToConsole('‚ùå localStorage\'da usersData bulunamadƒ±');
                        return;
                    }
                }
            }
            
            // Debug: Final data validation
            if (!usersData || !usersData.patients) {
                logToConsole('‚ùå T√ºm y√ºkleme denemeleri ba≈üarƒ±sƒ±z!');
                logToConsole(`üìä usersData: ${usersData ? 'VAR' : 'YOK'}`);
                logToConsole(`üìä patients: ${usersData?.patients ? usersData.patients.length : '0'}`);
                return;
            }
            
            logToConsole(`üìä Hasta takibi i√ßin ${usersData.patients.length} hasta y√ºkleniyor...`);
            
            // Hasta listesini y√ºkle
            loadPatientsList();
            
            // Debug: HTML i√ßeriƒüi kontrol√º
            const html = container.innerHTML;
            logToConsole(`üìã Hasta listesi HTML uzunluƒüu: ${html.length} karakter`);
            
            if (html.length === 0) {
                logToConsole('‚ö†Ô∏è HTML bo≈ü! Zorla yeniden y√ºkleme deneniyor...');
                // Zorla yeniden y√ºkle
                setTimeout(() => {
                    loadPatientsList();
                    logToConsole(`ÔøΩ Zorla yeniden y√ºkleme: ${container.innerHTML.length} karakter`);
                }, 100);
            }
            
            logToConsole('‚úÖ Hasta takibi sayfasƒ± y√ºklendi');
            
            // üîß EK DEBUG: Final durumu kontrol et
            setTimeout(() => {
                const finalContainer = document.getElementById('patients-list');
                if (finalContainer) {
                    const finalLength = finalContainer.innerHTML.length;
                    logToConsole(`üéØ FINAL DURUM: patients-list container = ${finalLength} karakter`);
                    
                    if (finalLength === 0) {
                        logToConsole('üö® PROBLEM TESPƒ∞T EDƒ∞LDƒ∞: Container bo≈ü kaldƒ±!');
                        logToConsole('üîß Acil √ß√∂z√ºm deneniyor...');
                        // Acil √ß√∂z√ºm: Doƒürudan yeniden y√ºkle
                        loadPatientsList();
                    } else {
                        logToConsole(`‚úÖ Hasta listesi ba≈üarƒ±yla y√ºklendi: ${finalContainer.querySelectorAll('.patient-card').length} kart`);
                    }
                } else {
                    logToConsole('‚ùå CRITICAL: patients-list container hi√ß bulunamadƒ±!');
                }
            }, 200);
        }
        
        // Hasta listesini y√ºkle
        function loadPatientsList() {
            const container = document.getElementById('patients-list');
            
            // Debug: Detaylƒ± kontroller
            logToConsole('üîÑ Hasta listesi y√ºkleniyor...');
            logToConsole(`üìç Container: ${container ? 'BULUNDU' : 'BULUNAMADI'}`);
            
            if (!container) {
                logToConsole('‚ùå patients-list container element bulunamadƒ±!');
                return;
            }
            
            if (!usersData) {
                logToConsole('‚ùå usersData global deƒüi≈ükeni bulunamadƒ±!');
                return;
            }
            
            if (!usersData.patients) {
                logToConsole('‚ùå usersData.patients array bulunamadƒ±!');
                logToConsole(`üîç usersData yapƒ±sƒ±: ${JSON.stringify(Object.keys(usersData))}`);
                return;
            }
            
            if (usersData.patients.length === 0) {
                logToConsole('‚ö†Ô∏è usersData.patients array bo≈ü!');
                container.innerHTML = '<div class="alert alert-warning">Hen√ºz hasta kaydƒ± yok.</div>';
                return;
            }
            
            logToConsole(`üìä ${usersData.patients.length} hasta bulundu`);
            
            let html = '';
            usersData.patients.forEach((patient, index) => {
                logToConsole(`üè• Hasta ${index + 1}: ${patient.firstName} ${patient.lastName} (${patient.id})`);
                
                html += `
                    <div class="patient-card" onclick="selectPatient('${patient.id}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong>${patient.firstName} ${patient.lastName}</strong>
                                <small class="text-muted d-block">ID: ${patient.id}</small>
                                <span class="badge bg-success">${patient.status || 'aktif'}</span>
                            </div>
                            <div class="btn-group-vertical btn-group-sm" onclick="event.stopPropagation();">
                                <button class="btn btn-outline-info btn-sm" onclick="viewPatientJSON('${patient.id}')" title="JSON G√∂r√ºnt√ºle" style="font-size: 10px; padding: 2px 5px;">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="editPatient('${patient.id}')" title="D√ºzenle" style="font-size: 10px; padding: 2px 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deletePatient('${patient.id}')" title="Sil" style="font-size: 10px; padding: 2px 5px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            logToConsole(`üìã HTML olu≈üturuldu: ${html.length} karakter`);
            
            // üîß CRITICAL DEBUG: HTML i√ßeriƒüini kontrol et
            if (html.length > 0) {
                logToConsole(`üìÑ ƒ∞lk hasta kartƒ± √∂rneƒüi: ${html.substring(0, 200)}...`);
            } else {
                logToConsole('‚ùå HTML tamamen bo≈ü - hastalar d√∂ng√ºye girmiyor!');
            }
            
            container.innerHTML = html;
            logToConsole(`‚úÖ Hasta listesi container'a yerle≈ütirildi`);
            
            // üîß SON KONTROL: Container'ƒ±n DOM'daki durumunu kontrol et
            setTimeout(() => {
                const finalCheck = document.getElementById('patients-list');
                if (finalCheck) {
                    logToConsole(`üîç Son kontrol - Container i√ßeriƒüi: ${finalCheck.innerHTML.length} karakter`);
                    if (finalCheck.innerHTML.length === 0) {
                        logToConsole('‚ùå HATA: Container i√ßeriƒüi silindi veya g√ºncellemede sorun var!');
                    } else {
                        logToConsole(`‚úÖ Container ba≈üarƒ±yla dolu - ƒ∞lk 100 karakter: ${finalCheck.innerHTML.substring(0, 100)}...`);
                    }
                } else {
                    logToConsole('‚ùå SON KONTROL: patients-list container kayboldu!');
                }
            }, 50);
        }
        
        // Hasta Y√∂netimi Fonksiyonlarƒ±
        
        // Hasta y√∂netimi modalƒ±nƒ± g√∂ster
        function showPatientManagement() {
            loadPatientsManagementTable();
            const modal = new bootstrap.Modal(document.getElementById('patientManagementModal'));
            modal.show();
        }
        
        // Hasta y√∂netimi tablosunu y√ºkle
        function loadPatientsManagementTable() {
            const tbody = document.getElementById('patients-management-table');
            if (!tbody || !usersData.patients) return;
            
            let html = '';
            usersData.patients.forEach(patient => {
                const dietName = getDietDisplayName(patient.dietType || 'lowcarb');
                html += `
                    <tr>
                        <td>${patient.id}</td>
                        <td>${patient.firstName} ${patient.lastName}</td>
                        <td>${patient.age || 'N/A'}</td>
                        <td>${patient.gender || 'N/A'}</td>
                        <td>${patient.phone || 'N/A'}</td>
                        <td>${dietName}</td>
                        <td>
                            <span class="badge ${patient.status === 'aktif' ? 'bg-success' : patient.status === 'pasif' ? 'bg-danger' : 'bg-warning'}">
                                ${patient.status || 'aktif'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editPatient('${patient.id}')" title="D√ºzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Diyet g√∂r√ºnt√ºleme adƒ±nƒ± al
        function getDietDisplayName(dietType) {
            const dietNames = {
                'ketojenik': 'ü•ë Ketojenik',
                'lowcarb': 'ü•© D√º≈ü√ºk Karbonhidrat', 
                'akdeniz': 'üêü Akdeniz',
                'sporcu': 'üí™ Sporcu',
                'gebelik': 'ü§± Gebelik'
            };
            return dietNames[dietType] || dietType;
        }
        
        // Hasta d√ºzenle modalƒ±nƒ± a√ß
        function editPatient(patientId) {
            // √ñnce temel hasta bilgisini bul
            const basicPatient = usersData.patients.find(p => p.id === patientId);
            if (!basicPatient) {
                try { showToast('Hasta bulunamadƒ±!', 'error'); } catch(_){ alert('Hasta bulunamadƒ±!'); }
                return;
            }
            
            // Detaylƒ± hasta verisini y√ºkle
            const detailedPatient = loadPatientDetailedData(patientId);
            
            // En g√ºncel verileri kullan (detaylƒ± veri varsa onu, yoksa temel veriyi)
            const patientData = detailedPatient || basicPatient;
            
            logToConsole(`‚úèÔ∏è Hasta d√ºzenleme a√ßƒ±lƒ±yor: ${patientId}`);
            logToConsole(`üìä Detaylƒ± veri: ${detailedPatient ? 'VAR' : 'YOK'}`);
            
            // Form alanlarƒ±nƒ± doldur - detaylƒ± veriden veya temel veriden
            document.getElementById('edit-patient-id').value = patientId;
            
            if (detailedPatient && detailedPatient.personalInfo) {
                // Detaylƒ± veriden doldur
                const info = detailedPatient.personalInfo;
                const healthInfo = detailedPatient.healthInfo || {};
                const nutritionPref = detailedPatient.nutritionPreferences || {};
                const goals = detailedPatient.nutritionGoals || {};
                
                // Temel bilgiler
                document.getElementById('edit-firstName').value = info.firstName || '';
                document.getElementById('edit-lastName').value = info.lastName || '';
                document.getElementById('edit-age').value = info.age || '';
                document.getElementById('edit-gender').value = info.gender || 'kadƒ±n';
                document.getElementById('edit-phone').value = info.phone || '';
                document.getElementById('edit-height').value = info.height || '';
                document.getElementById('edit-weight').value = info.weight || '';
                document.getElementById('edit-activity').value = info.activityLevel || '3';
                
                // Saƒülƒ±k bilgileri
                document.getElementById('edit-diseases').value = healthInfo.diseases || '';
                document.getElementById('edit-allergies').value = healthInfo.allergies || '';
                document.getElementById('edit-medications').value = healthInfo.medications || '';
                
                // Beslenme tercihleri
                document.getElementById('edit-likedFoods').value = nutritionPref.likedFoods || '';
                document.getElementById('edit-dislikedFoods').value = nutritionPref.dislikedFoods || '';
                document.getElementById('edit-diet').value = nutritionPref.dietType || 'lowcarb';
                
                // Kalori hesaplama y√∂ntemi
                const calorieMethod = goals.calorieCalculationMethod || 'custom';
                document.querySelector(`input[name="edit-calorieMethod"][value="${calorieMethod}"]`).checked = true;
                
                // Makro hedefler
                document.getElementById('edit-targetCarbs').value = goals.targetCarbs || '';
                document.getElementById('edit-targetProtein').value = goals.targetProtein || '';
                document.getElementById('edit-targetFat').value = goals.targetFat || '';
                document.getElementById('edit-targetCalories').value = goals.targetCalories || '';
                
                // Notlar
                document.getElementById('edit-notes').value = healthInfo.notes || '';
                
                console.log('‚úÖ Detaylƒ± hasta verisi form alanlarƒ±na y√ºklendi');
            } else {
                // Temel veriden doldur
                document.getElementById('edit-firstName').value = basicPatient.firstName || '';
                document.getElementById('edit-lastName').value = basicPatient.lastName || '';
                document.getElementById('edit-age').value = basicPatient.age || '';
                document.getElementById('edit-gender').value = basicPatient.gender || 'kadƒ±n';
                document.getElementById('edit-phone').value = basicPatient.phone || '';
                document.getElementById('edit-height').value = basicPatient.height || '';
                document.getElementById('edit-weight').value = basicPatient.weight || '';
                document.getElementById('edit-activity').value = basicPatient.activityLevel || '3';
                document.getElementById('edit-diet').value = basicPatient.dietType || 'lowcarb';
                document.getElementById('edit-notes').value = basicPatient.notes || '';
                
                // Diƒüer alanlarƒ± temizle
                document.getElementById('edit-diseases').value = '';
                document.getElementById('edit-allergies').value = '';
                document.getElementById('edit-medications').value = '';
                document.getElementById('edit-likedFoods').value = '';
                document.getElementById('edit-dislikedFoods').value = '';
                document.getElementById('edit-targetCarbs').value = '';
                document.getElementById('edit-targetProtein').value = '';
                document.getElementById('edit-targetFat').value = '';
                document.getElementById('edit-targetCalories').value = '';
                
                console.log('‚ö†Ô∏è Sadece temel hasta verisi y√ºklendi');
            }
            
            // Durum her zaman temel veriden (√ß√ºnk√º detaylƒ± veride farklƒ± yerde)
            document.getElementById('edit-status').value = basicPatient.status || 'aktif';
            
            // Deƒüi≈üiklik ge√ßmi≈üini y√ºkle
            loadPatientChangeHistory(patientId);
            
            // Modalƒ± a√ß
            const modal = new bootstrap.Modal(document.getElementById('editPatientModal'));
            modal.show();
            
            // Makrolarƒ± hesapla
            setTimeout(() => {
                calculateEditMacros();
            }, 100);
            
            logToConsole(`‚úÖ Hasta d√ºzenleme formu dolduruldu`);
        }
        
        // Mevcut se√ßili hastayƒ± d√ºzenle
        function editCurrentPatient() {
            if (!currentPatient || !currentPatient.personalInfo) {
                try { showToast('√ñnce bir hasta se√ßin!', 'warning'); } catch(_){ alert('√ñnce bir hasta se√ßin!'); }
                return;
            }
            
            const patientId = currentPatient.personalInfo.id || getCurrentPatientId();
            if (patientId) {
                editPatient(patientId);
            } else {
                try { showToast('Hasta ID bulunamadƒ±!', 'error'); } catch(_){ alert('Hasta ID bulunamadƒ±!'); }
            }
        }
        
        // Hasta g√ºncelle
        async function updatePatient() {
            const patientId = document.getElementById('edit-patient-id').value;
            const firstName = document.getElementById('edit-firstName').value.trim();
            const lastName = document.getElementById('edit-lastName').value.trim();
            const age = parseInt(document.getElementById('edit-age').value);
            const weight = parseFloat(document.getElementById('edit-weight').value);
            const height = parseInt(document.getElementById('edit-height').value);
            
            if (!firstName || !lastName || !age || !weight || !height) {
                try { showToast('L√ºtfen zorunlu alanlarƒ± doldurun!', 'warning'); } catch(_){ alert('L√ºtfen zorunlu alanlarƒ± doldurun!'); }
                return;
            }
            
            console.log('üìù G√ºncelleme ba≈ülatƒ±lƒ±yor:', { patientId, firstName, lastName, age, weight, height });
            
            // Hasta verilerini g√ºncelle
            const patientIndex = usersData.patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) {
                try { showToast('Hasta bulunamadƒ±!', 'error'); } catch(_){ alert('Hasta bulunamadƒ±!'); }
                return;
            }
            
            // Eski veriler (deƒüi≈üiklikleri takip etmek i√ßin)
            const oldPatient = JSON.parse(JSON.stringify(usersData.patients[patientIndex]));
            
            // Form verilerini al
            const newData = {
                firstName: firstName,
                lastName: lastName,
                age: age,
                gender: document.getElementById('edit-gender').value,
                phone: document.getElementById('edit-phone').value,
                height: height,
                weight: weight,
                activityLevel: parseInt(document.getElementById('edit-activity').value),
                dietType: document.getElementById('edit-diet').value,
                status: document.getElementById('edit-status').value,
                notes: document.getElementById('edit-notes').value,
                
                // Yeni alanlar
                diseases: document.getElementById('edit-diseases').value,
                allergies: document.getElementById('edit-allergies').value,
                medications: document.getElementById('edit-medications').value,
                likedFoods: document.getElementById('edit-likedFoods').value,
                dislikedFoods: document.getElementById('edit-dislikedFoods').value,
                
                // Makro hedefler
                targetCarbs: parseFloat(document.getElementById('edit-targetCarbs').value) || 0,
                targetProtein: parseFloat(document.getElementById('edit-targetProtein').value) || 0,
                targetFat: parseFloat(document.getElementById('edit-targetFat').value) || 0,
                targetCalories: parseFloat(document.getElementById('edit-targetCalories').value) || 0,
                calorieCalculationMethod: document.querySelector('input[name="edit-calorieMethod"]:checked')?.value || 'custom'
            };
            
            // Deƒüi≈üiklikleri kaydet
            const changes = trackPatientChanges(oldPatient, newData, patientId);
            
            // G√ºncellenen bilgileri kaydet (basit veri)
            usersData.patients[patientIndex] = {
                ...usersData.patients[patientIndex],
                ...newData,
                updatedAt: new Date().toISOString()
            };
            
            // Detaylƒ± hasta JSON'unu y√ºkle veya olu≈ütur
            let detailedPatient = loadPatientDetailedData(patientId);
            
            if (!detailedPatient) {
                console.log('üÜï Yeni detaylƒ± JSON olu≈üturuluyor...');
                detailedPatient = createDetailedPatientData(newData, patientId);
            } else {
                console.log('üìã Mevcut detaylƒ± JSON g√ºncelleniyor...');
                
                // Ki≈üisel bilgiler
                detailedPatient.personalInfo = {
                    ...detailedPatient.personalInfo,
                    id: patientId,
                    firstName: firstName,
                    lastName: lastName,
                    age: age,
                    gender: newData.gender,
                    phone: newData.phone,
                    height: height,
                    weight: weight,
                    activityLevel: newData.activityLevel,
                    updatedAt: new Date().toISOString()
                };
                
                // Saƒülƒ±k bilgileri
                detailedPatient.healthInfo = {
                    ...detailedPatient.healthInfo,
                    diseases: newData.diseases,
                    allergies: newData.allergies,
                    medications: newData.medications,
                    notes: newData.notes,
                    updatedAt: new Date().toISOString()
                };
                
                // Beslenme tercihleri
                detailedPatient.nutritionPreferences = {
                    ...detailedPatient.nutritionPreferences,
                    dietType: newData.dietType,
                    likedFoods: newData.likedFoods,
                    dislikedFoods: newData.dislikedFoods,
                    updatedAt: new Date().toISOString()
                };
                
                // Beslenme hedefleri
                detailedPatient.nutritionGoals = {
                    ...detailedPatient.nutritionGoals,
                    targetCarbs: newData.targetCarbs,
                    targetProtein: newData.targetProtein,
                    targetFat: newData.targetFat,
                    targetCalories: newData.targetCalories,
                    calorieCalculationMethod: newData.calorieCalculationMethod,
                    updatedAt: new Date().toISOString()
                };
                
                // Deƒüi≈üiklik ge√ßmi≈üini ekle
                if (!detailedPatient.changeHistory) {
                    detailedPatient.changeHistory = [];
                }
                
                if (changes.length > 0) {
                    detailedPatient.changeHistory.push({
                        timestamp: new Date().toISOString(),
                        changes: changes,
                        updatedBy: 'System'
                    });
                }
            }
            
            // Detaylƒ± JSON'u localStorage'a kaydet
            localStorage.setItem(`patient_${patientId}`, JSON.stringify(detailedPatient));
            console.log('‚úÖ Detaylƒ± JSON ba≈üarƒ±yla g√ºncellendi');
            
            // JSON dosyasƒ±na kaydet (localStorage yerine)
            await saveUsersData();
            
            // JSON dosyasƒ±na da kaydet (t√ºm browser'larda g√∂r√ºnmesi i√ßin)
            try {
                await updateJsonFile('/data/patients_list.json', (json) => {
                    // usersData'yƒ± JSON formatƒ±na d√∂n√º≈üt√ºr
                    if (Array.isArray(usersData)) {
                        json.patients = usersData.map(user => ({
                            id: user.id,
                            name: user.name || user.personalInfo?.name,
                            email: user.email || user.personalInfo?.email,
                            type: user.type || 'patient',
                            createdAt: user.createdAt || new Date().toISOString(),
                            personalInfo: user.personalInfo,
                            nutritionalRequirements: user.nutritionalRequirements,
                            weeklyData: user.weeklyData
                        }));
                    } else {
                        json.patients = [];
                    }
                    json.lastUpdated = new Date().toISOString();
                    return json;
                });
                console.log('üóÇÔ∏è Kullanƒ±cƒ± verileri JSON dosyasƒ±na kaydedildi');
            } catch (error) {
                console.error('‚ùå Kullanƒ±cƒ± verileri JSON kaydetme hatasƒ±:', error);
            }
            
            // Mevcut hasta se√ßiliyse bilgilerini g√ºncelle
            if (currentPatient && currentPatient.personalInfo && currentPatient.personalInfo.id === patientId) {
                console.log('üîÑ Mevcut hasta bilgileri g√ºncelleniyor...');
                
                // currentPatient nesnesini detaylƒ± verilerle g√ºncelle
                currentPatient = detailedPatient || {
                    personalInfo: {
                        id: patientId,
                        firstName: firstName,
                        lastName: lastName,
                        age: age,
                        gender: document.getElementById('edit-gender').value,
                        phone: document.getElementById('edit-phone').value,
                        height: height,
                        weight: weight
                    },
                    preferences: {
                        activityLevel: parseInt(document.getElementById('edit-activity').value),
                        dietType: document.getElementById('edit-diet').value
                    }
                };
                
                // Hasta bilgilerini yeniden y√ºkle
                loadPatientInfo();
            }
            
            // Listeleri g√ºncelle
            loadPatientsList();
            loadPatientsManagementTable();
            
            // Modal'ƒ± kapat
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPatientModal'));
            modal.hide();
            
            // Ba≈üarƒ± mesajƒ±
            logToConsole(`‚úÖ Hasta g√ºncellendi: ${firstName} ${lastName} - ${changes.length} deƒüi≈üiklik yapƒ±ldƒ±`);
            try { showToast(`Hasta bilgileri g√ºncellendi (${changes.length} alan)`, 'success'); } catch(_){ }
        }
        
        // Deƒüi≈üiklikleri takip et
        function trackPatientChanges(oldData, newData, patientId) {
            const changes = [];
            const fieldNames = {
                firstName: 'Ad',
                lastName: 'Soyad',
                age: 'Ya≈ü',
                gender: 'Cinsiyet',
                phone: 'Telefon',
                height: 'Boy',
                weight: 'Kilo',
                activityLevel: 'Aktivite D√ºzeyi',
                dietType: 'Diyet T√ºr√º',
                status: 'Durum',
                notes: 'Notlar',
                diseases: 'Ek Hastalƒ±klar',
                allergies: 'Alerjiler',
                medications: 'ƒ∞la√ßlar',
                likedFoods: 'Sevilen Yemekler',
                dislikedFoods: 'Sevmediƒüi Yemekler',
                targetCarbs: 'Hedef Karbonhidrat',
                targetProtein: 'Hedef Protein',
                targetFat: 'Hedef Yaƒü',
                targetCalories: 'Hedef Kalori',
                calorieCalculationMethod: 'Kalori Hesaplama Y√∂ntemi'
            };
            
            for (const field in fieldNames) {
                const oldValue = oldData[field] || '';
                const newValue = newData[field] || '';
                
                if (oldValue != newValue) {
                    changes.push({
                        field: field,
                        fieldName: fieldNames[field],
                        oldValue: oldValue,
                        newValue: newValue,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log(`üìù Deƒüi≈üiklik: ${fieldNames[field]} "${oldValue}" ‚Üí "${newValue}"`);
                }
            }
            
            return changes;
        }
        
        // Detaylƒ± hasta verisi olu≈ütur
        function createDetailedPatientData(data, patientId) {
            return {
                personalInfo: {
                    id: patientId,
                    firstName: data.firstName,
                    lastName: data.lastName,
                    age: data.age,
                    gender: data.gender,
                    phone: data.phone,
                    height: data.height,
                    weight: data.weight,
                    activityLevel: data.activityLevel,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },
                healthInfo: {
                    diseases: data.diseases || '',
                    allergies: data.allergies || '',
                    medications: data.medications || '',
                    notes: data.notes || '',
                    updatedAt: new Date().toISOString()
                },
                nutritionPreferences: {
                    dietType: data.dietType,
                    likedFoods: data.likedFoods || '',
                    dislikedFoods: data.dislikedFoods || '',
                    updatedAt: new Date().toISOString()
                },
                nutritionGoals: {
                    targetCarbs: data.targetCarbs || 0,
                    targetProtein: data.targetProtein || 0,
                    targetFat: data.targetFat || 0,
                    targetCalories: data.targetCalories || 0,
                    calorieCalculationMethod: data.calorieCalculationMethod || 'custom',
                    updatedAt: new Date().toISOString()
                },
                changeHistory: [{
                    timestamp: new Date().toISOString(),
                    changes: ['Hasta kaydƒ± olu≈üturuldu'],
                    updatedBy: 'System'
                }],
                status: data.status || 'aktif'
            };
        }
        
        // Edit modalƒ± i√ßin makro hesaplama
        function calculateEditMacros() {
            const weight = parseFloat(document.getElementById('edit-weight').value);
            const height = parseInt(document.getElementById('edit-height').value);
            const age = parseInt(document.getElementById('edit-age').value);
            const gender = document.getElementById('edit-gender').value;
            const activityLevel = parseInt(document.getElementById('edit-activity').value);
            const dietType = document.getElementById('edit-diet').value;
            const method = document.querySelector('input[name="edit-calorieMethod"]:checked')?.value;
            
            if (!weight || !height || !age || !activityLevel || !dietType) {
                return;
            }
            
            let calories, carbs, protein, fat;
            
            if (method === 'harris') {
                // Harris-Benedict form√ºl√º
                let bmr;
                if (gender === 'erkek') {
                    bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }
                
                const activityMultipliers = [0, 1.2, 1.375, 1.55, 1.725, 1.9];
                calories = Math.round(bmr * activityMultipliers[activityLevel]);
            } else {
                // √ñzel form√ºl
                const baseCarbs = weight * 0.6;
                const baseProtein = weight * 0.8;
                const baseFat = weight * 1.2;
                
                const activityMultipliers = [0, 1.0, 1.1, 1.2, 1.3, 1.4];
                const multiplier = activityMultipliers[activityLevel];
                
                carbs = Math.round(baseCarbs * multiplier);
                protein = Math.round(baseProtein * multiplier);
                fat = Math.round(baseFat * multiplier);
                calories = Math.round((carbs * 4) + (protein * 4) + (fat * 9));
            }
            
            // Diyet t√ºr√ºne g√∂re ayarlama
            const dietAdjustments = {
                ketojenik: { carbs: 0.1, protein: 1.0, fat: 1.5 },
                lowcarb: { carbs: 0.3, protein: 1.2, fat: 1.3 },
                akdeniz: { carbs: 1.0, protein: 1.0, fat: 1.0 },
                sporcu: { carbs: 1.3, protein: 1.5, fat: 0.8 },
                gebelik: { carbs: 1.2, protein: 1.3, fat: 1.1 }
            };
            
            if (method !== 'harris' && dietAdjustments[dietType]) {
                const adj = dietAdjustments[dietType];
                carbs = Math.round(carbs * adj.carbs);
                protein = Math.round(protein * adj.protein);
                fat = Math.round(fat * adj.fat);
                calories = Math.round((carbs * 4) + (protein * 4) + (fat * 9));
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('edit-targetCarbs').value = carbs || '';
            document.getElementById('edit-targetProtein').value = protein || '';
            document.getElementById('edit-targetFat').value = fat || '';
            document.getElementById('edit-targetCalories').value = calories || '';
            
            // Hesaplama detaylarƒ±nƒ± g√∂ster
            const details = `${method === 'harris' ? 'Harris-Benedict' : '√ñzel Form√ºl'} | ${dietType} | Aktivite: ${activityLevel}`;
            document.getElementById('edit-calculation-details').textContent = details;
            document.getElementById('edit-macro-breakdown').style.display = 'block';
        }
        
        // Hasta deƒüi≈üiklik ge√ßmi≈üini y√ºkle
        function loadPatientChangeHistory(patientId) {
            const detailedPatient = loadPatientDetailedData(patientId);
            const historyDiv = document.getElementById('edit-changes-history');
            
            if (!detailedPatient || !detailedPatient.changeHistory || detailedPatient.changeHistory.length === 0) {
                historyDiv.innerHTML = '<small class="text-muted">Hen√ºz deƒüi≈üiklik kaydƒ± bulunmuyor...</small>';
                return;
            }
            
            let historyHTML = '';
            detailedPatient.changeHistory.slice(-10).reverse().forEach(entry => {
                const date = new Date(entry.timestamp).toLocaleString('tr-TR');
                historyHTML += `<div class="border-bottom pb-2 mb-2">`;
                historyHTML += `<small class="text-primary fw-bold">${date}</small><br>`;
                
                if (Array.isArray(entry.changes)) {
                    if (typeof entry.changes[0] === 'string') {
                        historyHTML += `<small>${entry.changes.join(', ')}</small>`;
                    } else {
                        entry.changes.forEach(change => {
                            historyHTML += `<small><strong>${change.fieldName}:</strong> "${change.oldValue}" ‚Üí "${change.newValue}"</small><br>`;
                        });
                    }
                }
                
                historyHTML += `</div>`;
            });
            
            historyDiv.innerHTML = historyHTML;
        }
        
        // Hasta sil
        async function deletePatient(patientId) {
            const patient = usersData.patients.find(p => p.id === patientId);
            if (!patient) {
                try { showToast('Hasta bulunamadƒ±!', 'error'); } catch(_){ alert('Hasta bulunamadƒ±!'); }
                return;
            }
            
            // Onay yerine bilgi ama√ßlƒ± toast; √ºretimde modal onay kullanƒ±labilir
            try { showToast(`${patient.firstName} ${patient.lastName} siliniyor...`, 'warning'); } catch(_){}
                console.log('üóëÔ∏è Hasta silme i≈ülemi ba≈ülatƒ±lƒ±yor:', patientId);
                
                // Hastayƒ± listeden √ßƒ±kar
                usersData.patients = usersData.patients.filter(p => p.id !== patientId);
                
                // Detaylƒ± JSON'u da sil
                try {
                    localStorage.removeItem(`patient_${patientId}`);
                    console.log('‚úÖ Detaylƒ± JSON ba≈üarƒ±yla silindi:', `patient_${patientId}`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Detaylƒ± JSON silinirken hata:', error);
                }
                
                // JSON dosyasƒ±na kaydet (localStorage yerine)
                await saveUsersData();
                
                // Mevcut hasta se√ßiliyse se√ßimi temizle
                if (currentPatient && currentPatient.personalInfo && currentPatient.personalInfo.id === patientId) {
                    currentPatient = null;
                    window.currentPatientId = null;
                    document.getElementById('patient-details').style.display = 'none';
                    document.getElementById('no-patient-selected').style.display = 'block';
                    console.log('üîÑ Mevcut hasta se√ßimi temizlendi');
                }
                
                // Listeleri g√ºncelle
                loadPatientsList();
                loadPatientsManagementTable();
                
                // Ba≈üarƒ± mesajƒ±
                logToConsole(`üóëÔ∏è Hasta silindi: ${patient.firstName} ${patient.lastName}`);
        try { showToast('Hasta ba≈üarƒ±yla silindi!', 'success'); } catch(_){ }
    }
        
        // Mevcut se√ßili hastayƒ± sil
        function deleteCurrentPatient() {
            if (!currentPatient || !currentPatient.personalInfo) {
                try { showToast('√ñnce bir hasta se√ßin!', 'warning'); } catch(_){ alert('√ñnce bir hasta se√ßin!'); }
                return;
            }
            
            const patientId = currentPatient.personalInfo.id || getCurrentPatientId();
            if (patientId) {
                deletePatient(patientId);
            } else {
                try { showToast('Hasta ID bulunamadƒ±!', 'error'); } catch(_){ alert('Hasta ID bulunamadƒ±!'); }
            }
        }
        
        // Yeni hasta ekle
        function addNewPatient() {
            // Users sayfasƒ±na y√∂nlendir
            showPage('users');
            
            // Hasta formunu a√ß
            document.getElementById('userType').value = 'patient';
            showUserForm();
            
            // Modal'larƒ± kapat
            const managementModal = bootstrap.Modal.getInstance(document.getElementById('patientManagementModal'));
            if (managementModal) managementModal.hide();
        }
        
        // Hasta JSON'unu g√∂r√ºnt√ºle
        function viewPatientJSON(patientId) {
            const detailedData = loadPatientDetailedData(patientId);
            
            if (!detailedData) {
                try { showToast('Bu hasta i√ßin detaylƒ± JSON verisi bulunamadƒ±!', 'error'); } catch(_){ alert('Bu hasta i√ßin detaylƒ± JSON verisi bulunamadƒ±!'); }
                return;
            }
            
            // JSON'u g√ºzelce formatla ve yeni pencerede g√∂ster
            const formattedJSON = JSON.stringify(detailedData, null, 2);
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            
            newWindow.document.write(`
                <html>
                    <head>
                        <title>Hasta JSON - ${detailedData.personalInfo.firstName} ${detailedData.personalInfo.lastName}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                margin: 20px; 
                                background: #1e1e1e; 
                                color: #d4d4d4; 
                            }
                            .json-container {
                                background: #252526;
                                padding: 20px;
                                border-radius: 8px;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                                border: 1px solid #333;
                            }
                            .header {
                                background: #007acc;
                                color: white;
                                padding: 10px 20px;
                                border-radius: 8px 8px 0 0;
                                margin: -20px -20px 20px -20px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="json-container">
                            <div class="header">
                                <h2>üìã Hasta Detay JSON - ${detailedData.personalInfo.firstName} ${detailedData.personalInfo.lastName}</h2>
                                <p>Hasta ID: ${patientId} | G√ºncelleme: ${detailedData.lastUpdated}</p>
                            </div>
                            ${formattedJSON}
                        </div>
                    </body>
                </html>
            `);
            
            newWindow.document.close();
            
            logToConsole(`üìÑ Hasta JSON g√∂r√ºnt√ºlendi: ${patientId}`);
        }
        
        // Hasta se√ß
        async function selectPatient(patientId) {
            try {
                // JSON server'dan fresh hasta verilerini y√ºkle
                if (JSON_SERVER_ENABLED) {
                    try {
                        const response = await fetch('http://localhost:3000/data/patients_list.json');
                        if (response.ok) {
                            const data = await response.json();
                            const freshPatient = data.patients.find(p => p.id === patientId);
                            if (freshPatient) {
                                currentPatient = freshPatient;
                                console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Fresh hasta verisi y√ºklendi:', patientId);
                            }
                        }
                    } catch (e) {
                        console.warn('JSON server\'dan hasta y√ºklenemedi, localStorage\'a ge√ßiliyor');
                    }
                }
                
                // Fallback: Detaylƒ± hasta verisini localStorage'dan y√ºkle
                if (!currentPatient) {
                    currentPatient = loadPatientDetailedData(patientId);
                }
                
                if (!currentPatient) {
                    // Detaylƒ± veri bulunamazsa, temel veriyi kullan ve eksik kƒ±sƒ±mlarƒ± tamamla
                    const basicPatient = usersData.patients.find(p => p.id === patientId);
                    if (!basicPatient) {
                        logToConsole('‚ùå Hasta bulunamadƒ±: ' + patientId);
                        return;
                    }
                    
                    // Temel hasta verisinden detaylƒ± veri olu≈ütur
                    currentPatient = createDetailedPatientFromBasic(basicPatient);
                    
                    // Yeni detaylƒ± veriyi kaydet
                    savePatientDetailedData(patientId, currentPatient);
                }
                
                // Global deƒüi≈ükeni ayarla
                window.currentPatientId = patientId;
                
                // Hasta kartlarƒ±nƒ±n se√ßili durumunu g√ºncelle
                document.querySelectorAll('.patient-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Tƒ±klanan kartƒ± se√ßili yap (g√ºvenli kontrol ile)
                const clickedCard = document.querySelector(`[onclick="selectPatient('${patientId}')"]`);
                if (clickedCard) {
                    clickedCard.classList.add('selected');
                }
                
                // Hasta detaylarƒ±nƒ± g√∂ster
                document.getElementById('patient-details').style.display = 'block';
                document.getElementById('no-patient-selected').style.display = 'none';
                
                // Hasta bilgilerini doldur
                loadPatientInfo();
                loadPatientSettings();
                
                // Haftalƒ±k planlarƒ± y√ºkle
                await loadWeeklyTabs();
                
                logToConsole(`üë§ Hasta se√ßildi: ${currentPatient.personalInfo.firstName} ${currentPatient.personalInfo.lastName}`);
                logToConsole(`üìä Hasta detay verisi y√ºklendi. Toplam haftalƒ±k plan: ${currentPatient.weeklyPlans?.length || 0}`);
                
            } catch (error) {
                logToConsole('‚ùå Hasta y√ºkleme hatasƒ±: ' + error.message);
                try { showToast('Hasta bilgileri y√ºklenirken hata: ' + error.message, 'error'); } catch(_){ alert('Hasta bilgileri y√ºklenirken hata: ' + error.message); }
            }
        }
        
        // Temel hasta verisinden detaylƒ± veri olu≈ütur
        function createDetailedPatientFromBasic(basicPatient) {
            const detailedPatient = {
                id: basicPatient.id,
                version: '1.0',
                lastUpdated: new Date().toISOString(),
                status: basicPatient.status || 'active',
                
                personalInfo: {
                    id: basicPatient.id,
                    firstName: basicPatient.firstName,
                    lastName: basicPatient.lastName,
                    age: basicPatient.age || 30,
                    gender: basicPatient.gender || 'kadƒ±n',
                    phone: basicPatient.phone || '',
                    email: basicPatient.email || '',
                    height: basicPatient.height || 165,
                    weight: basicPatient.weight || 70,
                    activityLevel: basicPatient.activityLevel || 3,
                    createdDate: basicPatient.createdDate || new Date().toISOString()
                },
                
                healthInfo: {
                    diseases: basicPatient.diseases || [],
                    allergies: basicPatient.allergies || [],
                    medications: basicPatient.medications || [],
                    notes: basicPatient.notes || ''
                },
                
                nutritionPreferences: {
                    likedFoods: basicPatient.likedFoods || [],
                    dislikedFoods: basicPatient.dislikedFoods || [],
                    dietType: basicPatient.dietType || 'lowcarb',
                    calorieMethod: 'automatic',
                    targetMacros: basicPatient.targetMacros || { carbs: 0, protein: 0, fat: 0, calories: 0 },
                    targetCalories: basicPatient.targetCalories || 0
                }
            };
            
            // Makro hesaplamasƒ±nƒ± yap
            const calculatedMacros = calculatePatientMacros(
                detailedPatient.personalInfo.weight,
                detailedPatient.personalInfo.activityLevel,
                detailedPatient.nutritionPreferences.dietType
            );
            
            if (calculatedMacros) {
                detailedPatient.nutritionPreferences.targetMacros = calculatedMacros;
                detailedPatient.nutritionPreferences.targetCalories = calculatedMacros.calories;
            }
            
            // Planlama ayarlarƒ± ekle
            const systemMealSettings = systemSettings.mealLines || {
                breakfast: 3, snack1: 2, lunch: 4, snack2: 2, dinner: 4, night: 1
            };
            
            detailedPatient.planningSettings = {
                dietType: detailedPatient.nutritionPreferences.dietType,
                mealCount: systemSettings.defaultMealCount || 5,
                mealLines: systemMealSettings,
                planningFactors: getSystemPlanningFactors(),
                customRules: [],
                ruleHierarchy: getSystemRules().map((rule, index) => ({
                    ...rule,
                    priority: index + 1,
                    enabled: true
                })),
                useSystemRules: true,
                likedFoodsBoost: 25,
                varietyLevel: 'medium'
            };
            
            // Haftalƒ±k planlar
            detailedPatient.weeklyPlans = [];
            detailedPatient.planHistory = [];
            
            // ƒ∞lk hafta planƒ± olu≈ütur
            const initialWeek = createInitialWeekPlan(detailedPatient);
            if (initialWeek) {
                detailedPatient.weeklyPlans.push(initialWeek);
            }
            
            // Diƒüer gerekli alanlarƒ± ekle
            detailedPatient.medicalTeam = {
                assignedDoctor: null,
                assignedDietitian: null,
                permissions: {
                    doctorCanEdit: true,
                    dietitianCanEdit: true,
                    patientCanView: true
                }
            };
            
            detailedPatient.nutritionTracking = {
                dailyLogs: [],
                weeklyAverages: [],
                monthlyReports: [],
                goals: {
                    weightGoal: null,
                    targetDate: null,
                    weeklyWeightChange: 0
                }
            };
            
            detailedPatient.preferences = {
                language: 'tr',
                notifications: {
                    mealReminders: true,
                    waterReminders: true,
                    exerciseReminders: false
                },
                display: {
                    showCalories: true,
                    showMacros: true,
                    showPortions: true
                }
            };
            
            return detailedPatient;
        }
        
        // Hasta ayarlarƒ±nƒ± y√ºkle
        function loadPatientSettings() {
            if (!currentPatient || !currentPatient.planningSettings) return;
            
            const settings = currentPatient.planningSettings;
            
            // Diyet t√ºr√ºn√º ayarla
            const dietSelect = document.getElementById('patient-custom-diet');
            if (dietSelect) {
                dietSelect.value = settings.dietType || 'lowcarb';
            }
            
            // √ñƒü√ºn sayƒ±sƒ±nƒ± ayarla
            const mealCountSelect = document.getElementById('patient-meal-count');
            if (mealCountSelect) {
                mealCountSelect.value = settings.mealCount || 5;
            }
            
            // √ñƒü√ºn satƒ±r sayƒ±larƒ±nƒ± ayarla
            const mealLines = settings.mealLines || {};
            const lineFields = [
                'breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'night'
            ];
            
            lineFields.forEach(meal => {
                const field = document.getElementById(`patient-${meal}-lines`);
                if (field) {
                    field.value = mealLines[meal] || 1;
                }
            });
            
            // Sistem kurallarƒ± kullanƒ±m durumunu ayarla
            const useSystemRules = document.getElementById('use-system-rules');
            if (useSystemRules) {
                useSystemRules.checked = settings.useSystemRules !== false;
            }
        }
        
        // Hasta bilgilerini y√ºkle
        function loadPatientInfo() {
            const container = document.getElementById('patient-info');
            if (!container || !currentPatient || !currentPatient.personalInfo) {
                console.warn('‚ö†Ô∏è loadPatientInfo: Gerekli veriler eksik', { container: !!container, currentPatient: !!currentPatient });
                return;
            }
            
            try {
                const info = currentPatient.personalInfo || {};
                const health = currentPatient.healthInfo || {};
                const nutrition = currentPatient.nutritionPreferences || {};
                
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Ki≈üisel Bilgiler</h6>
                            <p><strong>Ad Soyad:</strong> ${info.firstName || ''} ${info.lastName || ''}</p>
                            <p><strong>Ya≈ü:</strong> ${info.age || 'Belirtilmemi≈ü'}</p>
                            <p><strong>Cinsiyet:</strong> ${info.gender || 'Belirtilmemi≈ü'}</p>
                            <p><strong>Boy:</strong> ${info.height || 'Belirtilmemi≈ü'} cm</p>
                            <p><strong>Kilo:</strong> ${info.weight || 'Belirtilmemi≈ü'} kg</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Saƒülƒ±k Bilgileri</h6>
                            <p><strong>Hastalƒ±klar:</strong> ${health.diseases || 'Yok'}</p>
                            <p><strong>Alerjiler:</strong> ${health.allergies || 'Yok'}</p>
                            <p><strong>ƒ∞la√ßlar:</strong> ${health.medications || 'Yok'}</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Beslenme Tercihleri</h6>
                            <p><strong>Diyet T√ºr√º:</strong> ${nutrition.dietType || 'Belirtilmemi≈ü'}</p>
                            <p><strong>Hedef Kalori:</strong> ${nutrition.targetCalories || 'Belirtilmemi≈ü'}</p>
                            <p><strong>Sevilen Gƒ±dalar:</strong> ${nutrition.likedFoods || 'Belirtilmemi≈ü'}</p>
                            <p><strong>Sevmediƒüi Gƒ±dalar:</strong> ${nutrition.dislikedFoods || 'Belirtilmemi≈ü'}</p>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Hasta bilgileri ba≈üarƒ±yla y√ºklendi');
            } catch (error) {
                console.error('‚ùå Hasta bilgileri y√ºklenirken bir hata olu≈ütu:', error);
                container.innerHTML = '<div class="alert alert-warning">Hasta bilgileri y√ºklenirken bir hata olu≈ütu.</div>';
            }
        }
        
        // Haftalƒ±k tablarƒ± y√ºkle
        async function loadWeeklyTabs() {
            const container = document.getElementById('weekly-tabs');
            if (!container) {
                console.warn('‚ö†Ô∏è weekly-tabs container bulunamadƒ±');
                return;
            }
            
            // JSON server'dan hasta verilerini yeniden y√ºkle (g√ºncel hafta tablarƒ± i√ßin)
            if (JSON_SERVER_ENABLED && currentPatient) {
                try {
                    const response = await fetch('http://localhost:3000/data/patients_list.json');
                    if (response.ok) {
                        const data = await response.json();
                        const updatedPatient = data.patients.find(p => p.id === currentPatient.id);
                        if (updatedPatient) {
                            currentPatient = updatedPatient;
                            console.log('üîÑ [Fƒ∞Zƒ∞KSEL JSON] Hafta tablarƒ± i√ßin hasta verileri g√ºncellendi:', currentPatient.id);
                        }
                    }
                } catch (e) {
                    console.warn('JSON server\'dan hasta g√ºncellemesi yapƒ±lamadƒ±');
                }
            }

            if (!currentPatient) {
                container.innerHTML = '<div class="alert alert-info">Hen√ºz haftalƒ±k plan olu≈üturulmamƒ±≈ü.</div>';
                return;
            }
            // Haftalƒ±k plan listesi hazƒ±rlƒ±k
            if (!Array.isArray(currentPatient.weeklyPlans)) currentPatient.weeklyPlans = [];
            if (currentPatient.weeklyPlans.length === 0) {
                console.log('‚ÑπÔ∏è Haftalƒ±k plan yok, ilk hafta olu≈üturma s√ºreci ba≈ülatƒ±lƒ±yor...');
                addNewWeek();
                return;
            }
            // Sƒ±rala ve normalize et
            currentPatient.weeklyPlans = currentPatient.weeklyPlans
                .map((w, i) => ({
                    ...w,
                    weekNumber: w.weekNumber || (i + 1),
                    dateRange: w.dateRange || (w.startDate && w.endDate
                        ? `${new Date(w.startDate).toLocaleDateString('tr-TR')} - ${new Date(w.endDate).toLocaleDateString('tr-TR')}`
                        : getWeekDateRange(w.weekNumber || (i + 1)))
                }))
                .sort((a,b)=> (a.weekNumber||0) - (b.weekNumber||0));
            
            try {
                let html = '<ul class="nav nav-tabs" role="tablist">';
                currentPatient.weeklyPlans.forEach((week, index) => {
                    html += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${index === 0 ? 'active' : ''}" data-week="${week.weekNumber}" type="button" role="tab" onclick="selectWeek(${week.weekNumber})">
                                ${week.weekNumber}. Hafta <small class="text-muted">(${week.dateRange})</small>
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
                
                // En son se√ßilen hafta varsa onu, yoksa ilkini se√ß
                const preferred = currentPatient.lastSelectedWeek && currentPatient.weeklyPlans.find(w=>w.weekNumber===currentPatient.lastSelectedWeek)
                    ? currentPatient.lastSelectedWeek
                    : (currentPatient.weeklyPlans[0]?.weekNumber);
                if (preferred) await selectWeek(preferred);
                
                console.log('‚úÖ [Fƒ∞Zƒ∞KSEL JSON] Haftalƒ±k tablar ba≈üarƒ±yla y√ºklendi:', currentPatient.weeklyPlans.length, 'hafta');
            } catch (error) {
                console.error('‚ùå Haftalƒ±k tablar y√ºklenirken hata:', error);
                container.innerHTML = '<div class="alert alert-warning">Haftalƒ±k planlar y√ºklenirken bir hata olu≈ütu.</div>';
            }
        }
        
        // Hafta tarih aralƒ±ƒüƒ± olu≈ütur
        function getWeekDateRange(weekNumber) {
            const today = new Date();
            const startDate = new Date(today.getTime() + (weekNumber - 1) * 7 * 24 * 60 * 60 * 1000);
            const endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
            
            return `${startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })} - ${endDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })}`;
        }
        
        // Hafta tarih aralƒ±ƒüƒ± olu≈ütur
        function getWeekDateRange(weekNumber) {
            const today = new Date();
            const startDate = new Date(today.getTime() + (weekNumber - 1) * 7 * 24 * 60 * 60 * 1000);
            const endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
            
            return `${startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })} - ${endDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })}`;
        }
        
        // Hafta se√ß
    async function selectWeek(weekNumber) {
            try {
        // Tab'larƒ± g√ºncelle (Bootstrap nav-link)
        document.querySelectorAll('#weekly-tabs .nav-link').forEach(link => link.classList.remove('active'));
        const link = document.querySelector(`#weekly-tabs .nav-link[data-week="${weekNumber}"]`);
        if (link) link.classList.add('active');
                
                // Hafta planƒ±nƒ± y√ºkle
                if (currentPatient && currentPatient.weeklyPlans) {
                    currentWeek = currentPatient.weeklyPlans.find(w => w.weekNumber === weekNumber);
                    
                    // Eƒüer hafta bulunamazsa veya plan eksikse varsayƒ±lan olu≈ütur
                    if (!currentWeek || !currentWeek.plan) {
                        console.warn(`‚ö†Ô∏è Hafta ${weekNumber} planƒ± bulunamadƒ±, varsayƒ±lan olu≈üturuluyor`);
                        currentWeek = {
                            weekNumber: weekNumber,
                            plan: createEmptyWeekPlan(),
                            weeklyAverages: {
                                calories: 0,
                                carbs: 0,
                                protein: 0,
                                fat: 0
                            }
                        };
                        // Hasta planlarƒ±na ekle
                        if (!currentPatient.weeklyPlans) currentPatient.weeklyPlans = [];
                        currentPatient.weeklyPlans.push(currentWeek);
                    }
                    
                    // WeeklyAverages yoksa varsayƒ±lan deƒüerler ekle
                    if (!currentWeek.weeklyAverages) {
                        currentWeek.weeklyAverages = {
                            calories: 0,
                            carbs: 0,
                            protein: 0,
                            fat: 0
                        };
                    }
                    
                    // Haftalƒ±k ortalamalarƒ± hesapla
                    calculateWeeklyAverages(currentWeek);
                    
            // Son se√ßilen haftayƒ± hasta nesnesine yaz ve kaydet
            currentPatient.lastSelectedWeek = weekNumber;
            const pid = getCurrentPatientId && getCurrentPatientId();
            if (pid) try { await savePatientDetailedData(pid, currentPatient); } catch(_) {}
            
            // Kriter paneli dropdown'ƒ±nƒ± g√ºncelle
            try { 
                const weekSelect = document.getElementById('criteria-week-select');
                if (weekSelect && weekSelect.value != weekNumber) {
                    weekSelect.value = weekNumber;
                }
                await renderCriteriaWeekControls(); 
            } catch(_) {}
            
                    await loadWeeklyPlanContent();
                    
                    // Hafta deƒüi≈üiminde sabit yemekleri y√ºkle
                    try { 
                        await loadFixedMealsFromStorage();
                        console.log(`üçΩÔ∏è [Fƒ∞Zƒ∞KSEL JSON] Hafta ${weekNumber} sabit yemekleri y√ºklendi`);
                    } catch(_) {}
                    
                    // Kriterleri haftaya g√∂re uygula
                    try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
                    
                    logToConsole(`üìÖ ${weekNumber}. hafta se√ßildi`);
                } else {
                    console.warn('‚ö†Ô∏è Haftalƒ±k planlar bulunamadƒ±');
                }
            } catch (error) {
                console.error('‚ùå Hafta se√ßimi hatasƒ±:', error);
            }
        }
        
        // Bo≈ü hafta planƒ± olu≈ütur
        function createEmptyWeekPlan() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const plan = {};
            
            days.forEach(day => {
                plan[day] = {
                    breakfast: [],
                    lunch: [], 
                    dinner: []
                };
            });
            
            return plan;
        }
        
        // Haftalƒ±k ortalamalarƒ± hesapla
        function calculateWeeklyAverages(weekData) {
            if (!weekData || !weekData.plan) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            let totalCalories = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
            let dayCount = 0;
            
            days.forEach(day => {
                if (weekData.plan[day]) {
                    const dayPlan = weekData.plan[day];
                    
                    // G√ºnl√ºk toplamlarƒ± hesapla
                    let dayCalories = 0, dayCarbs = 0, dayProtein = 0, dayFat = 0;
                    
                    // T√ºm √∂ƒü√ºnleri kontrol et
                    const meals = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
                    meals.forEach(meal => {
                        if (dayPlan[meal]) {
                            dayPlan[meal].forEach(food => {
                                if (food) {
                                    dayCalories += parseFloat(food.calories || food.kalori || 0);
                                    dayCarbs += parseFloat(food.carbs || food.karbonhidrat || 0);
                                    dayProtein += parseFloat(food.protein || 0);
                                    dayFat += parseFloat(food.fat || food.yag || 0);
                                }
                            });
                        }
                    });
                    
                    // G√ºnl√ºk toplamlarƒ± kaydet
                    dayPlan.dailyTotals = {
                        calories: Math.round(dayCalories),
                        carbs: Math.round(dayCarbs),
                        protein: Math.round(dayProtein),
                        fat: Math.round(dayFat)
                    };
                    
                    totalCalories += dayCalories;
                    totalCarbs += dayCarbs;
                    totalProtein += dayProtein;
                    totalFat += dayFat;
                    dayCount++;
                }
            });
            
            // Haftalƒ±k ortalamalarƒ± hesapla
            weekData.weeklyAverages = {
                calories: dayCount > 0 ? Math.round(totalCalories / dayCount) : 0,
                carbs: dayCount > 0 ? Math.round(totalCarbs / dayCount) : 0,
                protein: dayCount > 0 ? Math.round(totalProtein / dayCount) : 0,
                fat: dayCount > 0 ? Math.round(totalFat / dayCount) : 0
            };
        }
        
        // Haftalƒ±k plan i√ßeriƒüini y√ºkle
        async function loadWeeklyPlanContent() {
            const container = document.getElementById('weekly-plan-content');
            if (!container || !currentWeek) return;
            
            // Sistem ≈üablonlarƒ± dropdown'ƒ±
            const profiles = await getSystemWeeklyProfiles();
            const keys = Object.keys(profiles || {}).sort((a,b)=>Number(a)-Number(b));
            const options = keys.length ? keys.map(k => {
                const p = profiles[k];
                const name = p?.name ? ` - ${p.name}` : '';
                return `<option value="${k}">Hafta ${k}${name}</option>`;
            }).join('') : '<option value="">≈ûablon yok</option>';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6 class="mb-1">${currentWeek.weekNumber}. Hafta Planƒ± (${currentWeek.dateRange})</h6>
                        <div class="small text-muted">Hafta Tanƒ±mƒ±: <span id="week-desc-text">${(currentWeek.description || currentWeek.appliedSystemProfile?.name || '-')}
                            </span> ${currentWeek.appliedSystemProfile ? `<span class="badge bg-info ms-2" title="Uygulanan sistem ≈üablonu">${currentWeek.appliedSystemProfile.name || ('Hafta '+currentWeek.appliedSystemProfile.weekNumber)}</span>` : ''}
                        </div>
                        <div class="small mt-1">
                            <span class="text-muted">Tarih Aralƒ±ƒüƒ±:</span> <span class="fw-semibold">${currentWeek.startDate} - ${currentWeek.endDate}</span>
                            <button class="btn btn-link btn-sm p-0 ms-2" onclick="editCurrentWeekDates()" title="Tarihleri d√ºzenle">Tarihleri D√ºzenle</button>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="generateAutoPlan()">
                            <i class="fas fa-magic"></i> Otomatik Plan Olu≈ütur
                        </button>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                    <div class="input-group input-group-sm" style="max-width: 460px;">
                        <span class="input-group-text">Hafta Tanƒ±mƒ±</span>
                        <input id="week-desc-input" type="text" class="form-control" value="${(currentWeek.description || currentWeek.appliedSystemProfile?.name || '')}" placeholder="√∂rn: Eliminasyon, Adaptasyon...">
                        <button class="btn btn-outline-success" onclick="saveCurrentWeekMeta()" title="Hafta tanƒ±mƒ±nƒ± kaydet"><i class="fas fa-save"></i></button>
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 560px;">
                        <span class="input-group-text">Sistem ≈ûablonu</span>
                        <select id="apply-system-week-select" class="form-select">
                            ${options}
                        </select>
                        <button class="btn btn-outline-primary" onclick="applySelectedSystemWeekToCurrent()"><i class="fas fa-download"></i> Uygula</button>
                        ${currentWeek.appliedSystemProfile ? `<button class="btn btn-outline-danger" onclick="clearAppliedSystemWeek()" title="Uygulanan ≈üablonu kaldƒ±r"><i class=\"fas fa-times\"></i></button>` : ''}
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="meal-table">
                        <thead>
                            <tr>
                                <th>G√ºn</th>
                                <th>√ñƒü√ºn</th>
                                <th>Yemek</th>
                                <th>Rol/Kategori</th>
                                <th>Porsiyon</th>
                                <th>Kalori</th>
                                <th>Karb.</th>
                                <th>Protein</th>
                                <th>Yaƒü</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // G√ºnleri ekle
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayNames = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            
            days.forEach((day, dayIndex) => {
                // G√ºvenlik kontrol√º - plan nesnesi var mƒ±?
                if (!currentWeek.plan || typeof currentWeek.plan !== 'object') {
                    console.warn(`‚ö†Ô∏è Hafta ${weekNumber} plan verisi eksik veya hatalƒ±`);
                    return;
                }
                
                const dayPlan = currentWeek.plan[day];
                if (!dayPlan) return;
                
                const meals = ['breakfast', 'lunch', 'dinner'];
                const mealNames = ['Kahvaltƒ±', '√ñƒüle', 'Ak≈üam'];
                
                meals.forEach((meal, mealIndex) => {
                    // Plan yapƒ±sƒ± kontrol et - basit mi (dayPlan.breakfast) yoksa kompleks mi (dayPlan.meals.breakfast)?
                    const mealFoods = (dayPlan.meals && dayPlan.meals[meal]) || dayPlan[meal] || [];
                    
                    if (mealFoods.length === 0) {
                        // Bo≈ü √∂ƒü√ºn
                        html += `
                            <tr>
                                <td>${dayIndex === 0 && mealIndex === 0 ? dayNames[dayIndex] : ''}</td>
                                <td>${mealNames[mealIndex]}</td>
                                <td colspan="8" class="text-muted text-center">
                                    <em>Bu √∂ƒü√ºn i√ßin plan yapƒ±lmamƒ±≈ü</em>
                                    <button class="btn btn-sm btn-outline-primary ms-2" 
                                            onclick="addMealToSlot('${day}', '${meal}')">
                                        <i class="fas fa-plus"></i> Yemek Ekle
                                    </button>
                                </td>
                            </tr>
                        `;
                    } else {
                        // Yemekleri listele
                        mealFoods.forEach((food, foodIndex) => {
                            html += `
                                <tr class="meal-row" onclick="editMeal('${day}', '${meal}', ${foodIndex})">
                                    <td>${dayIndex === 0 && mealIndex === 0 && foodIndex === 0 ? dayNames[dayIndex] : ''}</td>
                                    <td>${foodIndex === 0 ? mealNames[mealIndex] : ''}</td>
                                    <td>${food.name || food.isim || 'Bilinmeyen Yemek'}</td>
                                    <td><span class="badge bg-secondary">${food.role || food.kategori || '-'}</span></td>
                                    <td>${food.portion || food.porsiyon || '1'}</td>
                                    <td>${food.calories || food.kalori || 0}</td>
                                    <td>${food.carbs || food.karbonhidrat || 0}</td>
                                    <td>${food.protein || 0}</td>
                                    <td>${food.fat || food.yag || 0}</td>
                                    <td>
                                        <button class="change-meal-btn" onclick="changeMeal('${day}', '${meal}', ${foodIndex})">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                });
                
                // G√ºnl√ºk toplamlar
                const dailyTotals = dayPlan.dailyTotals || { calories: 0, carbs: 0, protein: 0, fat: 0 };
                html += `
                    <tr class="daily-totals">
                        <td colspan="5"><strong>G√ºnl√ºk Toplam (${dayNames[dayIndex]})</strong></td>
                        <td><strong>${dailyTotals.calories}</strong></td>
                        <td><strong>${dailyTotals.carbs}</strong></td>
                        <td><strong>${dailyTotals.protein}</strong></td>
                        <td><strong>${dailyTotals.fat}</strong></td>
                        <td></td>
                    </tr>
                `;
            });
            
            // Haftalƒ±k ortalamalar
            const weeklyAverages = currentWeek.weeklyAverages || { calories: 0, carbs: 0, protein: 0, fat: 0 };
            html += `
                    <tr class="weekly-averages">
                        <td colspan="5"><strong>Haftalƒ±k Ortalama</strong></td>
                        <td><strong>${weeklyAverages.calories}</strong></td>
                        <td><strong>${weeklyAverages.carbs}</strong></td>
                        <td><strong>${weeklyAverages.protein}</strong></td>
                        <td><strong>${weeklyAverages.fat}</strong></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
            `;
            
            container.innerHTML = html;
            // Hafta √∂zel kriter snapshot'ƒ±nƒ± uygula (varsa)
            try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
        }

        // Hafta tarihlerini d√ºzenle
        async function editCurrentWeekDates() {
            if (!currentPatient || !currentWeek) return;
            const toYMD = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().split('T')[0];
            const parseYMD = s => { const [y,m,d] = s.split('-').map(Number); const dt = new Date(Date.UTC(y, m-1, d)); return new Date(dt.getTime()); };
            const curStart = currentWeek.startDate || toYMD(new Date());
            const input = prompt('Yeni ba≈ülangƒ±√ß tarihini girin (YYYY-MM-DD):', curStart);
            if (!input) return;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(input)) { alert('Ge√ßerli format: YYYY-MM-DD'); return; }
            try {
                const start = parseYMD(input);
                const end = new Date(start); end.setDate(start.getDate() + 6);
                currentWeek.startDate = toYMD(start);
                currentWeek.endDate = toYMD(end);
                currentWeek.dateRange = `${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')}`;
                const pid = getCurrentPatientId && getCurrentPatientId();
                if (pid) savePatientDetailedData(pid, currentPatient);
                // Tablarƒ± yeniden √ßiz ve aynƒ± haftayƒ± se√ßili tut
                await loadWeeklyTabs();
                await selectWeek(currentWeek.weekNumber);
                try { showToast('Hafta tarihleri g√ºncellendi', 'success'); } catch(_) {}
            } catch(e) {
                alert('Tarih g√ºncelleme hatasƒ±: ' + e.message);
            }
        }
        
        // Yeni hafta ekle
    async function addNewWeek() {
            if (!currentPatient) return;
            
            const lastWeek = currentPatient.weeklyPlans[currentPatient.weeklyPlans.length - 1];
            const newWeekNumber = lastWeek ? lastWeek.weekNumber + 1 : 1;

            // Yardƒ±mcƒ±lar
            const toYMD = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().split('T')[0];
            const parseYMD = s => { const [y,m,d] = s.split('-').map(Number); const dt = new Date(Date.UTC(y, m-1, d)); return new Date(dt.getTime()); };
            const getNextMonday = (fromDate) => {
                const d = new Date(fromDate);
                const day = d.getDay(); // 0 Pazar, 1 Pazartesi
                const diff = (day === 1) ? 0 : ((8 - day) % 7);
                d.setDate(d.getDate() + diff);
                return d;
            };

            // √ñnerilen tarih aralƒ±ƒüƒ±nƒ± hazƒ±rla
            let proposedStart;
            if (lastWeek && lastWeek.endDate) {
                const dayAfter = new Date(lastWeek.endDate);
                dayAfter.setDate(dayAfter.getDate() + 1);
                // Devamlƒ±lƒ±k esas: bir √∂ncekinin ertesi g√ºn√º ba≈ülasƒ±n
                proposedStart = dayAfter;
            } else {
                // ƒ∞lk hafta: bug√ºn√ºn haftasƒ±nƒ±n pazartesi g√ºn√º ba≈ülat
                proposedStart = getNextMonday(new Date());
            }
            let proposedEnd = new Date(proposedStart);
            proposedEnd.setDate(proposedStart.getDate() + 6);
            const proposedRangeText = `${proposedStart.toLocaleDateString('tr-TR')} - ${proposedEnd.toLocaleDateString('tr-TR')}`;

            // Onaya sun
            let useCustom = false;
            const ok = confirm(`Yeni haftayƒ± ≈üu tarihlerle olu≈üturmak ister misiniz?\n${proposedRangeText}`);
            let startDate = proposedStart;
            let endDate = proposedEnd;
            if (!ok) {
                const input = prompt('Ba≈ülangƒ±√ß tarihi girin (YYYY-MM-DD):', toYMD(proposedStart));
                if (input && /^\d{4}-\d{2}-\d{2}$/.test(input)) {
                    try {
                        startDate = parseYMD(input);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        useCustom = true;
                    } catch(_) {}
                }
            }

            const dateRange = `${startDate.toLocaleDateString('tr-TR')} - ${endDate.toLocaleDateString('tr-TR')}`;
            
            const newWeek = {
                weekNumber: newWeekNumber,
                startDate: toYMD(startDate),
                endDate: toYMD(endDate),
                dateRange: dateRange,
                status: 'active',
                createdDate: new Date().toISOString(),
                createdBy: 'dietitian_001', // Dinamik olarak belirlenecek
                plan: createEmptyWeekPlan(startDate),
                weeklyAverages: {
                    calories: 0,
                    protein: 0,
                    carbs: 0,
                    fat: 0
                },
                notes: ''
            };
            
            currentPatient.weeklyPlans.push(newWeek);

            // Eƒüer sistemde bu hafta i√ßin ≈üablon varsa ili≈ütir
            try {
                const prof = await getSystemWeekProfile(newWeekNumber);
                if (prof) {
                    const idx = currentPatient.weeklyPlans.findIndex(w => w.weekNumber === newWeekNumber);
                    if (idx >= 0) {
                        currentPatient.weeklyPlans[idx].appliedSystemProfile = {
                            weekNumber: prof.weekNumber,
                            name: prof.name,
                            appliedAt: new Date().toISOString(),
                            source: 'system',
                            settings: prof.settings
                        };
                        // Hafta tanƒ±mƒ±nƒ± ve kriter snapshot'ƒ±nƒ± da kaydet
                        currentPatient.weeklyPlans[idx].description = prof.name || '';
                        if (prof.settings?.criteria) {
                            currentPatient.weeklyPlans[idx].criteriaSnapshot = prof.settings.criteria;
                        }
                    }
                }
            } catch (_) {}
            
            // Hafta tablarƒ±nƒ± yeniden y√ºkle
            await loadWeeklyTabs();
            try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
            
            logToConsole(`üìÖ ${newWeekNumber}. hafta eklendi`);
        }
        
        // Bo≈ü hafta planƒ± olu≈ütur
        function createEmptyWeekPlan(startDate = null) {
            const plan = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((day, index) => {
                // startDate yoksa bug√ºn√º kullan
                if (!startDate) {
                    plan[day] = {
                        meals: {
                            breakfast: [],
                            lunch: [],
                            dinner: []
                        },
                        dailyTotals: {
                            calories: 0,
                            protein: 0,
                            carbs: 0,
                            fat: 0
                        }
                    };
                } else {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + index);
                    
                    plan[day] = {
                        date: date.toISOString().split('T')[0],
                        meals: {
                            breakfast: [],
                            lunch: [],
                            dinner: []
                        },
                        dailyTotals: {
                            calories: 0,
                            protein: 0,
                            carbs: 0,
                            fat: 0
                        }
                    };
                }
            });
            
            return plan;
        }
        
        // Otomatik plan olu≈ütur
        function generateAutoPlan() {
            if (!currentWeek || !currentPatient) return;
            
            logToConsole('üéØ Otomatik plan olu≈üturuluyor...');
            
            // Buraya geli≈ümi≈ü planlama algoritmasƒ± gelecek
            // ≈ûimdilik basit √∂rnek veriler ekleyelim
            
            try { showToast('Otomatik plan olu≈üturma geli≈ütirme a≈üamasƒ±nda...', 'info'); } catch(_){ }
        }
        
        // Kullanƒ±cƒ±lar sayfasƒ±nƒ± y√ºkle
        function loadUsersPage() {
            // Sayfa y√ºklendiƒüinde veri kontrol√º yap
            if (!usersData || !usersData.patients) {
                logToConsole('‚ö†Ô∏è Kullanƒ±cƒ± verileri y√ºkleniyor...');
                // usersData'yƒ± yeniden y√ºkle
                loadEmbeddedData();
            }
            
            // Mevcut kullanƒ±cƒ±larƒ± listele
            loadUsersLists();
            
            // Kullanƒ±cƒ± sayƒ±larƒ±nƒ± g√ºncelle  
            updateUsersCounts();
            
            // Hasta tabƒ±na otomatik ge√ß (varsayƒ±lan)
            const patientsTab = document.querySelector('a[href="#patients-content"]');
            if (patientsTab) {
                const tab = new bootstrap.Tab(patientsTab);
                tab.show();
            }
            
            logToConsole('üë• Kullanƒ±cƒ±lar sayfasƒ± y√ºklendi');
            logToConsole(`üìä Toplam hasta: ${usersData?.patients?.length || 0}`);
            logToConsole(`üìä Toplam doktor: ${usersData?.doctors?.length || 0}`);
            logToConsole(`üìä Toplam diyetisyen: ${usersData?.dietitians?.length || 0}`);
            
            // Test ama√ßlƒ± zorla y√ºkle
            setTimeout(() => {
                forceLoadUsersTable();
            }, 100);
        }
        
        // Kullanƒ±cƒ± formunu g√∂ster/gizle
        function showUserForm() {
            const userType = document.getElementById('userType').value;
            
            // T√ºm formlarƒ± gizle
            document.getElementById('patient-form').style.display = 'none';
            document.getElementById('doctor-form').style.display = 'none';
            document.getElementById('dietitian-form').style.display = 'none';
            document.getElementById('form-buttons').style.display = 'none';
            
            // Se√ßilen forma g√∂re g√∂ster
            if (userType) {
                document.getElementById(userType + '-form').style.display = 'block';
                document.getElementById('form-buttons').style.display = 'block';
            }
        }
        
        // Kullanƒ±cƒ± kaydet
        async function saveUser() {
            const userType = document.getElementById('userType').value;
            
            if (!userType) {
                try { showToast('Kullanƒ±cƒ± t√ºr√º se√ßiniz!', 'warning'); } catch(_){ alert('Kullanƒ±cƒ± t√ºr√º se√ßiniz!'); }
                return;
            }
            
            try {
                let userData = {};
                let isValid = false;
                
                switch(userType) {
                    case 'patient':
                        userData = collectPatientData();
                        isValid = validatePatientData(userData);
                        break;
                    case 'doctor':
                        userData = collectDoctorData();
                        isValid = validateDoctorData(userData);
                        break;
                    case 'dietitian':
                        userData = collectDietitianData();
                        isValid = validateDietitianData(userData);
                        break;
                }
                
                if (!isValid) {
                    return;
                }
                
                // Kullanƒ±cƒ±yƒ± kaydet
                await saveUserToSystem(userType, userData);
                
                // Formu temizle
                resetUserForm();
                
                // Kullanƒ±cƒ± listesini yenile
                loadUsersLists();
                
                logToConsole(`‚úÖ ${userType === 'patient' ? 'Hasta' : userType === 'doctor' ? 'Doktor' : 'Diyetisyen'} ba≈üarƒ±yla kaydedildi`);
                
            } catch (error) {
                logToConsole('‚ùå Kullanƒ±cƒ± kaydetme hatasƒ±: ' + error.message);
                alert('Kullanƒ±cƒ± kaydedilirken bir hata olu≈ütu: ' + error.message);
            }
        }
        
        // Hasta verilerini topla
        function collectPatientData() {
            // Diyet hedef deƒüerlerini al
            const targetCarbs = document.getElementById('targetCarbs').value;
            const targetProtein = document.getElementById('targetProtein').value;
            const targetFat = document.getElementById('targetFat').value;
            const targetCalories = document.getElementById('targetCalories').value;
            const dietType = document.getElementById('patientDietType').value;
            const calorieMethod = document.querySelector('input[name="calorieMethod"]:checked').value;

            return {
                personalInfo: {
                    firstName: document.getElementById('patientFirstName').value.trim(),
                    lastName: document.getElementById('patientLastName').value.trim(),
                    age: parseInt(document.getElementById('patientAge').value),
                    gender: document.getElementById('patientGender').value,
                    phone: document.getElementById('patientPhone').value.trim(),
                    email: '', // Opsiyonel
                    height: parseInt(document.getElementById('patientHeight').value),
                    weight: parseFloat(document.getElementById('patientWeight').value),
                    activityLevel: parseInt(document.getElementById('patientActivityLevel').value),
                    createdDate: new Date().toISOString()
                },
                healthInfo: {
                    diseases: document.getElementById('patientDiseases').value.trim().split(',').map(s => s.trim()).filter(s => s),
                    allergies: document.getElementById('patientAllergies').value.trim().split(',').map(s => s.trim()).filter(s => s),
                    medications: document.getElementById('patientMedications').value.trim().split(',').map(s => s.trim()).filter(s => s),
                    notes: document.getElementById('patientNotes').value.trim()
                },
                nutritionPreferences: {
                    likedFoods: document.getElementById('patientLikedFoods').value.trim().split(',').map(s => s.trim()).filter(s => s),
                    dislikedFoods: document.getElementById('patientDislikedFoods').value.trim().split(',').map(s => s.trim()).filter(s => s),
                    dietType: dietType || 'lowcarb', // Se√ßilen diyet t√ºr√º
                    calorieMethod: calorieMethod, // Hesaplama y√∂ntemi
                    targetMacros: {
                        carbs: targetCarbs ? parseInt(targetCarbs) : null,
                        protein: targetProtein ? parseInt(targetProtein) : null,
                        fat: targetFat ? parseInt(targetFat) : null,
                        calories: targetCalories ? parseInt(targetCalories) : null
                    },
                    // Fallback: Harris-Benedict hesaplama
                    targetCalories: targetCalories ? parseInt(targetCalories) : calculateBasicCalories(
                        parseInt(document.getElementById('patientAge').value),
                        document.getElementById('patientGender').value,
                        parseInt(document.getElementById('patientHeight').value),
                        parseFloat(document.getElementById('patientWeight').value),
                        parseInt(document.getElementById('patientActivityLevel').value)
                    )
                }
            };
        }
        
        // Doktor verilerini topla
        function collectDoctorData() {
            return {
                personalInfo: {
                    title: 'Dr.',
                    firstName: document.getElementById('doctorFirstName').value.trim(),
                    lastName: document.getElementById('doctorLastName').value.trim(),
                    specialization: document.getElementById('doctorSpecialization').value,
                    licenseNumber: document.getElementById('doctorLicense').value.trim(),
                    phone: document.getElementById('doctorPhone').value.trim(),
                    email: document.getElementById('doctorEmail').value.trim(),
                    createdDate: new Date().toISOString()
                },
                workInfo: {
                    hospital: document.getElementById('doctorHospital').value.trim(),
                    department: document.getElementById('doctorSpecialization').value,
                    position: 'Uzman Doktor'
                }
            };
        }
        
        // Diyetisyen verilerini topla
        function collectDietitianData() {
            const expertDiets = [];
            if (document.getElementById('dietKeto').checked) expertDiets.push('ketojenik');
            if (document.getElementById('dietLowCarb').checked) expertDiets.push('lowcarb');
            if (document.getElementById('dietMed').checked) expertDiets.push('akdeniz');
            if (document.getElementById('dietSport').checked) expertDiets.push('sporcu');
            
            return {
                personalInfo: {
                    title: 'Dyt.',
                    firstName: document.getElementById('dietitianFirstName').value.trim(),
                    lastName: document.getElementById('dietitianLastName').value.trim(),
                    specialization: document.getElementById('dietitianSpecialization').value,
                    licenseNumber: document.getElementById('dietitianLicense').value.trim(),
                    phone: document.getElementById('dietitianPhone').value.trim(),
                    email: document.getElementById('dietitianEmail').value.trim(),
                    createdDate: new Date().toISOString()
                },
                workInfo: {
                    clinic: document.getElementById('dietitianClinic').value.trim(),
                    department: document.getElementById('dietitianSpecialization').value,
                    position: 'Klinik Diyetisyen'
                },
                expertise: {
                    dietTypes: expertDiets,
                    specialConditions: [],
                    ageGroups: ['adult']
                }
            };
        }
        
        // Temel kalori hesaplama (Harris-Benedict)
        function calculateBasicCalories(age, gender, height, weight, activity) {
            let bmr;
            if (gender === 'erkek') {
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            
            const multipliers = [1.2, 1.375, 1.55, 1.725, 1.9];
            return Math.round(bmr * multipliers[activity - 1]);
        }

        // üÜï Hasta i√ßin √∂zel macro hesaplama fonksiyonu
        async function calculatePatientMacros() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const dietType = document.getElementById('patientDietType').value;
            const calorieMethod = document.querySelector('input[name="calorieMethod"]:checked').value;
            const activityLevel = parseInt(document.getElementById('patientActivityLevel').value);

            if (!weight || !dietType || !activityLevel) {
                clearMacroDisplay();
                return;
            }

            try {
                // üîß Embedded data kullan (CORS sorunu √ß√∂z√ºm√º)
                const dietConfig = await getEmbeddedData('diet_config.json');
                const selectedDiet = dietConfig.diets.find(d => d.id === dietType);

                if (!selectedDiet) {
                    console.error('Diyet t√ºr√º bulunamadƒ±:', dietType);
                    return;
                }

                let targetCalories, targetCarbs, targetProtein, targetFat;
                let calculationDetails = '';

                if (calorieMethod === 'custom') {
                    // üéØ DOƒûRU √ñZEL FORM√úL: Sizin belirttiƒüiniz form√ºl
                    const macroCoeff = selectedDiet.macroCoefficients;
                    
                    // üìä AKTƒ∞Vƒ∞TE √áARPANLARI
                    let activityMultiplier;
                    
                    if (dietType === 'sporcu') {
                        // Sporcu diyeti i√ßin √∂zel √ßarpanlar
                        const sportMultipliers = { 1: 1.4, 2: 1.6, 3: 1.8, 4: 2.0, 5: 2.2 };
                        activityMultiplier = sportMultipliers[activityLevel];
                    } else {
                        // Normal diyetler i√ßin standart √ßarpanlar
                        const activityMultipliers = { 
                            1: 0.8,  // Sedanter
                            2: 0.9,  // Hafif aktif  
                            3: 1.0,  // Orta aktif
                            4: 1.1,  // √áok aktif
                            5: 1.2   // Extra aktif
                        };
                        activityMultiplier = activityMultipliers[activityLevel];
                    }

                    // ü•ó MAKRO HESAPLAMA: Kilo √ó MacroKatsayƒ±
                    const baseCarbs = weight * macroCoeff.carbs;   // √ñrn: 80kg √ó 0.6 = 48g
                    const baseProtein = weight * macroCoeff.protein; // √ñrn: 80kg √ó 0.8 = 64g  
                    const baseFat = weight * macroCoeff.fat;       // √ñrn: 80kg √ó 1.2 = 96g

                    // üî• KALORƒ∞ HESAPLAMA: (karb√ó4 + protein√ó4 + yaƒü√ó9) √ó aktivite
                    const baseCalories = (baseCarbs * 4) + (baseProtein * 4) + (baseFat * 9);
                    targetCalories = Math.round(baseCalories * activityMultiplier);

                    // Final makro deƒüerleri (aktivite ile √ßarpƒ±lmƒ±≈ü)
                    targetCarbs = Math.round(baseCarbs * activityMultiplier);
                    targetProtein = Math.round(baseProtein * activityMultiplier);
                    targetFat = Math.round(baseFat * activityMultiplier);

                    calculationDetails = `${weight}kg ‚Üí C:${baseCarbs.toFixed(0)}g P:${baseProtein.toFixed(0)}g Y:${baseFat.toFixed(0)}g ‚Üí (${baseCarbs}√ó4 + ${baseProtein}√ó4 + ${baseFat}√ó9) √ó ${activityMultiplier} = ${targetCalories}kcal`;

                } else {
                    // Harris-Benedict y√∂ntemi
                    const gender = document.getElementById('patientGender').value;
                    const age = parseInt(document.getElementById('patientAge').value);
                    const height = parseInt(document.getElementById('patientHeight').value);

                    if (!gender || !age || !height) {
                        alert('Harris-Benedict i√ßin cinsiyet, ya≈ü ve boy gerekli');
                        return;
                    }

                    let bmr;
                    if (gender === 'erkek') {
                        bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                    } else {
                        bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                    }

                    const harrisActivityMultipliers = { 1: 1.2, 2: 1.375, 3: 1.55, 4: 1.725, 5: 1.9 };
                    targetCalories = Math.round(bmr * harrisActivityMultipliers[activityLevel]);

                    // Diyet oranlarƒ±na g√∂re makrolarƒ± daƒüƒ±t
                    const macroRatios = selectedDiet.macroRatios;
                    const carbCalories = targetCalories * (macroRatios.carbs / 100);
                    const proteinCalories = targetCalories * (macroRatios.protein / 100);
                    const fatCalories = targetCalories * (macroRatios.fat / 100);

                    targetCarbs = Math.round(carbCalories / 4);
                    targetProtein = Math.round(proteinCalories / 4);
                    targetFat = Math.round(fatCalories / 9);

                    calculationDetails = `BMR: ${Math.round(bmr)} x ${harrisActivityMultipliers[activityLevel]} = ${targetCalories} kcal`;
                }

                // Sonu√ßlarƒ± g√∂ster
                document.getElementById('targetCarbs').value = targetCarbs;
                document.getElementById('targetProtein').value = targetProtein;
                document.getElementById('targetFat').value = targetFat;
                document.getElementById('targetCalories').value = targetCalories;

                document.getElementById('calculation-details').textContent = calculationDetails;
                document.getElementById('macro-breakdown').style.display = 'block';

                // ‚úÖ Ba≈üarƒ± logu
                console.log('‚úÖ Macro hesaplama ba≈üarƒ±lƒ±:', { targetCarbs, targetProtein, targetFat, targetCalories });

            } catch (error) {
                console.error('‚ùå Macro hesaplama hatasƒ±:', error);
                alert('Hesaplama sƒ±rasƒ±nda hata olu≈ütu: ' + error.message);
            }
        }

        function clearMacroDisplay() {
            document.getElementById('targetCarbs').value = '';
            document.getElementById('targetProtein').value = '';
            document.getElementById('targetFat').value = '';
            document.getElementById('targetCalories').value = '';
            document.getElementById('macro-breakdown').style.display = 'none';
        }
        
        
        
        // Hasta verilerini doƒürula
        function validatePatientData(data) {
            if (!data.personalInfo.firstName || !data.personalInfo.lastName) {
                alert('Ad ve soyad alanlarƒ± zorunludur!');
                return false;
            }
            
            if (!data.personalInfo.age || data.personalInfo.age < 0 || data.personalInfo.age > 120) {
                alert('Ge√ßerli bir ya≈ü giriniz!');
                return false;
            }
            
            if (!data.personalInfo.height || data.personalInfo.height < 100 || data.personalInfo.height > 250) {
                alert('Ge√ßerli bir boy deƒüeri giriniz!');
                return false;
            }
            
            if (!data.personalInfo.weight || data.personalInfo.weight < 30 || data.personalInfo.weight > 300) {
                alert('Ge√ßerli bir kilo deƒüeri giriniz!');
                return false;
            }
            
            // üÜï Diyet t√ºr√º kontrol√º
            if (!data.nutritionPreferences.dietType) {
                alert('Diyet t√ºr√º se√ßimi zorunludur!');
                return false;
            }
            
            // üÜï Macro deƒüerleri kontrol√º (√∂zel hesaplama se√ßilmi≈üse)
            if (data.nutritionPreferences.calorieMethod === 'custom') {
                if (!data.nutritionPreferences.targetMacros.calories) {
                    alert('Macro hesaplama tamamlanmadƒ±! L√ºtfen t√ºm alanlarƒ± doldurun.');
                    return false;
                }
            }
            
            return true;
        }
        
        // Doktor verilerini doƒürula
        function validateDoctorData(data) {
            if (!data.personalInfo.firstName || !data.personalInfo.lastName) {
                alert('Ad ve soyad alanlarƒ± zorunludur!');
                return false;
            }
            
            if (!data.personalInfo.specialization) {
                alert('Uzmanlƒ±k alanƒ± se√ßiniz!');
                return false;
            }
            
            return true;
        }
        
        // Diyetisyen verilerini doƒürula
        function validateDietitianData(data) {
            if (!data.personalInfo.firstName || !data.personalInfo.lastName) {
                alert('Ad ve soyad alanlarƒ± zorunludur!');
                return false;
            }
            
            if (!data.personalInfo.specialization) {
                alert('Uzmanlƒ±k alanƒ± se√ßiniz!');
                return false;
            }
            
            return true;
        }
        
        // Kullanƒ±cƒ±yƒ± sisteme kaydet
        async function saveUserToSystem(userType, userData) {
            // Yeni ID olu≈ütur
            const newId = generateUserId(userType);
            userData.id = newId;
            userData.version = '1.0';
            userData.lastUpdated = new Date().toISOString();
            userData.status = 'active';
            
            // Hasta i√ßin ek ayarlar ve tam JSON yapƒ±sƒ±
            if (userType === 'patient') {
                // Sistem ayarlarƒ±ndan varsayƒ±lan deƒüerleri al
                const systemMealSettings = systemSettings.mealLines || {
                    breakfast: 3, snack1: 2, lunch: 4, snack2: 2, dinner: 4, night: 1
                };
                
                userData.planningSettings = {
                    dietType: userData.nutritionPreferences.dietType,
                    mealCount: systemSettings.defaultMealCount || 5,
                    mealLines: systemMealSettings,
                    planningFactors: getSystemPlanningFactors(),
                    customRules: [],
                    ruleHierarchy: getSystemRules().map((rule, index) => ({
                        ...rule,
                        priority: index + 1,
                        enabled: true
                    })),
                    useSystemRules: true,
                    likedFoodsBoost: 25,
                    varietyLevel: 'medium',
                    avoidRepeat: {
                        sameDay: true,
                        consecutiveDays: 2,
                        weeklyLimit: 3
                    }
                };
                
                userData.medicalTeam = {
                    assignedDoctor: null,
                    assignedDietitian: null,
                    permissions: {
                        doctorCanEdit: true,
                        dietitianCanEdit: true,
                        patientCanView: true,
                        dataSharing: true
                    }
                };
                
                userData.weeklyPlans = [];
                userData.planHistory = [];
                
                // Otomatik ilk hafta planƒ± olu≈ütur
                const initialWeekPlan = createInitialWeekPlan(userData);
                if (initialWeekPlan) {
                    userData.weeklyPlans.push(initialWeekPlan);
                }
                
                // Hasta √∂zel makro hedefleri hesapla
                const calculatedMacros = calculatePatientMacros(
                    userData.personalInfo.weight,
                    userData.personalInfo.activityLevel,
                    userData.nutritionPreferences.dietType
                );
                
                if (calculatedMacros) {
                    userData.nutritionPreferences.targetMacros = {
                        carbs: calculatedMacros.carbs,
                        protein: calculatedMacros.protein,
                        fat: calculatedMacros.fat,
                        calories: calculatedMacros.calories
                    };
                    userData.nutritionPreferences.targetCalories = calculatedMacros.calories;
                }
                
                // Beslenme takip kayƒ±tlarƒ±
                userData.nutritionTracking = {
                    dailyLogs: [],
                    weeklyAverages: [],
                    monthlyReports: [],
                    goals: {
                        weightGoal: null,
                        targetDate: null,
                        weeklyWeightChange: 0
                    }
                };
                
                // Hasta ayarlarƒ± ve tercihler
                userData.preferences = {
                    language: 'tr',
                    notifications: {
                        mealReminders: true,
                        waterReminders: true,
                        exerciseReminders: false,
                        progressUpdates: true
                    },
                    display: {
                        showCalories: true,
                        showMacros: true,
                        showPortions: true,
                        theme: 'light'
                    }
                };
            }
            
            // Doktor/Diyetisyen i√ßin ek ayarlar
            if (userType === 'doctor' || userType === 'dietitian') {
                userData.permissions = getDefaultPermissions(userType);
                userData.assignedPatients = [];
                userData.preferences = {
                    defaultDietType: 'lowcarb',
                    preferredPlanDuration: 7,
                    notificationSettings: {
                        emailNotifications: true,
                        smsNotifications: false
                    }
                };
            }
            
            // users_list.json'ƒ± g√ºncelle
            const listEntry = {
                id: newId,
                firstName: userData.personalInfo.firstName,
                lastName: userData.personalInfo.lastName,
                status: 'active',
                createdDate: userData.personalInfo.createdDate
            };
            
            if (userType === 'doctor' || userType === 'dietitian') {
                listEntry.specialization = userData.personalInfo.specialization;
            }
            
            // üîß localStorage'a kaydet (CORS sorunu √ß√∂z√ºm√º)
            usersData[userType + 's'].push(listEntry);
            usersData.counters['last' + capitalize(userType) + 'Id']++;
            
            // Kullanƒ±cƒ± verilerini JSON dosyasƒ±na kaydet (localStorage yerine)
            await saveUsersData();
            
            // Hasta detaylƒ± verisini ayrƒ± kaydet
            const detailedKey = `${userType}_${newId}_detailed`;
            localStorage.setItem(detailedKey, JSON.stringify(userData));
            
            logToConsole(`üíæ ${userType} ba≈üarƒ±yla kaydedildi: ${newId}`);
            
            // Dashboard istatistiklerini g√ºncelle
            updateDashboardStats();
            
            return newId; // ID'yi d√∂nd√ºr
        }
        
        // Kullanƒ±cƒ± ID'si olu≈ütur
        function generateUserId(userType) {
            const counters = usersData.counters;
            let counter;
            
            switch(userType) {
                case 'patient':
                    counter = counters.lastPatientId + 1;
                    break;
                case 'doctor':
                    counter = counters.lastDoctorId + 1;
                    break;
                case 'dietitian':
                    counter = counters.lastDietitianId + 1;
                    break;
            }
            
            return userType + '_' + String(counter).padStart(3, '0');
        }
        
        // String capitalize helper
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // String'i b√ºy√ºk harf ile ba≈ülat
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Sistem planlama fakt√∂rlerini al
        function getSystemPlanningFactors() {
            return EMBEDDED_DATA.planningFactors || {
                health: { weight: 25, priority: 1 },
                preference: { weight: 20, priority: 2 },
                nutrition: { weight: 20, priority: 3 },
                variety: { weight: 15, priority: 4 },
                cost: { weight: 10, priority: 5 },
                season: { weight: 10, priority: 6 }
            };
        }
        
        // Sistem kurallarƒ±nƒ± al
        function getSystemRules() {
            return EMBEDDED_DATA.rules || [
                { id: 1, name: "Saƒülƒ±k Durumu", description: "Hastalƒ±k ve alerji kontrolleri", weight: 25 },
                { id: 2, name: "Besin Tercihleri", description: "Sevilen/sevilmeyen besinler", weight: 20 },
                { id: 3, name: "Makro Denge", description: "Karbonhidrat/protein/yaƒü oranlarƒ±", weight: 20 },
                { id: 4, name: "√áe≈üitlilik", description: "G√ºnl√ºk/haftalƒ±k √ße≈üitlilik", weight: 15 },
                { id: 5, name: "Maliyet", description: "B√ºt√ße uygunluƒüu", weight: 10 },
                { id: 6, name: "Mevsimsellik", description: "Mevsimsel besin tercihi", weight: 10 }
            ];
        }
        
        // ƒ∞lk hafta planƒ± olu≈ütur
        function createInitialWeekPlan(patientData) {
            const weekId = 'week_001';
            const startDate = new Date();
            const endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            return {
                weekId: weekId,
                patientId: patientData.id,
                weekNumber: 1,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                status: 'draft', // draft, active, completed, archived
                title: 'ƒ∞lk Hafta Planƒ±',
                description: 'Otomatik olu≈üturulan ba≈ülangƒ±√ß planƒ±',
                createdDate: new Date().toISOString(),
                createdBy: 'system',
                
                // Haftalƒ±k hedefler
                targets: {
                    dailyCalories: patientData.nutritionPreferences.targetCalories,
                    macros: patientData.nutritionPreferences.targetMacros,
                    waterIntake: 2500, // ml
                    exerciseMinutes: 30,
                    sleepHours: 8
                },
                
                // 7 g√ºnl√ºk plan
                days: generateWeeklyMealPlan(patientData),
                
                // Hafta √∂zeti
                summary: {
                    totalMeals: 0,
                    averageCalories: 0,
                    macroDistribution: { carbs: 0, protein: 0, fat: 0 },
                    varietyScore: 0,
                    completed: false
                },
                
                // Notlar ve √∂zelle≈ütirmeler
                notes: [],
                modifications: [],
                feedback: null
            };
        }
        
        // Haftalƒ±k √∂ƒü√ºn planƒ± olu≈ütur
        function generateWeeklyMealPlan(patientData) {
            const days = [];
            const dayNames = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                
                days.push({
                    dayNumber: i + 1,
                    dayName: dayNames[i],
                    date: date.toISOString().split('T')[0],
                    meals: generateDailyMeals(patientData),
                    dailyTotals: { calories: 0, carbs: 0, protein: 0, fat: 0 },
                    notes: '',
                    completed: false
                });
            }
            
            return days;
        }
        
        // G√ºnl√ºk √∂ƒü√ºnler olu≈ütur
        function generateDailyMeals(patientData) {
            const mealCount = patientData.planningSettings?.mealCount || 5;
            const mealLines = patientData.planningSettings?.mealLines || {
                breakfast: 3, snack1: 2, lunch: 4, snack2: 2, dinner: 4, night: 1
            };
            
            const meals = [
                {
                    mealType: 'breakfast',
                    mealName: 'Kahvaltƒ±',
                    time: '08:00',
                    foods: generateMealFoods('breakfast', mealLines.breakfast),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                },
                {
                    mealType: 'lunch', 
                    mealName: '√ñƒüle Yemeƒüi',
                    time: '13:00',
                    foods: generateMealFoods('lunch', mealLines.lunch),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                },
                {
                    mealType: 'dinner',
                    mealName: 'Ak≈üam Yemeƒüi', 
                    time: '19:00',
                    foods: generateMealFoods('dinner', mealLines.dinner),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                }
            ];
            
            // Ara √∂ƒü√ºnler ekle
            if (mealCount >= 4) {
                meals.splice(1, 0, {
                    mealType: 'snack1',
                    mealName: 'Ku≈üluk',
                    time: '10:30',
                    foods: generateMealFoods('snack1', mealLines.snack1),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                });
            }
            
            if (mealCount >= 5) {
                meals.splice(3, 0, {
                    mealType: 'snack2',
                    mealName: 'ƒ∞kindi',
                    time: '16:00',
                    foods: generateMealFoods('snack2', mealLines.snack2),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                });
            }
            
            if (mealCount >= 6) {
                meals.push({
                    mealType: 'night',
                    mealName: 'Gece',
                    time: '21:30',
                    foods: generateMealFoods('night', mealLines.night),
                    totals: { calories: 0, carbs: 0, protein: 0, fat: 0 }
                });
            }
            
            return meals;
        }
        
        // √ñƒü√ºn besinlerini olu≈ütur (placeholder)
        function generateMealFoods(mealType, lineCount) {
            const foods = [];
            
            for (let i = 0; i < lineCount; i++) {
                foods.push({
                    foodId: null,
                    foodName: `${mealType}_food_${i + 1}`,
                    portion: 1,
                    unit: 'porsiyon',
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    notes: ''
                });
            }
            
            return foods;
        }
        
        // Hasta detaylƒ± JSON'unu y√ºkle
        function loadPatientDetailedData(patientId) {
            const detailedKey = `patient_${patientId}_detailed`;
            const savedData = localStorage.getItem(detailedKey);
            
            if (savedData) {
                try {
                    return JSON.parse(savedData);
                } catch (error) {
                    console.error('Hasta detay verisi y√ºklenemedi:', error);
                    return null;
                }
            }
            
            return null;
        }
        
        // Hasta detaylƒ± JSON'unu kaydet
        async function savePatientDetailedData(patientId, patientData) {
            patientData.lastUpdated = new Date().toISOString();
            
            try {
                // √ñnce JSON server'a kaydetmeyi dene
                if (JSON_SERVER_ENABLED) {
                    // Hasta listesini al
                    const response = await fetch('http://localhost:3000/data/patients_list.json');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Bu hasta varsa g√ºncelle, yoksa ekle
                        let patientIndex = data.patients.findIndex(p => p.id === patientId);
                        if (patientIndex !== -1) {
                            data.patients[patientIndex] = patientData;
                        } else {
                            data.patients.push(patientData);
                        }
                        
                        // JSON server'a geri kaydet
                        const saveResponse = await fetch('http://localhost:3000/data/patients_list.json', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        
                        if (saveResponse.ok) {
                            console.log(`üíæ [Fƒ∞Zƒ∞KSEL JSON] Hasta detay verisi kaydedildi: ${patientId}`);
                            return true;
                        }
                    }
                }
                
                // JSON server ba≈üarƒ±sƒ±z olursa localStorage'a fallback
                const detailedKey = `patient_${patientId}_detailed`;
                localStorage.setItem(detailedKey, JSON.stringify(patientData, null, 2));
                console.log(`üíæ [FALLBACK] Hasta detay verisi localStorage'a kaydedildi: ${patientId}`);
                return true;
                
            } catch (error) {
                console.error('Hasta detay verisi kaydedilemedi:', error);
                
                // Hata durumunda localStorage'a kaydet
                try {
                    const detailedKey = `patient_${patientId}_detailed`;
                    localStorage.setItem(detailedKey, JSON.stringify(patientData, null, 2));
                    console.log(`üíæ [ERROR FALLBACK] Hasta detay verisi localStorage'a kaydedildi: ${patientId}`);
                    return true;
                } catch (fallbackError) {
                    console.error('localStorage fallback de ba≈üarƒ±sƒ±z:', fallbackError);
                    return false;
                }
            }
        }
        
        // Varsayƒ±lan yetkiler
        function getDefaultPermissions(userType) {
            if (userType === 'doctor') {
                return {
                    canCreatePatients: true,
                    canEditPatients: true,
                    canDeletePatients: false,
                    canViewAllPatients: true,
                    canCreatePlans: true,
                    canModifySystemSettings: false,
                    canAccessReports: true
                };
            } else if (userType === 'dietitian') {
                return {
                    canCreatePatients: true,
                    canEditPatients: true,
                    canDeletePatients: false,
                    canViewAssignedPatients: true,
                    canCreatePlans: true,
                    canModifyDietSettings: true,
                    canCreateTemplates: true,
                    canAccessReports: true
                };
            }
        }
        
        // Kullanƒ±cƒ± formunu sƒ±fƒ±rla
        function resetUserForm() {
            document.getElementById('userType').value = '';
            
            // T√ºm input alanlarƒ±nƒ± temizle
            const inputs = document.querySelectorAll('#users input, #users textarea, #users select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.type === 'select-one') {
                    if (input.id === 'patientGender') {
                        input.value = 'kadƒ±n'; // Varsayƒ±lan
                    } else if (input.id === 'patientActivity') {
                        input.value = '3'; // Varsayƒ±lan
                    } else {
                        input.selectedIndex = 0;
                    }
                } else {
                    input.value = '';
                }
            });
            
            // Formlarƒ± gizle
            showUserForm();
        }
        
        // Kullanƒ±cƒ± listelerini y√ºkle
        function loadUsersLists() {
            loadPatientsTable();
            loadDoctorsTable();
            loadDietitiansTable();
            updateUsersCounts();
        }
        
        // Hasta tablosunu y√ºkle
        function loadPatientsTable() {
            const tbody = document.getElementById('patients-table-body');
            
            // Debug: Element kontrol√º
            if (!tbody) {
                logToConsole('‚ùå patients-table-body elementi bulunamadƒ±');
                return;
            }
            
            // Debug: UsersData kontrol√º
            if (!usersData || !usersData.patients) {
                logToConsole('‚ùå usersData.patients verisi yok');
                logToConsole('üîç usersData durumu: ' + JSON.stringify(usersData));
                return;
            }
            
            logToConsole(`üìä Hasta tablosuna ${usersData.patients.length} hasta y√ºkleniyor...`);
            
            let html = '';
            usersData.patients.forEach((patient, index) => {
                logToConsole(`üìù Hasta ${index + 1}: ${patient.firstName} ${patient.lastName}`);
                
                // Detaylƒ± hasta verisini y√ºkle
                const detailedData = loadPatientDetailedData(patient.id);
                
                // Temel bilgileri al (detaylƒ± veriden veya temel veriden)
                const age = detailedData?.personalInfo?.age || patient.age || '-';
                const phone = detailedData?.personalInfo?.phone || patient.phone || '-';
                const dietType = detailedData?.nutritionPreferences?.dietType || patient.dietType || '-';
                const weight = detailedData?.personalInfo?.weight || patient.weight || '-';
                const height = detailedData?.personalInfo?.height || patient.height || '-';
                const gender = detailedData?.personalInfo?.gender || patient.gender || '-';
                
                // Diyet t√ºr√º g√∂r√ºnt√ºleme adƒ±
                const dietDisplayName = getDietDisplayName(dietType);
                
                html += `
                    <tr>
                        <td><code>${patient.id}</code></td>
                        <td>
                            <strong>${patient.firstName} ${patient.lastName}</strong>
                            <br><small class="text-muted">${age} ya≈ü, ${gender}</small>
                        </td>
                        <td>${weight !== '-' ? weight + ' kg' : '-'}</td>
                        <td>${height !== '-' ? height + ' cm' : '-'}</td>
                        <td>
                            ${phone !== '-' ? `<small>${phone}</small>` : '-'}
                        </td>
                        <td>
                            <span class="badge ${patient.status === 'active' ? 'bg-success' : 'bg-warning'}">${patient.status}</span>
                            <br><small class="text-muted">${dietDisplayName}</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewPatientJSON('${patient.id}')" title="JSON G√∂r√ºnt√ºle">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editPatient('${patient.id}')" title="D√ºzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" class="text-center text-muted">Hen√ºz hasta kaydƒ± bulunmamaktadƒ±r.</td></tr>';
                logToConsole('‚ö†Ô∏è HTML i√ßeriƒüi bo≈ü - varsayƒ±lan mesaj eklendi');
            }
            
            tbody.innerHTML = html;
            logToConsole(`‚úÖ Hasta tablosu g√ºncellendi. HTML uzunluƒüu: ${html.length} karakter`);
        }
        
        // Doktor tablosunu y√ºkle
        function loadDoctorsTable() {
            const tbody = document.getElementById('doctors-table-body');
            if (!tbody || !usersData.doctors) return;
            
            let html = '';
            usersData.doctors.forEach(doctor => {
                html += `
                    <tr>
                        <td><code>${doctor.id}</code></td>
                        <td>Dr. ${doctor.firstName} ${doctor.lastName}</td>
                        <td><span class="badge bg-info">${doctor.specialization}</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td><span class="badge bg-success">${doctor.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('doctor', '${doctor.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('doctor', '${doctor.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" class="text-center text-muted">Hen√ºz doktor kaydƒ± bulunmamaktadƒ±r.</td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        // Diyetisyen tablosunu y√ºkle
        function loadDietitiansTable() {
            const tbody = document.getElementById('dietitians-table-body');
            if (!tbody || !usersData.dietitians) return;
            
            let html = '';
            usersData.dietitians.forEach(dietitian => {
                html += `
                    <tr>
                        <td><code>${dietitian.id}</code></td>
                        <td>Dyt. ${dietitian.firstName} ${dietitian.lastName}</td>
                        <td><span class="badge bg-warning">${dietitian.specialization}</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td><span class="badge bg-success">${dietitian.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('dietitian', '${dietitian.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('dietitian', '${dietitian.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" class="text-center text-muted">Hen√ºz diyetisyen kaydƒ± bulunmamaktadƒ±r.</td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        // Kullanƒ±cƒ± sayƒ±larƒ±nƒ± g√ºncelle
        function updateUsersCounts() {
            const patientsCount = usersData.patients?.length || 0;
            const doctorsCount = usersData.doctors?.length || 0;
            const dietitiansCount = usersData.dietitians?.length || 0;
            
            // Debug loglarƒ±
            logToConsole(`üî¢ Sayƒ± g√ºncellemeleri: Hastalar: ${patientsCount}, Doktorlar: ${doctorsCount}, Diyetisyenler: ${dietitiansCount}`);
            
            // DOM elementlerini g√ºncelle
            const patientsCountEl = document.getElementById('patients-count');
            const doctorsCountEl = document.getElementById('doctors-count');
            const dietitiansCountEl = document.getElementById('dietitians-count');
            
            if (patientsCountEl) patientsCountEl.textContent = patientsCount;
            if (doctorsCountEl) doctorsCountEl.textContent = doctorsCount;
            if (dietitiansCountEl) dietitiansCountEl.textContent = dietitiansCount;
            
            logToConsole(`‚úÖ Kullanƒ±cƒ± sayƒ±larƒ± g√ºncellendi`);
        }
        
        // Console'a log yaz
        function logToConsole(message) {
            const console = document.getElementById('console-log');
            if (console) {
                const time = new Date().toLocaleTimeString();
                console.innerHTML += `<div>[${time}] ${message}</div>`;
                console.scrollTop = console.scrollHeight;
            }
        }
        
        // Placeholder fonksiyonlar
        function createNewTemplate() {
            alert('Yeni ≈üablon olu≈üturma √∂zelliƒüi geli≈ütirilecek...');
        }
        
        function editTemplate(id) {
            alert('≈ûablon d√ºzenleme √∂zelliƒüi geli≈ütirilecek...');
        }
        
        function deleteTemplate(id) {
            if (confirm('Bu ≈üablonu silmek istediƒüinize emin misiniz?')) {
                alert('≈ûablon silme √∂zelliƒüi geli≈ütirilecek...');
            }
        }
        
        // √ñƒü√ºn satƒ±r sayƒ±sƒ± input kontrol√º
        function toggleMealRangeInputs(mealType) {
            const fixedInput = document.getElementById(`${mealType}-fixed`);
            const minInput = document.getElementById(`${mealType}-min`);
            const maxInput = document.getElementById(`${mealType}-max`);
            
            if (fixedInput && minInput && maxInput) {
                const hasFixedValue = fixedInput.value && fixedInput.value.trim() !== '';
                const fixedValue = parseInt(fixedInput.value) || 0;
                
                // Sabit deƒüer varsa min/max'ƒ± pasif yap
                minInput.disabled = hasFixedValue;
                maxInput.disabled = hasFixedValue;
                
                // G√∂rsel feedback
                if (hasFixedValue) {
                    minInput.style.backgroundColor = '#f8f9fa';
                    maxInput.style.backgroundColor = '#f8f9fa';
                    minInput.style.color = '#6c757d';
                    maxInput.style.color = '#6c757d';
                } else {
                    minInput.style.backgroundColor = '';
                    maxInput.style.backgroundColor = '';
                    minInput.style.color = '';
                    maxInput.style.color = '';
                }
                
                // Debug log
                logToConsole(`üéØ ${mealType} √∂ƒü√ºn√º: ${hasFixedValue ? 'Sabit ' + fixedInput.value : 'Aralƒ±k ' + minInput.value + '-' + maxInput.value}`);
                
                // Makro daƒüƒ±lƒ±m input'unu kontrol et - sabit deƒüer 0 ise pasif yap
                const macroInput = document.getElementById(`${mealType}-macro`);
                if (macroInput) {
                    // √ñƒü√ºn sayƒ±sƒ± 0 ise makro input'unu pasif yap
                    const shouldDisable = hasFixedValue && fixedValue === 0;
                    macroInput.disabled = shouldDisable;
                    
                    if (shouldDisable) {
                        macroInput.style.backgroundColor = '#f8f9fa';
                        macroInput.style.color = '#6c757d';
                        macroInput.value = '0'; // Deƒüeri de 0 yap
                    } else {
                        macroInput.style.backgroundColor = '';
                        macroInput.style.color = '';
                    }
                    
                    // Makro toplamƒ±nƒ± g√ºncelle
                    updateMealMacroTotal();
                }
            }
        }
        
        // Sabit yemek butonu durumunu g√ºncelle
        function updateFixedMealButton(mealType) {
            const fixedInput = document.getElementById(`${mealType}-fixed`);
            const minInput = document.getElementById(`${mealType}-min`);
            const maxInput = document.getElementById(`${mealType}-max`);
            const addButton = document.getElementById(`add-${mealType}-fixed-meal-btn`);
            const container = document.getElementById(`${mealType}-fixed-meals-container`);
            
            if (!addButton || !container) return;
            
            // Satƒ±r sayƒ±sƒ±nƒ± kontrol et
            let mealCount = 0;
            
            if (fixedInput && fixedInput.value && fixedInput.value.trim() !== '') {
                mealCount = parseInt(fixedInput.value) || 0;
            } else if (minInput && minInput.value) {
                mealCount = parseInt(minInput.value) || 0;
            }
            
            // En az 1 satƒ±r varsa buton aktif, yoksa pasif
            if (mealCount > 0) {
                // Aktif duruma getir
                addButton.disabled = false;
                addButton.classList.remove('btn-outline-secondary');
                addButton.classList.add('btn-outline-primary');
                
                // Container'ƒ± aktif hale getir
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
                
                // Mevcut satƒ±rlarƒ± aktif hale getir
                const existingRows = container.querySelectorAll('.row');
                existingRows.forEach(row => {
                    if (row.id.includes('fixed-meal-')) {
                        row.style.opacity = '1';
                        const inputs = row.querySelectorAll('input, button');
                        inputs.forEach(input => input.disabled = false);
                    }
                });
                
            } else {
                // Pasif duruma getir
                addButton.disabled = true;
                addButton.classList.remove('btn-outline-primary');
                addButton.classList.add('btn-outline-secondary');
                
                // Container'ƒ± pasif hale getir
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
                
                // Mevcut satƒ±rlarƒ± pasif hale getir
                const existingRows = container.querySelectorAll('.row');
                existingRows.forEach(row => {
                    if (row.id.includes('fixed-meal-')) {
                        row.style.opacity = '0.5';
                        const inputs = row.querySelectorAll('input, button');
                        inputs.forEach(input => input.disabled = true);
                    }
                });
            }
            
            console.log(`üéØ ${mealType} sabit yemek container durumu: ${mealCount > 0 ? 'aktif' : 'pasif'} (sayƒ±: ${mealCount})`);
        }
        
        // Sabit yemek satƒ±rƒ± ekle
        function addFixedMealRow(mealType) {
            const listContainer = document.getElementById(`${mealType}-fixed-meals-list`);
            if (!listContainer) return;
            
            const rowId = `${mealType}-fixed-meal-${Date.now()}`;
            
            const mealRow = document.createElement('div');
            mealRow.className = 'row align-items-center mb-2 p-2 border rounded bg-white';
            mealRow.id = rowId;
            
            mealRow.innerHTML = `
                <div class="col-8">
                    <div class="position-relative">
                        <input type="text" class="form-control form-control-sm fixed-meal-search" 
                               placeholder="Yemek adƒ± yazƒ±n..." 
                               oninput="searchFixedMeal(this); autoSaveFixedMeals();" 
                               onfocus="showFixedMealSuggestions(this)"
                               onblur="hideFixedMealSuggestions(this)"
                               data-meal-type="${mealType}" 
                               data-row-id="${rowId}">
                        <div class="fixed-meal-suggestions position-absolute w-100 bg-white border rounded shadow-sm d-none" 
                             style="top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="col-2">
                    <input type="text" class="form-control form-control-sm fixed-meal-amount" 
                           placeholder="Porsiyon" 
                           value="1"
                           title="Porsiyon katsayƒ±sƒ± veya '-' (otomatik)"
                           oninput="validateFixedMealAmount(this); autoSaveFixedMeals();">
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            onclick="removeFixedMealRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            listContainer.appendChild(mealRow);
            console.log(`‚ûï ${mealType} √∂ƒü√ºn√º i√ßin sabit yemek satƒ±rƒ± eklendi`);
            
            // Container durumunu kontrol et ve g√ºncelle
            updateFixedMealButton(mealType);
            
            // Focus to input
            const input = mealRow.querySelector('.fixed-meal-search');
            if (input) input.focus();
            
            // Otomatik kaydet
            setTimeout(() => {
                saveFixedMealsToStorage();
                console.log('üíæ Yeni satƒ±r eklendikten sonra otomatik kayƒ±t yapƒ±ldƒ±');
            }, 500);
        }
        
        // Sabit yemek satƒ±rƒ±nƒ± sil
        function removeFixedMealRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                // Meal type'ƒ± row id'den √ßƒ±kar
                const mealType = rowId.split('-fixed-meal-')[0];
                
                row.remove();
                console.log(`üóëÔ∏è Sabit yemek satƒ±rƒ± silindi: ${rowId}`);
                
                // Container durumunu kontrol et ve g√ºncelle
                if (mealType) {
                    updateFixedMealButton(mealType);
                }
                
                // Otomatik kaydet
                setTimeout(() => {
                    saveFixedMealsToStorage();
                    console.log('üíæ Satƒ±r silindikten sonra otomatik kayƒ±t yapƒ±ldƒ±');
                }, 100);
            }
        }
        
        // Otomatik kaydetme i√ßin yardƒ±mcƒ± fonksiyon
        function autoSaveFixedMeals() {
            clearTimeout(window.fixedMealSaveTimeout);
            window.fixedMealSaveTimeout = setTimeout(async () => {
                await saveFixedMealsToStorage();
                console.log('üíæ [Fƒ∞Zƒ∞KSEL JSON] Sabit yemek deƒüi≈üikliƒüi otomatik kaydedildi');
            }, 800);
        }
        
        // Sabit yemek arama fonksiyonu
        function searchFixedMeal(input) {
            const query = input.value.toLowerCase().trim();
            const suggestionsDiv = input.parentElement.querySelector('.fixed-meal-suggestions');
            
            if (!query || query.length < 2) {
                suggestionsDiv.classList.add('d-none');
                return;
            }
            
            // Yemek veritabanƒ±ndan arama yap
            const meals = getFoodDatabase();
            if (!meals || meals.length === 0) {
                suggestionsDiv.innerHTML = '<div class="p-2 text-muted">Yemek veritabanƒ± y√ºklenmedi</div>';
                suggestionsDiv.classList.remove('d-none');
                return;
            }
            
            const matches = meals.filter(meal => 
                meal.name.toLowerCase().includes(query) ||
                (meal.category && meal.category.toLowerCase().includes(query))
            ).slice(0, 8); // En fazla 8 sonu√ß
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.map(meal => `
                    <div class="suggestion-item p-2 border-bottom" 
                         style="cursor: pointer;"
                         onmousedown="selectFixedMeal('${input.dataset.rowId}', '${meal.name.replace(/'/g, "\\'")}', ${meal.calories || 0}, ${meal.carbs || 0}, ${meal.protein || 0}, ${meal.fat || 0}, ${meal.minQuantity || 1}, ${meal.maxQuantity || 2}, ${meal.step || 0.5})"
                         onmouseover="this.style.backgroundColor='#f8f9fa'"
                         onmouseout="this.style.backgroundColor=''">
                        <div class="fw-bold">${meal.name}</div>
                        <small class="text-muted">${meal.calories || 0} kcal ‚Ä¢ ${meal.category || 'Genel'} ‚Ä¢ ${meal.minQuantity || 1}-${meal.maxQuantity || 2} porsiyon</small>
                    </div>
                `).join('');
                suggestionsDiv.classList.remove('d-none');
            } else {
                suggestionsDiv.innerHTML = '<div class="p-2 text-muted">Sonu√ß bulunamadƒ±</div>';
                suggestionsDiv.classList.remove('d-none');
            }
        }
        
        // Yemek veritabanƒ±nƒ± al
        function getFoodDatabase() {
            // Global window.foodsData'yƒ± kullan
            if (window.foodsData && window.foodsData.length > 0) {
                console.log('üçΩÔ∏è Yemek veritabanƒ± bulundu:', window.foodsData.length, 'yemek');
                return window.foodsData;
            }
            
            // Fallback: localStorage'dan dene
            try {
                const stored = localStorage.getItem('foodsData');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    console.log('üçΩÔ∏è localStorage\'dan yemek veritabanƒ± y√ºklendi:', parsed.length, 'yemek');
                    return parsed;
                }
            } catch (e) {
                console.warn('localStorage yemek veritabanƒ± okuma hatasƒ±:', e);
            }
            
            // Son fallback: basit demo veriler
            const demoFoods = [
                { name: 'Kur≈üun Ge√ßirmez Kahve', category: 'ƒ∞√ßecek', calories: 5, carbs: 0, protein: 0, fat: 0, minQuantity: 1, maxQuantity: 3, step: 0.5 },
                { name: 'Sade Omlet', category: 'Protein', calories: 180, carbs: 2, protein: 12, fat: 14, minQuantity: 1, maxQuantity: 2, step: 0.5 },
                { name: 'Avokado', category: 'Meyve', calories: 250, carbs: 12, protein: 3, fat: 23, minQuantity: 1, maxQuantity: 1.5, step: 0.25 },
                { name: 'Badem', category: 'Kuruyemi≈ü', calories: 580, carbs: 22, protein: 21, fat: 50, minQuantity: 1, maxQuantity: 2, step: 0.5 },
                { name: 'Izgara Tavuk', category: 'Protein', calories: 165, carbs: 0, protein: 31, fat: 4, minQuantity: 1, maxQuantity: 2, step: 0.5 },
                { name: 'Brokoli', category: 'Sebze', calories: 34, carbs: 7, protein: 3, fat: 0, minQuantity: 1, maxQuantity: 3, step: 0.5 },
                { name: 'Karnabahar', category: 'Sebze', calories: 25, carbs: 5, protein: 2, fat: 0, minQuantity: 1, maxQuantity: 3, step: 0.5 },
                { name: 'Somon', category: 'Protein', calories: 200, carbs: 0, protein: 25, fat: 11, minQuantity: 1, maxQuantity: 2, step: 0.5 }
            ];
            
            console.log('üçΩÔ∏è Demo yemek veritabanƒ± kullanƒ±lƒ±yor:', demoFoods.length, 'yemek');
            return demoFoods;
        }
        
        // Sabit yemek se√ß
        function selectFixedMeal(rowId, mealName, calories, carbs, protein, fat, minQuantity, maxQuantity, step) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const input = row.querySelector('.fixed-meal-search');
            const suggestionsDiv = row.querySelector('.fixed-meal-suggestions');
            const amountInput = row.querySelector('.fixed-meal-amount');
            
            if (input) {
                input.value = mealName;
                input.dataset.selectedMeal = JSON.stringify({
                    name: mealName,
                    calories: calories,
                    carbs: carbs,
                    protein: protein,
                    fat: fat,
                    minQuantity: minQuantity || 1,
                    maxQuantity: maxQuantity || 2,
                    step: step || 0.5
                });
            }
            
            // Miktar input'unu porsiyon katsayƒ±sƒ± sistemiyle deƒüi≈ütir
            if (amountInput) {
                const min = minQuantity || 1;
                const max = maxQuantity || 2;
                const stepSize = step || 0.5;
                
                // Input'u number type'a √ßevir ve spin butonlarƒ± ekle
                amountInput.type = 'number';
                amountInput.min = min;
                amountInput.max = max;
                amountInput.step = stepSize;
                amountInput.placeholder = `${min}-${max} veya "-"`;
                amountInput.title = `${mealName} i√ßin porsiyon katsayƒ±sƒ±: ${min}-${max} (adƒ±m: ${stepSize}). "-" girerseniz otomatik planlama porsiyon belirler.`;
                
                // Varsayƒ±lan deƒüer olarak 1 al (eƒüer aralƒ±k i√ßindeyse)
                const defaultValue = (min <= 1 && max >= 1) ? 1 : min;
                amountInput.value = defaultValue;
                
                console.log(`üéØ ${mealName} porsiyon aralƒ±ƒüƒ± ayarlandƒ±: ${min}-${max} (adƒ±m: ${stepSize}), varsayƒ±lan: ${defaultValue}`);
            }
            
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('d-none');
            }
            
            console.log(`üéØ Sabit yemek se√ßildi: ${mealName} (${minQuantity}-${maxQuantity} porsiyon, adƒ±m: ${step})`);
            
            // Otomatik kaydet
            setTimeout(() => {
                saveFixedMealsToStorage();
                console.log('üíæ Yemek se√ßimi sonrasƒ± otomatik kayƒ±t yapƒ±ldƒ±');
            }, 200);
        }
        
        // Sabit yemek miktar validasyonu
        function validateFixedMealAmount(input) {
            const value = input.value.trim();
            const row = input.closest('.row');
            const searchInput = row ? row.querySelector('.fixed-meal-search') : null;
            
            // Eƒüer yemek se√ßilmemi≈üse validasyon yapma
            if (!searchInput || !searchInput.dataset.selectedMeal) {
                return;
            }
            
            try {
                const mealData = JSON.parse(searchInput.dataset.selectedMeal);
                const min = mealData.minQuantity || 1;
                const max = mealData.maxQuantity || 2;
                const step = mealData.step || 0.5;
                
                // "-" deƒüeri otomatik planlama anlamƒ±na gelir
                if (value === '-' || value === '') {
                    input.style.borderColor = '#28a745'; // Ye≈üil
                    input.title = `${mealData.name} i√ßin otomatik porsiyon (${min}-${max} arasƒ±nda, adƒ±m: ${step})`;
                    return;
                }
                
                // Sayƒ±sal deƒüer kontrol et
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    input.style.borderColor = '#dc3545'; // Kƒ±rmƒ±zƒ±
                    input.title = `Ge√ßerli porsiyon katsayƒ±sƒ± girin (${min}-${max}, adƒ±m: ${step}) veya "-"`;
                    return;
                }
                
                // Step kontrol√º
                const stepsFromMin = (numValue - min) / step;
                const isValidStep = Math.abs(stepsFromMin - Math.round(stepsFromMin)) < 0.001;
                
                if (!isValidStep) {
                    input.style.borderColor = '#ffc107'; // Sarƒ±
                    input.title = `${mealData.name}: ${step} adƒ±mlarƒ±nda olmalƒ± (√∂rn: ${min}, ${min + step}, ${min + step * 2}...)`;
                    return;
                }
                
                // Aralƒ±k kontrol√º
                if (numValue >= min && numValue <= max) {
                    input.style.borderColor = '#28a745'; // Ye≈üil
                    input.title = `${mealData.name}: ${numValue} porsiyon (ge√ßerli aralƒ±k: ${min}-${max}, adƒ±m: ${step})`;
                } else {
                    input.style.borderColor = '#ffc107'; // Sarƒ± (uyarƒ±)
                    input.title = `√ñnerilen aralƒ±k ${min}-${max} porsiyon, girilen: ${numValue}`;
                }
                
            } catch (e) {
                console.warn('Porsiyon validasyonu hatasƒ±:', e);
            }
        }
        
        // √ñnerileri g√∂ster
        function showFixedMealSuggestions(input) {
            if (input.value.length >= 2) {
                searchFixedMeal(input);
            }
        }
        
        // √ñnerileri gizle (delay ile)
        function hideFixedMealSuggestions(input) {
            setTimeout(() => {
                const suggestionsDiv = input.parentElement.querySelector('.fixed-meal-suggestions');
                if (suggestionsDiv) {
                    suggestionsDiv.classList.add('d-none');
                }
            }, 200); // Click event'ini yakalamak i√ßin delay
        }
        
        // Sabit yemekleri storage'a kaydet
        async function saveFixedMealsToStorage() {
            const fixedMeals = {};
            const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
            
            mealTypes.forEach(mealType => {
                const listContainer = document.getElementById(`${mealType}-fixed-meals-list`);
                if (listContainer) {
                    const rows = listContainer.querySelectorAll('.row');
                    fixedMeals[mealType] = [];
                    
                    rows.forEach(row => {
                        const input = row.querySelector('.fixed-meal-search');
                        const amountInput = row.querySelector('.fixed-meal-amount');
                        
                        if (input && input.value.trim()) {
                            const amountValue = amountInput ? amountInput.value.trim() : '1';
                            
                            // Eƒüer selectedMeal dataset'i varsa onu kullan
                            if (input.dataset.selectedMeal) {
                                try {
                                    const mealData = JSON.parse(input.dataset.selectedMeal);
                                    fixedMeals[mealType].push({
                                        name: mealData.name,
                                        amount: amountValue === '-' || amountValue === '' ? 'auto' : amountValue,
                                        calories: mealData.calories,
                                        carbs: mealData.carbs,
                                        protein: mealData.protein,
                                        fat: mealData.fat,
                                        minQuantity: mealData.minQuantity,
                                        maxQuantity: mealData.maxQuantity,
                                        step: mealData.step
                                    });
                                } catch (e) {
                                    console.warn('Sabit yemek verisi parse edilemedi:', e);
                                }
                            } else {
                                // Manuel girilen yemek - basit format
                                fixedMeals[mealType].push({
                                    name: input.value.trim(),
                                    amount: amountValue === '-' || amountValue === '' ? 'auto' : amountValue,
                                    calories: 0,
                                    carbs: 0,
                                    protein: 0,
                                    fat: 0,
                                    minQuantity: 1,
                                    maxQuantity: 2,
                                    step: 0.5,
                                    isManual: true
                                });
                                console.log(`üìù [MANUAL-MEAL] Manuel yemek kaydedildi: ${input.value.trim()}`);
                            }
                        }
                    });
                }
            });
            
            // **YENƒ∞: TEMPLATE-SPECIFIC SABƒ∞T YEMEK KAYDETME**
            const templateId = getCurrentTemplateId();
            console.log(`üîç [DEBUG-FIXED-MEALS] getCurrentTemplateId() = ${templateId}`);
            console.log(`üîç [DEBUG-FIXED-MEALS] criteria-week-select value =`, document.getElementById('criteria-week-select')?.value);
            
            if (templateId) {
                console.log(`üíæ [TEMPLATE-FIXED-MEALS] ≈ûablon ${templateId} sabit yemekleri kaydediliyor:`, fixedMeals);
                await saveTemplateSpecificData(templateId, 'fixedMeals', fixedMeals);
                console.log(`‚úÖ [TEMPLATE-FIXED-MEALS] ≈ûablon ${templateId} sabit yemekleri kaydedildi`);
                
                // GitHub'a da kaydet
                if (GITHUB_CONFIG.token) {
                    try {
                        const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                        await saveToGitHub('data/system_settings.json', systemSettings, `Update template ${templateId} fixed meals`);
                        console.log(`‚úÖ [GITHUB] ≈ûablon ${templateId} sabit yemekleri GitHub'a kaydedildi`);
                    } catch (error) {
                        console.warn('‚ùå GitHub kaydetme hatasƒ±:', error);
                    }
                }
                
                return;
            }
            
            // Aktif hafta kontrol et (eski sistem)
            const weekSelect = document.getElementById('criteria-week-select');
            const selectedValue = weekSelect?.value;
            
            if (selectedValue && selectedValue !== 'system') {
                // Hafta ≈üablonu se√ßilmi≈ü - hafta ≈üablonuna kaydet
                if (selectedValue.startsWith('template_')) {
                    const weekNo = parseInt(selectedValue.replace('template_', ''));
                    await saveSystemSettings(null, weekNo, { fixedMeals });
                    console.log(`üíæ [Fƒ∞Zƒ∞KSEL JSON] ≈ûablon ${weekNo} sabit yemekleri kaydedildi:`, fixedMeals);
                } else {
                    // Hasta haftasƒ± se√ßilmi≈ü - hasta haftasƒ±na kaydet  
                    const weekNo = parseInt(selectedValue);
                    if (currentPatient && currentPatient.weeklyPlans) {
                        let weekPlan = currentPatient.weeklyPlans.find(w => w.weekNumber === weekNo);
                        if (!weekPlan) {
                            weekPlan = { weekNumber: weekNo };
                            currentPatient.weeklyPlans.push(weekPlan);
                        }
                        weekPlan.fixedMeals = fixedMeals;
                        
                        // Hasta verisini JSON server'a kaydet
                        const pid = getCurrentPatientId && getCurrentPatientId();
                        if (pid) {
                            try { 
                                await savePatientDetailedData(pid, currentPatient); 
                                console.log(`üíæ [Fƒ∞Zƒ∞KSEL JSON] Hasta hafta ${weekNo} sabit yemekleri kaydedildi:`, fixedMeals);
                            } catch(e) {
                                console.error('Hasta hafta sabit yemek kaydetme hatasƒ±:', e);
                            }
                        }
                    }
                }
            } else {
                // Sistem geneli (varsayƒ±lan) - sistem ayarlarƒ±na kaydet
                await saveSystemSettings({ fixedMeals });
                console.log('üíæ [Fƒ∞Zƒ∞KSEL JSON] Sistem varsayƒ±lan sabit yemekleri kaydedildi:', fixedMeals);
            }
        }
        
        // Sabit yemekleri storage'dan y√ºkle
        async function loadFixedMealsFromStorage() {
            try {
                let fixedMeals = null;
                
                // **YENƒ∞: TEMPLATE-SPECIFIC SABƒ∞T YEMEK Y√úKLEME**  
                const templateId = getCurrentTemplateId();
                if (templateId) {
                    console.log(`üì• [TEMPLATE-FIXED-MEALS] ≈ûablon ${templateId} sabit yemekleri y√ºkleniyor...`);
                    
                    const templateFixedMeals = await loadTemplateSpecificData(templateId, 'fixedMeals');
                    if (templateFixedMeals) {
                        console.log(`‚úÖ [TEMPLATE-FIXED-MEALS] ≈ûablon ${templateId} sabit yemekleri bulundu:`, templateFixedMeals);
                        loadFixedMealsFromWeekProfile(templateFixedMeals);
                        return templateFixedMeals;
                    } else {
                        console.log(`‚ö†Ô∏è [TEMPLATE-FIXED-MEALS] ≈ûablon ${templateId} i√ßin sabit yemek bulunamadƒ±, varsayƒ±lan kullanƒ±lacak`);
                    }
                }
                
                // ESKƒ∞ Sƒ∞STEM: Hafta veya sistem varsayƒ±lan y√ºkleme
                const weekSelect = document.getElementById('criteria-week-select');
                const selectedValue = weekSelect?.value;
                console.log('üîç [SABIT YEMEK Y√úKLEME] Se√ßili deƒüer:', selectedValue);
                
                if (selectedValue && selectedValue !== 'system') {
                    // Hafta ≈üablonu se√ßilmi≈ü - o haftanƒ±n sabit yemeklerini y√ºkle
                    if (selectedValue.startsWith('template_')) {
                        const weekNo = parseInt(selectedValue.replace('template_', ''));
                        console.log('üîç [≈ûABLON Y√úKLEME] Hafta numarasƒ±:', weekNo);
                        
                        // JSON server'dan sistem ayarlarƒ±nƒ± y√ºkle
                        if (JSON_SERVER_ENABLED) {
                            try {
                                const response = await fetch('http://localhost:3000/data/system_settings.json');
                                if (response.ok) {
                                    const systemSettings = await response.json();
                                    const profile = systemSettings?.weeklyProfiles?.[weekNo];
                                    console.log('üîç [≈ûABLON PROFIL]:', profile);
                                    console.log('üîç [≈ûABLON SABIT YEMEK]:', profile?.fixedMeals);
                                    
                                    if (profile && profile.fixedMeals) {
                                        fixedMeals = profile.fixedMeals;
                                        console.log(`üîÑ [Fƒ∞Zƒ∞KSEL JSON] ≈ûablon ${weekNo} sabit yemekleri y√ºkleniyor:`, fixedMeals);
                                    } else {
                                        console.log(`‚ö†Ô∏è ≈ûablon ${weekNo} i√ßin fixedMeals bulunamadƒ±`);
                                        fixedMeals = { breakfast: [], snack1: [], lunch: [], snack2: [], dinner: [] };
                                    }
                                }
                            } catch (e) {
                                console.warn('JSON server\'dan ≈üablon sabit yemek y√ºklenemedi, localStorage\'a ge√ßiliyor');
                            }
                        }
                        
                        // Fallback: localStorage'dan y√ºkle
                        if (!fixedMeals) {
                            const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                            const profile = systemSettings?.weeklyProfiles?.[weekNo];
                            
                            if (profile && profile.fixedMeals) {
                                fixedMeals = profile.fixedMeals;
                                console.log(`üîÑ [FALLBACK] ≈ûablon ${weekNo} sabit yemekleri localStorage\'dan y√ºkleniyor:`, fixedMeals);
                            } else {
                                fixedMeals = { breakfast: [], snack1: [], lunch: [], snack2: [], dinner: [] };
                            }
                        }
                    } else {
                        // Hasta haftasƒ± se√ßilmi≈ü - hasta haftasƒ±nƒ±n sabit yemeklerini y√ºkle
                        const weekNo = parseInt(selectedValue);
                        if (currentPatient && currentPatient.weeklyPlans) {
                            const weekPlan = currentPatient.weeklyPlans.find(w => w.weekNumber === weekNo);
                            if (weekPlan && weekPlan.fixedMeals) {
                                fixedMeals = weekPlan.fixedMeals;
                                console.log(`üîÑ [Fƒ∞Zƒ∞KSEL JSON] Hasta hafta ${weekNo} sabit yemekleri y√ºkleniyor:`, fixedMeals);
                            } else {
                                fixedMeals = { breakfast: [], snack1: [], lunch: [], snack2: [], dinner: [] };
                            }
                        }
                    }
                } else {
                    // Sistem geneli (varsayƒ±lan) sabit yemekler
                    if (JSON_SERVER_ENABLED) {
                        try {
                            const response = await fetch('http://localhost:3000/data/system_settings.json');
                            if (response.ok) {
                                const systemSettings = await response.json();
                                if (systemSettings.systemDefaults && systemSettings.systemDefaults.fixedMeals) {
                                    fixedMeals = systemSettings.systemDefaults.fixedMeals;
                                    console.log('üîÑ [Fƒ∞Zƒ∞KSEL JSON] Sistem varsayƒ±lan sabit yemekleri y√ºkleniyor:', fixedMeals);
                                }
                            }
                        } catch (e) {
                            console.warn('JSON server\'dan sistem sabit yemek y√ºklenemedi, localStorage\'a ge√ßiliyor');
                        }
                    }
                    
                    // Fallback: localStorage'dan y√ºkle
                    if (!fixedMeals) {
                        fixedMeals = JSON.parse(localStorage.getItem('fixedMeals') || '{}');
                        console.log('üîÑ [FALLBACK] Sistem varsayƒ±lan sabit yemekleri localStorage\'dan y√ºkleniyor:', fixedMeals);
                    }
                }
                
                // Default bo≈ü obje
                if (!fixedMeals) {
                    fixedMeals = { breakfast: [], snack1: [], lunch: [], snack2: [], dinner: [] };
                }
                
                const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
                
                mealTypes.forEach(mealType => {
                    const meals = fixedMeals[mealType] || [];
                    const listContainer = document.getElementById(`${mealType}-fixed-meals-list`);
                    
                    if (listContainer) {
                        listContainer.innerHTML = ''; // Temizle
                        
                        meals.forEach(meal => {
                            addFixedMealRow(mealType);
                            
                            // Son eklenen satƒ±rƒ± bul ve doldur
                            const rows = listContainer.querySelectorAll('.row');
                            const lastRow = rows[rows.length - 1];
                            
                            if (lastRow) {
                                const input = lastRow.querySelector('.fixed-meal-search');
                                const amountInput = lastRow.querySelector('.fixed-meal-amount');
                                
                                if (input) {
                                    input.value = meal.name;
                                    input.dataset.selectedMeal = JSON.stringify({
                                        name: meal.name,
                                        calories: meal.calories,
                                        carbs: meal.carbs,
                                        protein: meal.protein,
                                        fat: meal.fat,
                                        minQuantity: meal.minQuantity,
                                        maxQuantity: meal.maxQuantity
                                    });
                                }
                                
                                if (amountInput) {
                                    const displayAmount = meal.amount === 'auto' ? '-' : meal.amount;
                                    amountInput.value = displayAmount;
                                    
                                    // Min-max ayarlarƒ± ve validasyon
                                    if (meal.minQuantity && meal.maxQuantity) {
                                        amountInput.min = meal.minQuantity;
                                        amountInput.max = meal.maxQuantity;
                                        amountInput.placeholder = `${meal.minQuantity}-${meal.maxQuantity}g veya "-"`;
                                        amountInput.title = `${meal.name} i√ßin miktar aralƒ±ƒüƒ±: ${meal.minQuantity}-${meal.maxQuantity}g. "-" girerseniz otomatik planlama miktar belirler.`;
                                        
                                        // Validasyon uygula
                                        validateFixedMealAmount(amountInput);
                                    }
                                    
                                    // Otomatik kaydetme event listener ekle
                                    amountInput.addEventListener('input', function() {
                                        validateFixedMealAmount(this);
                                        autoSaveFixedMeals();
                                    });
                                    
                                    amountInput.addEventListener('change', function() {
                                        validateFixedMealAmount(this);
                                        autoSaveFixedMeals();
                                    });
                                }
                                
                                // Search input'a da event listener ekle (loadFixedMealsFromStorage)
                                const currentRow = amountInput.closest('.row');
                                if (currentRow) {
                                    const searchInput = currentRow.querySelector('.fixed-meal-search');
                                    if (searchInput) {
                                        searchInput.addEventListener('input', function() {
                                            autoSaveFixedMeals();
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Buton durumunu g√ºncelle
                    updateFixedMealButton(mealType);
                });
                
                console.log('üì• Sabit yemekler y√ºklendi:', fixedMeals);
            } catch (e) {
                console.warn('Sabit yemek y√ºkleme hatasƒ±:', e);
            }
        }
        
        // Hafta profil sabit yemeklerini direkt y√ºkle (context karƒ±≈üƒ±klƒ±ƒüƒ±nƒ± √∂nlemek i√ßin)
        function loadFixedMealsFromWeekProfile(fixedMeals) {
            try {
                console.log('üîÑ Hafta profil sabit yemekleri y√ºkleniyor:', fixedMeals);
                
                const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
                
                mealTypes.forEach(mealType => {
                    const meals = fixedMeals[mealType] || [];
                    const listContainer = document.getElementById(`${mealType}-fixed-meals-list`);
                    
                    if (listContainer) {
                        listContainer.innerHTML = ''; // Temizle
                        
                        meals.forEach(meal => {
                            addFixedMealRow(mealType);
                            
                            // Son eklenen satƒ±rƒ± bul ve doldur
                            const rows = listContainer.querySelectorAll('.row');
                            const lastRow = rows[rows.length - 1];
                            
                            if (lastRow) {
                                const input = lastRow.querySelector('.fixed-meal-search');
                                const amountInput = lastRow.querySelector('.fixed-meal-amount');
                                
                                if (input) {
                                    input.value = meal.name;
                                    input.dataset.selectedMeal = JSON.stringify({
                                        name: meal.name,
                                        calories: meal.calories,
                                        carbs: meal.carbs,
                                        protein: meal.protein,
                                        fat: meal.fat,
                                        minQuantity: meal.minQuantity,
                                        maxQuantity: meal.maxQuantity,
                                        step: meal.step
                                    });
                                }
                                
                                if (amountInput) {
                                    const displayAmount = meal.amount === 'auto' ? '-' : meal.amount;
                                    amountInput.value = displayAmount;
                                    
                                    // Min-max ayarlarƒ± ve validasyon
                                    if (meal.minQuantity && meal.maxQuantity) {
                                        amountInput.type = 'number';
                                        amountInput.min = meal.minQuantity;
                                        amountInput.max = meal.maxQuantity;
                                        amountInput.step = meal.step || 0.5;
                                        amountInput.placeholder = `${meal.minQuantity}-${meal.maxQuantity} veya "-"`;
                                        amountInput.title = `${meal.name} i√ßin porsiyon katsayƒ±sƒ±: ${meal.minQuantity}-${meal.maxQuantity} (adƒ±m: ${meal.step || 0.5}). "-" girerseniz otomatik planlama porsiyon belirler.`;
                                    }
                                    
                                    // Validasyon uygula
                                    validateFixedMealAmount(amountInput);
                                    
                                    // Otomatik kaydetme event listener ekle
                                    amountInput.addEventListener('input', function() {
                                        validateFixedMealAmount(this);
                                        autoSaveFixedMeals();
                                    });
                                    
                                    amountInput.addEventListener('change', function() {
                                        validateFixedMealAmount(this);
                                        autoSaveFixedMeals();
                                    });
                                }
                                
                                // Search input'a da event listener ekle (loadFixedMealsFromWeekProfile)
                                const currentRow = amountInput.closest('.row');
                                if (currentRow) {
                                    const searchInput = currentRow.querySelector('.fixed-meal-search');
                                    if (searchInput) {
                                        searchInput.addEventListener('input', function() {
                                            autoSaveFixedMeals();
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Buton durumunu g√ºncelle
                    updateFixedMealButton(mealType);
                });
                
                console.log('üì• Hafta profil sabit yemekleri y√ºklendi:', fixedMeals);
            } catch (e) {
                console.warn('Hafta profil sabit yemek y√ºkleme hatasƒ±:', e);
            }
        }
        
        // Sabit yemekleri otomatik planlama i√ßin al
        function getFixedMealsForPlanning() {
            try {
                // 1) Aktif hafta var mƒ± kontrol et (kritere g√∂re)
                const weekSelect = document.getElementById('criteria-week-select');
                const selectedValue = weekSelect?.value;
                
                if (selectedValue && selectedValue !== 'system') {
                    // Hafta ≈üablonu se√ßilmi≈ü - o haftanƒ±n sabit yemeklerini kullan
                    if (selectedValue.startsWith('template_')) {
                        const weekNo = parseInt(selectedValue.replace('template_', ''));
                        const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                        const profile = systemSettings?.weeklyProfiles?.[weekNo];
                        
                        if (profile && profile.fixedMeals) {
                            console.log(`üéØ ≈ûablon ${weekNo} sabit yemekleri planlama i√ßin kullanƒ±lƒ±yor:`, profile.fixedMeals);
                            return profile.fixedMeals;
                        }
                    } else {
                        // Hasta haftasƒ± se√ßilmi≈ü - hasta haftasƒ±nƒ±n sabit yemeklerini kontrol et
                        const weekNo = parseInt(selectedValue);
                        if (currentPatient && currentPatient.weeklyPlans) {
                            const weekPlan = currentPatient.weeklyPlans.find(w => w.weekNumber === weekNo);
                            if (weekPlan && weekPlan.fixedMeals) {
                                console.log(`üéØ Hasta hafta ${weekNo} sabit yemekleri planlama i√ßin kullanƒ±lƒ±yor:`, weekPlan.fixedMeals);
                                return weekPlan.fixedMeals;
                            }
                        }
                    }
                }
                
                // 2) Fallback: localStorage'dan genel sabit yemekler
                const fixedMeals = JSON.parse(localStorage.getItem('fixedMeals') || '{}');
                console.log('üéØ Genel sabit yemekler planlama i√ßin kullanƒ±lƒ±yor:', fixedMeals);
                return fixedMeals;
            } catch (e) {
                console.warn('Sabit yemek alma hatasƒ±:', e);
                return {};
            }
        }
        
        // Belirli √∂ƒü√ºn i√ßin sabit yemek var mƒ± kontrol et
        function hasFixedMealsForMeal(mealType) {
            const fixedMeals = getFixedMealsForPlanning();
            return fixedMeals[mealType] && fixedMeals[mealType].length > 0;
        }
        
        // Belirli √∂ƒü√ºn√ºn sabit yemeklerini al
        function getFixedMealsForMeal(mealType) {
            const fixedMeals = getFixedMealsForPlanning();
            return fixedMeals[mealType] || [];
        }
        
        // Sabit yemek i√ßin miktar belirle (otomatik planlama i√ßin)
        function determineFixedMealAmount(fixedMeal) {
            if (!fixedMeal.amount || fixedMeal.amount === 'auto' || fixedMeal.amount === '-') {
                // Otomatik porsiyon: min-max arasƒ±nda step'e uygun rastgele se√ß
                const min = fixedMeal.minQuantity || 1;
                const max = fixedMeal.maxQuantity || 2;
                const step = fixedMeal.step || 0.5;
                
                // Step'e uygun rastgele deƒüer se√ß
                const steps = Math.floor((max - min) / step) + 1;
                const randomStepIndex = Math.floor(Math.random() * steps);
                const randomAmount = min + (randomStepIndex * step);
                
                console.log(`üé≤ ${fixedMeal.name} i√ßin otomatik porsiyon belirlendi: ${randomAmount} (${min}-${max} arasƒ±nda, adƒ±m: ${step})`);
                return randomAmount;
            } else {
                // Sabit porsiyon kullan
                const fixedAmount = parseFloat(fixedMeal.amount);
                console.log(`üîí ${fixedMeal.name} i√ßin sabit porsiyon kullanƒ±lƒ±yor: ${fixedAmount}`);
                return fixedAmount;
            }
        }
        
        // Sabit yemeklerin toplam kalori/makro deƒüerlerini hesapla
        function calculateFixedMealsNutrition(mealType) {
            const fixedMeals = getFixedMealsForMeal(mealType);
            let totalCalories = 0;
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;
            
            const detailedMeals = fixedMeals.map(meal => {
                const portionAmount = determineFixedMealAmount(meal);
                
                // Porsiyon katsayƒ±sƒ±na g√∂re besin deƒüerlerini hesapla
                const calories = Math.round((meal.calories || 0) * portionAmount);
                const carbs = Math.round((meal.carbs || 0) * portionAmount);
                const protein = Math.round((meal.protein || 0) * portionAmount);
                const fat = Math.round((meal.fat || 0) * portionAmount);
                
                totalCalories += calories;
                totalCarbs += carbs;
                totalProtein += protein;
                totalFat += fat;
                
                return {
                    name: meal.name,
                    portion: portionAmount,
                    calories: calories,
                    carbs: carbs,
                    protein: protein,
                    fat: fat
                };
            });
            
            console.log(`üìä ${mealType} sabit yemekleri toplam besin deƒüerleri (porsiyon bazlƒ±):`, {
                totalCalories, totalCarbs, totalProtein, totalFat,
                meals: detailedMeals
            });
            
            return {
                totalCalories,
                totalCarbs,
                totalProtein,
                totalFat,
                meals: detailedMeals
            };
        }
        
        // Hedef kalori hesaplama
        function calculateTargetCalories() {
            const age = parseInt(document.getElementById('target-age')?.value) || 35;
            const weight = parseInt(document.getElementById('target-weight')?.value) || 70;
            const activity = parseFloat(document.getElementById('target-activity')?.value) || 1.55;
            const height = parseInt(document.getElementById('target-height')?.value) || 165;
            const gender = (document.getElementById('target-gender')?.value || 'female');
            const dietType = document.getElementById('system-default-diet')?.value || 'lowcarb';
            
            // Kalori hesaplama y√∂ntemini al
            const calorieMethod = document.querySelector('input[name="defaultCalorieMethod"]:checked')?.value || 'custom';
            
            let targetCalories, carbsGrams, proteinGrams, fatGrams;
            
            if (calorieMethod === 'custom') {
                // üéØ √ñzel Form√ºl: Makro x Katsayƒ± x Aktivite
                // Dinamik makro katsayƒ±larƒ± (diyet bazlƒ± override)
                const defaultsMacro = {
                    'ketojenik': { carbs: 0.3, protein: 0.8, fat: 1.2 },
                    'lowcarb': { carbs: 0.6, protein: 0.8, fat: 1.0 },
                    'akdeniz': { carbs: 1.2, protein: 0.8, fat: 0.9 },
                    'sporcu': { carbs: 1.5, protein: 1.4, fat: 0.7 },
                    'gebelik': { carbs: 1.3, protein: 1.0, fat: 0.8 }
                };
                // UI √ºzerindeki katsayƒ±lar √∂nceliklidir
                const uiCoeff = getCustomFormulaCoefficientsForDiet(dietType);
                const macroCoeff = uiCoeff || defaultsMacro[dietType] || defaultsMacro['lowcarb'];
                
                // Aktivite √ßarpanƒ±nƒ± d√∂n√º≈üt√ºr (1.2-1.9 aralƒ±ƒüƒ±nƒ± 0.8-1.2 aralƒ±ƒüƒ±na)
                const activityLevel = Math.round((activity - 1.2) / 0.175) + 1; // 1-5 arasƒ±
                const activityMultipliers = getCustomActivityMultipliers();
                let activityMultiplier = activityMultipliers[activityLevel] || 1.0;
                
                // ü•ó MAKRO HESAPLAMA: Kilo √ó MacroKatsayƒ±
                const baseCarbs = weight * macroCoeff.carbs;
                const baseProtein = weight * macroCoeff.protein; 
                const baseFat = weight * macroCoeff.fat;
                
                // üî• KALORƒ∞ HESAPLAMA: (karb√ó4 + protein√ó4 + yaƒü√ó9) √ó aktivite
                const baseCalories = (baseCarbs * 4) + (baseProtein * 4) + (baseFat * 9);
                targetCalories = Math.round(baseCalories * activityMultiplier);
                
                // Final makro deƒüerleri (aktivite ile √ßarpƒ±lmƒ±≈ü)
                carbsGrams = Math.round(baseCarbs * activityMultiplier);
                proteinGrams = Math.round(baseProtein * activityMultiplier);
                fatGrams = Math.round(baseFat * activityMultiplier);
                
                logToConsole(`üéØ √ñzel Form√ºl: ${weight}kg √ó [C:${macroCoeff.carbs} P:${macroCoeff.protein} Y:${macroCoeff.fat}] √ó ${activityMultiplier} = ${targetCalories}kcal`);
                
            } else if (calorieMethod === 'harris') {
                // Harris-Benedict BMR Form√ºl√º (revised)
                // Erkek: 88.362 + (13.397 √ó kg) + (4.799 √ó cm) ‚àí (5.677 √ó ya≈ü)
                // Kadƒ±n: 447.593 + (9.247 √ó kg) + (3.098 √ó cm) ‚àí (4.330 √ó ya≈ü)
                const bmr = gender === 'female'
                    ? (447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age))
                    : (88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age));
                targetCalories = Math.round(bmr * activity);
                
                // Diyet tipine g√∂re makro oranlarƒ±
                const macroRatios = {
                    'ketojenik': { protein: 25, carbs: 5, fat: 70 },
                    'lowcarb': { protein: 30, carbs: 20, fat: 50 },
                    'akdeniz': { protein: 20, carbs: 45, fat: 35 },
                    'sporcu': { protein: 25, carbs: 50, fat: 25 },
                    'gebelik': { protein: 20, carbs: 55, fat: 25 }
                };
                
                const ratios = macroRatios[dietType] || macroRatios['lowcarb'];
                
                // Makro hesaplamalarƒ± (gram cinsinden)
                carbsGrams = Math.round((targetCalories * ratios.carbs / 100) / 4);
                proteinGrams = Math.round((targetCalories * ratios.protein / 100) / 4);
                fatGrams = Math.round((targetCalories * ratios.fat / 100) / 9);
                
                logToConsole(`üéØ Harris-Benedict: BMR ${Math.round(bmr)} √ó ${activity} = ${targetCalories}kcal (${gender}, ${height}cm)`);
            } else if (calorieMethod === 'mifflin') {
                // Mifflin‚ÄìSt Jeor BMR Form√ºl√º
                // Erkek: 10√ókg + 6.25√ócm ‚àí 5√óya≈ü + 5
                // Kadƒ±n: 10√ókg + 6.25√ócm ‚àí 5√óya≈ü ‚àí 161
                const bmr = gender === 'female'
                    ? (10 * weight + 6.25 * height - 5 * age - 161)
                    : (10 * weight + 6.25 * height - 5 * age + 5);
                targetCalories = Math.round(bmr * activity);

                // Diyet tipine g√∂re makro oranlarƒ± (HB ile aynƒ± daƒüƒ±lƒ±m kullanƒ±lƒ±r)
                const macroRatios = {
                    'ketojenik': { protein: 25, carbs: 5, fat: 70 },
                    'lowcarb': { protein: 30, carbs: 20, fat: 50 },
                    'akdeniz': { protein: 20, carbs: 45, fat: 35 },
                    'sporcu': { protein: 25, carbs: 50, fat: 25 },
                    'gebelik': { protein: 20, carbs: 55, fat: 25 }
                };
                const ratios = macroRatios[dietType] || macroRatios['lowcarb'];
                carbsGrams = Math.round((targetCalories * ratios.carbs / 100) / 4);
                proteinGrams = Math.round((targetCalories * ratios.protein / 100) / 4);
                fatGrams = Math.round((targetCalories * ratios.fat / 100) / 9);
                logToConsole(`üéØ Mifflin‚ÄìSt Jeor: BMR ${Math.round(bmr)} √ó ${activity} = ${targetCalories}kcal (${gender}, ${height}cm)`);
            }
            
            // UI g√ºncelle
            document.getElementById('calculated-calories').textContent = targetCalories;
            document.getElementById('calculated-carbs').textContent = carbsGrams;
            document.getElementById('calculated-protein').textContent = proteinGrams;
            document.getElementById('calculated-fat').textContent = fatGrams;
            
            // √ñƒü√ºn kalorilerini de g√ºncelle
            updateMealCalories(targetCalories);

            // Saƒü alt aynalama
            try { updateRightMacrosFromTop(); } catch(_){ }
            
            const methodName = calorieMethod === 'custom' ? '√ñzel Form√ºl' : (calorieMethod === 'mifflin' ? 'Mifflin‚ÄìSt Jeor' : 'Harris-Benedict');
            logToConsole(`üéØ ${methodName} ile hedef kalori: ${targetCalories} kcal (${age}y, ${weight}kg, ${height}cm, ${gender}, ${dietType})`);

            // Form√ºl kutusunu g√ºncelle
            try { updateCalorieMethodFormulaDisplay(); } catch(_){ }
            
            return targetCalories;
        }

        // Se√ßili kalori y√∂ntemi i√ßin form√ºl a√ßƒ±klamasƒ±nƒ± g√∂ster
        function updateCalorieMethodFormulaDisplay() {
            const box = document.getElementById('calorie-formula-box');
            const span = document.getElementById('calorie-formula-text');
            if (!box || !span) return;

            const age = parseInt(document.getElementById('target-age')?.value) || 35;
            const weight = parseFloat(document.getElementById('target-weight')?.value) || 70;
            const height = parseInt(document.getElementById('target-height')?.value) || 165;
            const gender = (document.getElementById('target-gender')?.value || 'female');
            const activity = parseFloat(document.getElementById('target-activity')?.value) || 1.55;
            const method = document.querySelector('input[name="defaultCalorieMethod"]:checked')?.value || 'custom';

            let text = '';
            if (method === 'harris') {
                const bmr = gender === 'female'
                    ? (447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age))
                    : (88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age));
                text = `Harris-Benedict (revised): BMR = ${gender==='female' ? '447.593 + 9.247√ókg + 3.098√ócm ‚àí 4.330√óya≈ü' : '88.362 + 13.397√ókg + 4.799√ócm ‚àí 5.677√óya≈ü'} ‚áí BMR ‚âà ${Math.round(bmr)}, TDEE = BMR √ó ${activity}`;
            } else if (method === 'mifflin') {
                const bmr = gender === 'female'
                    ? (10 * weight + 6.25 * height - 5 * age - 161)
                    : (10 * weight + 6.25 * height - 5 * age + 5);
                text = `Mifflin‚ÄìSt Jeor: BMR = 10√ókg + 6.25√ócm ‚àí 5√óya≈ü ${gender==='female' ? '‚àí 161' : '+ 5'} ‚áí BMR ‚âà ${Math.round(bmr)}, TDEE = BMR √ó ${activity}`;
            } else {
                text = '√ñzel Form√ºl: (Karb√ó4 + Protein√ó4 + Yaƒü√ó9) √ó Aktivite; Karb/Prot/Yaƒü = Kilo √ó Katsayƒ± (alttaki panelden).';
            }

            span.textContent = text;
            box.style.display = 'block';
        }

        // Dinamik form√ºl √∂zetini g√ºncelle
        function updateCustomFormulaSummary() {
            const dietType = document.getElementById('system-default-diet')?.value || 'lowcarb';
            const c = parseFloat(document.getElementById('custom-coeff-carbs')?.value) || 0;
            const p = parseFloat(document.getElementById('custom-coeff-protein')?.value) || 0;
            const f = parseFloat(document.getElementById('custom-coeff-fat')?.value) || 0;
            const acts = [1,2,3,4,5].map(i => document.getElementById('custom-act-' + i)?.value || '');
            const dietNames = { ketojenik:'Ketojenik', lowcarb:'D√º≈ü√ºk Karbonhidrat', akdeniz:'Akdeniz', sporcu:'Sporcu', gebelik:'Gebelik' };
            const name = dietNames[dietType] || dietType;
            const elDiet = document.getElementById('summary-diet');
            const elC = document.getElementById('summary-c');
            const elP = document.getElementById('summary-p');
            const elF = document.getElementById('summary-f');
            const elActs = document.getElementById('summary-acts');
            // Sporcu notu kaldƒ±rƒ±ldƒ±
            if (elDiet) elDiet.textContent = name;
            if (elC) elC.textContent = c;
            if (elP) elP.textContent = p;
            if (elF) elF.textContent = f;
            if (elActs) elActs.textContent = acts.join(' , ');
            // no-op
        }

        // Saƒü alt hedef makrolarƒ±, sol √ºstteki hesaplanan deƒüerlerden aynala
        function updateRightMacrosFromTop() {
            const cals = document.getElementById('calculated-calories')?.textContent || '-';
            const c = document.getElementById('calculated-carbs')?.textContent || '-';
            const p = document.getElementById('calculated-protein')?.textContent || '-';
            const f = document.getElementById('calculated-fat')?.textContent || '-';
            const rc = document.getElementById('right-calculated-calories');
            const r1 = document.getElementById('right-calculated-carbs');
            const r2 = document.getElementById('right-calculated-protein');
            const r3 = document.getElementById('right-calculated-fat');
            if (rc) rc.textContent = cals;
            if (r1) r1.textContent = c;
            if (r2) r2.textContent = p;
            if (r3) r3.textContent = f;
        }

        // √ñzel form√ºl paneli: UI'dan deƒüerleri oku
        function getCustomFormulaCoefficientsForDiet(dietType) {
            try {
                const c = parseFloat(document.getElementById('custom-coeff-carbs')?.value);
                const p = parseFloat(document.getElementById('custom-coeff-protein')?.value);
                const f = parseFloat(document.getElementById('custom-coeff-fat')?.value);
                if ([c,p,f].every(v => Number.isFinite(v) && v >= 0)) {
                    return { carbs: c, protein: p, fat: f };
                }
            } catch (_) {}
            return null;
        }

        function getCustomActivityMultipliers() {
            const def = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };
            try {
                const vals = [1,2,3,4,5].map(i => parseFloat(document.getElementById('custom-act-' + i)?.value));
                if (vals.every(v => Number.isFinite(v) && v > 0)) {
                    return { 1: vals[0], 2: vals[1], 3: vals[2], 4: vals[3], 5: vals[4] };
                }
            } catch (_) {}
            return def;
        }

    // Sporcuya √∂zel aktivite √ßarpanlarƒ± kaldƒ±rƒ±ldƒ±; tek set kullanƒ±lacak

        // Preset yardƒ±mcƒ±larƒ±
        function applyCoeffPreset(diet) {
            const presets = {
                ketojenik: { carbs: 0.3, protein: 0.8, fat: 1.2 },
                lowcarb:   { carbs: 0.6, protein: 0.8, fat: 1.0 },
                akdeniz:   { carbs: 1.2, protein: 0.8, fat: 0.9 },
                sporcu:    { carbs: 1.5, protein: 1.4, fat: 0.7 },
                gebelik:   { carbs: 1.3, protein: 1.0, fat: 0.8 }
            };
            const p = presets[diet];
            if (!p) return;
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            set('custom-coeff-carbs', p.carbs);
            set('custom-coeff-protein', p.protein);
            set('custom-coeff-fat', p.fat);
            onCustomFormulaChanged();
            try { showToast('√ñnerilen katsayƒ±lar uygulandƒ±', 'info'); } catch(_) {}
        }

        function applyActivityPreset(kind = 'general') {
            const map = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };
            [1,2,3,4,5].forEach(i => {
                const el = document.getElementById('custom-act-' + i);
                if (el) el.value = map[i];
            });
            onCustomFormulaChanged();
            try { showToast('Aktivite √ßarpanlarƒ± varsayƒ±lanlarƒ± y√ºklendi', 'info'); } catch(_) {}
        }

        // √ñzel form√ºl panelini y√∂ntem se√ßimine g√∂re etkinle≈ütir/devre dƒ±≈üƒ± bƒ±rak
        function toggleCustomFormulaPanel() {
            const method = document.querySelector('input[name="defaultCalorieMethod"]:checked')?.value || 'custom';
            const panel = document.getElementById('custom-formula-panel');
            if (!panel) return;
            const disabled = method !== 'custom';
            panel.style.opacity = disabled ? '0.6' : '1';
            panel.querySelectorAll('input').forEach(inp => inp.disabled = disabled);
        }

        // √ñzel form√ºl deƒüerleri deƒüi≈ütiƒüinde canlƒ± hesapla
        function onCustomFormulaChanged() {
            calculateTargetCalories();
            try { updateCustomFormulaSummary(); } catch(_){}
            try { updateRightMacrosFromTop(); } catch(_){}
        }
        
        // √ñƒü√ºn makro daƒüƒ±lƒ±m toplamƒ±nƒ± g√ºncelle
        function updateMealMacroTotal() {
            const meals = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
            let total = 0;
            
            meals.forEach(meal => {
                const input = document.getElementById(`${meal}-macro`);
                if (input && !input.disabled) {
                    total += parseInt(input.value) || 0;
                }
            });
            
            const totalElement = document.getElementById('meal-macro-total');
            const remaining = 100 - total;
            
            if (totalElement) {
                if (total === 100) {
                    totalElement.textContent = `${total}%`;
                    totalElement.className = 'fs-5 text-success';
                } else {
                    const sign = remaining >= 0 ? '+' : '';
                    totalElement.textContent = `${total}% (${sign}${remaining})`;
                    totalElement.className = 'fs-5 text-danger';
                }
            }
            
            // Hedef kaloriyi al ve √∂ƒü√ºn kalorilerini g√ºncelle
            const targetCalories = parseInt(document.getElementById('calculated-calories')?.textContent) || 1850;
            updateMealCalories(targetCalories);
            
            logToConsole(`üìä √ñƒü√ºn makro toplamƒ±: ${total}% (${remaining >= 0 ? '+' : ''}${remaining})`);
        }
        
        // √ñƒü√ºn kalori deƒüerlerini g√ºncelle
        function updateMealCalories(targetCalories) {
            const meals = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner'];
            
            meals.forEach(meal => {
                const macroInput = document.getElementById(`${meal}-macro`);
                const calorieElement = document.getElementById(`${meal}-calories`);
                
                if (macroInput && calorieElement) {
                    const percentage = parseInt(macroInput.value) || 0;
                    const calories = Math.round((targetCalories * percentage) / 100);
                    calorieElement.textContent = `${calories} kcal`;
                }
            });
        }
        
        // Sistem ayarlarƒ±ndan √∂ƒü√ºn yapƒ±landƒ±rmasƒ±nƒ± al
        function getMealConfiguration() {
            const config = {
                breakfast: getMealConfig('breakfast', 'üç≥ Kahvaltƒ±'),
                snack1: getMealConfig('snack1', 'ü•§ Ara √ñƒü√ºn'),
                lunch: getMealConfig('lunch', 'üçΩÔ∏è √ñƒüle'),
                snack2: getMealConfig('snack2', 'ü•§ Ara √ñƒü√ºn'),
                dinner: getMealConfig('dinner', 'üåô Ak≈üam')
            };
            
            logToConsole('üìä √ñƒü√ºn yapƒ±landƒ±rmasƒ± alƒ±ndƒ±:', config);
            return config;
        }
        
        // Tek bir √∂ƒü√ºn i√ßin yapƒ±landƒ±rmayƒ± al
        function getMealConfig(mealType, mealName) {
            const fixedInput = document.getElementById(`${mealType}-fixed`);
            const minInput = document.getElementById(`${mealType}-min`);
            const maxInput = document.getElementById(`${mealType}-max`);
            
            const fixedValue = fixedInput?.value && fixedInput.value.trim() !== '' ? parseInt(fixedInput.value) : null;
            
            if (fixedValue) {
                return {
                    name: mealName,
                    type: 'fixed',
                    value: fixedValue
                };
            } else {
                return {
                    name: mealName,
                    type: 'range',
                    min: parseInt(minInput?.value || 1),
                    max: parseInt(maxInput?.value || 1)
                };
            }
        }
        
        // ====== Dƒ∞YET Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI ======
        
        // Diyet ayarlarƒ± sayfasƒ±nƒ± y√ºkle
        function loadDietConfigPage() {
            logToConsole('üçÉ Diyet ayarlarƒ± sayfasƒ± y√ºkleniyor...');
            loadDietsData();
            setTimeout(() => {
                displayDiets();
                updateDietStats();
            }, 200);
            logToConsole('‚úÖ Diyet ayarlarƒ± sayfasƒ± y√ºklendi');
        }
        
        // Diyet verilerini y√ºkle
        async function loadDietsData() {
            try {
                // √ñnce embedded JSON'dan y√ºkle
                const dietsJson = await getEmbeddedData('diets.json');
                if (dietsJson && dietsJson.diets) {
                    dietsData = dietsJson.diets;
                    logToConsole(`üìä ${dietsData.length} diyet JSON'dan y√ºklendi`);
                } else {
                    // Fallback - varsayƒ±lan diyetleri y√ºkle
                    dietsData = [...defaultDiets];
                    logToConsole(`üìä ${dietsData.length} varsayƒ±lan diyet y√ºklendi (JSON bulunamadƒ±)`);
                }
                
                // localStorage ile senkronize et
                const saved = localStorage.getItem('dietsData');
                if (saved) {
                    const localDiets = JSON.parse(saved);
                    // Yerel deƒüi≈üiklikleri koru
                    mergeLocalDietsChanges(localDiets);
                }
                
            } catch (error) {
                logToConsole('‚ùå Diyet verileri y√ºkleme hatasƒ±:', error);
                dietsData = [...defaultDiets];
            }
        }
        
        // Yerel deƒüi≈üiklikleri JSON verisi ile birle≈ütir
        function mergeLocalDietsChanges(localDiets) {
            localDiets.forEach(localDiet => {
                const existingIndex = dietsData.findIndex(d => d.id === localDiet.id);
                if (existingIndex >= 0) {
                    // Mevcut diyet varsa g√ºncelle (yerel deƒüi≈üiklikler √∂ncelikli)
                    if (new Date(localDiet.updatedAt || 0) > new Date(dietsData[existingIndex].updatedAt || 0)) {
                        dietsData[existingIndex] = localDiet;
                        logToConsole(`üîÑ Yerel deƒüi≈üiklik aktarƒ±ldƒ±: ${localDiet.name}`);
                    }
                } else {
                    // Yeni diyet ekle
                    dietsData.push(localDiet);
                    logToConsole(`‚ûï Yerel diyet eklendi: ${localDiet.name}`);
                }
            });
        }
        
        // Diyet verilerini kaydet
        async function saveDietsData() {
            try {
                // localStorage'a kaydet (hƒ±zlƒ± eri≈üim i√ßin)
                localStorage.setItem('dietsData', JSON.stringify(dietsData));
                
                // JSON dosyasƒ±nƒ± g√ºncelle
                await updateDietsJsonFile();
                
                logToConsole('üíæ Diyet verileri kaydedildi (localStorage + JSON)');
            } catch (error) {
                logToConsole('‚ùå Diyet verileri kaydetme hatasƒ±:', error);
            }
        }
        
        // Diyetler JSON dosyasƒ±nƒ± g√ºncelle
        async function updateDietsJsonFile() {
            try {
                const jsonData = {
                    diets: dietsData.map(diet => ({
                        ...diet,
                        updatedAt: new Date().toISOString()
                    })),
                    metadata: {
                        version: "2.0",
                        lastUpdated: new Date().toISOString(),
                        totalDiets: dietsData.length,
                        systemGenerated: true
                    }
                };
                
                // JSON'u g√ºzelce formatla
                const jsonString = JSON.stringify(jsonData, null, 2);
                
                // Browser ortamƒ±nda doƒürudan dosya yazamayƒ±z ama localStorage'da JSON formatƒ±nda saklayabiliriz
                localStorage.setItem('dietsJsonBackup', jsonString);
                
                // Konsola JSON'u yazdƒ±r (manuel kaydetme i√ßin)
                logToConsole('üìÑ G√ºncellenmi≈ü diets.json i√ßeriƒüi:');
                console.log('=== DIETS.JSON ===');
                console.log(jsonString);
                console.log('=== /DIETS.JSON ===');
                
                // Kullanƒ±cƒ±ya bilgi ver
                if (window.dietsSaveNotificationShown !== true) {
                    alert('üíæ Diyet verileri kaydedildi!\n\nüìã Konsolu a√ßarak g√ºncellenmi≈ü diets.json i√ßeriƒüini kopyalayabilir ve dosyaya manuel olarak kaydedebilirsiniz.\n\n(Bu mesaj bu oturum i√ßin bir kez g√∂sterilir)');
                    window.dietsSaveNotificationShown = true;
                }
                
            } catch (error) {
                logToConsole('‚ùå JSON dosyasƒ± g√ºncelleme hatasƒ±:', error);
            }
        }
        
        // Diyetleri g√∂r√ºnt√ºle
        function displayDiets() {
            const container = document.getElementById('diets-grid');
            if (!container) {
                console.log('diets-grid bulunamadƒ±!');
                return;
            }
            
            let html = '';
            
            dietsData.forEach(diet => {
                const statusBadge = diet.status === 'active' ? 'bg-success' : 'bg-secondary';
                const statusText = diet.status === 'active' ? 'Aktif' : 'Pasif';
                
                html += '<div class="col-md-6 col-lg-4 mb-3">';
                html += '<div class="card h-100 diet-card" data-diet-id="' + diet.id + '">';
                html += '<div class="card-header d-flex justify-content-between align-items-center">';
                html += '<div>';
                html += '<span style="font-size: 1.5rem;">' + diet.icon + '</span>';
                html += '<strong>' + diet.name + '</strong>';
                html += '</div>';
                html += '<span class="badge ' + statusBadge + '">' + statusText + '</span>';
                html += '</div>';
                html += '<div class="card-body">';
                html += '<p class="card-text text-muted small">' + diet.description + '</p>';
                
                // Makro Daƒüƒ±lƒ±mƒ±
                html += '<div class="mb-2">';
                html += '<small class="text-muted">Makro Daƒüƒ±lƒ±mƒ±:</small>';
                html += '<div class="d-flex justify-content-between mt-1">';
                html += '<span class="badge bg-primary">K: ' + diet.macros.carbs + '%</span>';
                html += '<span class="badge bg-success">P: ' + diet.macros.protein + '%</span>';
                html += '<span class="badge bg-warning text-dark">Y: ' + diet.macros.fat + '%</span>';
                html += '</div>';
                html += '</div>';
                
                // Kalori Aralƒ±ƒüƒ±
                html += '<div class="mb-2">';
                html += '<small class="text-muted">Kalori: </small>';
                html += '<span class="badge bg-info">' + diet.criteria.caloriesMin + ' - ' + diet.criteria.caloriesMax + ' kcal</span>';
                html += '</div>';
                
                // Kƒ±sƒ±tlamalar
                if (diet.restrictions && diet.restrictions.length > 0) {
                    html += '<div class="mb-2">';
                    html += '<small class="text-muted">Kƒ±sƒ±tlamalar:</small><br>';
                    diet.restrictions.forEach(r => {
                        html += '<span class="badge bg-danger me-1">' + r + '</span>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                html += '<div class="card-footer">';
                html += '<div class="btn-group w-100" role="group">';
                html += '<button class="btn btn-sm btn-outline-primary" onclick="editDiet(\'' + diet.id + '\')">';
                html += '<i class="fas fa-edit"></i> D√ºzenle';
                html += '</button>';
                html += '<button class="btn btn-sm btn-outline-info" onclick="duplicateDiet(\'' + diet.id + '\')">';
                html += '<i class="fas fa-copy"></i> Kopyala';
                html += '</button>';
                html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteDiet(\'' + diet.id + '\')">';
                html += '<i class="fas fa-trash"></i> Sil';
                html += '</button>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            if (html === '') {
                html = '<div class="col-12 text-center py-5">';
                html += '<div class="text-muted">';
                html += '<i class="fas fa-utensils fa-3x mb-3"></i>';
                html += '<h5>Hen√ºz diyet tanƒ±mlanmamƒ±≈ü</h5>';
                html += '<p>Yeni diyet eklemek i√ßin "Yeni Diyet Ekle" butonunu kullanƒ±n</p>';
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
            logToConsole('Diyetler g√∂r√ºnt√ºlendi: ' + dietsData.length + ' adet');
        }
        
        // Yeni diyet modal g√∂ster
        function showAddDietModal() {
            clearDietForm();
            
            const modal = new bootstrap.Modal(document.getElementById('dietModal'));
            modal.show();
            
            logToConsole('‚ûï Yeni diyet ekleme modal\'ƒ± a√ßƒ±ldƒ±');
        }
        
        // Diyet d√ºzenle
        function editDiet(dietId) {
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) {
                alert('‚ùå Diyet bulunamadƒ±!');
                return;
            }
            
            // Form alanlarƒ±nƒ± doldur
            document.getElementById('dietId').value = diet.id;
            document.getElementById('dietName').value = diet.name;
            document.getElementById('dietCode').value = diet.code || '';
            document.getElementById('dietIcon').value = diet.icon;
            document.getElementById('dietDescription').value = diet.description;
            document.getElementById('dietStatus').value = diet.status;
            document.getElementById('dietNotes').value = diet.notes || '';
            
            // Makro oranlarƒ±
            document.getElementById('macroCarbs').value = diet.macros.carbs;
            document.getElementById('macroProtein').value = diet.macros.protein;
            document.getElementById('macroFat').value = diet.macros.fat;
            
            // Kriterler
            document.getElementById('caloriesMin').value = diet.criteria.caloriesMin;
            document.getElementById('caloriesMax').value = diet.criteria.caloriesMax;
            document.getElementById('waterIntake').value = diet.criteria.water;
            document.getElementById('mealGap').value = diet.criteria.mealGap;
            document.getElementById('weightLoss').value = diet.criteria.weightLoss;
            
            // Kƒ±sƒ±tlamalar
            const restrictionOptions = ['dairy', 'nuts', 'sugar', 'bread', 'nightshades', 'alcohol', 'raw_fish', 'processed'];
            restrictionOptions.forEach(restriction => {
                const checkbox = document.getElementById(`restriction_${restriction}`);
                if (checkbox) {
                    checkbox.checked = diet.restrictions.includes(restriction);
                }
            });
            
            // Modal ba≈ülƒ±ƒüƒ± ayarla
            document.getElementById('dietEditModalLabel').textContent = `‚úèÔ∏è ${diet.name} - D√ºzenle`;
            
            // Makro toplamƒ±nƒ± g√ºncelle
            updateMacroTotal();
            
            // Modal'ƒ± a√ß
            const modal = new bootstrap.Modal(document.getElementById('dietEditModal'));
            modal.show();
        }
        
        // Diyet kopyala
        function duplicateDiet(dietId) {
            const originalDiet = dietsData.find(d => d.id === dietId);
            if (!originalDiet) {
                alert('‚ùå Kopyalanacak diyet bulunamadƒ±!');
                return;
            }
            
            const newDiet = {
                ...originalDiet,
                id: originalDiet.id + '_copy_' + Date.now(),
                name: originalDiet.name + ' (Kopya)',
                code: originalDiet.code + '_copy',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            dietsData.push(newDiet);
            saveDietsData();
            displayDiets();
            
            logToConsole(`üìã Diyet kopyalandƒ±: ${newDiet.name}`);
            try { showToast(`Diyet kopyalandƒ±: ${newDiet.name}`, 'success'); } catch(_){ }
        }
        
        // Diyet sil
        function deleteDiet(dietId) {
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) {
                try { showToast('‚ùå Silinecek diyet bulunamadƒ±!', 'error'); } catch(_){ alert('‚ùå Silinecek diyet bulunamadƒ±!'); }
                return;
            }
            // Non-blocking info instead of confirm
            try { showToast(`"${diet.name}" siliniyor...`, 'warning'); } catch(_){}
                dietsData = dietsData.filter(d => d.id !== dietId);
                saveDietsData();
                displayDiets();
                
                logToConsole(`üóëÔ∏è Diyet silindi: ${diet.name}`);
                try { showToast(`‚úÖ Diyet ba≈üarƒ±yla silindi: ${diet.name}`, 'success'); } catch(_){}
        }
        
        // Diyet kaydet
        function saveDietEdit() {
            // Form verilerini topla
            const dietData = {
                id: document.getElementById('dietId').value,
                name: document.getElementById('dietName').value.trim(),
                code: document.getElementById('dietCode').value.trim(),
                icon: document.getElementById('dietIcon').value || 'üçΩÔ∏è',
                description: document.getElementById('dietDescription').value.trim(),
                status: document.getElementById('dietStatus').value,
                macros: {
                    carbs: parseInt(document.getElementById('macroCarbs').value) || 0,
                    protein: parseInt(document.getElementById('macroProtein').value) || 0,
                    fat: parseInt(document.getElementById('macroFat').value) || 0
                },
                criteria: {
                    caloriesMin: parseInt(document.getElementById('caloriesMin').value) || 1200,
                    caloriesMax: parseInt(document.getElementById('caloriesMax').value) || 1800,
                    water: parseFloat(document.getElementById('waterIntake').value) || 2.5,
                    mealGap: parseInt(document.getElementById('mealGap').value) || 3,
                    weightLoss: parseFloat(document.getElementById('weightLoss').value) || 0.5
                },
                restrictions: [],
                notes: document.getElementById('dietNotes').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            // Validasyon
            if (!dietData.name) {
                alert('‚ùå Diyet adƒ± zorunludur!');
                return;
            }
            
            // Makro toplamƒ± kontrol√º
            const macroTotal = dietData.macros.carbs + dietData.macros.protein + dietData.macros.fat;
            if (macroTotal !== 100) {
                alert(`‚ùå Makro oranlarƒ± toplamƒ± %100 olmalƒ±dƒ±r! (≈ûu anki toplam: %${macroTotal})`);
                return;
            }
            
            // Kƒ±sƒ±tlamalarƒ± topla
            const restrictionOptions = ['sugar', 'bread', 'dairy', 'meat', 'fruit'];
            restrictionOptions.forEach(restriction => {
                const checkbox = document.getElementById(`restrict_${restriction}`);
                if (checkbox && checkbox.checked) {
                    dietData.restrictions.push(restriction);
                }
            });
            
            // Yeni diyet mi g√ºncelleme mi?
            if (!dietData.id) {
                // Yeni diyet
                dietData.id = dietData.code || dietData.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                dietData.createdAt = new Date().toISOString();
                
                // ID √ßakƒ±≈ümasƒ± kontrol√º
                if (dietsData.find(d => d.id === dietData.id)) {
                    dietData.id += '_' + Date.now();
                }
                
                dietsData.push(dietData);
                logToConsole(`‚ûï Yeni diyet eklendi: ${dietData.name}`);
                alert(`‚úÖ Yeni diyet ba≈üarƒ±yla eklendi: ${dietData.name}`);
            } else {
                // Mevcut diyet g√ºncellemesi
                const index = dietsData.findIndex(d => d.id === dietData.id);
                if (index >= 0) {
                    dietData.createdAt = dietsData[index].createdAt; // Olu≈üturma tarihini koru
                    dietsData[index] = dietData;
                    logToConsole(`üîÑ Diyet g√ºncellendi: ${dietData.name}`);
                    alert(`‚úÖ Diyet ba≈üarƒ±yla g√ºncellendi: ${dietData.name}`);
                } else {
                    alert('‚ùå G√ºncellenecek diyet bulunamadƒ±!');
                    return;
                }
            }
            
            // Verileri kaydet ve ekranƒ± g√ºncelle
            saveDietsData();
            displayDiets();
            
            // Modal'ƒ± kapat
            const modal = bootstrap.Modal.getInstance(document.getElementById('dietEditModal'));
            if (modal) modal.hide();
        }
        
        // Diyet formu temizle
        function clearDietForm() {
            document.getElementById('dietId').value = '';
            document.getElementById('dietName').value = '';
            document.getElementById('dietCode').value = '';
            document.getElementById('dietIcon').value = 'üçΩÔ∏è';
            document.getElementById('dietDescription').value = '';
            document.getElementById('dietStatus').value = 'active';
            document.getElementById('dietNotes').value = '';
            
            // Makro oranlarƒ± - dengeli varsayƒ±lan
            document.getElementById('macroCarbs').value = 40;
            document.getElementById('macroProtein').value = 30;
            document.getElementById('macroFat').value = 30;
            
            // Kriterler - varsayƒ±lan deƒüerler
            document.getElementById('caloriesMin').value = 1200;
            document.getElementById('caloriesMax').value = 1800;
            document.getElementById('waterIntake').value = 2.5;
            document.getElementById('mealGap').value = 3;
            document.getElementById('weightLoss').value = 0.5;
            
            // Kƒ±sƒ±tlamalarƒ± temizle
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('restrict_' + restriction);
                if (checkbox) checkbox.checked = false;
            });
            
            // Makro toplamƒ±nƒ± g√ºncelle
            updateMacroTotal();
        }
        
        // Makro toplam kontrol
        function updateMacroTotal() {
            const carbs = parseInt(document.getElementById('macroCarbs').value) || 0;
            const protein = parseInt(document.getElementById('macroProtein').value) || 0;
            const fat = parseInt(document.getElementById('macroFat').value) || 0;
            
            const total = carbs + protein + fat;
            const totalElement = document.getElementById('macroTotal');
            
            if (totalElement) {
                totalElement.textContent = total + '%';
                
                if (total === 100) {
                    totalElement.className = 'fw-bold text-success';
                } else if (total < 100) {
                    totalElement.className = 'fw-bold text-warning';
                } else {
                    totalElement.className = 'fw-bold text-danger';
                }
            }
            
            // Kaydet butonu kontrol√º
            const saveBtn = document.getElementById('saveDietBtn');
            if (saveBtn) {
                if (total === 100) {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('btn-secondary');
                    saveBtn.classList.add('btn-primary');
                } else {
                    saveBtn.disabled = true;
                    saveBtn.classList.remove('btn-primary');
                    saveBtn.classList.add('btn-secondary');
                }
            }
        }
        
        // JSON dosyasƒ±nƒ± dƒ±≈üa aktar
        function exportDietsData() {
            updateDietsJsonFile();
            alert('üìÅ JSON dosyasƒ± konsola yazdƒ±rƒ±ldƒ±!\n\nKonsolu a√ßarak (F12) g√ºncellenmi≈ü diets.json i√ßeriƒüini kopyalayƒ±p dosyaya kaydedebilirsiniz.');
        }
        
        // Yeni diyet modal g√∂ster
        function showAddDietModal() {
            clearDietForm();
            
            const modal = new bootstrap.Modal(document.getElementById('dietModal'));
            modal.show();
            
            logToConsole('‚ûï Yeni diyet ekleme modal\'ƒ± a√ßƒ±ldƒ±');
        }
        
        // Diyet d√ºzenle
        function editDiet(dietId) {
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) {
                alert('‚ùå Diyet bulunamadƒ±!');
                return;
            }
            
            // Form verilerini doldur
            document.getElementById('dietId').value = diet.id;
            document.getElementById('dietName').value = diet.name;
            document.getElementById('dietCode').value = diet.code;
            document.getElementById('dietIcon').value = diet.icon;
            document.getElementById('dietStatus').value = diet.status;
            document.getElementById('dietDescription').value = diet.description || '';
            
            // Makro deƒüerleri
            if (diet.macros) {
                document.getElementById('macroCarbs').value = diet.macros.carbs || 0;
                document.getElementById('macroProtein').value = diet.macros.protein || 0;
                document.getElementById('macroFat').value = diet.macros.fat || 0;
                updateMacroTotal();
            }
            
            // Kriter deƒüerleri
            if (diet.criteria) {
                document.getElementById('caloriesMin').value = diet.criteria.caloriesMin || 0;
                document.getElementById('caloriesMax').value = diet.criteria.caloriesMax || 0;
                document.getElementById('waterIntake').value = diet.criteria.water || 2.0;
                document.getElementById('mealGap').value = diet.criteria.mealGap || 3;
                document.getElementById('weightLoss').value = diet.criteria.weightLoss || 0.5;
            }
            
            // Notlar
            if (document.getElementById('dietNotes')) {
                document.getElementById('dietNotes').value = diet.notes || '';
            }
            
            // Kƒ±sƒ±tlamalarƒ± temizle ve y√ºkle
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('restrict_' + restriction);
                if (checkbox) {
                    checkbox.checked = diet.restrictions && diet.restrictions.includes(restriction);
                }
            });
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle ve a√ß
            document.getElementById('dietEditModalLabel').textContent = `‚úèÔ∏è ${diet.name} - D√ºzenle`;
            
            const dietModal = new bootstrap.Modal(document.getElementById('dietEditModal'));
            dietModal.show();
        }
        
        // Diyet kopyala
        function duplicateDiet(dietId) {
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) return;
            
            const newDiet = {
                ...diet,
                id: diet.code + '_copy_' + Date.now(),
                name: diet.name + ' (Kopya)',
                code: diet.code + '_copy',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            dietsData.push(newDiet);
            saveDietsData();
            displayDiets();
            
            logToConsole('üìÑ Diyet kopyalandƒ±: ' + newDiet.name);
            alert('‚úÖ "' + diet.name + '" diyeti ba≈üarƒ±yla kopyalandƒ±!');
        }
        
        // Diyet sil
        function deleteDiet(dietId) {
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) return;
            
            if (confirm('"' + diet.name + '" diyetini silmek istediƒüinize emin misiniz?')) {
                dietsData = dietsData.filter(d => d.id !== dietId);
                saveDietsData();
                displayDiets();
                
                logToConsole('üóëÔ∏è Diyet silindi: ' + diet.name);
                alert('‚úÖ "' + diet.name + '" diyeti ba≈üarƒ±yla silindi!');
            }
        }
        
        // Diyet kaydet
        function saveDiet() {
            const name = document.getElementById('newDietName').value.trim();
            const code = document.getElementById('newDietCode').value.trim();
            const icon = document.getElementById('newDietIcon').value.trim();
            
            if (!name || !code) {
                alert('‚ùå Diyet adƒ± ve kodu zorunludur!');
                return;
            }
            
            // Makro kontrol
            const total = getNewMacroTotal();
            if (total !== 100) {
                alert(`‚ùå Makro daƒüƒ±lƒ±mƒ± toplamƒ± 100% olmalƒ±dƒ±r! ≈ûu anda: ${total}%`);
                return;
            }
            
            const dietId = `diet_${Date.now()}`;
            
            // Kƒ±sƒ±tlamalarƒ± topla
            const restrictions = [];
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('newRestrict_' + restriction);
                if (checkbox && checkbox.checked) {
                    restrictions.push(restriction);
                }
            });
            
            const dietData = {
                id: dietId,
                name: name,
                code: code,
                icon: icon || 'üçΩÔ∏è',
                description: document.getElementById('newDietDescription')?.value.trim() || '',
                status: document.getElementById('newDietStatus')?.value || 'active',
                macros: {
                    carbs: parseInt(document.getElementById('newDietCarbs').value) || 0,
                    protein: parseInt(document.getElementById('newDietProtein').value) || 0,
                    fat: parseInt(document.getElementById('newDietFat').value) || 0
                },
                criteria: {
                    caloriesMin: parseInt(document.getElementById('newCaloriesMin').value) || 1200,
                    caloriesMax: parseInt(document.getElementById('newCaloriesMax').value) || 1800,
                    water: parseFloat(document.getElementById('newWaterIntake').value) || 2.5,
                    mealGap: parseInt(document.getElementById('newMealGap').value) || 3,
                    weightLoss: parseFloat(document.getElementById('newWeightLoss').value) || 0.5
                },
                restrictions: restrictions,
                notes: document.getElementById('newDietNotes')?.value.trim() || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            dietsData.push(dietData);
            logToConsole(`‚ûï Yeni diyet eklendi: ${name}`);
            alert(`‚úÖ "${name}" diyeti ba≈üarƒ±yla eklendi!`);
            
            saveDietsData();
            displayDiets();
            
            // Modal'ƒ± kapat
            const modal = bootstrap.Modal.getInstance(document.getElementById('dietModal'));
            if (modal) modal.hide();
            
            // Formu temizle
            clearDietForm();
        }
        
        // Diyet formu temizle (yeni ekleme modal'ƒ± i√ßin)
        function clearDietForm() {
            document.getElementById('newDietName').value = '';
            document.getElementById('newDietCode').value = '';
            document.getElementById('newDietIcon').value = 'üçΩÔ∏è';
            document.getElementById('newDietDescription').value = '';
            document.getElementById('newDietStatus').value = 'active';
            document.getElementById('newDietCarbs').value = 20;
            document.getElementById('newDietProtein').value = 30;
            document.getElementById('newDietFat').value = 50;
            document.getElementById('newCaloriesMin').value = 1200;
            document.getElementById('newCaloriesMax').value = 1800;
            document.getElementById('newWaterIntake').value = 2.5;
            document.getElementById('newMealGap').value = 3;
            document.getElementById('newWeightLoss').value = 0.5;
            document.getElementById('newDietNotes').value = '';
            
            // Kƒ±sƒ±tlamalarƒ± temizle
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('newRestrict_' + restriction);
                if (checkbox) checkbox.checked = false;
            });
            
            validateMacroTotal();
        }
        
        // Makro toplam kontrol (yeni ekleme modal'ƒ± i√ßin)
        function validateMacroTotal() {
            const total = getNewMacroTotal();
            const remaining = 100 - total;
            const totalSpan = document.getElementById('newMacroTotal');
            
            if (totalSpan) {
                if (total === 100) {
                    totalSpan.textContent = `${total}%`;
                    totalSpan.className = 'fw-bold text-success';
                } else {
                    const sign = remaining >= 0 ? '+' : '';
                    totalSpan.textContent = `${total}% (${sign}${remaining})`;
                    totalSpan.className = 'fw-bold text-danger';
                }
            }
        }
        
        // Makro toplamƒ±nƒ± hesapla (yeni ekleme modal'ƒ± i√ßin)
        function getNewMacroTotal() {
            const carbs = parseInt(document.getElementById('newDietCarbs').value) || 0;
            const protein = parseInt(document.getElementById('newDietProtein').value) || 0;
            const fat = parseInt(document.getElementById('newDietFat').value) || 0;
            return carbs + protein + fat;
        }
        
        // Makro toplamƒ±nƒ± hesapla (d√ºzenleme modal'ƒ± i√ßin)
        function getMacroTotal() {
            const carbs = parseInt(document.getElementById('macroCarbs').value) || 0;
            const protein = parseInt(document.getElementById('macroProtein').value) || 0;
            const fat = parseInt(document.getElementById('macroFat').value) || 0;
            return carbs + protein + fat;
        }
        
        // Kriter etkinlik durumunu deƒüi≈ütir
        async function toggleCriteriaEnabled(criteriaId, isEnabled) {
            // Undefined parametrelerini kontrol et
            if (criteriaId === undefined || criteriaId === null) {
                console.warn('‚ùå toggleCriteriaEnabled: criteriaId tanƒ±mlƒ± deƒüil');
                return;
            }
            
            console.log(`üîÑ toggleCriteriaEnabled √ßaƒürƒ±ldƒ±: ${criteriaId} = ${isEnabled}`);
            
            // Mevcut ayarlarƒ± y√ºkle
            const savedSettings = JSON.parse(localStorage.getItem('criteriaSettings') || '{}');
            
            // Ayarƒ± g√ºncelle
            savedSettings[criteriaId] = isEnabled;
            
            // localStorage'a kaydet
            localStorage.setItem('criteriaSettings', JSON.stringify(savedSettings));
            console.log('üíæ Yeni criteriaSettings kaydedildi:', savedSettings);
            
            // JSON dosyasƒ±na da kaydet
            try {
                await updateJsonFile('/data/system_settings.json', {
                    criteriaSettings: savedSettings
                });
                console.log('üóÇÔ∏è CriteriaSettings JSON dosyasƒ±na kaydedildi');
            } catch (error) {
                console.error('‚ùå CriteriaSettings JSON kaydetme hatasƒ±:', error);
            }
            
            // Visual feedback
            const criteriaItem = document.querySelector(`[data-criteria-id="${criteriaId}"]`);
            if (criteriaItem) {
                if (isEnabled) {
                    criteriaItem.style.opacity = '1';
                    criteriaItem.style.background = 'white';
                    criteriaItem.classList.remove('criteria-disabled');
                    criteriaItem.classList.add('criteria-enabled');
                } else {
                    criteriaItem.style.opacity = '0.5';
                    criteriaItem.style.background = '#f0f0f0';
                    criteriaItem.classList.remove('criteria-enabled');
                    criteriaItem.classList.add('criteria-disabled');
                }
                console.log(`üé® Visual feedback uygulandƒ±: ${criteriaId}`);
            } else {
                console.error(`‚ùå Criteria item bulunamadƒ±: ${criteriaId}`);
            }
            
            logToConsole(`üîÑ Kriter ${isEnabled ? 'aktifle≈ütirildi' : 'devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±'}: ${criteriaId}`);
        }
        
    // (Legacy) Basit save/reset fonksiyonlarƒ± kaldƒ±rƒ±ldƒ±; a≈üaƒüƒ±daki kapsamlƒ± s√ºr√ºmler kullanƒ±lacaktƒ±r.
        
        function addMealToSlot(day, meal) {
            alert('Yemek ekleme √∂zelliƒüi geli≈ütirilecek...');
        }
        
        function editMeal(day, meal, index) {
            alert('Yemek d√ºzenleme √∂zelliƒüi geli≈ütirilecek...');
        }
        
        function changeMeal(day, meal, index) {
            alert('Yemek deƒüi≈ütirme √∂zelliƒüi geli≈ütirilecek...');
        }
        
        // Kullanƒ±cƒ± d√ºzenleme
        function editUser(userType, userId) {
            alert(`${userType} d√ºzenleme √∂zelliƒüi geli≈ütirilecek... (ID: ${userId})`);
        }
        
        // Kullanƒ±cƒ± silme
        function deleteUser(userType, userId) {
            if (confirm(`Bu ${userType === 'patient' ? 'hastayƒ±' : userType === 'doctor' ? 'doktoru' : 'diyetisyeni'} silmek istediƒüinize emin misiniz?`)) {
                // Kullanƒ±cƒ±yƒ± listeden kaldƒ±r
                const userList = usersData[userType + 's'];
                const index = userList.findIndex(u => u.id === userId);
                if (index !== -1) {
                    userList.splice(index, 1);
                    loadUsersLists();
                    logToConsole(`üóëÔ∏è ${userType} silindi: ${userId}`);
                }
            }
        }

        // üÜï Sƒ∞STEM AYARLARI FONKSƒ∞YONLARI
        
        // Sistem ayarlarƒ± sayfasƒ±nƒ± y√ºkle
        function loadSystemSettings() {
            showPage('system-settings');
            // √ñnce sistem ayarlarƒ±nƒ± y√ºkle
            loadSystemSettingsPage();
            // Sonra kriter hiyerar≈üisini y√ºkle
            loadDefaultCriteriaHierarchy();
        }

        // Tam yedek/geri y√ºkleme (tek JSON paket)
        function exportFullBackup() {
            try {
                const bundle = {
                    meta: { version: '2.1.0', exportedAt: new Date().toISOString() },
                    localStorage: {
                        systemSettings_v2: localStorage.getItem('systemSettings_v2') || null,
                        systemSettings: localStorage.getItem('systemSettings') || null,
                        criteriaSettings: localStorage.getItem('criteriaSettings') || null,
                        defaultCriteriaOrder: localStorage.getItem('defaultCriteriaOrder') || null,
                        systemRulesArchive: localStorage.getItem('systemRulesArchive') || null,
                        frequencyRules: localStorage.getItem('frequencyRules') || null,
                        dependencyRules: localStorage.getItem('dependencyRules') || null,
                        lockRules: localStorage.getItem('lockRules') || null,
                        dietsData: localStorage.getItem('dietsData') || null,
                        foodsData: localStorage.getItem('foodsData') || null,
                        templatesData: localStorage.getItem('templatesData') || null,
                        usersData: localStorage.getItem('usersData') || null,
                        mealsData: localStorage.getItem('mealsData') || null
                    },
                    // Tekil hasta detay JSON'larƒ±nƒ± da toplayalƒ±m (patient_*)
                    patients: (() => {
                        const arr = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith('patient_')) {
                                arr.push({ key: k, value: localStorage.getItem(k) });
                            }
                        }
                        return arr;
                    })(),
                    embedded: {
                        systemSettings: EMBEDDED_DATA?.systemSettings || null,
                        planningFactors: EMBEDDED_DATA?.planningFactors || null,
                        dietConfig: EMBEDDED_DATA?.dietConfig || null
                    }
                };
                downloadJsonFallback('full_backup.json', bundle);
                try { showToast('Tam yedek indirildi (full_backup.json)', 'success'); } catch(_){}
            } catch (e) {
                console.error('Yedekleme hatasƒ±:', e);
                try { showToast('Yedekleme sƒ±rasƒ±nda hata: ' + e.message, 'error'); } catch(_){}
            }
        }

        async function importFullBackup() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json,.json';
                input.onchange = async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    const text = await file.text();
                    const data = JSON.parse(text);
                    const ls = data.localStorage || {};
                    // Se√ßili anahtarlarƒ± y√ºkle
                    Object.entries(ls).forEach(([k, v]) => {
                        if (v != null) localStorage.setItem(k, v);
                    });
                    // Hasta detaylarƒ±
                    if (Array.isArray(data.patients)) {
                        data.patients.forEach(p => {
                            if (p?.key && typeof p.value === 'string') localStorage.setItem(p.key, p.value);
                        });
                    }
                    // Embedded'ƒ± hafƒ±zada g√ºncelle (dosyalara yazamayƒ±z)
                    if (data.embedded) {
                        try { Object.assign(EMBEDDED_DATA, data.embedded); } catch(_) {}
                    }
                    showToast('Tam yedek i√ße aktarƒ±ldƒ±. Aray√ºz yeniden y√ºklenecek.', 'success');
                    setTimeout(() => {
                        try { loadSavedSystemSettings(); } catch(_){}
                        try { initCustomFormulaPanel(); } catch(_){}
                        try { renderRulesHierarchyList(); } catch(_){}
                        try { loadUsersLists(); } catch(_){}
                        try { calculateTargetCalories(); } catch(_){}
                    }, 150);
                };
                input.click();
            } catch (e) {
                console.error('Geri y√ºkleme hatasƒ±:', e);
                try { showToast('Geri y√ºkleme sƒ±rasƒ±nda hata: ' + e.message, 'error'); } catch(_){}
            }
        }
        
        // Varsayƒ±lan kriter hiyerar≈üisini y√ºkle
        async function loadDefaultCriteriaHierarchy() {
            try {
                // üîß Embedded data kullan
                const planningData = await getEmbeddedData('planning_factors.json');
                // LocalStorage'da kayƒ±tlƒ± sƒ±ra varsa uygula
                const saved = JSON.parse(localStorage.getItem('criteriaOrder') || 'null');
                if (Array.isArray(saved) && saved.length) {
                    const byId = new Map(planningData.factors.map(f=>[f.id,f]));
                    planningData.factors = saved
                        .map(id => byId.get(id))
                        .filter(Boolean)
                        .concat(planningData.factors.filter(f=>!saved.includes(f.id)));
                    planningData.factors.forEach((f, i) => f.priority = i+1);
                }
                
                const container = document.getElementById('default-criteria-hierarchy');
                let html = '';
                
                // Kaydedilmi≈ü criteria sƒ±rasƒ±nƒ± kontrol et
                let sortedFactors = [...planningData.factors];
                const savedOrder = localStorage.getItem('defaultCriteriaOrder');
                
                if (savedOrder) {
                    try {
                        const orderIds = JSON.parse(savedOrder);
                        console.log('üìä Kaydedilmi≈ü criteria sƒ±rasƒ± bulundu:', orderIds);
                        
                        // Kaydedilmi≈ü sƒ±raya g√∂re factors'larƒ± sƒ±rala
                        const factorsById = new Map(planningData.factors.map(f => [f.id, f]));
                        sortedFactors = [];
                        
                        // √ñnce kaydedilmi≈ü sƒ±radaki √∂ƒüeleri ekle
                        orderIds.forEach(id => {
                            const factor = factorsById.get(id);
                            if (factor) {
                                sortedFactors.push(factor);
                            }
                        });
                        
                        // Sonra kaydedilmi≈ü sƒ±rada olmayan yeni √∂ƒüeleri ekle
                        planningData.factors.forEach(factor => {
                            if (!orderIds.includes(factor.id)) {
                                sortedFactors.push(factor);
                            }
                        });
                        
                        // Priority'leri g√ºncelle
                        sortedFactors.forEach((factor, index) => {
                            factor.priority = index + 1;
                        });
                    } catch (error) {
                        console.error('Kaydedilmi≈ü criteria sƒ±rasƒ± parse hatasƒ±:', error);
                    }
                }
                
                // Kaydedilmi≈ü criteria settings'i bir kez y√ºkle
                console.log('üîß HTML generation ba≈ülƒ±yor...');
                
                sortedFactors.forEach((factor, index) => {
                    // HTML generation'da checkbox'ƒ± varsayƒ±lan checked durumunda olu≈ütur
                    // Ger√ßek durum applyCriteriaVisualFeedback() ile ayarlanacak
                    
                    html += `
                        <div class="criteria-item" data-criteria-id="${factor.id}">
                            <div class="criteria-checkbox">
                                <input type="checkbox" class="form-check-input criteria-checkbox-input" 
                                       id="criteria-${factor.id}" 
                                       data-criteria-id="${factor.id}"
                                       checked>
                            </div>
                            <div class="criteria-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="criteria-priority">${factor.priority}</div>
                            <div class="criteria-content">
                                <div class="criteria-title">${factor.name}</div>
                                <div class="criteria-description">${factor.description}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Visual feedback'i uygula (checkbox durumlarƒ±nƒ± ayarla)
                applyCriteriaVisualFeedback();
                
                // Visual feedback tamamlandƒ±ktan SONRA event listener'larƒ±nƒ± kur
                setTimeout(() => {
                    setupCriteriaCheckboxListeners();
                    console.log('üìã Event listener\'lar visual feedback sonrasƒ± kuruldu');
                }, 100);
                
                // Sortable.js i√ßin yeniden initialize et
                setTimeout(async () => {
                    initializeSortables();
                    // Aktif haftanƒ±n kriter snapshot'ƒ±nƒ± uygula (varsa)
                    try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
                    try { await renderCriteriaWeekControls(); } catch(_) {}
                }, 150);
                
            } catch (error) {
                console.error('Krul hiyerar≈üisi y√ºklenirken hata:', error);
            }
        }

        function refreshCriteriaPriorities() {
            const container = document.getElementById('default-criteria-hierarchy');
            [...container.querySelectorAll('.criteria-item')].forEach((el, idx) => {
                const badge = el.querySelector('.criteria-priority');
                if (badge) badge.textContent = String(idx + 1);
            });
        }

        function persistCriteriaOrderFromDOM() {
            const container = document.getElementById('default-criteria-hierarchy');
            const order = [...container.querySelectorAll('.criteria-item')].map(el => el.getAttribute('data-criteria-id'));
            localStorage.setItem('criteriaOrder', JSON.stringify(order));
            logToConsole('üíæ Kriter hiyerar≈üisi kaydedildi');
            // JSON dosyasƒ±na da yaz (data/planning_factors.json)
            saveCriteriaHierarchyToJSON(order);
        }

        // Kriter hiyerar≈üisini data/planning_factors.json'a kaydet
        async function saveCriteriaHierarchyToJSON(orderIds) {
            try {
                const ok = await updateJsonFile('/data/planning_factors.json', (json) => {
                    const out = { ...(json || {}) };
                    out.uiCriteriaOrder = Array.isArray(orderIds) ? [...orderIds] : [];
                    out.lastUpdated = new Date().toISOString();
                    if (Array.isArray(out.factorHierarchy)) {
                        const idxById = new Map(out.uiCriteriaOrder.map((id, i) => [id, i + 1]));
                        out.factorHierarchy = out.factorHierarchy
                            .map(item => ({ ...item }))
                            .sort((a, b) => {
                                const pa = idxById.get(a.id) || Number.MAX_SAFE_INTEGER;
                                const pb = idxById.get(b.id) || Number.MAX_SAFE_INTEGER;
                                return pa - pb;
                            })
                            .map((item, i) => ({ ...item, priority: i + 1 }));
                    }
                    return out;
                });
                if (ok) logToConsole('üìÑ data/planning_factors.json g√ºncellendi (kriter sƒ±rasƒ±)');
            } catch (e) {
                console.warn('Kriter hiyerar≈üisi JSON kaydƒ± ba≈üarƒ±sƒ±z:', e);
            }
        }

        // DOM'dan criteria hierarchy sƒ±rasƒ±nƒ± al
        function getCriteriaHierarchyFromDOM() {
            const container = document.getElementById('default-criteria-hierarchy');
            if (!container) return [];
            
            const criteriaItems = container.querySelectorAll('.criteria-item');
            const hierarchy = [];
            
            criteriaItems.forEach((item, index) => {
                const criteriaId = item.dataset.criteriaId;
                const titleEl = item.querySelector('.criteria-title');
                const descriptionEl = item.querySelector('.criteria-description');
                
                if (criteriaId) {
                    hierarchy.push({
                        id: criteriaId,
                        name: titleEl ? titleEl.textContent : '',
                        description: descriptionEl ? descriptionEl.textContent : '',
                        priority: index + 1
                    });
                }
            });
            
            console.log('üìä Criteria hierarchy toplandƒ±:', hierarchy);
            return hierarchy;
        }

        // T√ºm form verilerini topla
        function collectAllFormData() {
            // Hasta bilgisi
            const patientData = {
                age: parseInt(document.getElementById('target-age')?.value) || 35,
                weight: parseInt(document.getElementById('target-weight')?.value) || 70,
                height: parseInt(document.getElementById('target-height')?.value) || 165,
                gender: document.getElementById('target-gender')?.value || 'female',
                activity: document.getElementById('target-activity')?.value || "1.55",
                dietType: document.getElementById('system-default-diet')?.value || 'lowcarb',
                targetCalories: parseInt(document.getElementById('calculated-calories')?.textContent) || 1850
            };

            // √ñƒü√ºn ayarlarƒ±
            const mealSettings = {
                breakfast: {
                    min: parseInt(document.getElementById('breakfast-min')?.value) || 2,
                    max: parseInt(document.getElementById('breakfast-max')?.value) || 4,
                    fixed: parseInt(document.getElementById('breakfast-fixed')?.value) || null,
                    macroPercent: parseInt(document.getElementById('breakfast-macro')?.value) || 25
                },
                snack1: {
                    min: parseInt(document.getElementById('snack1-min')?.value) || 1,
                    max: parseInt(document.getElementById('snack1-max')?.value) || 2,
                    fixed: parseInt(document.getElementById('snack1-fixed')?.value) || null,
                    macroPercent: parseInt(document.getElementById('snack1-macro')?.value) || 10
                },
                lunch: {
                    min: parseInt(document.getElementById('lunch-min')?.value) || 3,
                    max: parseInt(document.getElementById('lunch-max')?.value) || 5,
                    fixed: parseInt(document.getElementById('lunch-fixed')?.value) || null,
                    macroPercent: parseInt(document.getElementById('lunch-macro')?.value) || 30
                },
                snack2: {
                    min: parseInt(document.getElementById('snack2-min')?.value) || 1,
                    max: parseInt(document.getElementById('snack2-max')?.value) || 2,
                    fixed: parseInt(document.getElementById('snack2-fixed')?.value) || null,
                    macroPercent: parseInt(document.getElementById('snack2-macro')?.value) || 10
                },
                dinner: {
                    min: parseInt(document.getElementById('dinner-min')?.value) || 3,
                    max: parseInt(document.getElementById('dinner-max')?.value) || 5,
                    fixed: parseInt(document.getElementById('dinner-fixed')?.value) || null,
                    macroPercent: parseInt(document.getElementById('dinner-macro')?.value) || 25
                }
            };

            // Kalori hesaplama ayarlarƒ±
            const calorieMethod = document.querySelector('input[name="defaultCalorieMethod"]:checked')?.value || 'custom';
            const customFormula = collectCustomFormula();

            // Kriter ayarlarƒ±
            const criteriaOrder = getCriteriaOrderIdsFromDOM();
            const criteriaSettings = {};
            document.querySelectorAll('.criteria-item').forEach(item => {
                const criteriaId = item.getAttribute('data-criteria-id');
                const checkbox = item.querySelector('.criteria-checkbox-input');
                if (criteriaId && checkbox) {
                    criteriaSettings[criteriaId] = checkbox.checked;
                }
            });

            console.log('üîß collectAllFormData - Kriter durumlarƒ±:', criteriaSettings);
            console.log('üîß collectAllFormData - Kriter sƒ±rasƒ±:', criteriaOrder);
            
            // Sabit yemekler
            const fixedMeals = JSON.parse(localStorage.getItem('fixedMeals') || '{}');

            return {
                patientData,
                mealSettings,
                calorieMethod,
                customFormula,
                criteriaHierarchy: criteriaOrder,
                criteriaSettings,
                fixedMeals,
                timestamp: new Date().toISOString()
            };
        }

        // √ñzel form√ºl parametrelerini topla
        function collectCustomFormula() {
            const get = id => parseFloat(document.getElementById(id)?.value);
            const obj = {
                coeff: {
                    carbs: get('custom-coeff-carbs') || 0.6,
                    protein: get('custom-coeff-protein') || 0.8,
                    fat: get('custom-coeff-fat') || 1.0
                },
                act: {},
                coeffByDiet: {}
            };
            [1,2,3,4,5].forEach(i => obj.act[i] = get('custom-act-'+i) || (i===3?1.0:(i<3?0.8+(i-1)*0.1:1.0+(i-3)*0.1)));
            
            try {
                const diet = document.getElementById('system-default-diet')?.value || 'lowcarb';
                obj.coeffByDiet[diet] = { ...obj.coeff };
                // Varsa √∂nceki kayƒ±tlarƒ± koru
                const currentRaw = localStorage.getItem('systemSettings_v2');
                if (currentRaw) {
                    const current = JSON.parse(currentRaw);
                    const prev = current?.systemDefaults?.customFormula?.coeffByDiet;
                    if (prev && typeof prev === 'object') {
                        Object.keys(prev).forEach(k => {
                            if (!obj.coeffByDiet[k]) obj.coeffByDiet[k] = prev[k];
                        });
                    }
                }
            } catch(_){}
            return obj;
        }

        // Legacy uyum verileri kaydet
        function saveLegacyCompatibilityData(allFormData) {
            // Eski sistemle uyum i√ßin
            localStorage.setItem('systemSettings', JSON.stringify({
                criteriaHierarchy: allFormData.criteriaHierarchy,
                criteriaSettings: allFormData.criteriaSettings
            }));
        }

        // Sistem ayarlarƒ±nƒ± kaydet (v2 √∂ncelikli + legacy uyum)
        async function saveSystemSettings() {
            try {
                // T√ºm form verilerini topla (hasta bilgisi, √∂ƒü√ºn ayarlarƒ±, makro daƒüƒ±lƒ±mlarƒ±, kriterler)
                const allFormData = collectAllFormData();
                
                // Kapsam (Genel vs Hafta) belirle
                const scopeSel = document.getElementById('criteria-week-select');
                const scopeVal = scopeSel?.value || 'system';
                
                let selectedWeekNo = null;
                let isWeekScope = false;
                let isTemplateScope = false;
                
                if (scopeVal !== 'system') {
                    if (scopeVal.startsWith('template_')) {
                        // ≈ûablon hafta se√ßilmi≈ü
                        selectedWeekNo = parseInt(scopeVal.replace('template_', ''));
                        isTemplateScope = true;
                        isWeekScope = true;
                    } else {
                        // Normal hafta se√ßilmi≈ü
                        selectedWeekNo = parseInt(scopeVal);
                        isWeekScope = !isNaN(selectedWeekNo);
                    }
                }
                
                if (isTemplateScope) {
                    console.log(`üß≠ Kaydetme kapsamƒ±: ≈ûablon Hafta ${selectedWeekNo}`);
                } else if (isWeekScope) {
                    console.log(`üß≠ Kaydetme kapsamƒ±: Hasta Hafta ${selectedWeekNo}`);
                } else {
                    console.log('üß≠ Kaydetme kapsamƒ±: Genel (Sistem Varsayƒ±lanƒ±)');
                }
                
                
                if (isTemplateScope) {
                    // ≈ûABLON HAFTA KAYDETME
                    console.log(`üíæ ≈ûablon Hafta ${selectedWeekNo} kaydediliyor...`);
                    let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                    
                    if (!systemSettings.weeklyProfiles) systemSettings.weeklyProfiles = {};
                    
                    systemSettings.weeklyProfiles[selectedWeekNo] = {
                        ...allFormData,
                        name: systemSettings.weeklyProfiles[selectedWeekNo]?.name || `Hafta ${selectedWeekNo}`,
                        weekNumber: selectedWeekNo,
                        createdAt: systemSettings.weeklyProfiles[selectedWeekNo]?.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    console.log(`‚úÖ ≈ûablon Hafta ${selectedWeekNo} kaydedildi:`, systemSettings.weeklyProfiles[selectedWeekNo]);
                    
                    // JSON dosyasƒ±na da kaydet
                    try {
                        await updateJsonFile('/data/system_settings.json', (json) => {
                            return systemSettings;
                        });
                        console.log(`üíæ ≈ûablon Hafta ${selectedWeekNo} JSON dosyasƒ±na da kaydedildi`);
                    } catch (jsonError) {
                        console.warn(`‚ö†Ô∏è ≈ûablon Hafta JSON kaydetme hatasƒ±: ${jsonError.message}`);
                    }
                } else if (!isWeekScope) {
                    // GENEL Sƒ∞STEM VARSAYILANI KAYDETME
                    console.log('üíæ Sistem varsayƒ±lanlarƒ± kaydediliyor...');
                    let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                    
                    // Sistem varsayƒ±lanlarƒ±nƒ± g√ºncelle
                    systemSettings.systemDefaults = allFormData;
                    
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    console.log('‚úÖ Sistem varsayƒ±lanlarƒ± kaydedildi:', systemSettings.systemDefaults);
                    
                    // JSON dosyasƒ±na da kaydet (web'e aktarƒ±m i√ßin)
                    try {
                        await updateJsonFile('/data/system_settings.json', (json) => {
                            return systemSettings;
                        });
                        console.log('üíæ Sistem ayarlarƒ± JSON dosyasƒ±na da kaydedildi');
                    } catch (jsonError) {
                        console.warn(`‚ö†Ô∏è JSON kaydetme hatasƒ±: ${jsonError.message}`);
                    }
                    
                    // Legacy uyum i√ßin ayrƒ± kayƒ±tlar
                    saveLegacyCompatibilityData(allFormData);
                    
                    showToast('success', 'Sistem ayarlarƒ± ba≈üarƒ±yla kaydedildi!');
                } else {
                    // HAFTA ≈ûABLONu KAYDETME
                    console.log(`üíæ Hafta ${selectedWeekNo} ≈üablonu kaydediliyor...`);
                    let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                    
                    // Hafta ≈üablonunu g√ºncelle
                    if (!systemSettings.weeklyProfiles) systemSettings.weeklyProfiles = {};
                    systemSettings.weeklyProfiles[selectedWeekNo] = allFormData;
                    
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    console.log(`‚úÖ Hafta ${selectedWeekNo} ≈üablonu kaydedildi:`, systemSettings.weeklyProfiles[selectedWeekNo]);
                    
                    // JSON dosyasƒ±na da kaydet (web'e aktarƒ±m i√ßin)
                    try {
                        await updateJsonFile('/data/system_settings.json', (json) => {
                            return systemSettings;
                        });
                        console.log(`üíæ Hafta ${selectedWeekNo} ≈üablonu JSON dosyasƒ±na da kaydedildi`);
                    } catch (jsonError) {
                        console.warn(`‚ö†Ô∏è JSON kaydetme hatasƒ±: ${jsonError.message}`);
                    }
                    
                    showToast('success', `Hafta ${selectedWeekNo} ≈üablonu ba≈üarƒ±yla kaydedildi!`);
                    
                    // ≈ûablon listesini yenile
                    listSystemWeekProfiles();
                }
                
            } catch (error) {
                console.error('saveSystemSettings error:', error);
                showToast('error', 'Kayƒ±t hatasƒ±: ' + error.message);
            }
        }

        // Sistem ayarlarƒ±nƒ± sƒ±fƒ±rla
        // Sistem ayarlarƒ±nƒ± sƒ±fƒ±rla
        async function resetSystemSettings() {
            const ok = await showConfirm({
                title: 'Onay',
                message: 'Sistem ayarlarƒ±nƒ± varsayƒ±lan deƒüerlere sƒ±fƒ±rlamak istediƒüinize emin misiniz? Bu i≈ülem mevcut ayarlarƒ±nƒ±zƒ± ge√ßici olarak geri alƒ±r.',
                confirmText: 'Evet, sƒ±fƒ±rla',
                cancelText: 'Vazge√ß',
                variant: 'warning'
            });
            if (!ok) return;

            try {
                // Varsayƒ±lan se√ßiciler
                const defaults = {
                    dietType: 'lowcarb',
                    calorieMethod: 'custom',
                    user: { age: 35, weight: 70, height: 165, gender: 'female', activity: '1.55' },
                    mealPercentages: { breakfast: 25, snack1: 10, lunch: 30, snack2: 10, dinner: 25 },
                    mealSettings: {
                        breakfast: { min: 2, max: 4, fixed: null },
                        snack1: { min: 1, max: 2, fixed: null },
                        lunch: { min: 3, max: 5, fixed: null },
                        snack2: { min: 1, max: 2, fixed: null },
                        dinner: { min: 3, max: 5, fixed: null }
                    },
                    customFormula: {
                        coeff: { carbs: 0.6, protein: 0.8, fat: 1.0 },
                        act: { 1:0.8, 2:0.9, 3:1.0, 4:1.1, 5:1.2 }
                    }
                };

                // Diyet ve y√∂ntem
                const dietSelect = document.getElementById('system-default-diet');
                if (dietSelect) dietSelect.value = defaults.dietType;
                const methodRadio = document.querySelector(`input[name="defaultCalorieMethod"][value="${defaults.calorieMethod}"]`);
                if (methodRadio) methodRadio.checked = true;

                // Kullanƒ±cƒ± alanlarƒ±
                const ageInput = document.getElementById('target-age');
                const weightInput = document.getElementById('target-weight');
                const heightInput = document.getElementById('target-height');
                const genderSelect = document.getElementById('target-gender');
                const activitySelect = document.getElementById('target-activity');
                if (ageInput) ageInput.value = defaults.user.age;
                if (weightInput) weightInput.value = defaults.user.weight;
                if (heightInput) heightInput.value = defaults.user.height;
                if (genderSelect) genderSelect.value = defaults.user.gender;
                if (activitySelect) activitySelect.value = defaults.user.activity;

                // √ñƒü√ºn y√ºzdeleri
                const perc = defaults.mealPercentages;
                const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                setVal('breakfast-macro', perc.breakfast);
                setVal('snack1-macro', perc.snack1);
                setVal('lunch-macro', perc.lunch);
                setVal('snack2-macro', perc.snack2);
                setVal('dinner-macro', perc.dinner);

                // √ñƒü√ºn satƒ±r ayarlarƒ±
                const ms = defaults.mealSettings;
                Object.keys(ms).forEach(meal => {
                    const S = ms[meal];
                    setVal(`${meal}-min`, S.min);
                    setVal(`${meal}-max`, S.max);
                    const fixedEl = document.getElementById(`${meal}-fixed`);
                    if (fixedEl) fixedEl.value = '';
                    try { toggleMealRangeInputs(meal); } catch(_){}
                });

                // √ñzel form√ºl
                setVal('custom-coeff-carbs', defaults.customFormula.coeff.carbs);
                setVal('custom-coeff-protein', defaults.customFormula.coeff.protein);
                setVal('custom-coeff-fat', defaults.customFormula.coeff.fat);
                [1,2,3,4,5].forEach(i => setVal(`custom-act-${i}`, defaults.customFormula.act[i]));

                // localStorage temizliƒüi (yalnƒ±z legacy anahtar)
                try {
                    localStorage.removeItem('systemSettings');
                    // v2 anahtarƒ± silinmez; kullanƒ±cƒ± isterse √ºst√ºne kaydeder
                } catch(_){ }

                // Canlƒ± hesap ve √∂zetleri tetikle
                calculateTargetCalories();
                updateMealMacroTotal();
                try { updateCustomFormulaSummary(); } catch(_){}
                try { updateRightMacrosFromTop(); } catch(_){}
                try { toggleCustomFormulaPanel(); } catch(_){}
                try { updateCalorieMethodFormulaDisplay(); } catch(_){}

                showToast('Sistem ayarlarƒ± varsayƒ±lan deƒüerlere alƒ±ndƒ±', 'success');
            } catch (e) {
                console.error(e);
                try { showToast('Sƒ±fƒ±rlama sƒ±rasƒ±nda hata: ' + e.message, 'error'); } catch(_){ }
            }
        }

        // üÜï KURAL Y√ñNETƒ∞Cƒ∞Sƒ∞ FONKSƒ∞YONLARI
        
        // Kurallar sayfasƒ± lifecycle
        async function loadRulesPage() {
            try {
                // Kurallar hiyerar≈üisini doldur (frequency + diƒüer t√ºrler)
                renderRulesHierarchyList();
                // DnD etkinle≈ütir
                enableRulesDragAndDrop();
                // Varsayƒ±lan buton etiketleri ve bo≈ü durumlarƒ± toparla
                const previewBtn = document.querySelector('#rules .btn.btn-info');
                if (previewBtn && !previewBtn.innerHTML.trim()) {
                    previewBtn.innerHTML = '<i class="fas fa-eye"></i> Etkiyi √ñnizle';
                }
                const resetBtn = document.querySelector('#rules .btn.btn-secondary');
                if (resetBtn && !resetBtn.innerHTML.trim()) {
                    resetBtn.innerHTML = '<i class="fas fa-undo"></i> Varsayƒ±lana D√∂n';
                }
                const saveBtn = document.querySelector('#rules .btn.btn-primary-custom');
                if (saveBtn && !saveBtn.innerHTML.trim()) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Kural Sƒ±rasƒ±nƒ± Kaydet';
                }
                const details = document.getElementById('selected-rule-details');
                if (details && !details.querySelector('.card-body')) {
                    details.innerHTML = '<div class="card-body"><p class="text-muted mb-0">Bir kural se√ßin...</p></div>';
                }

                // Saƒü taraftaki kutuya ‚ÄúJSON‚Äôa Kaydet‚Äù butonu ekle
                const rightBox = previewBtn ? previewBtn.parentElement : null;
                if (rightBox && !document.getElementById('rules-json-save-btn')) {
                    const btn = document.createElement('button');
                    btn.id = 'rules-json-save-btn';
                    btn.className = 'btn btn-outline-primary ms-2';
                    btn.innerHTML = '<i class="fas fa-database"></i> JSON\'a Kaydet';
                    btn.onclick = saveRulesAndCriteriaToJSON;
                    rightBox.appendChild(btn);
                }
            } catch (e) {
                console.warn('Kurallar sayfasƒ± y√ºkleme hatasƒ±:', e);
            }
        }

        // Kriter y√∂neticisi sayfasƒ±nƒ± y√ºkle
        function loadCriteriaManager() {
            showPage('criteria-manager');
            loadCriteriaHierarchy();
        }
        
        // Kriter hiyerar≈üisini y√ºkle
        async function loadCriteriaHierarchy() {
            try {
                // üîß Embedded data kullan
                const planningData = await getEmbeddedData('planning_factors.json');
                
                const container = document.getElementById('rules-hierarchy-container');
                let html = '';
                
                planningData.factors.forEach((factor, index) => {
                    html += `
                        <div class="rule-item" data-factor-id="${factor.id}" onclick="selectRule('${factor.id}')">
                            <div class="rule-priority">${factor.priority}</div>
                            <div class="rule-content">
                                <div class="rule-title">${factor.name}</div>
                                <div class="rule-description">${factor.description}</div>
                            </div>
                            <div class="rule-actions">
                                <button class="btn btn-sm btn-outline-secondary" onclick="editRule('${factor.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <span class="drag-handle ms-2">
                                    <i class="fas fa-grip-vertical"></i>
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Kural hiyerar≈üisi y√ºklenirken hata:', error);
            }
        }

    // Hiyerar≈üi: S√ºr√ºkle-bƒ±rak etkinle≈ütir ve √∂ncelik g√ºncelleme (Kurallar i√ßin)
        function enableRulesDragAndDrop() {
            const container = document.getElementById('rules-hierarchy-container');
            if (!container) return;
            // √ñƒüeleri draggable yap
        container.querySelectorAll('.rule-item').forEach(el => {
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', (e) => {
            const id = el.getAttribute('data-rule-id') || el.getAttribute('data-factor-id');
            if (id) e.dataTransfer.setData('text/plain', id);
                    el.classList.add('dragging');
                });
                el.addEventListener('dragend', () => el.classList.remove('dragging'));
            });
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = container.querySelector('.dragging');
                if (!dragging) return;
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, afterElement);
                }
            });
            container.addEventListener('drop', () => {
                refreshSystemRulePrioritiesFromDOM();
            });
        }

        function getDragAfterElement(container, y) {
            const els = [...container.querySelectorAll('.rule-item:not(.dragging)')];
            return els.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Kurallar: DOM sƒ±rasƒ±na g√∂re √∂ncelikleri g√ºncelle ve kalƒ±cƒ±la≈ütƒ±r
        function refreshSystemRulePrioritiesFromDOM() {
            const container = document.getElementById('rules-hierarchy-container');
            if (!container) return;
            
            const ruleItems = [...container.querySelectorAll('.rule-item')];
            const orderData = ruleItems.map(el => ({
                id: el.getAttribute('data-rule-id'),
                type: el.getAttribute('data-rule-type') // frequency, dependency veya lock
            }));
            
            // Her √º√ß rule tipini de sƒ±rayƒ± g√ºncelleyecek ≈üekilde organize et
            const freqById = new Map(frequencyRules.map(r => [r.id, r]));
            const depById = new Map(dependencyRules.map(r => [r.id, r]));
            const lockById = new Map(lockRules.map(r => [r.id, r]));
            
            const newFreqList = [];
            const newDepList = [];
            const newLockList = [];
            
            orderData.forEach(({id, type}, idx) => {
                const priority = idx + 1;
                
                if (type === 'frequency') {
                    const r = freqById.get(id);
                    if (r) { 
                        r.priority = priority; 
                        newFreqList.push(r); 
                        freqById.delete(id); 
                    }
                } else if (type === 'dependency') {
                    const r = depById.get(id);
                    if (r) { 
                        r.priority = priority; 
                        newDepList.push(r); 
                        depById.delete(id); 
                    }
                } else if (type === 'lock') {
                    const r = lockById.get(id);
                    if (r) { 
                        r.priority = priority; 
                        newLockList.push(r); 
                        lockById.delete(id); 
                    }
                }
            });
            
            // Kalanlarƒ± ekle (her ihtimale kar≈üƒ±)
            const maxPriority = orderData.length;
            let nextPriority = maxPriority + 1;
            
            freqById.forEach((r) => { 
                r.priority = nextPriority++; 
                newFreqList.push(r); 
            });
            
            depById.forEach((r) => { 
                r.priority = nextPriority++; 
                newDepList.push(r); 
            });
            
            lockById.forEach((r) => { 
                r.priority = nextPriority++; 
                newLockList.push(r); 
            });
            
            // Array'leri g√ºncelle
            frequencyRules = newFreqList;
            dependencyRules = newDepList;
            lockRules = newLockList;
            
            // DOM'daki priority badge'leri g√ºncelle
            ruleItems.forEach((el, idx) => {
                const badge = el.querySelector('.rule-priority');
                if (badge) badge.textContent = String(idx + 1);
            });
            
            // Her √º√ß rule tipini de kaydet
            persistSystemRulesArchive();
            
            logToConsole('‚ÜïÔ∏è Kurallar hiyerar≈üisi g√ºncellendi (sƒ±klƒ±k + baƒüƒ±mlƒ±lƒ±k + kilit)');
        }

        // Kurallar listesini olu≈ütur (sadece mevcut: frequency)
        function ensureRulePriorities() {
            let maxP = 0;
            // Her √º√ß rule tipinden de maximum priority'yi bul
            frequencyRules.forEach(r => { if (typeof r.priority === 'number') maxP = Math.max(maxP, r.priority); });
            dependencyRules.forEach(r => { if (typeof r.priority === 'number') maxP = Math.max(maxP, r.priority); });
            lockRules.forEach(r => { if (typeof r.priority === 'number') maxP = Math.max(maxP, r.priority); });
            
            // Eksik priority'leri ata
            frequencyRules.forEach((r, idx) => { if (typeof r.priority !== 'number') r.priority = (++maxP) || (idx + 1); });
            dependencyRules.forEach((r, idx) => { if (typeof r.priority !== 'number') r.priority = (++maxP) || (frequencyRules.length + idx + 1); });
            lockRules.forEach((r, idx) => { if (typeof r.priority !== 'number') r.priority = (++maxP) || (frequencyRules.length + dependencyRules.length + idx + 1); });
        }

        function summarizeRule(r) {
            if (!r) return '';
            
            // Lock rule ise
            if (r.type === 'lock' || ((r.category || r.role) && r.period)) {
                const scopeLabel = r.scope === 'meal' ? '√ñƒü√ºn' : r.scope === 'day' ? 'G√ºn' : 'Hafta';
                const periodLabel = {
                    'daily': 'G√ºnl√ºk',
                    'weekly': 'Haftalƒ±k', 
                    'monthly': 'Aylƒ±k',
                    'custom': '√ñzel'
                }[r.period] || r.period;
                
                let targetLabel = '';
                if (r.category && r.role) {
                    targetLabel = `${r.category} + ${r.role}`;
                } else if (r.category) {
                    targetLabel = r.category;
                } else if (r.role) {
                    targetLabel = r.role;
                } else {
                    targetLabel = 'Belirsiz';
                }
                
                return `${targetLabel} ‚Üí ${periodLabel} kilit (${scopeLabel})`;
            }
            
            // Dependency rule ise
            if (r.type === 'dependency' || (r.dependent && r.target)) {
                const depParts = [];
                const dep = r.dependent || {};
                const target = r.target || {};
                
                if (dep.names?.length) depParts.push(`Ad:[${dep.names.join(', ')}]`);
                if (dep.tags?.length) depParts.push(`Tag:[${dep.tags.join(', ')}]`);
                if (dep.categories?.length) depParts.push(`Kat:[${dep.categories.join(', ')}]`);
                if (dep.roles?.length) depParts.push(`Rol:[${(dep.roles||[]).map(getFoodRoleLabel).join(', ')}]`);
                
                const targetParts = [];
                if (target.names?.length) targetParts.push(`Ad:[${target.names.join(', ')}]`);
                if (target.tags?.length) targetParts.push(`Tag:[${target.tags.join(', ')}]`);
                if (target.categories?.length) targetParts.push(`Kat:[${target.categories.join(', ')}]`);
                if (target.roles?.length) targetParts.push(`Rol:[${(target.roles||[]).map(getFoodRoleLabel).join(', ')}]`);
                
                const depStr = depParts.length ? depParts.join(' | ') : 'Herhangi';
                const targetStr = targetParts.length ? targetParts.join(' | ') : 'Herhangi';
                
                return `${depStr} ‚Üí ${targetStr} (${r.ratio || 40}%)`;
            }
            
            // Frequency rule ise
            const f = r.filters || {};
            const parts = [];
            if (f.names?.length) parts.push(`Ad:[${f.names.join(', ')}]`);
            if (f.tags?.length) parts.push(`Tag:[${f.tags.join(', ')}]`);
            if (f.categories?.length) parts.push(`Kat:[${f.categories.join(', ')}]`);
            if (f.roles?.length) parts.push(`Rol:[${(f.roles||[]).map(getFoodRoleLabel).join(', ')}]`);
            const scopeStr = r.scope === 'meal' ? `√ñƒü√ºn(${(r.meals||[]).length? (r.meals||[]).map(m=>({breakfast:'Kahvaltƒ±',lunch:'√ñƒüle',dinner:'Ak≈üam',snack:'Ara √ñƒü√ºn'}[m]||m)).join(', '):'t√ºm√º'})` : (r.scope==='day'?'G√ºn':'Hafta');
            const countStr = (r.countType==='min'?'En az':r.countType==='max'?'En √ßok':'Sabit')+` ${r.count}`;
            return `${scopeStr} ‚Ä¢ ${countStr} ${parts.length? '‚Ä¢ '+parts.join(' | '):''}`;
        }

        function renderRulesHierarchyList() {
            const container = document.getElementById('rules-hierarchy-container');
            if (!container) return;
            ensureRulePriorities();
            
            console.log('üîß Debug - renderRulesHierarchyList √ßaƒürƒ±ldƒ±');
            console.log('üîß Debug - frequencyRules:', frequencyRules.length);
            console.log('üîß Debug - dependencyRules:', dependencyRules.length);
            console.log('üîß Debug - lockRules:', lockRules.length);
            
            const totalRules = frequencyRules.length + dependencyRules.length + lockRules.length;
            if (!totalRules) {
                container.innerHTML = '<div class="text-muted">Hen√ºz kural eklenmemi≈ü. A≈üaƒüƒ±dan kural ekleyin; burada sƒ±rasƒ±nƒ± belirleyin.</div>';
                return;
            }
            
            // Frequency rules'larƒ± "frequency" type ile i≈üaretle
            const freqRulesWithType = frequencyRules.map(r => ({...r, type: 'frequency', title: r.title || 'Sƒ±klƒ±k Kuralƒ±'}));
            // Dependency rules'larƒ± "dependency" type ile i≈üaretle  
            const depRulesWithType = dependencyRules.map(r => ({...r, type: 'dependency', title: r.title || 'Baƒüƒ±mlƒ±lƒ±k Kuralƒ±'}));
            // Lock rules'larƒ± "lock" type ile i≈üaretle
            const lockRulesWithType = lockRules.map(r => ({...r, type: 'lock', title: r.name || 'Kategori Kilidi'}));
            
            console.log('üîß Debug - lockRulesWithType:', lockRulesWithType);
            
            // T√ºm kurallarƒ± birle≈ütir ve sƒ±rala
            const allRules = [...freqRulesWithType, ...depRulesWithType, ...lockRulesWithType];
            const sorted = allRules.sort((a,b) => (a.priority||9999)-(b.priority||9999));
            
            container.innerHTML = sorted.map(r => `
                <div class="rule-item" data-rule-id="${r.id}" data-rule-type="${r.type}" onclick="showSystemRuleDetails('${r.id}', '${r.type}')">
                    <div class="rule-priority">${r.priority || 0}</div>
                    <div class="rule-content">
                        <div class="rule-title">
                            <span class="badge ${r.type === 'frequency' ? 'bg-primary' : (r.type === 'dependency' ? 'bg-success' : 'bg-warning')} me-2">
                                ${r.type === 'frequency' ? 'Sƒ±klƒ±k' : (r.type === 'dependency' ? 'Baƒüƒ±mlƒ±lƒ±k' : 'Kilit')}
                            </span>
                            ${r.title}
                        </div>
                        <div class="rule-description">${summarizeRule(r)}</div>
                    </div>
                    <div class="rule-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); ${r.type === 'frequency' ? 'editFrequencyRule' : (r.type === 'dependency' ? 'editDependencyRule' : 'editLockRule')}('${r.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="event.stopPropagation(); ${r.type === 'frequency' ? 'deleteFrequencyRule' : (r.type === 'dependency' ? 'deleteDependencyRule' : 'deleteLockRule')}('${r.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <span class="drag-handle ms-2"><i class="fas fa-grip-vertical"></i></span>
                    </div>
                </div>
            `).join('');
        }

        // Kural se√ß
        function selectRule(factorId) {
            // T√ºm rule-item'lardan active sƒ±nƒ±fƒ±nƒ± kaldƒ±r
            document.querySelectorAll('.rule-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Se√ßili √∂ƒüeye active sƒ±nƒ±fƒ± ekle
            document.querySelector(`[data-factor-id="${factorId}"]`).classList.add('active');
            
            // Kural detaylarƒ±nƒ± g√∂ster
            showRuleDetails(factorId);
        }

        // Kural detaylarƒ±nƒ± g√∂ster
    async function showRuleDetails(factorId) {
            try {
                // üîß Embedded data kullan
                const planningData = await getEmbeddedData('planning_factors.json');
                const factor = planningData.factors.find(f => f.id === factorId);
                
                if (factor) {
                    document.getElementById('selected-rule-details').innerHTML = `
                        <div class="card-body">
                            <h6 class="card-title">${factor.name}</h6>
                            <p class="card-text">${factor.description}</p>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">√ñncelik:</small><br>
                                    <strong>${factor.priority}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">T√ºr:</small><br>
                                    <span class="badge bg-primary">${factor.type}</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">Etki Alanƒ±:</small><br>
                                <span class="text-info">${factor.scope}</span>
                            </div>
                        </div>
                    `;
                    // Basit ayar paneli (placeholder)
                    const panel = document.getElementById('rule-settings-panel');
                    if (panel) {
                        panel.innerHTML = `
                            <div class="card border-0">
                                <div class="card-body p-2">
                                    <small class="text-muted">Bu kural i√ßin detaylƒ± ayarlar yakƒ±nda eklenecek.</small>
                                </div>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Kural detaylarƒ± y√ºklenirken hata:', error);
            }
        }

        // Kurallar sayfasƒ±: se√ßilen kural detaylarƒ± (frequency)
        function showSystemRuleDetails(ruleId) {
            const r = frequencyRules.find(x => x.id === ruleId);
            if (!r) return;
            const details = document.getElementById('selected-rule-details');
            if (!details) return;
            const f = r.filters || {};
            const filterLines = [
                f.names?.length ? `Ad: ${f.names.join(', ')}` : null,
                f.tags?.length ? `Tag: ${f.tags.join(', ')}` : null,
                f.categories?.length ? `Kategori: ${f.categories.join(', ')}` : null,
                f.roles?.length ? `Rol: ${(f.roles||[]).map(getFoodRoleLabel).join(', ')}` : null
            ].filter(Boolean).join(' | ');
            const scopeStr = r.scope === 'meal' ? `√ñƒü√ºn: ${(r.meals||[]).map(m=>({breakfast:'Kahvaltƒ±',lunch:'√ñƒüle',dinner:'Ak≈üam',snack:'Ara √ñƒü√ºn'}[m]||m)).join(', ')}` : (r.scope==='day'?'G√ºn':'Hafta');
            const countStr = (r.countType==='min'?'En az':r.countType==='max'?'En √ßok':'Sabit')+` ${r.count}`;
            const weeksStr = (r.weeks && r.weeks.length) ? r.weeks.join(', ') : 'T√ºm√º';
            details.innerHTML = `
                <div class="card-body">
                    <h6 class="card-title">Sƒ±klƒ±k Kuralƒ±</h6>
                    <div class="mb-1"><small class="text-muted">√ñncelik:</small> <strong>${r.priority || '-'}</strong></div>
                    <div class="mb-1"><small class="text-muted">Kapsam:</small> ${scopeStr}</div>
                    <div class="mb-1"><small class="text-muted">Sƒ±klƒ±k:</small> ${countStr}</div>
                    <div class="mb-1"><small class="text-muted">Haftalar:</small> ${weeksStr}</div>
                    <div class="mt-2"><small class="text-muted">Filtre:</small> ${filterLines || '-'}</div>
                </div>
            `;
        }

        // Hiyerar≈üi i≈ülemleri (buton baƒülƒ±)
    async function saveRulesHierarchy() {
            try {
        refreshSystemRulePrioritiesFromDOM();
        alert('Kurallar sƒ±rasƒ± kaydedildi');
            } catch (e) {
                alert('Kaydetme hatasƒ±: ' + e.message);
            }
        }

    async function resetRulesHierarchy() {
            try {
        // √ñncelikleri 1..N olarak yeniden ata, mevcut sƒ±rayƒ± (eklenme sƒ±rasƒ±nƒ±) kullan
        let priority = 1;
        frequencyRules.forEach((r, idx) => r.priority = priority++);
        dependencyRules.forEach((r, idx) => r.priority = priority++);
        
        persistFrequencyRules();
        persistDependencyRules();
        renderRulesHierarchyList();
        enableRulesDragAndDrop();
        logToConsole('üîÑ Kurallar hiyerar≈üisi varsayƒ±lana alƒ±ndƒ± (sƒ±klƒ±k + baƒüƒ±mlƒ±lƒ±k)');
            } catch (e) {
                console.warn('Sƒ±fƒ±rlama hatasƒ±:', e);
            }
        }

    function editRule(factorId) {
        // Eski: kriter d√ºzenleme ‚Äì Kurallar sayfasƒ±nda kullanƒ±lmƒ±yor
        selectRule(factorId);
        logToConsole('‚úèÔ∏è (Kriter) d√ºzenleme a√ßƒ±ldƒ±: ' + factorId);
    }

        function previewRulesEffect() {
            // Basit bir √∂nizleme: Mevcut sƒ±ralamayƒ± ve se√ßili kuralƒ± bildir
            try {
                const items = [...document.querySelectorAll('#rules-hierarchy-container .rule-item')]
                    .map((el, idx) => `${idx+1}. ${el.querySelector('.rule-description')?.textContent || el.querySelector('.rule-title')?.textContent || el.getAttribute('data-rule-id')}`);
                const selected = document.querySelector('#rules-hierarchy-container .rule-item.active .rule-description')?.textContent 
                    || document.querySelector('#rules-hierarchy-container .rule-item.active .rule-title')?.textContent 
                    || 'Se√ßilmedi';
                showToast('Kural sƒ±rasƒ± √∂nizleme konsola yazƒ±ldƒ±', 'info');
                console.log('√ñnizleme\n\nKural Sƒ±rasƒ± (√ºst √∂ncelikli):\n' + items.join('\n') + '\n\nSe√ßili: ' + selected + '\n\nNot: √áakƒ±≈üma halinde √ºstteki kural kƒ±demlidir. Detaylƒ± sim√ºlasyon planlama entegrasyonu ile gelecektir.');
            } catch (e) {
                showToast('√ñnizleme √ßalƒ±≈ütƒ±rƒ±lamadƒ±: ' + e.message, 'error');
            }
        }

        // Tek tu≈üla kurallar + kriterler JSON'a yaz
        async function saveRulesAndCriteriaToJSON() {
            try {
                // Kurallar: mevcut state zaten frequencyRules i√ßinde; doƒürudan kaydet
                const rulesOk = await saveRulesHierarchyToJSON();

                // Kriterler: DOM sƒ±rasƒ±nƒ± topla ve kaydet
                const container = document.getElementById('default-criteria-hierarchy');
                let criteriaOk = false;
                if (container) {
                    // DOM'dan doƒüru attribute ile sƒ±rayƒ± al
                    const order = [...container.querySelectorAll('.criteria-item')].map(el => el.getAttribute('data-criteria-id'));
                    criteriaOk = await saveCriteriaHierarchyToJSON(order);
                }

                if (!JSON_SERVER_ENABLED) {
                    // Sunucu kapalƒ±; indirilebilir yedek √ºret
                    try {
                        // Kurallar fallback
                        const sorted = Array.isArray(frequencyRules) ? [...frequencyRules].sort((a,b)=>(a.priority||9999)-(b.priority||9999)) : [];
                        const compact = sorted.map(r => ({ id: r.id, title: r.title||undefined, filters: r.filters||{}, scope: r.scope, meals: r.meals||[], countType: r.countType, count: r.count, weeks: r.weeks||[], priority: r.priority }));
                        downloadJsonFallback('system_rules.json', { rulesArchive: { frequencyRules: compact, priorityPolicy: 'top-first' }, lastUpdated: new Date().toISOString() });
                        // Kriterler fallback
                        const order = container ? [...container.querySelectorAll('.criteria-item')].map(el => el.getAttribute('data-criteria-id')) : [];
                        downloadJsonFallback('planning_factors.json', { uiCriteriaOrder: order, lastUpdated: new Date().toISOString() });
                        showToast('Sunucu kapalƒ±. JSON dosyalarƒ± indirildi.', 'warning');
                    } catch (_) { /* no-op */ }
                    return;
                }

                if (rulesOk || criteriaOk) {
                    showToast('JSON kaydƒ± tamamlandƒ±', 'success');
                } else {
                    showToast('JSON kaydƒ± ger√ßekle≈ütirilemedi', 'error');
                }
            } catch (e) {
                showToast('JSON kaydƒ± sƒ±rasƒ±nda hata: ' + (e?.message || e), 'error');
            }
        }

        // üÜï HASTA √ñZEL AYARLAR FONKSƒ∞YONLARI
        
        // Hasta ayarlarƒ±nƒ± kaydet
        function savePatientSettings() {
            if (!currentPatient || !currentPatient.personalInfo || !currentPatient.personalInfo.id) {
                alert('Hasta se√ßilmedi!');
                return;
            }

            try {
                const patientId = currentPatient.personalInfo.id;
                
                // Mevcut hasta ayarlarƒ±nƒ± g√ºncelle
                const updatedSettings = {
                    dietType: document.getElementById('patient-custom-diet').value,
                    mealCount: parseInt(document.getElementById('patient-meal-count').value),
                    useSystemRules: document.getElementById('use-system-rules').checked,
                    mealLines: {
                        breakfast: parseInt(document.getElementById('patient-breakfast-lines').value),
                        snack1: parseInt(document.getElementById('patient-snack1-lines').value),
                        lunch: parseInt(document.getElementById('patient-lunch-lines').value),
                        snack2: parseInt(document.getElementById('patient-snack2-lines').value),
                        dinner: parseInt(document.getElementById('patient-dinner-lines').value),
                        night: parseInt(document.getElementById('patient-night-lines').value)
                    }
                };

                // currentPatient nesnesini g√ºncelle
                if (!currentPatient.planningSettings) {
                    currentPatient.planningSettings = {};
                }
                
                currentPatient.planningSettings = {
                    ...currentPatient.planningSettings,
                    ...updatedSettings,
                    lastUpdated: new Date().toISOString()
                };
                
                // Diyet t√ºr√º deƒüi≈ütiyse makrolarƒ± yeniden hesapla
                if (currentPatient.nutritionPreferences.dietType !== updatedSettings.dietType) {
                    currentPatient.nutritionPreferences.dietType = updatedSettings.dietType;
                    
                    const newMacros = calculatePatientMacros(
                        currentPatient.personalInfo.weight,
                        currentPatient.personalInfo.activityLevel,
                        updatedSettings.dietType
                    );
                    
                    if (newMacros) {
                        currentPatient.nutritionPreferences.targetMacros = newMacros;
                        currentPatient.nutritionPreferences.targetCalories = newMacros.calories;
                        
                        // Hasta bilgilerini yeniden y√ºkle
                        loadPatientInfo();
                    }
                }

                // Detaylƒ± hasta verisini localStorage'a kaydet
                savePatientDetailedData(patientId, currentPatient);
                
                // Ba≈üarƒ± mesajƒ±
                const successAlert = document.getElementById('patient-settings-success');
                if (successAlert) {
                    successAlert.style.display = 'block';
                    setTimeout(() => {
                        successAlert.style.display = 'none';
                    }, 3000);
                }
                
                logToConsole(`üë§ Hasta ayarlarƒ± g√ºncellendi: ${patientId}`);
                logToConsole(`üìä Yeni makrolar: ${JSON.stringify(currentPatient.nutritionPreferences.targetMacros)}`);
                
            } catch (error) {
                console.error('Hasta ayarlarƒ± kaydedilirken hata:', error);
                alert('‚ùå Ayarlar kaydedilirken hata olu≈ütu: ' + error.message);
            }
        }

        // Sistem varsayƒ±lanlarƒ±na d√∂n
        function resetToSystemDefaults() {
            if (confirm('Hasta ayarlarƒ±nƒ± sistem varsayƒ±lanlarƒ±na sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) {
                const patientId = getCurrentPatientId();
                if (patientId) {
                    const patientKey = `patient_${patientId}_settings`;
                    localStorage.removeItem(patientKey);
                    loadSystemDefaultsForPatient();
                    alert('‚úÖ Hasta ayarlarƒ± sistem varsayƒ±lanlarƒ±na sƒ±fƒ±rlandƒ±!');
                }
            }
        }

        // Hasta i√ßin sistem varsayƒ±lanlarƒ±nƒ± y√ºkle
        function loadSystemDefaultsForPatient() {
            const systemSettings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
            
            // Varsayƒ±lan deƒüerler
            document.getElementById('patient-custom-diet').value = systemSettings.defaultDiet || 'lowcarb';
            document.getElementById('patient-meal-count').value = systemSettings.defaultMealCount || 5;
            document.getElementById('use-system-rules').checked = true;
            
            const defaultLines = systemSettings.mealLines || {
                breakfast: 3, snack1: 2, lunch: 4, snack2: 2, dinner: 4, night: 1
            };
            
            document.getElementById('patient-breakfast-lines').value = defaultLines.breakfast;
            document.getElementById('patient-snack1-lines').value = defaultLines.snack1;
            document.getElementById('patient-lunch-lines').value = defaultLines.lunch;
            document.getElementById('patient-snack2-lines').value = defaultLines.snack2;
            document.getElementById('patient-dinner-lines').value = defaultLines.dinner;
            document.getElementById('patient-night-lines').value = defaultLines.night;
        }

        // ≈ûu anki hasta ID'sini al
        function getCurrentPatientId() {
            // √ñnce currentPatient'dan al
            if (currentPatient && currentPatient.personalInfo && currentPatient.personalInfo.id) {
                return currentPatient.personalInfo.id;
            }
            
            // currentPatient.id'den al
            if (currentPatient && currentPatient.id) {
                return currentPatient.id;
            }
            
            // window.currentPatientId'den al
            if (window.currentPatientId) {
                return window.currentPatientId;
            }
            
            // localStorage'dan al
            const storedId = localStorage.getItem('currentPatientId');
            if (storedId) {
                return storedId;
            }
            
            console.warn('‚ö†Ô∏è getCurrentPatientId: Hasta ID bulunamadƒ±');
            return null;
        }

        // === YENƒ∞: TEMPLATE-SPECIFIC STORAGE SYSTEM (RADIKAL √á√ñZ√úM) ===
        
        // ≈ûablona √∂zel veri kaydetme
        async function saveTemplateSpecificData(templateId, dataType, data) {
            try {
                console.log(`üíæ [TEMPLATE-SAVE] ${templateId} - ${dataType}:`, data);
                
                const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                
                // Template yoksa olu≈ütur
                if (!systemSettings.weeklyProfiles[templateId]) {
                    systemSettings.weeklyProfiles[templateId] = {
                        name: templateId.toString(),
                        created: new Date().toLocaleString('tr-TR'),
                        createdAt: new Date().toISOString()
                    };
                }
                
                // Template-specific data alanƒ±nƒ± olu≈ütur
                if (!systemSettings.weeklyProfiles[templateId].templateData) {
                    systemSettings.weeklyProfiles[templateId].templateData = {};
                }
                
                // Veriyi kaydet
                systemSettings.weeklyProfiles[templateId].templateData[dataType] = data;
                systemSettings.weeklyProfiles[templateId].updatedAt = new Date().toISOString();
                systemSettings.weeklyProfiles[templateId].updated = new Date().toLocaleString('tr-TR');
                
                // LocalStorage'a kaydet
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                
                // JSON server'a kaydet
                if (JSON_SERVER_ENABLED) {
                    try {
                        const response = await fetch('http://localhost:3000/data/system_settings.json');
                        if (response.ok) {
                            let json = await response.json();
                            json.weeklyProfiles = systemSettings.weeklyProfiles;
                            
                            await fetch('http://localhost:3000/data/system_settings.json', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(json)
                            });
                            console.log(`üì§ [TEMPLATE-SAVE] ${templateId} - ${dataType} JSON server'a kaydedildi`);
                        }
                    } catch (error) {
                        console.error(`‚ùå [TEMPLATE-SAVE] JSON server hatasƒ±:`, error);
                    }
                }
                
                // Cache g√ºncelle
                window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
                
                return true;
                
            } catch (error) {
                console.error(`‚ùå [TEMPLATE-SAVE] ${templateId} - ${dataType} kaydetme hatasƒ±:`, error);
                return false;
            }
        }
        
        // ≈ûablondan √∂zel veri y√ºkleme
        async function loadTemplateSpecificData(templateId, dataType) {
            try {
                console.log(`üì• [TEMPLATE-LOAD] ${templateId} - ${dataType} y√ºkleniyor...`);
                
                // Template ID'den numeric ID √ßƒ±kar
                let numericId = templateId;
                if (typeof templateId === 'string' && templateId.startsWith('template_')) {
                    numericId = templateId.replace('template_', '');
                }
                
                console.log(`üîç [TEMPLATE-LOAD] Numeric ID: ${numericId}`);
                
                let systemSettings = null;
                
                // √ñnce JSON server'dan dene
                if (JSON_SERVER_ENABLED) {
                    try {
                        const response = await fetch('http://localhost:3000/data/system_settings.json');
                        if (response.ok) {
                            systemSettings = await response.json();
                        }
                    } catch (e) {
                        console.warn('[TEMPLATE-LOAD] JSON server hatasƒ±, localStorage kullanƒ±lacak');
                    }
                }
                
                // JSON server ba≈üarƒ±sƒ±zsa localStorage
                if (!systemSettings) {
                    systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                }
                
                const profile = systemSettings?.weeklyProfiles?.[numericId];
                if (!profile) {
                    console.log(`‚ö†Ô∏è [TEMPLATE-LOAD] Profile bulunamadƒ±: ${numericId}`);
                    return null;
                }
                
                // Template-specific data varsa onu kullan
                let templateData = profile?.templateData?.[dataType];
                
                // Template-specific data yoksa, profile'dan al (backward compatibility)
                if (!templateData && dataType === 'fixedMeals') {
                    templateData = profile.fixedMeals;
                }
                if (!templateData && dataType === 'criteriaStates') {
                    templateData = profile.criteriaSettings;
                }
                
                if (templateData && Object.keys(templateData).length > 0) {
                    console.log(`‚úÖ [TEMPLATE-LOAD] ${numericId} - ${dataType} bulundu:`, templateData);
                    return templateData;
                } else {
                    console.log(`‚ö†Ô∏è [TEMPLATE-LOAD] ${numericId} - ${dataType} bulunamadƒ±, varsayƒ±lan kullanƒ±lacak`);
                    return null;
                }
                
            } catch (error) {
                console.error(`‚ùå [TEMPLATE-LOAD] ${templateId} - ${dataType} y√ºkleme hatasƒ±:`, error);
                return null;
            }
        }
        
        // Template-specific storage fonksiyonlarƒ± i√ßin yardƒ±mcƒ±
        function isTemplateMode() {
            const weekSelect = document.getElementById('criteria-week-select');
            const selectedValue = weekSelect?.value;
            
            // Sadece template_ ile ba≈ülayanlarda template mode
            const isTemplate = selectedValue && selectedValue.startsWith('template_');
            console.log(`üîç [TEMPLATE-CHECK] isTemplateMode: ${isTemplate}, value: ${selectedValue}`);
            return isTemplate;
        }

        // Aktif ≈üablon ID'sini al
        function getCurrentTemplateId() {
            const weekSelect = document.getElementById('criteria-week-select');
            const selectedValue = weekSelect?.value;
            
            console.log(`üîç [TEMPLATE-ID] Dropdown value: ${selectedValue}`);
            
            if (selectedValue && selectedValue.startsWith('template_')) {
                const templateId = selectedValue.replace('template_', '');
                console.log(`üîç [TEMPLATE-ID] Template ID √ßƒ±karƒ±ldƒ±: ${templateId}`);
                return templateId;
            }
            
            console.log(`üîç [TEMPLATE-ID] Template mode deƒüil, null d√∂nd√ºr√ºl√ºyor`);
            return null;
        }

        // Hafta ≈ûablonlarƒ± (Sistem) ‚Äì kaydet, listele, uygula, sil
        async function getSystemWeeklyProfiles() {
            try {
                // √ñnce JSON server'dan dene
                if (JSON_SERVER_ENABLED) {
                    try {
                        const response = await fetch('http://localhost:3000/data/system_settings.json');
                        if (response.ok) {
                            const all = await response.json();
                            console.log('üîç [Fƒ∞Zƒ∞KSEL JSON] getSystemWeeklyProfiles - systemSettings_v2:', all);
                            const profiles = all?.weeklyProfiles || {};
                            console.log('üîç [Fƒ∞Zƒ∞KSEL JSON] getSystemWeeklyProfiles - profiles found:', Object.keys(profiles));
                            return profiles;
                        }
                    } catch (e) {
                        console.warn('JSON server\'dan hafta profilleri y√ºklenemedi, localStorage\'a ge√ßiliyor');
                    }
                }
                
                // Fallback: localStorage'dan y√ºkle
                const all = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                console.log('üîç [FALLBACK] getSystemWeeklyProfiles - systemSettings_v2:', all);
                const profiles = all?.weeklyProfiles || {};
                console.log('üîç [FALLBACK] getSystemWeeklyProfiles - profiles found:', Object.keys(profiles));
                return profiles;
            } catch (e) { 
                console.warn('getSystemWeeklyProfiles error:', e);
                return {}; 
            }
        }

        async function getSystemWeekProfile(weekNo) {
            const all = await getSystemWeeklyProfiles();
            return all && all[weekNo] ? all[weekNo] : null;
        }

        async function saveSystemWeekProfile() {
            const numEl = document.getElementById('week-profile-number');
            const nameEl = document.getElementById('week-profile-name');
            const weekNo = parseInt(numEl?.value || '');
            const name = (nameEl?.value || '').trim();
            
            if (!weekNo || weekNo < 1) {
                alert('Ge√ßerli bir hafta numarasƒ± girin.');
                return;
            }

            try {
                // T√ºm form verilerini topla
                const allFormData = collectAllFormData();
                
                const snapshot = {
                    name: name || `Hafta ${weekNo}`,
                    weekNumber: weekNo,
                    createdAt: new Date().toISOString(),
                    ...allFormData  // T√ºm form verileri hafta ≈üablonuna dahil
                };

                let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                
                if (!systemSettings.weeklyProfiles) systemSettings.weeklyProfiles = {};
                systemSettings.weeklyProfiles[weekNo] = snapshot;
                
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                
                // JSON dosyasƒ±na da yaz (web'e aktarƒ±m i√ßin)
                try {
                    await updateJsonFile('/data/system_settings.json', (json) => {
                        return systemSettings;
                    });
                    console.log(`üíæ Hafta ${weekNo} ≈üablonu JSON dosyasƒ±na da kaydedildi`);
                } catch (jsonError) {
                    console.warn(`‚ö†Ô∏è JSON kaydetme hatasƒ±: ${jsonError.message}`);
                }
                
                // Cache g√ºncelle
                window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
                
                // Listeyi yenile
                listSystemWeekProfiles();
                
                // Formu temizle
                numEl.value = '';
                nameEl.value = '';
                
                showToast('success', `Hafta ${weekNo} - "${snapshot.name}" ≈üablonu kaydedildi!`);
                console.log(`‚úÖ Hafta ${weekNo} ≈üablonu kaydedildi:`, snapshot);
                
            } catch (e) {
                console.error('saveSystemWeekProfile error', e);
                alert('Kayƒ±t hatasƒ±: ' + e.message);
            }
        }

        async function listSystemWeekProfiles() {
            console.log('üîç listSystemWeekProfiles √ßaƒürƒ±ldƒ±');
            const container = document.getElementById('system-week-profiles-list');
            if (!container) {
                console.warn('‚ö†Ô∏è system-week-profiles-list container bulunamadƒ±');
                return;
            }
            
            const saved = window.__weeklyProfilesCache || await getSystemWeeklyProfiles();
            console.log('üîç listSystemWeekProfiles - saved data:', saved);
            
            const keys = Object.keys(saved || {}).sort((a,b)=>Number(a)-Number(b));
            console.log('üîç listSystemWeekProfiles - profile keys:', keys);
            
            if (!keys.length) { 
                container.innerHTML = '<div class="text-muted">Hen√ºz kayƒ±t yok.</div>'; 
                console.log('üìã Hafta ≈üablonu bulunamadƒ±');
                return; 
            }
            
            container.innerHTML = keys.map(k => {
                const p = saved[k];
                const title = p?.name || `Hafta ${k}`;
                const date = p?.createdAt ? new Date(p.createdAt).toLocaleString('tr-TR') : '';
                return `<div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                    <div>
                        <strong>Hafta ${k}:</strong> ${title}
                        <div class=\"text-muted small\">${date}</div>
                    </div>
                    <div class=\"btn-group btn-group-sm\">
                        <button class=\"btn btn-outline-secondary\" onclick=\"editSystemWeekProfile(${k})\" title=\"Bu ≈üablonu d√ºzenlemek i√ßin y√ºkle\"><i class='fas fa-edit'></i> D√ºzenle</button>
                        <button class=\"btn btn-outline-success\" onclick=\"saveCurrentSettingsToTemplate(${k})\" title=\"Mevcut ayarlarƒ± bu ≈üablona kaydet\"><i class='fas fa-save'></i> Kaydet</button>
                        <button class=\"btn btn-outline-primary\" onclick=\"(async () => await applySystemWeekProfile(${k}))()\" title=\"Bu ≈üablonu mevcut ayarlara uygula\"><i class='fas fa-download'></i> Uygula</button>
                        <button class=\"btn btn-outline-danger\" onclick=\"deleteSystemWeekProfile(${k})\"><i class='fas fa-trash'></i></button>
                    </div>
                </div>`;
            }).join('');
            
            console.log(`üìã ${keys.length} hafta ≈üablonu listelendi`);
        }

        // Hafta ≈üablonu d√ºzenle: isim deƒüi≈ütir ve/veya UI'den yeniden yakala
        async function editSystemWeekProfile(weekNo) {
            const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
            const profile = systemSettings?.weeklyProfiles?.[weekNo];
            
            if (!profile) {
                alert('≈ûablon bulunamadƒ±.');
                return;
            }
            
            const newName = prompt('Hafta adƒ±/izahƒ± g√ºncelle:', profile.name || `Hafta ${weekNo}`);
            if (newName === null) return;
            
            // ƒ∞steƒüe baƒülƒ±: mevcut UI durumunu yeniden yakala mƒ±?
            const recapture = confirm('Mevcut ekran ayarlarƒ±nƒ± bu ≈üablona yeniden kaydetmek ister misiniz?');
            
            if (recapture) {
                // T√ºm form verilerini yeniden yakala
                const allFormData = collectAllFormData();
                profile.patientData = allFormData.patientData;
                profile.mealSettings = allFormData.mealSettings;
                profile.calorieMethod = allFormData.calorieMethod;
                profile.customFormula = allFormData.customFormula;
                profile.criteriaHierarchy = allFormData.criteriaHierarchy;
                profile.criteriaSettings = allFormData.criteriaSettings;
            }
            
            profile.name = (newName || '').trim() || profile.name;
            profile.updatedAt = new Date().toISOString();
            
            if (!systemSettings.weeklyProfiles) systemSettings.weeklyProfiles = {};
            systemSettings.weeklyProfiles[weekNo] = profile;
            
            localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
            
            // JSON dosyasƒ±na da kaydet
            try {
                await updateJsonFile('/data/system_settings.json', (json) => {
                    json.weeklyProfiles = systemSettings.weeklyProfiles;
                    return json;
                });
                console.log('üóÇÔ∏è Hafta ≈üablonu d√ºzenlemesi JSON dosyasƒ±na kaydedildi');
            } catch (error) {
                console.error('‚ùå Hafta ≈üablonu d√ºzenlemesi JSON kaydetme hatasƒ±:', error);
            }
            
            // Cache g√ºncelle
            window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
            
            listSystemWeekProfiles();
            // Success mesajlarƒ±nƒ± kaldƒ±r - sadece console log
            // showToast('success', `Hafta ${weekNo} ≈üablonu g√ºncellendi.`);
        }

        // Yeni: Mevcut ayarlarƒ± belirtilen ≈üablona kaydet
        async function saveCurrentSettingsToTemplate(weekNo) {
            try {
                console.log(`üíæ Mevcut ayarlar Hafta ${weekNo} ≈üablonuna kaydediliyor...`);
                
                // Mevcut form verilerini topla
                const formData = collectAllFormData();
                
                // Sistem ayarlarƒ±nƒ± al
                const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                
                // Eƒüer ≈üablon yoksa olu≈ütur
                if (!systemSettings.weeklyProfiles[weekNo]) {
                    systemSettings.weeklyProfiles[weekNo] = {
                        name: weekNo.toString(),
                        created: new Date().toLocaleString('tr-TR'),
                        createdAt: new Date().toISOString()
                    };
                }
                
                // Mevcut ayarlarƒ± ≈üablona kaydet
                const templateData = systemSettings.weeklyProfiles[weekNo];
                templateData.criteriaStates = formData.criteriaStates || {};
                templateData.criteriaOrder = formData.criteriaOrder || [];
                templateData.patientData = formData.patientData || {};
                templateData.fixedMeals = formData.fixedMeals || {};
                templateData.updatedAt = new Date().toISOString();
                templateData.updated = new Date().toLocaleString('tr-TR');
                
                // localStorage'a kaydet
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                
                // JSON server'a da kaydet
                if (JSON_SERVER_ENABLED) {
                    try {
                        const response = await fetch('http://localhost:3000/data/system_settings.json');
                        if (response.ok) {
                            let json = await response.json();
                            json.weeklyProfiles = systemSettings.weeklyProfiles;
                            
                            await fetch('http://localhost:3000/data/system_settings.json', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(json)
                            });
                            console.log(`üì§ [Fƒ∞Zƒ∞KSEL JSON] Hafta ${weekNo} ≈üablonu g√ºncellendi`);
                        }
                    } catch (error) {
                        console.error(`‚ùå JSON server'a Hafta ${weekNo} kaydetme hatasƒ±:`, error);
                    }
                }
                
                // Cache g√ºncelle
                window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
                
                // Liste g√ºncelle
                listSystemWeekProfiles();
                // Success mesajlarƒ±nƒ± kaldƒ±r - sadece console log
                // showToast('success', `Mevcut ayarlar Hafta ${weekNo} ≈üablonuna kaydedildi.`);
                
            } catch (error) {
                console.error(`‚ùå Hafta ${weekNo} ≈üablonuna kaydetme hatasƒ±:`, error);
                alert('Kaydetme sƒ±rasƒ±nda hata olu≈ütu.');
            }
        }

        // Hafta ≈üablonu uygula
        async function applySystemWeekProfile(weekNo) {
            try {
                console.log(`üì• [TEMPLATE-APPLY] Hafta ${weekNo} ≈üablonu uygulanƒ±yor...`);
                
                const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                const profile = systemSettings?.weeklyProfiles?.[weekNo];
                
                if (!profile) {
                    alert('≈ûablon bulunamadƒ±.');
                    return;
                }

                // Template-specific data y√ºkle
                const templateId = `template_${weekNo}`;
                console.log(`üéØ [TEMPLATE-APPLY] Template ID: ${templateId}`);
                
                // Fixed meals template data
                const templateFixedMeals = await loadTemplateSpecificData(templateId, 'fixedMeals');
                console.log(`üçΩÔ∏è [TEMPLATE-APPLY] Template fixed meals:`, templateFixedMeals);
                
                // Criteria states template data
                const templateCriteriaStates = await loadTemplateSpecificData(templateId, 'criteriaStates');
                console.log(`üìã [TEMPLATE-APPLY] Template criteria states:`, templateCriteriaStates);
                
                // Full template data object i√ßin
                const templateData = {
                    fixedMeals: templateFixedMeals,
                    criteriaStates: templateCriteriaStates
                };
                console.log(`üéØ [TEMPLATE-APPLY] Template-specific veri:`, templateData);

                // Hasta bilgilerini form alanlarƒ±na y√ºkle
                if (profile.patientData) {
                    const p = profile.patientData;
                    document.getElementById('target-age').value = p.age || 35;
                    document.getElementById('target-weight').value = p.weight || 70;
                    document.getElementById('target-height').value = p.height || 165;
                    document.getElementById('target-gender').value = p.gender || 'female';
                    document.getElementById('target-activity').value = p.activity || '1.55';
                    document.getElementById('system-default-diet').value = p.dietType || 'lowcarb';
                }

                // Template-specific fixed meals UI'ye y√ºkle
                if (templateFixedMeals) {
                    console.log(`üçΩÔ∏è [TEMPLATE-APPLY] Template fixed meals UI'ye y√ºkleniyor:`, templateFixedMeals);
                    loadFixedMealsFromWeekProfile(templateFixedMeals);
                }

                // √ñƒü√ºn ayarlarƒ±nƒ± y√ºkle
                if (profile.mealSettings) {
                    const m = profile.mealSettings;
                    Object.keys(m).forEach(meal => {
                        const mealData = m[meal];
                        document.getElementById(`${meal}-min`).value = mealData.min || 2;
                        document.getElementById(`${meal}-max`).value = mealData.max || 4;
                        document.getElementById(`${meal}-macro`).value = mealData.macroPercent || 25;
                    });
                }

                // Kalori hesaplama y√∂ntemi
                if (profile.calorieMethod) {
                    const methodRadio = document.querySelector(`input[name="defaultCalorieMethod"][value="${profile.calorieMethod}"]`);
                    if (methodRadio) methodRadio.checked = true;
                }

                // √ñzel form√ºl parametreleri
                if (profile.customFormula) {
                    const cf = profile.customFormula;
                    if (cf.coeff) {
                        document.getElementById('custom-coeff-carbs').value = cf.coeff.carbs || 0.6;
                        document.getElementById('custom-coeff-protein').value = cf.coeff.protein || 0.8;
                        document.getElementById('custom-coeff-fat').value = cf.coeff.fat || 1.0;
                    }
                    if (cf.act) {
                        [1,2,3,4,5].forEach(i => {
                            const el = document.getElementById(`custom-act-${i}`);
                            if (el) el.value = cf.act[i] || 1.0;
                        });
                    }
                }

                // Kriter sƒ±ralamasƒ± ve etkinlik durumlarƒ±
                if (profile.criteriaHierarchy && profile.criteriaSettings) {
                    applyCriteriaOrderToDOM(profile.criteriaHierarchy);
                    
                    // Template-specific criteria states varsa kullan, yoksa profil ayarlarƒ±nƒ± kullan
                    let criteriaStatesToApply = profile.criteriaSettings;
                    if (templateCriteriaStates && Object.keys(templateCriteriaStates).length > 0) {
                        console.log(`‚úÖ [TEMPLATE-APPLY] Template-specific kriter durumlarƒ± kullanƒ±lƒ±yor:`, templateCriteriaStates);
                        criteriaStatesToApply = templateCriteriaStates;
                    } else {
                        console.log(`üìã [TEMPLATE-APPLY] Profil kriter durumlarƒ± kullanƒ±lƒ±yor:`, profile.criteriaSettings);
                    }
                    
                    // Checkbox'larƒ± g√ºncelle
                    Object.keys(criteriaStatesToApply).forEach(criteriaId => {
                        const isActive = criteriaStatesToApply[criteriaId];
                        const checkbox = document.querySelector(`[data-criteria-id="${criteriaId}"]`);
                        if (checkbox) {
                            checkbox.checked = isActive;
                            console.log(`üìã [TEMPLATE-APPLY] ${criteriaId}: ${isActive ? 'aktif' : 'pasif'} - checkbox g√ºncellendi`);
                        } else {
                            console.warn(`‚ö†Ô∏è [TEMPLATE-APPLY] Checkbox bulunamadƒ±: ${criteriaId}`);
                        }
                    });
                    
                    // Visual feedback'i yenile
                    setTimeout(() => {
                        applyCriteriaVisualFeedback();
                        console.log(`‚ú® [TEMPLATE-APPLY] Visual feedback uygulandƒ±`);
                    }, 300);
                }

                // Hesaplamalarƒ± yenile
                calculateTargetCalories();
                updateMealMacroTotal();
                onCustomFormulaChanged();

                console.log(`‚úÖ [TEMPLATE-APPLY] Hafta ${weekNo} ≈üablonu ba≈üarƒ±yla uygulandƒ±`);
                
                // Dropdown'ƒ± g√ºncelle
                const weekSelect = document.getElementById('criteria-week-select');
                if (weekSelect) {
                    weekSelect.value = templateId;
                    console.log(`üîÑ [TEMPLATE-APPLY] Dropdown g√ºncellendi: ${templateId}`);
                }
                
            } catch (e) {
                console.error('‚ùå [TEMPLATE-APPLY] Hata:', e);
                alert('≈ûablon uygulama hatasƒ±: ' + e.message);
            }
        }

        // Hafta ≈üablonu sil
        function deleteSystemWeekProfile(weekNo) {
            if (!confirm(`Hafta ${weekNo} ≈üablonunu silmek istediƒüinizden emin misiniz?`)) return;
            
            try {
                let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                
                if (systemSettings.weeklyProfiles && systemSettings.weeklyProfiles[weekNo]) {
                    delete systemSettings.weeklyProfiles[weekNo];
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    
                    // Cache g√ºncelle
                    window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
                    
                    listSystemWeekProfiles();
                    showToast('success', `Hafta ${weekNo} ≈üablonu silindi.`);
                }
            } catch (e) {
                console.error('deleteSystemWeekProfile error', e);
                alert('Silme hatasƒ±: ' + e.message);
            }
        }
        // Hafta ≈üablonu sil
        async function deleteSystemWeekProfile(weekNo) {
            if (!confirm(`Hafta ${weekNo} ≈üablonunu silmek istediƒüinizden emin misiniz?`)) return;
            
            try {
                let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                
                if (systemSettings.weeklyProfiles && systemSettings.weeklyProfiles[weekNo]) {
                    delete systemSettings.weeklyProfiles[weekNo];
                    localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                    
                    // JSON dosyasƒ±ndan da sil
                    try {
                        await updateJsonFile('/data/system_settings.json', (json) => {
                            if (json.weeklyProfiles && json.weeklyProfiles[weekNo]) {
                                delete json.weeklyProfiles[weekNo];
                            }
                            return json;
                        });
                        console.log('üóÇÔ∏è Hafta ≈üablonu JSON dosyasƒ±ndan da silindi');
                    } catch (error) {
                        console.error('‚ùå Hafta ≈üablonu JSON silme hatasƒ±:', error);
                    }
                    
                    // Cache g√ºncelle
                    window.__weeklyProfilesCache = systemSettings.weeklyProfiles;
                    
                    listSystemWeekProfiles();
                    showToast('success', `Hafta ${weekNo} ≈üablonu silindi.`);
                }
            } catch (e) {
                console.error('deleteSystemWeekProfile error', e);
                alert('Silme hatasƒ±: ' + e.message);
            }
        }

        // Hasta haftasƒ±na sistem ≈üablonu uygula
        function applySystemWeekProfileToCurrentWeek(weekNo) {
            if (!currentPatient || !currentWeek) return alert('Aktif hafta yok.');
            const prof = getSystemWeekProfile(weekNo);
            if (!prof) return alert('Se√ßili hafta i√ßin sistem ≈üablonu bulunamadƒ±.');
            currentWeek.appliedSystemProfile = {
                weekNumber: prof.weekNumber,
                name: prof.name,
                appliedAt: new Date().toISOString(),
                source: 'system',
                settings: prof.settings
            };
            // Haftaya tanƒ±m ve kriter snapshotƒ±nƒ± yaz
            currentWeek.description = prof.name || currentWeek.description || '';
            if (prof.settings?.criteria) {
                currentWeek.criteriaSnapshot = prof.settings.criteria;
            }
            // Kaydet
            const patientId = getCurrentPatientId();
            if (patientId) savePatientDetailedData(patientId, currentPatient);
            // UI'yi g√ºncelle
            loadWeeklyPlanContent();
            try { applyCurrentWeekCriteriaToUI(); } catch(_) {}
        }

        function promptApplySystemWeekToCurrent() {
            const input = prompt('Uygulanacak sistem hafta numarasƒ± nedir?');
            if (!input) return;
            const weekNo = parseInt(input);
            if (!weekNo || weekNo < 1) return alert('Ge√ßerli bir hafta numarasƒ± girin.');
            applySystemWeekProfileToCurrentWeek(weekNo);
        }

        // Yeni: Hasta haftasƒ± meta i≈ülemleri
        function saveCurrentWeekMeta() {
            if (!currentPatient || !currentWeek) return;
            const input = document.getElementById('week-desc-input');
            if (input) {
                currentWeek.description = input.value.trim();
                const textEl = document.getElementById('week-desc-text');
                if (textEl) textEl.textContent = currentWeek.description || '-';
                const patientId = getCurrentPatientId();
                if (patientId) savePatientDetailedData(patientId, currentPatient);
                try { showToast('Hafta tanƒ±mƒ± kaydedildi', 'success'); } catch(_){ }
            }
        }

        function applySelectedSystemWeekToCurrent() {
            const sel = document.getElementById('apply-system-week-select');
            const val = sel && sel.value ? parseInt(sel.value) : null;
            if (!val) return alert('√ñnce bir sistem ≈üablonu se√ßin.');
            applySystemWeekProfileToCurrentWeek(val);
        }

        // === INTERACTION HISTORY MANAGEMENT ===
        
        // Refresh interaction history display (JSON'dan y√ºkle)
        function refreshInteractionHistory() {
            const container = document.getElementById('interaction-history-container');
            if (!container) return;
            
            // systemSettings_v2'den etkile≈üim ge√ßmi≈üini al
            const systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
            const log = systemSettings.interactionLog || [];
            
            if (log.length === 0) {
                container.innerHTML = '<div class="text-muted">Hen√ºz etkile≈üim kaydƒ± yok.</div>';
                return;
            }
            
            // Sort by timestamp descending (newest first)
            const sortedLog = log.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Group by session
            const groupedBySessions = {};
            sortedLog.forEach(interaction => {
                const sessionId = interaction.sessionId || 'unknown';
                if (!groupedBySessions[sessionId]) {
                    groupedBySessions[sessionId] = [];
                }
                groupedBySessions[sessionId].push(interaction);
            });
            
            let html = '';
            
            Object.keys(groupedBySessions).forEach(sessionId => {
                const sessionInteractions = groupedBySessions[sessionId];
                const sessionStart = new Date(sessionInteractions[sessionInteractions.length - 1].timestamp);
                const sessionEnd = new Date(sessionInteractions[0].timestamp);
                
                html += `
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="fas fa-clock"></i> Oturum: ${sessionId.substring(8, 20)}...</h6>
                            <span class="badge bg-secondary">${sessionInteractions.length} etkile≈üim</span>
                        </div>
                        <div class="small text-muted mb-2">
                            ${sessionStart.toLocaleString('tr-TR')} - ${sessionEnd.toLocaleString('tr-TR')}
                        </div>
                        <div class="interaction-list">
                `;
                
                sessionInteractions.slice(0, 10).forEach(interaction => {
                    const date = new Date(interaction.timestamp);
                    const timeStr = date.toLocaleTimeString('tr-TR');
                    const statusIcon = interaction.checked ? 
                        '<i class="fas fa-check-circle text-success"></i>' : 
                        '<i class="fas fa-times-circle text-danger"></i>';
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <div>
                                ${statusIcon} <strong>${interaction.criteriaId}</strong>
                                <span class="text-muted">‚Ä¢ Hasta: ${interaction.patientId} ‚Ä¢ Hafta: ${interaction.weekNumber}</span>
                            </div>
                            <span class="text-muted small">${timeStr}</span>
                        </div>
                    `;
                });
                
                if (sessionInteractions.length > 10) {
                    html += `<div class="text-muted small">... ve ${sessionInteractions.length - 10} daha</div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('üìä Etkile≈üim ge√ßmi≈üi yenilendi:', log.length, 'kayƒ±t');
        }
        
        // Eski localStorage verilerini JSON'a migrate et
        function migrateOldDataToJSON() {
            try {
                console.log('üîÑ Eski localStorage verilerini JSON\'a ta≈üƒ±ma i≈ülemi ba≈ülƒ±yor...');
                
                // Mevcut systemSettings_v2'yi al
                let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                
                // Eski etkile≈üim ge√ßmi≈üini ta≈üƒ±
                const oldInteractionLog = localStorage.getItem('criteriaInteractionLog');
                if (oldInteractionLog && !systemSettings.interactionLog) {
                    try {
                        systemSettings.interactionLog = JSON.parse(oldInteractionLog);
                        console.log('üìä Eski etkile≈üim ge√ßmi≈üi JSON\'a ta≈üƒ±ndƒ±:', systemSettings.interactionLog.length, 'kayƒ±t');
                    } catch (e) {
                        console.warn('Eski etkile≈üim ge√ßmi≈üi parse edilemedi:', e);
                        systemSettings.interactionLog = [];
                    }
                }
                
                // Timestamp ekle
                systemSettings.lastUpdated = new Date().toISOString();
                systemSettings.version = systemSettings.version || '2.1.0';
                
                // JSON'a kaydet
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                
                // Eski localStorage kayƒ±tlarƒ±nƒ± temizle
                localStorage.removeItem('criteriaInteractionLog');
                
                console.log('‚úÖ Migration tamamlandƒ± ve eski veriler temizlendi');
                
                return true;
            } catch (e) {
                console.error('Migration hatasƒ±:', e);
                return false;
            }
        }
        function clearInteractionHistory() {
            if (confirm('T√ºm etkile≈üim ge√ßmi≈üini silmek istediƒüinize emin misiniz?')) {
                // systemSettings_v2'den etkile≈üim ge√ßmi≈üini temizle
                let systemSettings = JSON.parse(localStorage.getItem('systemSettings_v2') || '{"systemDefaults": {}, "weeklyProfiles": {}}');
                systemSettings.interactionLog = [];
                localStorage.setItem('systemSettings_v2', JSON.stringify(systemSettings));
                
                refreshInteractionHistory();
                showToast('success', 'Etkile≈üim ge√ßmi≈üi temizlendi (JSON)');
                console.log('üóëÔ∏è Etkile≈üim ge√ßmi≈üi temizlendi');
            }
        }

        function clearAppliedSystemWeek() {
            if (!currentPatient || !currentWeek) return;
            delete currentWeek.appliedSystemProfile;
            const patientId = getCurrentPatientId();
            if (patientId) savePatientDetailedData(patientId, currentPatient);
            loadWeeklyPlanContent();
        }

        // Sistem: Hafta ≈üablonu d√ºzenleme bannerƒ±
        function showWeekProfileEditingBanner(weekNo) {
            const cont = document.getElementById('system-week-profile-editing');
            if (!cont) return;
            const all = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
            const prof = all?.systemDefaults?.weeklyProfiles?.[weekNo];
            if (!prof) return;
            cont.classList.remove('d-none');
            cont.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Hafta ${weekNo} d√ºzenleniyor:</strong> <span class="ms-1">${prof.name || ''}</span>
                        <div class="small text-muted">Bu banner a√ßƒ±kken sistem ekranƒ±ndaki alanlarƒ± g√ºncelleyip a≈üaƒüƒ±daki butonla bu ≈üablona yazabilirsiniz.</div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-success" onclick="commitWeekProfileEditing(${weekNo})"><i class='fas fa-save'></i> ≈ûablonu G√ºncelle</button>
                        <button class="btn btn-outline-secondary" onclick="hideWeekProfileEditingBanner()"><i class='fas fa-times'></i></button>
                    </div>
                </div>`;
        }

        function hideWeekProfileEditingBanner() {
            const cont = document.getElementById('system-week-profile-editing');
            if (cont) { cont.classList.add('d-none'); cont.innerHTML = ''; }
        }

        async function commitWeekProfileEditing(weekNo) {
            try {
                const all = JSON.parse(localStorage.getItem('systemSettings_v2') || '{}');
                if (!all.systemDefaults) all.systemDefaults = {};
                if (!all.systemDefaults.weeklyProfiles) all.systemDefaults.weeklyProfiles = {};
                const prof = all.systemDefaults.weeklyProfiles[weekNo];
                if (!prof) return alert('≈ûablon bulunamadƒ±');
                const defaults = collectSystemDefaultsFromUI();
                prof.settings = {
                    dietType: defaults.dietType,
                    defaultCalorieMethod: defaults.defaultCalorieMethod,
                    userSettings: defaults.userSettings,
                    mealPercentages: defaults.mealPercentages,
                    customFormula: defaults.customFormula,
                    mealSettings: defaults.mealSettings,
                    criteria: { hierarchy: defaults.criteriaHierarchy, enabled: defaults.criteriaSettings }
                };
                prof.updatedAt = new Date().toISOString();
                all.systemDefaults.weeklyProfiles[weekNo] = prof;
                localStorage.setItem('systemSettings_v2', JSON.stringify(all));
                
                // JSON dosyasƒ±na da kaydet
                try {
                    await updateJsonFile('/data/system_settings.json', (json) => {
                        json.systemDefaults = all.systemDefaults;
                        return json;
                    });
                    console.log('üóÇÔ∏è Hafta ≈üablonu d√ºzenlemesi JSON dosyasƒ±na kaydedildi');
                } catch (error) {
                    console.error('‚ùå Hafta ≈üablonu d√ºzenlemesi JSON kaydetme hatasƒ±:', error);
                }
                
                window.__weeklyProfilesCache = all.systemDefaults.weeklyProfiles;
                listSystemWeekProfiles();
                try { showToast('≈ûablon g√ºncellendi', 'success'); } catch(_){ alert('≈ûablon g√ºncellendi'); }
            } catch(e) {
                console.error('commitWeekProfileEditing error', e);
                alert('G√ºncelleme hatasƒ±: ' + e.message);
            }
        }

        // showPage fonksiyonu yukarƒ±da zaten tanƒ±mlƒ± - √ßift tanƒ±mlamayƒ± √∂nlemek i√ßin kaldƒ±rƒ±ldƒ±
    </script>

    <!-- Hasta Y√∂netimi Modal -->
    <div class="modal fade" id="patientManagementModal" tabindex="-1" aria-labelledby="patientManagementModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientManagementModalLabel">
                        <i class="fas fa-users-cog"></i> Hasta Y√∂netimi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Ad Soyad</th>
                                    <th>Ya≈ü</th>
                                    <th>Cinsiyet</th>
                                    <th>Telefon</th>
                                    <th>Diyet T√ºr√º</th>
                                    <th>Durum</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="patients-management-table">
                                <!-- Hasta listesi dinamik olarak y√ºklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-success" onclick="addNewPatient()">
                        <i class="fas fa-plus"></i> Yeni Hasta Ekle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hasta D√ºzenleme Modal -->
    <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPatientModalLabel">
                        <i class="fas fa-user-edit"></i> Hasta Bilgilerini D√ºzenle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPatientForm">
                        <input type="hidden" id="edit-patient-id">
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <h6 class="text-primary mb-3">üë§ Hasta Bilgileri</h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Ad *</label>
                                            <input type="text" class="form-control" id="edit-firstName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Soyad *</label>
                                            <input type="text" class="form-control" id="edit-lastName" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Ya≈ü *</label>
                                            <input type="number" class="form-control" id="edit-age" min="0" max="120" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Cinsiyet</label>
                                            <select class="form-control" id="edit-gender">
                                                <option value="kadƒ±n">Kadƒ±n</option>
                                                <option value="erkek">Erkek</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Telefon</label>
                                            <input type="tel" class="form-control" id="edit-phone">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Boy (cm) *</label>
                                            <input type="number" class="form-control" id="edit-height" min="100" max="250" required onchange="calculateEditMacros()">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Kilo (kg) *</label>
                                            <input type="number" class="form-control" id="edit-weight" min="30" max="300" step="0.1" required onchange="calculateEditMacros()">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Aktivite D√ºzeyi (1-5)</label>
                                            <select class="form-control" id="edit-activity" onchange="calculateEditMacros()">
                                                <option value="1">1 - √áok d√º≈ü√ºk (sedanter)</option>
                                                <option value="2">2 - D√º≈ü√ºk (hafif aktif)</option>
                                                <option value="3">3 - Orta aktif (haftada 3-5 g√ºn egzersiz)</option>
                                                <option value="4">4 - Y√ºksek (g√ºnl√ºk egzersiz)</option>
                                                <option value="5">5 - √áok y√ºksek (sporcu)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Ek Hastalƒ±klar</label>
                                    <textarea class="form-control" id="edit-diseases" rows="2" 
                                            placeholder="Diyabet, hipertansiyon vb."></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Alerjiler</label>
                                            <input type="text" class="form-control" id="edit-allergies" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n (√∂r: s√ºt, fƒ±ndƒ±k)">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Kullandƒ±ƒüƒ± ƒ∞la√ßlar</label>
                                            <input type="text" class="form-control" id="edit-medications" 
                                                   placeholder="ƒ∞la√ß adlarƒ± ve dozlarƒ±">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Sevilen Yemekler</label>
                                            <input type="text" class="form-control" id="edit-likedFoods" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Sevmediƒüi Yemekler</label>
                                            <input type="text" class="form-control" id="edit-dislikedFoods" 
                                                   placeholder="Virg√ºlle ayƒ±rarak yazƒ±n">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Notlar</label>
                                    <textarea class="form-control" id="edit-notes" rows="3" 
                                            placeholder="Ek bilgiler, √∂zel durumlar..."></textarea>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <h6 class="text-success mb-3">üéØ Diyet Hedefleri</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Diyet T√ºr√º *</label>
                                    <select class="form-control" id="edit-diet" onchange="calculateEditMacros()">
                                        <option value="">Se√ßiniz...</option>
                                        <option value="ketojenik">ü•ë Ketojenik</option>
                                        <option value="lowcarb">ü•© D√º≈ü√ºk Karbonhidrat</option>
                                        <option value="akdeniz">üêü Akdeniz Diyeti</option>
                                        <option value="sporcu">üí™ Sporcu Beslenmesi</option>
                                        <option value="gebelik">ü§± Gebelik Beslenmesi</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Kalori Hesaplama Y√∂ntemi</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="edit-calorieMethod" 
                                               id="edit-calorieMethodCustom" value="custom" checked onchange="calculateEditMacros()">
                                        <label class="form-check-label" for="edit-calorieMethodCustom">
                                            <strong>√ñzel Form√ºl</strong> (Makro x Katsayƒ± x Aktivite)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="edit-calorieMethod" 
                                               id="edit-calorieMethodHarris" value="harris" onchange="calculateEditMacros()">
                                        <label class="form-check-label" for="edit-calorieMethodHarris">
                                            Harris-Benedict BMR Form√ºl√º
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hedef Karbonhidrat (g)</label>
                                            <input type="number" class="form-control" id="edit-targetCarbs" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hedef Protein (g)</label>
                                            <input type="number" class="form-control" id="edit-targetProtein" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hedef Yaƒü (g)</label>
                                            <input type="number" class="form-control" id="edit-targetFat" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hedef Kalori</label>
                                            <input type="number" class="form-control" id="edit-targetCalories" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="edit-macro-breakdown" class="alert alert-info" style="display: none;">
                                    <small><i class="fas fa-info-circle"></i> <strong>Hesaplama Detaylarƒ±:</strong> <span id="edit-calculation-details"></span></small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Durum</label>
                                    <select class="form-control" id="edit-status">
                                        <option value="aktif" selected>Aktif</option>
                                        <option value="pasif">Pasif</option>
                                        <option value="beklemede">Beklemede</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deƒüi≈üiklik Ge√ßmi≈üi -->
                        <div class="mt-4">
                            <h6 class="text-info mb-3">üìã Deƒüi≈üiklik Ge√ßmi≈üi</h6>
                            <div id="edit-changes-history" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                <small class="text-muted">Hasta bilgilerindeki deƒüi≈üiklikler burada g√∂r√ºnecek...</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary" onclick="updatePatient()">
                        <i class="fas fa-save"></i> Deƒüi≈üiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Diyet Ekleme/D√ºzenleme Modalƒ± -->
    <div class="modal fade" id="dietModal" tabindex="-1" aria-labelledby="dietModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dietModalLabel">
                        <i class="fas fa-leaf"></i> <span id="dietModalTitle">Yeni Diyet Ekle</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dietForm">
                        <input type="hidden" id="newDietId" value="">
                        
                        <!-- Temel Bilgiler -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="newDietName" class="form-label">üè∑Ô∏è Diyet Adƒ± *</label>
                                <input type="text" class="form-control" id="newDietName" required>
                            </div>
                            <div class="col-md-3">
                                <label for="newDietCode" class="form-label">üîñ Kodu</label>
                                <input type="text" class="form-control" id="newDietCode" placeholder="otomatik">
                            </div>
                            <div class="col-md-3">
                                <label for="newDietIcon" class="form-label">üé® ƒ∞kon</label>
                                <input type="text" class="form-control" id="newDietIcon" placeholder="üçΩÔ∏è">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-9">
                                <label for="newDietDescription" class="form-label">üìù A√ßƒ±klama</label>
                                <input type="text" class="form-control" id="newDietDescription">
                            </div>
                            <div class="col-md-3">
                                <label for="newDietStatus" class="form-label">üìä Durum</label>
                                <select class="form-select" id="newDietStatus">
                                    <option value="active">Aktif</option>
                                    <option value="inactive">Pasif</option>
                                </select>
                            </div>
                        </div>

                        <!-- Makro Oranlarƒ± -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">ü•ó Makro Besin Oranlarƒ± (% olarak)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="newDietCarbs" class="form-label">üçû Karbonhidrat (%)</label>
                                        <input type="number" class="form-control" id="newDietCarbs" min="0" max="100" value="20" oninput="validateMacroTotal()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="newDietProtein" class="form-label">ü•© Protein (%)</label>
                                        <input type="number" class="form-control" id="newDietProtein" min="0" max="100" value="30" oninput="validateMacroTotal()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="newDietFat" class="form-label">ü•ë Yaƒü (%)</label>
                                        <input type="number" class="form-control" id="newDietFat" min="0" max="100" value="50" oninput="validateMacroTotal()">
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <div class="text-center w-100">
                                            <small class="text-muted">Toplam:</small><br>
                                            <span id="newMacroTotal" class="fw-bold text-success">100%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2">
                                    ‚ÑπÔ∏è Makro oranlarƒ± toplamƒ± <strong>%100</strong> olmalƒ±dƒ±r.
                                </div>
                            </div>
                        </div>

                        <!-- Kriterler -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üìä Beslenme Kriterleri</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="newCaloriesMin" class="form-label">üî• Min. Kalori</label>
                                        <input type="number" class="form-control" id="newCaloriesMin" min="800" max="5000" value="1200">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="newCaloriesMax" class="form-label">üî• Max. Kalori</label>
                                        <input type="number" class="form-control" id="newCaloriesMax" min="800" max="5000" value="1800">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="newWaterIntake" class="form-label">üíß Su (Litre)</label>
                                        <input type="number" class="form-control" id="newWaterIntake" step="0.1" min="1" max="5" value="2.5">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="newMealGap" class="form-label">‚è∞ √ñƒü√ºn Arasƒ± (Saat)</label>
                                        <input type="number" class="form-control" id="newMealGap" min="2" max="8" value="3">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="newWeightLoss" class="form-label">‚öñÔ∏è Hedef Kilo Kaybƒ± (kg/hafta)</label>
                                        <input type="number" class="form-control" id="newWeightLoss" step="0.1" min="0" max="2" value="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kƒ±sƒ±tlamalar -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üö´ Diyet Kƒ±sƒ±tlamalarƒ±</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">üç≠ Besin Grup Kƒ±sƒ±tlamalarƒ±</label>
                                        <div class="form-check-list">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newRestrict_sugar">
                                                <label class="form-check-label" for="newRestrict_sugar">üç≠ ≈ûeker ve Tatlƒ±lar</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newRestrict_bread">
                                                <label class="form-check-label" for="newRestrict_bread">üçû Ekmek ve Tahƒ±llar</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newRestrict_dairy">
                                                <label class="form-check-label" for="newRestrict_dairy">ü•õ S√ºt √úr√ºnleri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newRestrict_meat">
                                                <label class="form-check-label" for="newRestrict_meat">ü•© Et √úr√ºnleri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newRestrict_fruit">
                                                <label class="form-check-label" for="newRestrict_fruit">üçé Meyveler</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">üìù √ñzel Notlar</label>
                                        <textarea class="form-control" id="newDietNotes" rows="6" placeholder="Diyet hakkƒ±nda √∂zel notlar ve uyarƒ±lar..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveDiet()">
                        <i class="fas fa-save"></i> <span id="dietSaveButton">Kaydet</span>
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Diyet D√ºzenleme Modal -->
    <div class="modal fade" id="dietEditModal" tabindex="-1" aria-labelledby="dietEditModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dietEditModalLabel">‚úèÔ∏è Diyet D√ºzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dietEditForm">
                        <input type="hidden" id="dietId">
                        
                        <!-- Temel Bilgiler -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="dietName" class="form-label">üè∑Ô∏è Diyet Adƒ± *</label>
                                <input type="text" class="form-control" id="dietName" required>
                            </div>
                            <div class="col-md-3">
                                <label for="dietCode" class="form-label">üîñ Kodu</label>
                                <input type="text" class="form-control" id="dietCode" placeholder="otomatik">
                            </div>
                            <div class="col-md-3">
                                <label for="dietIcon" class="form-label">üé® ƒ∞kon</label>
                                <input type="text" class="form-control" id="dietIcon" placeholder="üçΩÔ∏è">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-9">
                                <label for="dietDescription" class="form-label">üìù A√ßƒ±klama</label>
                                <input type="text" class="form-control" id="dietDescription">
                            </div>
                            <div class="col-md-3">
                                <label for="dietStatus" class="form-label">üìä Durum</label>
                                <select class="form-select" id="dietStatus">
                                    <option value="active">Aktif</option>
                                    <option value="inactive">Pasif</option>
                                </select>
                            </div>
                        </div>

                        <!-- Makro Oranlarƒ± -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">ü•ó Makro Besin Oranlarƒ± (% olarak)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="macroCarbs" class="form-label">üçû Karbonhidrat (%)</label>
                                        <input type="number" class="form-control" id="macroCarbs" min="0" max="100" oninput="updateMacroTotal()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="macroProtein" class="form-label">ü•© Protein (%)</label>
                                        <input type="number" class="form-control" id="macroProtein" min="0" max="100" oninput="updateMacroTotal()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="macroFat" class="form-label">ü•ë Yaƒü (%)</label>
                                        <input type="number" class="form-control" id="macroFat" min="0" max="100" oninput="updateMacroTotal()">
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <div class="text-center w-100">
                                            <small class="text-muted">Toplam:</small><br>
                                            <span id="editMacroTotal" class="fw-bold text-danger">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2">
                                    ‚ÑπÔ∏è Makro oranlarƒ± toplamƒ± <strong>%100</strong> olmalƒ±dƒ±r.
                                </div>
                            </div>
                        </div>

                        <!-- Kriterler -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üìä Beslenme Kriterleri</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="caloriesMin" class="form-label">üî• Min. Kalori</label>
                                        <input type="number" class="form-control" id="caloriesMin" min="800" max="5000">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="caloriesMax" class="form-label">üî• Max. Kalori</label>
                                        <input type="number" class="form-control" id="caloriesMax" min="800" max="5000">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="waterIntake" class="form-label">üíß Su (Litre)</label>
                                        <input type="number" class="form-control" id="waterIntake" step="0.1" min="1" max="5">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="mealGap" class="form-label">‚è∞ √ñƒü√ºn Arasƒ± (Saat)</label>
                                        <input type="number" class="form-control" id="mealGap" min="2" max="8">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="weightLoss" class="form-label">üìâ Kilo Kaybƒ± (kg/hafta)</label>
                                        <input type="number" class="form-control" id="weightLoss" step="0.1" min="0" max="2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kƒ±sƒ±tlamalar -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üö´ Diyet Kƒ±sƒ±tlamalarƒ±</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">üç≠ Besin Grup Kƒ±sƒ±tlamalarƒ±</label>
                                        <div class="form-check-list">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="restrict_sugar">
                                                <label class="form-check-label" for="restrict_sugar">ÔøΩ ≈ûeker ve Tatlƒ±lar</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="restrict_bread">
                                                <label class="form-check-label" for="restrict_bread">üçû Ekmek ve Tahƒ±llar</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="restrict_dairy">
                                                <label class="form-check-label" for="restrict_dairy">ü•õ S√ºt √úr√ºnleri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="restrict_meat">
                                                <label class="form-check-label" for="restrict_meat">ü•© Et √úr√ºnleri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="restrict_fruit">
                                                <label class="form-check-label" for="restrict_fruit">ÔøΩ Meyveler</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">üìù √ñzel Notlar</label>
                                        <textarea class="form-control" id="dietNotes" rows="6" placeholder="Diyet hakkƒ±nda √∂zel notlar ve uyarƒ±lar..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary" id="saveDietBtn" onclick="saveDietEdit()">
                        üíæ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Diyet istatistiklerini g√ºncelle
        function updateDietStats() {
            const totalCount = dietsData.length;
            const activeCount = dietsData.filter(d => d.status === 'active').length;
            const inactiveCount = totalCount - activeCount;
            
            document.getElementById('totalDietsCount').textContent = totalCount;
            document.getElementById('activeDietsCount').textContent = activeCount;
            document.getElementById('inactiveDietsCount').textContent = inactiveCount;
            
            console.log('Diyet istatistikleri g√ºncellendi:', { total: totalCount, active: activeCount, inactive: inactiveCount });
        }
        
        // Temel diyet fonksiyonlarƒ± - basit versiyon
        function addNewDiet() {
            // Form temizle
            clearDietForm();
            
            // Modal'ƒ± a√ß
            const modal = new bootstrap.Modal(document.getElementById('dietModal'));
            modal.show();
            
            logToConsole('‚ûï Yeni diyet ekleme modal\'ƒ± a√ßƒ±ldƒ±');
        }
        
        function editDiet(dietId) {
            // Diyet verisini bul
            const diet = dietsData.find(d => d.id === dietId);
            if (!diet) {
                alert('‚ùå Diyet bulunamadƒ±!');
                return;
            }
            
            // Modal formu temizle
            clearDietEditForm();
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
            const modalTitle = document.getElementById('dietEditModalLabel');
            if (modalTitle) {
                modalTitle.textContent = `‚úèÔ∏è Diyet D√ºzenle: ${diet.name}`;
            }
            
            // Temel bilgileri doldur
            document.getElementById('dietId').value = diet.id;
            document.getElementById('dietName').value = diet.name;
            document.getElementById('dietCode').value = diet.code || '';
            document.getElementById('dietIcon').value = diet.icon || 'üçΩÔ∏è';
            document.getElementById('dietDescription').value = diet.description || '';
            document.getElementById('dietStatus').value = diet.status || 'active';
            
            // Makro deƒüerlerini doldur
            if (diet.macros) {
                document.getElementById('macroCarbs').value = diet.macros.carbs || 0;
                document.getElementById('macroProtein').value = diet.macros.protein || 0;
                document.getElementById('macroFat').value = diet.macros.fat || 0;
            }
            
            // Kriterleri doldur
            if (diet.criteria) {
                document.getElementById('caloriesMin').value = diet.criteria.caloriesMin || 1200;
                document.getElementById('caloriesMax').value = diet.criteria.caloriesMax || 1800;
                document.getElementById('waterIntake').value = diet.criteria.water || 2.5;
                document.getElementById('mealGap').value = diet.criteria.mealGap || 3;
                document.getElementById('weightLoss').value = diet.criteria.weightLoss || 0.5;
            }
            
            // Kƒ±sƒ±tlamalarƒ± doldur
            if (diet.restrictions) {
                ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                    const checkbox = document.getElementById('restrict_' + restriction);
                    if (checkbox) {
                        checkbox.checked = diet.restrictions.includes(restriction);
                    }
                });
            }
            
            // Notlarƒ± doldur
            document.getElementById('dietNotes').value = diet.notes || '';
            
            // Makro toplamƒ±nƒ± g√ºncelle
            updateMacroTotal();
            
            // Modal'ƒ± a√ß
            const modal = new bootstrap.Modal(document.getElementById('dietEditModal'));
            modal.show();
            
            logToConsole(`üìù Diyet d√ºzenleme a√ßƒ±ldƒ±: ${diet.name}`);
        }
        
        function clearDietEditForm() {
            // Temel alanlarƒ± temizle
            document.getElementById('dietId').value = '';
            document.getElementById('dietName').value = '';
            document.getElementById('dietCode').value = '';
            document.getElementById('dietIcon').value = 'üçΩÔ∏è';
            document.getElementById('dietDescription').value = '';
            document.getElementById('dietStatus').value = 'active';
            
            // Makro deƒüerlerini temizle
            document.getElementById('macroCarbs').value = 0;
            document.getElementById('macroProtein').value = 0;
            document.getElementById('macroFat').value = 0;
            
            // Kriterleri temizle
            document.getElementById('caloriesMin').value = 1200;
            document.getElementById('caloriesMax').value = 1800;
            document.getElementById('waterIntake').value = 2.5;
            document.getElementById('mealGap').value = 3;
            document.getElementById('weightLoss').value = 0.5;
            
            // Kƒ±sƒ±tlamalarƒ± temizle
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('restrict_' + restriction);
                if (checkbox) checkbox.checked = false;
            });
            
            // Notlarƒ± temizle
            document.getElementById('dietNotes').value = '';
            
            // Makro toplamƒ±nƒ± g√ºncelle
            updateMacroTotal();
        }
        
        function clearDietEditForm() {
            // Temel alanlarƒ± temizle
            document.getElementById('dietId').value = '';
            document.getElementById('dietName').value = '';
            document.getElementById('dietCode').value = '';
            document.getElementById('dietIcon').value = 'üçΩÔ∏è';
            document.getElementById('dietDescription').value = '';
            document.getElementById('dietStatus').value = 'active';
            
            // Makro deƒüerlerini temizle
            document.getElementById('macroCarbs').value = 0;
            document.getElementById('macroProtein').value = 0;
            document.getElementById('macroFat').value = 0;
            
            // Kriterleri temizle
            document.getElementById('caloriesMin').value = 1200;
            document.getElementById('caloriesMax').value = 1800;
            document.getElementById('waterIntake').value = 2.5;
            document.getElementById('mealGap').value = 3;
            document.getElementById('weightLoss').value = 0.5;
            
            // Kƒ±sƒ±tlamalarƒ± temizle
            ['sugar', 'bread', 'dairy', 'meat', 'fruit'].forEach(restriction => {
                const checkbox = document.getElementById('restrict_' + restriction);
                if (checkbox) checkbox.checked = false;
            });
            
            // Notlarƒ± temizle
            document.getElementById('dietNotes').value = '';
            
            // Makro toplamƒ±nƒ± g√ºncelle
            updateMacroTotal();
        }
        
        function duplicateDiet(dietId) {
            const originalDiet = dietsData.find(d => d.id === dietId);
            if (!originalDiet) {
                alert('‚ùå Kopyalanacak diyet bulunamadƒ±!');
                return;
            }
            
            // Yeni ID ve isim olu≈ütur
            const newId = originalDiet.id + '_copy_' + Date.now();
            const newName = originalDiet.name + ' (Kopya)';
            
            const duplicatedDiet = {
                ...originalDiet,
                id: newId,
                name: newName,
                code: originalDiet.code + '_copy',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            dietsData.push(duplicatedDiet);
            saveDietsData();
            displayDiets();
            
            logToConsole(`üìã Diyet kopyalandƒ±: ${originalDiet.name} ‚Üí ${newName}`);
            alert(`‚úÖ "${originalDiet.name}" diyeti ba≈üarƒ±yla kopyalandƒ±!`);
        }
        
        function deleteDiet(dietId) {
            if (confirm(`‚ùì "${dietId}" kodlu diyeti silmek istediƒüinizden emin misiniz?`)) {
                const index = dietsData.findIndex(d => d.id === dietId);
                if (index >= 0) {
                    const deletedDiet = dietsData.splice(index, 1)[0];
                    saveDietsData();
                    displayDiets();
                    logToConsole(`ÔøΩÔ∏è Diyet silindi: ${deletedDiet.name}`);
                    alert(`‚úÖ "${deletedDiet.name}" diyeti ba≈üarƒ±yla silindi!`);
                } else {
                    alert('‚ùå Diyet bulunamadƒ±!');
                }
            }
        }
        
        function updateMacroTotal() {
            // Makro toplam hesaplama (d√ºzenleme modal'ƒ± i√ßin)
            const carbs = parseInt(document.getElementById('macroCarbs')?.value) || 0;
            const protein = parseInt(document.getElementById('macroProtein')?.value) || 0;
            const fat = parseInt(document.getElementById('macroFat')?.value) || 0;
            
            const total = carbs + protein + fat;
            const remaining = 100 - total;
            const totalElement = document.getElementById('editMacroTotal');
            
            if (totalElement) {
                if (total === 100) {
                    totalElement.textContent = `${total}%`;
                    totalElement.className = 'fw-bold text-success';
                } else {
                    const sign = remaining >= 0 ? '+' : '';
                    totalElement.textContent = `${total}% (${sign}${remaining})`;
                    totalElement.className = 'fw-bold text-danger';
                }
            }
        }
        
        function exportDietsData() {
            alert('JSON dƒ±≈üa aktarma √∂zelliƒüi geli≈ütirme a≈üamasƒ±nda.');
        }
        
        console.log('Diyet y√∂netim fonksiyonlarƒ± y√ºklendi');
        
        // ====== YEMEK VERƒ∞TABANI Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI ======
        
        // Global deƒüi≈ükenler
        let foodsData = [];
        let filteredFoodsData = [];
        // Yemek tablosu sƒ±ralama durumu
        let foodSortState = { key: null, direction: 'asc' }; // key: name|calories|protein|carbs|fat|category

        // Sƒ±ralama i≈ülemini uygula (filteredFoodsData √ºzerinde)
        function applyFoodSort() {
            const { key, direction } = foodSortState || {};
            if (!key) return; // Sƒ±ralama se√ßilmemi≈üse dokunma
            const dir = direction === 'desc' ? -1 : 1;
            const numericKeys = new Set(['calories', 'protein', 'carbs', 'fat']);

            filteredFoodsData.sort((a, b) => {
                let av = a?.[key];
                let bv = b?.[key];
                // Rol i√ßin g√∂r√ºnen etiket √ºzerinden TR sƒ±ralama yap
                if (key === 'role') {
                    const ar = getFoodRoleLabel(normalizeRole(a?.role));
                    const br = getFoodRoleLabel(normalizeRole(b?.role));
                    const cmpRole = ar.localeCompare(br, 'tr', { sensitivity: 'base' });
                    return cmpRole * dir;
                }
                if (numericKeys.has(key)) {
                    av = parseFloat(av) || 0;
                    bv = parseFloat(bv) || 0;
                    if (av === bv) return 0;
                    return av < bv ? -1 * dir : 1 * dir;
                } else {
                    // Metin kar≈üƒ±la≈ütƒ±rma (TR duyarlƒ±, b√ºy√ºk-k√º√ß√ºk √∂nemsiz)
                    const as = (av ?? '').toString();
                    const bs = (bv ?? '').toString();
                    const cmp = as.localeCompare(bs, 'tr', { sensitivity: 'base' });
                    return cmp * dir;
                }
            });
        }

        // Ba≈ülƒ±ktan sƒ±ralama isteƒüi
        function sortFoodsBy(key) {
            if (foodSortState.key === key) {
                foodSortState.direction = foodSortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                foodSortState.key = key;
                foodSortState.direction = 'asc';
            }
            applyFoodSort();
            updateFoodSortUI();
            displayFoods();
        }

        // Sƒ±ralama ikonlarƒ± ve aria-sort g√ºncellemesi
        function updateFoodSortUI() {
            const keys = ['name', 'calories', 'protein', 'carbs', 'fat', 'category', 'role'];
            for (const k of keys) {
                const icon = document.getElementById('sortIcon-' + k);
                if (!icon) continue;
                const th = icon.closest('th');
                if (th) th.setAttribute('aria-sort', 'none');
                icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                icon.classList.add('fa-sort');
            }
            if (foodSortState.key) {
                const activeIcon = document.getElementById('sortIcon-' + foodSortState.key);
                const th = activeIcon?.closest('th');
                if (th) th.setAttribute('aria-sort', foodSortState.direction === 'asc' ? 'ascending' : 'descending');
                if (activeIcon) {
                    activeIcon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                    activeIcon.classList.add(foodSortState.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                }
            }
        }
        
        // Yemek veritabanƒ± sayfasƒ±nƒ± y√ºkle
        function loadFoodDatabasePage() {
            logToConsole('üçΩÔ∏è Yemek veritabanƒ± sayfasƒ± y√ºkleniyor...');
            loadFoodsData();
            setTimeout(() => {
                displayFoods();
                updateFoodStats();
            }, 200);
            logToConsole('‚úÖ Yemek veritabanƒ± sayfasƒ± y√ºklendi');
        }
        
        // Yemek verilerini y√ºkle
        async function loadFoodsData() {
            try {
                // ƒ∞lk √∂nce localStorage'dan kontrol et
                const stored = localStorage.getItem('foodsData');
                if (stored) {
                    const parsedData = JSON.parse(stored);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        foodsData = parsedData;
                        window.foodsData = parsedData; // Autocomplete i√ßin global eri≈üim
                        filteredFoodsData = [...parsedData];
                        logToConsole('ÔøΩ localStorage\'dan ' + foodsData.length + ' yemek y√ºklendi');
                        return;
                    }
                }
                
                // localStorage'da yoksa embedded data kullan
                const embeddedFoods = EMBEDDED_DATA.foods;
                if (Array.isArray(embeddedFoods)) {
                    foodsData = embeddedFoods;
                    window.foodsData = embeddedFoods; // Autocomplete i√ßin global eri≈üim
                    filteredFoodsData = [...embeddedFoods];
                    applyFoodSort();
                    logToConsole('ÔøΩ ' + foodsData.length + ' yemek embedded data\'dan y√ºklendi');
                    // localStorage'a kaydet
                    localStorage.setItem('foodsData', JSON.stringify(foodsData));
                } else {
                    logToConsole('‚ö†Ô∏è Embedded yemek verisi bulunamadƒ±');
                    foodsData = [];
                    window.foodsData = []; // Autocomplete i√ßin global eri≈üim
                    filteredFoodsData = [];
                }
            } catch (error) {
                logToConsole('‚ùå Yemek verileri y√ºklenirken hata: ' + error.message);
                foodsData = [];
                window.foodsData = []; // Autocomplete i√ßin global eri≈üim
                filteredFoodsData = [];
            }
        }
        
        // Dosyadan yemek verisi y√ºkle
        function loadFoodsFromFile(event) { 
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        foodsData = data;
                        window.foodsData = data; // Autocomplete i√ßin global eri≈üim
                        filteredFoodsData = [...data];
                        applyFoodSort();
                        localStorage.setItem('foodsData', JSON.stringify(foodsData));
                        displayFoods();
                        updateFoodStats();
                        logToConsole('üì• Dosyadan ' + foodsData.length + ' yemek y√ºklendi');
                    } else {
                        alert('Ge√ßersiz dosya formatƒ±!');
                    }
                } catch (err) {
                    alert('Dosya okunamadƒ±: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Yemekleri tablo formatƒ±nda g√∂r√ºnt√ºle
        function displayFoods() {
            const container = document.getElementById('foods-table-body');
            if (!container) {
                console.log('foods-table-body bulunamadƒ±!');
                return;
            }
            
            let html = '';
            
            if (filteredFoodsData.length === 0) {
                html = '<tr><td colspan="9" class="text-center"><div class="alert alert-info">';
                html += '<h5>Hen√ºz yemek tanƒ±mlanmamƒ±≈ü veya filtre sonucu bulunamadƒ±</h5>';
                html += '<p>Yeni yemek eklemek i√ßin "Yeni Yemek Ekle" butonunu kullanƒ±n</p>';
                html += '</div></td></tr>';
            } else {
                filteredFoodsData.forEach((food, index) => {
                    // √ñzellikler badges
                    let features = '';
                    if (food.keto) features += '<span class="badge bg-success me-1">Keto</span>';
                    if (food.lowcarb) features += '<span class="badge bg-warning me-1">LowCarb</span>';
                    if (food.fillerLunch) features += '<span class="badge bg-info me-1">√ñƒüle</span>';
                    if (food.fillerDinner) features += '<span class="badge bg-primary me-1">Ak≈üam</span>';
                    const roleLabel = getFoodRoleLabel(normalizeRole(food.role));
                    
                    html += '<tr>';
                    html += '<td><strong>' + food.name + '</strong></td>';
                    html += '<td><strong>' + food.calories + '</strong></td>';
                    html += '<td>' + food.protein + 'g</td>';
                    html += '<td>' + food.carbs + 'g</td>';
                    html += '<td>' + food.fat + 'g</td>';
                    html += '<td><span class="badge bg-secondary">' + (food.category || 'GENEL') + '</span></td>';
                    html += '<td><span class="badge bg-dark">' + roleLabel + '</span></td>';
                    html += '<td>' + features + '</td>';
                    html += '<td>';
                    html += '<div class="btn-group btn-group-sm" role="group">';
                    html += '<button class="btn btn-outline-primary" onclick="editFood(' + index + ')" title="D√ºzenle">';
                    html += '<i class="fas fa-edit"></i>';
                    html += '</button>';
                    html += '<button class="btn btn-outline-success" onclick="copyFood(' + index + ')" title="Kopyala">';
                    html += '<i class="fas fa-copy"></i>';
                    html += '</button>';
                    html += '<button class="btn btn-outline-danger" onclick="deleteFood(' + index + ')" title="Sil">';
                    html += '<i class="fas fa-trash"></i>';
                    html += '</button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                });
            }
            
            container.innerHTML = html;
            // Sƒ±ralama ikonlarƒ±nƒ± g√ºncelle
            updateFoodSortUI();
            logToConsole('Yemekler g√∂r√ºnt√ºlendi: ' + filteredFoodsData.length + ' adet');
        }
        
        // Yemek rol√º ikonlarƒ±
        function getFoodRoleIcon(role) {
            const icons = {
                'mainDish': 'üçΩÔ∏è',
                'side': 'ü•ó',
                'drink': 'ü•§',
                'soup': 'ÔøΩ',
                'dessert': 'üç∞',
                'fruit': 'ÔøΩ',
                'bread': 'üçû',
                'snack': 'üçø',
                'supplement': 'üíä',
                'vegetable': 'ü•¨',
                'fat': 'ü´í'
            };
            return icons[role] || 'üç¥';
        }

        // Rol normalizasyonu (√ße≈üitli yazƒ±mlarƒ± tek tipe √ßevir)
        function normalizeRole(role) {
            const r = (role ?? 'mainDish').toString().toLowerCase();
            switch (r) {
                case 'maindish':
                case 'main':
                case 'ana':
                case 'anayemek':
                    return 'mainDish';
                case 'sidedish':
                case 'side':
                case 'yan':
                case 'yanyemek':
                    return 'side';
                case 'supplement':
                case 'ek':
                    return 'supplement';
                case 'drink':
                case 'i√ßecek':
                case 'icecek':
                    return 'drink';
                case 'soup':
                case '√ßorba':
                case 'corba':
                    return 'soup';
                case 'dessert':
                case 'tatlƒ±':
                case 'tatli':
                    return 'dessert';
                case 'fruit':
                case 'meyve':
                    return 'fruit';
                case 'bread':
                case 'ekmek':
                    return 'bread';
                case 'snack':
                case 'atƒ±≈ütƒ±rmalƒ±k':
                case 'atistirmalik':
                    return 'snack';
                case 'vegetable':
                case 'sebze':
                    return 'vegetable';
                case 'fat':
                case 'yaƒü':
                case 'yag':
                    return 'fat';
                default:
                    return 'mainDish';
            }
        }

        // Rol etiketlerini TR kar≈üƒ±lƒ±ƒüƒ±na √ßevir
        function getFoodRoleLabel(role) {
            const map = {
                mainDish: 'Ana Yemek',
                side: 'Yan Yemek',
                drink: 'ƒ∞√ßecek',
                soup: '√áorba',
                dessert: 'Tatlƒ±',
                fruit: 'Meyve',
                bread: 'Ekmek',
                snack: 'Atƒ±≈ütƒ±rmalƒ±k',
                supplement: 'Ek',
                vegetable: 'Sebze',
                fat: 'Yaƒü'
            };
            return map[role] || 'Ana Yemek';
        }
        
        // Yemek istatistiklerini g√ºncelle
        function updateFoodStats() {
            const totalCount = foodsData.length;
            const ketoCount = foodsData.filter(f => f.keto).length;
            const lowCarbCount = foodsData.filter(f => f.lowcarb).length;
            const mainDishCount = foodsData.filter(f => normalizeRole(f.role) === 'mainDish').length;
            const drinkCount = foodsData.filter(f => normalizeRole(f.role) === 'drink').length;
            
            document.getElementById('totalFoodsCount').textContent = totalCount;
            document.getElementById('ketoFoodsCount').textContent = ketoCount;
            document.getElementById('lowCarbFoodsCount').textContent = lowCarbCount;
            document.getElementById('mainDishesCount').textContent = mainDishCount;
            document.getElementById('drinksCount').textContent = drinkCount;
            
            console.log('Yemek istatistikleri g√ºncellendi:', { 
                total: totalCount, 
                keto: ketoCount, 
                lowCarb: lowCarbCount, 
                mainDish: mainDishCount, 
                drinks: drinkCount 
            });
        }
        
        // Yemek filtreleme
        function filterFoods() {
            const searchTerm = document.getElementById('foodSearch').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const dietFilter = document.getElementById('dietFilter').value;
            
            filteredFoodsData = foodsData.filter(food => {
                let matchesSearch = true;
                
                // Arama terimi varsa √ßoklu kelime aramasƒ± yap
                if (searchTerm.trim()) {
                    // Bo≈ü kelimeleri filtrele ve k√º√ß√ºk harfe √ßevir
                    const queryWords = searchTerm.toLowerCase().split(/\s+/).filter(word => word.length >= 1);
                    
                    if (queryWords.length > 0) {
                        const foodName = food.name.toLowerCase();
                        
                        // Her query kelimesini kontrol et
                        matchesSearch = queryWords.every(queryWord => {
                            return foodName.includes(queryWord) || 
                                   (food.tags && food.tags.some(tag => tag.toLowerCase().includes(queryWord)));
                        });
                    }
                }
                
                const matchesCategory = !categoryFilter || food.category === categoryFilter;
                const matchesRole = !roleFilter || normalizeRole(food.role) === roleFilter;
                const matchesDiet = !dietFilter || 
                                 (dietFilter === 'keto' && food.keto) ||
                                 (dietFilter === 'lowcarb' && food.lowcarb);
                
                return matchesSearch && matchesCategory && matchesRole && matchesDiet;
            });
            
            applyFoodSort();
            displayFoods();
            logToConsole('Filtre uygulandƒ±: ' + filteredFoodsData.length + '/' + foodsData.length + ' yemek');
        }
        
        // Filtreleri temizle
        function clearFilters() {
            document.getElementById('foodSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('dietFilter').value = '';
            
            filteredFoodsData = [...foodsData];
            applyFoodSort();
            displayFoods();
            logToConsole('Filtreler temizlendi');
        }
        
        // Yeni yemek ekleme modal g√∂ster
        function showAddFoodModal() {
            clearFoodForm();
            document.getElementById('foodEditModalLabel').textContent = '‚ûï Yeni Yemek Ekle';
            document.getElementById('saveFoodBtn').textContent = 'üíæ Kaydet';
            document.getElementById('originalFoodName').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('foodEditModal'));
            // Aria-hidden'ƒ± manuel olarak kaldƒ±r
            const modalElement = document.getElementById('foodEditModal');
            modalElement.removeAttribute('aria-hidden');
            modal.show();
        }
        
        // Yemek d√ºzenleme modal g√∂ster
        function editFood(index) {
            const food = filteredFoodsData[index];
            if (!food) {
                alert('Yemek bulunamadƒ±!');
                return;
            }
            
            // Formu doldur
            clearFoodForm();
            document.getElementById('foodName').value = food.name;
            document.getElementById('foodCalories').value = food.calories;
            document.getElementById('foodProtein').value = food.protein;
            document.getElementById('foodCarbs').value = food.carbs;
            document.getElementById('foodFat').value = food.fat;
            document.getElementById('foodCategory').value = food.category || 'GENEL';
            document.getElementById('foodRole').value = normalizeRole(food.role);
            document.getElementById('foodMaxQuantity').value = food.maxQuantity || 100;
            document.getElementById('foodMinQuantity').value = food.minQuantity || 50;
            document.getElementById('foodStep').value = food.step || 10;
            document.getElementById('foodKeto').checked = food.keto || false;
            document.getElementById('foodLowCarb').checked = food.lowcarb || false;
            document.getElementById('foodFillerLunch').checked = food.fillerLunch || false;
            document.getElementById('foodFillerDinner').checked = food.fillerDinner || false;
            
            // Modal ayarlarƒ±
            document.getElementById('foodEditModalLabel').textContent = '‚úèÔ∏è Yemek D√ºzenle';
            document.getElementById('saveFoodBtn').textContent = 'üíæ G√ºncelle';
            document.getElementById('originalFoodName').value = food.name;
            
            const modal = new bootstrap.Modal(document.getElementById('foodEditModal'));
            // Aria-hidden'ƒ± manuel olarak kaldƒ±r
            const modalElement = document.getElementById('foodEditModal');
            modalElement.removeAttribute('aria-hidden');
            modal.show();
        }
        
        // Yemek kopyalama
        function copyFood(index) {
            const food = filteredFoodsData[index];
            if (!food) {
                alert('Yemek bulunamadƒ±!');
                return;
            }
            
            // Formu kopyalanacak yemek ile doldur
            clearFoodForm();
            document.getElementById('foodName').value = food.name + ' (kopya)';
            document.getElementById('foodCalories').value = food.calories;
            document.getElementById('foodProtein').value = food.protein;
            document.getElementById('foodCarbs').value = food.carbs;
            document.getElementById('foodFat').value = food.fat;
            document.getElementById('foodCategory').value = food.category || 'GENEL';
            document.getElementById('foodRole').value = food.role || 'mainDish';
            document.getElementById('foodMaxQuantity').value = food.maxQuantity || 100;
            document.getElementById('foodMinQuantity').value = food.minQuantity || 50;
            document.getElementById('foodStep').value = food.step || 10;
            document.getElementById('foodKeto').checked = food.keto || false;
            document.getElementById('foodLowCarb').checked = food.lowcarb || false;
            document.getElementById('foodFillerLunch').checked = food.fillerLunch || false;
            document.getElementById('foodFillerDinner').checked = food.fillerDinner || false;
            
            // Modal ayarlarƒ±
            document.getElementById('foodEditModalLabel').textContent = 'üìã Yemek Kopyala';
            document.getElementById('saveFoodBtn').textContent = 'üíæ Kaydet';
            document.getElementById('originalFoodName').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('foodEditModal'));
            // Aria-hidden'ƒ± manuel olarak kaldƒ±r
            const modalElement = document.getElementById('foodEditModal');
            modalElement.removeAttribute('aria-hidden');
            modal.show();
        }
        
        // Yemek silme
        function deleteFood(index) {
            const food = filteredFoodsData[index];
            if (!food) {
                alert('Yemek bulunamadƒ±!');
                return;
            }
            
            if (confirm('üóëÔ∏è "' + food.name + '" yemeƒüini silmek istediƒüinize emin misiniz?\\n\\nBu i≈ülem geri alƒ±namaz!')) {
                // Ana listeden kaldƒ±r
                const mainIndex = foodsData.findIndex(f => f.name === food.name);
                if (mainIndex > -1) {
                    foodsData.splice(mainIndex, 1);
                    localStorage.setItem('foodsData', JSON.stringify(foodsData));
                }
                
                // Filtrelenmi≈üten kaldƒ±r
                filteredFoodsData.splice(index, 1);
                
                // Listeyi g√ºncelle
                applyFoodSort();
                displayFoods();
                updateFoodStats();
                
                logToConsole('Yemek silindi: ' + food.name);
                alert('‚úÖ Yemek ba≈üarƒ±yla silindi!');
            }
        }
        
        // Yemek d√ºzenleme modal g√∂ster (eski versiyon - geriye uyumluluk i√ßin)
        function editFoodOld(foodName) {
            const food = foodsData.find(f => f.name === foodName);
            if (!food) {
                alert('Yemek bulunamadƒ±: ' + foodName);
                return;
            }
            
            // Form alanlarƒ±nƒ± doldur
            document.getElementById('originalFoodName').value = food.name;
            document.getElementById('foodName').value = food.name;
            document.getElementById('foodCategory').value = food.category || '';
            document.getElementById('foodCalories').value = food.calories || 0;
            document.getElementById('foodProtein').value = food.protein || 0;
            document.getElementById('foodCarbs').value = food.carbs || 0;
            document.getElementById('foodFat').value = food.fat || 0;
            document.getElementById('foodMinQuantity').value = food.minQuantity || 0;
            document.getElementById('foodMaxQuantity').value = food.maxQuantity || 0;
            document.getElementById('foodStep').value = food.step || 0.5;
            document.getElementById('foodMultiplier').value = food.multiplier || 1;
            document.getElementById('foodPortionFixed').checked = food.portionFixed || false;
            document.getElementById('foodRole').value = food.role || '';
            document.getElementById('foodKeto').checked = food.keto || false;
            document.getElementById('foodLowCarb').checked = food.lowcarb || false;
            document.getElementById('foodFillerLunch').checked = food.fillerLunch || false;
            document.getElementById('foodFillerDinner').checked = food.fillerDinner || false;
            document.getElementById('foodSeasonRange').value = food.seasonRange || '[1,12]';
            document.getElementById('foodReversedSeason').checked = food.isReversedSeason || false;
            
            // Etiketleri doldur
            if (food.tags && Array.isArray(food.tags)) {
                document.getElementById('foodTags').value = food.tags.join(', ');
            } else {
                document.getElementById('foodTags').value = '';
            }
            
            if (food.compatibilityTags && Array.isArray(food.compatibilityTags)) {
                document.getElementById('foodCompatibilityTags').value = food.compatibilityTags.join(', ');
            } else {
                document.getElementById('foodCompatibilityTags').value = '';
            }
            
            if (food.incompatibilityTags && Array.isArray(food.incompatibilityTags)) {
                document.getElementById('foodIncompatibilityTags').value = food.incompatibilityTags.join(', ');
            } else {
                document.getElementById('foodIncompatibilityTags').value = '';
            }
            
            // √ñƒü√ºn tiplerini i≈üaretle
            const mealTypes = food.mealType || [];
            document.getElementById('mealBreakfast').checked = mealTypes.includes('breakfast');
            document.getElementById('mealLunch').checked = mealTypes.includes('lunch');
            document.getElementById('mealDinner').checked = mealTypes.includes('dinner');
            document.getElementById('mealSnack').checked = mealTypes.includes('snack');
            
            document.getElementById('foodEditModalLabel').textContent = '‚úèÔ∏è Yemek D√ºzenle';
            document.getElementById('saveFoodBtn').textContent = 'üíæ G√ºncelle';
            
            const modal = new bootstrap.Modal(document.getElementById('foodEditModal'));
            modal.show();
        }
        
        // Form temizleme
        function clearFoodForm() {
            document.getElementById('foodEditForm').reset();
            document.getElementById('foodSeasonRange').value = '[1,12]';
            document.getElementById('foodMultiplier').value = '1';
        }
        
        // Yemek kaydetme
        function saveFoodEdit() {
            const originalName = document.getElementById('originalFoodName').value;
            const isNewFood = !originalName;
            
            // Form verilerini topla
            const foodData = {
                name: document.getElementById('foodName').value.trim(),
                category: document.getElementById('foodCategory').value,
                calories: parseFloat(document.getElementById('foodCalories').value) || 0,
                protein: parseFloat(document.getElementById('foodProtein').value) || 0,
                carbs: parseFloat(document.getElementById('foodCarbs').value) || 0,
                fat: parseFloat(document.getElementById('foodFat').value) || 0,
                minQuantity: parseFloat(document.getElementById('foodMinQuantity').value) || 0,
                maxQuantity: parseFloat(document.getElementById('foodMaxQuantity').value) || 0,
                step: parseFloat(document.getElementById('foodStep').value) || 0.5,
                multiplier: parseFloat(document.getElementById('foodMultiplier').value) || 1,
                portionFixed: document.getElementById('foodPortionFixed').checked,
                role: document.getElementById('foodRole').value,
                keto: document.getElementById('foodKeto').checked,
                lowcarb: document.getElementById('foodLowCarb').checked,
                fillerLunch: document.getElementById('foodFillerLunch').checked,
                fillerDinner: document.getElementById('foodFillerDinner').checked,
                seasonRange: document.getElementById('foodSeasonRange').value || '[1,12]',
                isReversedSeason: document.getElementById('foodReversedSeason').checked
            };
            
            // Etiketleri i≈üle
            const tagsText = document.getElementById('foodTags').value.trim();
            foodData.tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            const compatText = document.getElementById('foodCompatibilityTags').value.trim();
            foodData.compatibilityTags = compatText ? compatText.split(',').map(tag => tag.trim()).filter(tag => tag) : null;
            
            const incompatText = document.getElementById('foodIncompatibilityTags').value.trim();
            foodData.incompatibilityTags = incompatText ? incompatText.split(',').map(tag => tag.trim()).filter(tag => tag) : null;
            
            // √ñƒü√ºn tiplerini topla
            const mealTypes = [];
            if (document.getElementById('mealBreakfast').checked) mealTypes.push('breakfast');
            if (document.getElementById('mealLunch').checked) mealTypes.push('lunch');
            if (document.getElementById('mealDinner').checked) mealTypes.push('dinner');
            if (document.getElementById('mealSnack').checked) mealTypes.push('snack');
            foodData.mealType = mealTypes;
            
            // Validasyon
            if (!foodData.name) {
                alert('Yemek adƒ± zorunludur!');
                return;
            }
            
            if (!foodData.category) {
                alert('Kategori se√ßimi zorunludur!');
                return;
            }
            
            // Aynƒ± isimde ba≈üka yemek var mƒ± kontrol et (d√ºzenleme durumunda mevcut hari√ß)
            const existingFood = foodsData.find(f => f.name === foodData.name && f.name !== originalName);
            if (existingFood) {
                alert('Bu isimde bir yemek zaten mevcut!');
                return;
            }
            
            if (isNewFood) {
                // Yeni yemek ekle
                foodsData.push(foodData);
                logToConsole('‚úÖ Yeni yemek eklendi: ' + foodData.name);
            } else {
                // Mevcut yemeƒüi g√ºncelle
                const index = foodsData.findIndex(f => f.name === originalName);
                if (index !== -1) {
                    foodsData[index] = foodData;
                    logToConsole('‚úÖ Yemek g√ºncellendi: ' + originalName + ' ‚Üí ' + foodData.name);
                }
            }
            
            // Verileri kaydet ve g√∂r√ºnt√ºle
            saveFoodsData();
            filteredFoodsData = [...foodsData];
            applyFoodSort();
            displayFoods();
            updateFoodStats();
            
            // Modal'ƒ± kapat
            const modal = bootstrap.Modal.getInstance(document.getElementById('foodEditModal'));
            modal.hide();
            
            alert((isNewFood ? '‚úÖ Yeni yemek eklendi!' : '‚úÖ Yemek g√ºncellendi!') + '\n\nYemek: ' + foodData.name);
        }
        
        // Yemek verisini localStorage'a kaydet
        function saveFoodsData() {
            try {
                localStorage.setItem('foodsData', JSON.stringify(foodsData));
                logToConsole('üíæ Yemek verileri localStorage\'a kaydedildi');
            } catch (error) {
                logToConsole('‚ùå Yemek verileri kaydetme hatasƒ±: ' + error.message);
            }
        }
        
        // Yemek kopyalama
        function duplicateFood(foodName) {
            const food = foodsData.find(f => f.name === foodName);
            if (!food) {
                alert('Yemek bulunamadƒ±: ' + foodName);
                return;
            }
            
            const newFood = {
                ...food,
                name: food.name + ' (Kopya)'
            };
            
            foodsData.push(newFood);
            saveFoodsData();
            filteredFoodsData = [...foodsData];
            applyFoodSort();
            displayFoods();
            updateFoodStats();
            
            logToConsole('üìÑ Yemek kopyalandƒ±: ' + foodName + ' ‚Üí ' + newFood.name);
            alert('‚úÖ "' + food.name + '" yemeƒüi ba≈üarƒ±yla kopyalandƒ±!');
        }
        
        // Yemek silme
        function deleteFood(foodName) {
            const food = foodsData.find(f => f.name === foodName);
            if (!food) {
                alert('Yemek bulunamadƒ±: ' + foodName);
                return;
            }
            
            if (confirm('"' + foodName + '" yemeƒüini silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!')) {
                foodsData = foodsData.filter(f => f.name !== foodName);
                saveFoodsData();
                filteredFoodsData = [...foodsData];
                applyFoodSort();
                displayFoods();
                updateFoodStats();
                
                logToConsole('üóëÔ∏è Yemek silindi: ' + foodName);
                alert('‚úÖ "' + foodName + '" yemeƒüi ba≈üarƒ±yla silindi!');
            }
        }
        
        // Yemek verilerini JSON olarak dƒ±≈üa aktar
        function exportFoodsData() {
            const jsonString = JSON.stringify(foodsData, null, 2);
            console.log('=== G√úNCEL YEMEKLER JSON ===');
            console.log(jsonString);
            console.log('=== JSON Bƒ∞Tƒ∞≈û ===');
            
            alert('üìÅ JSON dosyasƒ± konsola yazdƒ±rƒ±ldƒ±!\n\nKonsolu a√ßarak (F12) g√ºncellenmi≈ü yemekler_plain.json i√ßeriƒüini kopyalayƒ±p dosyaya kaydedebilirsiniz.');
        }
        
        console.log('Yemek veritabanƒ± fonksiyonlarƒ± y√ºklendi');
    </script>

    <script>
        // ====== KURAL MOTORU: Sƒ∞STEM AR≈ûƒ∞Vƒ∞ + SIKLIK KURALLARI ======
        // UI katmanƒ± frequencyRules ve dependencyRules ile √ßalƒ±≈üƒ±r; kalƒ±cƒ± kayƒ±t "systemRulesArchive" altƒ±nda tutulur.
        // Archive ≈üemasƒ±: { version, lastUpdated, rules: { frequency: Rule[], dependency: Rule[], lock: Rule[] } }
        let frequencyRules = []; // {id, filters:{names, nameMode, tags, tagMode, categories[], roles[]}, scope:'meal|day|week', meals[], countType:'min|max|fixed', count:number, weeks:number[]}
        let dependencyRules = []; // {id, dependent:{names, nameMode, tags, tagMode, categories[], roles[]}, target:{names, nameMode, tags, tagMode, categories[], roles[]}, ratio:number}
        let lockRules = []; // {id, categories[], roles[], scope:'days|weeks', duration:number, weeks:number[]}
        let systemRulesArchive = null;

        function getNowISO() { try { return new Date().toISOString(); } catch { return null; } }

        function initEmptySystemRulesArchive() {
            return {
                version: '2.0',
                lastUpdated: getNowISO(),
                rules: { frequency: [], dependency: [], lock: [] }
            };
        }

        function loadSystemRulesArchive() {
            // 1) systemRulesArchive var mƒ±? Y√ºkle
            try {
                const rawArchive = localStorage.getItem('systemRulesArchive');
                if (rawArchive) {
                    systemRulesArchive = JSON.parse(rawArchive);
                }
            } catch (e) {
                console.warn('systemRulesArchive parse hatasƒ±:', e);
            }

            // 2) Yoksa, eski anahtar (frequencyRules) var mƒ±? Migrasyon yap
            if (!systemRulesArchive) {
                systemRulesArchive = initEmptySystemRulesArchive();
                try {
                    const legacy = localStorage.getItem('frequencyRules');
                    if (legacy) {
                        const arr = JSON.parse(legacy) || [];
                        systemRulesArchive.rules.frequency = Array.isArray(arr) ? arr : [];
                        systemRulesArchive.lastUpdated = getNowISO();
                        localStorage.setItem('systemRulesArchive', JSON.stringify(systemRulesArchive));
                        console.log('üîÅ frequencyRules ‚Üí systemRulesArchive migrasyonu yapƒ±ldƒ±');
                    }
                    // Dependency rules i√ßin de eski veriler varsa y√ºkle
                    const legacyDep = localStorage.getItem('dependencyRules');
                    if (legacyDep) {
                        const arr = JSON.parse(legacyDep) || [];
                        systemRulesArchive.rules.dependency = Array.isArray(arr) ? arr : [];
                    }
                    if (!legacy && !legacyDep) {
                        // ƒ∞lk kez olu≈üturuluyor - JSON dosyasƒ±ndan y√ºklemeyi dene
                        loadRulesFromJSON().then(() => {
                            localStorage.setItem('systemRulesArchive', JSON.stringify(systemRulesArchive));
                            console.log('üÜï Bo≈ü systemRulesArchive olu≈üturuldu ve JSON\'dan y√ºklendi');
                        }).catch(() => {
                            localStorage.setItem('systemRulesArchive', JSON.stringify(systemRulesArchive));
                            console.log('üÜï Bo≈ü systemRulesArchive olu≈üturuldu');
                        });
                    }
                } catch (e) {
                    console.warn('systemRulesArchive olu≈üturma/migrasyon hatasƒ±:', e);
                }
            }

            // 3) UI state'i senkronize et
            const archivedFreq = systemRulesArchive?.rules?.frequency;
            const archivedDep = systemRulesArchive?.rules?.dependency;
            const archivedLock = systemRulesArchive?.rules?.lock;
            frequencyRules = Array.isArray(archivedFreq) ? [...archivedFreq] : [];
            dependencyRules = Array.isArray(archivedDep) ? [...archivedDep] : [];
            lockRules = Array.isArray(archivedLock) ? [...archivedLock] : [];
        }

        // JSON dosyasƒ±ndan kurallarƒ± y√ºkle
        async function loadRulesFromJSON() {
            try {
                const jsonData = await getEmbeddedData('system_rules.json');
                if (jsonData && jsonData.rulesArchive) {
                    const archive = jsonData.rulesArchive;
                    
                    // Frequency rules y√ºkle
                    if (Array.isArray(archive.frequencyRules)) {
                        systemRulesArchive.rules.frequency = [...archive.frequencyRules];
                        console.log(`üìÑ JSON'dan ${archive.frequencyRules.length} sƒ±klƒ±k kuralƒ± y√ºklendi`);
                    }
                    
                    // Dependency rules y√ºkle
                    if (Array.isArray(archive.dependencyRules)) {
                        systemRulesArchive.rules.dependency = [...archive.dependencyRules];
                        console.log(`üìÑ JSON'dan ${archive.dependencyRules.length} baƒüƒ±mlƒ±lƒ±k kuralƒ± y√ºklendi`);
                    }
                    
                    // Lock rules y√ºkle
                    if (Array.isArray(archive.lockRules)) {
                        systemRulesArchive.rules.lock = [...archive.lockRules];
                        console.log(`üìÑ JSON'dan ${archive.lockRules.length} kategori kilidi kuralƒ± y√ºklendi`);
                    }
                    
                    systemRulesArchive.lastUpdated = getNowISO();
                    return true;
                }
            } catch (e) {
                console.warn('JSON dosyasƒ±ndan kural y√ºkleme hatasƒ±:', e);
            }
            return false;
        }

        function persistSystemRulesArchive() {
            // UI state ‚Üí archive
            if (!systemRulesArchive) systemRulesArchive = initEmptySystemRulesArchive();
            if (!systemRulesArchive.rules) systemRulesArchive.rules = {};
            systemRulesArchive.rules.frequency = Array.isArray(frequencyRules) ? [...frequencyRules] : [];
            systemRulesArchive.rules.dependency = Array.isArray(dependencyRules) ? [...dependencyRules] : [];
            systemRulesArchive.rules.lock = Array.isArray(lockRules) ? [...lockRules] : [];
            systemRulesArchive.lastUpdated = getNowISO();
            // Kalƒ±cƒ±la≈ütƒ±r
            try {
                localStorage.setItem('systemRulesArchive', JSON.stringify(systemRulesArchive));
                // Geriye d√∂n√ºk uyumluluk i√ßin ayrƒ± anahtarƒ± da g√ºncel tutalƒ±m
                localStorage.setItem('frequencyRules', JSON.stringify(frequencyRules));
                localStorage.setItem('dependencyRules', JSON.stringify(dependencyRules));
                localStorage.setItem('lockRules', JSON.stringify(lockRules));
                // JSON dosyasƒ±na da yaz (system_rules.json)
                saveRulesHierarchyToJSON();
                if (typeof logToConsole === 'function') {
                    const freqCount = frequencyRules.length || 0;
                    const depCount = dependencyRules.length || 0;
                    const lockCount = lockRules.length || 0;
                    logToConsole(`üíæ Sistem kural ar≈üivi g√ºncellendi (${freqCount} sƒ±klƒ±k, ${depCount} baƒüƒ±mlƒ±lƒ±k, ${lockCount} kilit)`);
                }
            } catch (e) {
                console.warn('systemRulesArchive kaydetme hatasƒ±:', e);
            }
        }

        // Kurallar hiyerar≈üisini system_rules.json'a kaydet
        async function saveRulesHierarchyToJSON() {
            try {
                // Frequency rules
                const sortedFreq = Array.isArray(frequencyRules)
                    ? [...frequencyRules].sort((a, b) => (a.priority || 9999) - (b.priority || 9999))
                    : [];
                const compactFreq = sortedFreq.map(r => ({
                    id: r.id,
                    title: r.title || undefined,
                    filters: r.filters || {},
                    scope: r.scope,
                    meals: r.meals || [],
                    countType: r.countType,
                    count: r.count,
                    weeks: r.weeks || [],
                    priority: r.priority
                }));
                
                // Dependency rules
                const sortedDep = Array.isArray(dependencyRules)
                    ? [...dependencyRules].sort((a, b) => (a.priority || 9999) - (b.priority || 9999))
                    : [];
                const compactDep = sortedDep.map(r => ({
                    id: r.id,
                    title: r.title || undefined,
                    dependent: r.dependent || {},
                    target: r.target || {},
                    ratio: r.ratio,
                    priority: r.priority
                }));
                
                const ok = await updateJsonFile('/system_rules.json', (json) => {
                    const out = { ...(json || {}) };
                    out.rulesArchive = out.rulesArchive || {};
                    out.rulesArchive.frequencyRules = compactFreq;
                    out.rulesArchive.dependencyRules = compactDep;
                    out.rulesArchive.priorityPolicy = 'top-first';
                    out.lastUpdated = new Date().toISOString();
                    return out;
                });
                if (ok) {
                    const freqCount = compactFreq.length;
                    const depCount = compactDep.length;
                    logToConsole(`üìÑ system_rules.json g√ºncellendi (${freqCount} sƒ±klƒ±k, ${depCount} baƒüƒ±mlƒ±lƒ±k kuralƒ±)`);
                }
            } catch (e) {
                console.warn('Kurallar hiyerar≈üisi JSON kaydƒ± ba≈üarƒ±sƒ±z:', e);
            }
        }

        // JSON DI≈ûA/ƒ∞√áE AKTAR
        function exportSystemRulesArchive() {
            try {
                // Ar≈üivi g√ºncel hale getir ve indir
                persistSystemRulesArchive();
                const data = localStorage.getItem('systemRulesArchive') || JSON.stringify(initEmptySystemRulesArchive());
                const blob = new Blob([data], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_rules_archive_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                if (typeof logToConsole === 'function') logToConsole('üì§ Sistem kural ar≈üivi JSON olarak indirildi');
            } catch (e) {
                alert('Dƒ±≈üa aktarma sƒ±rasƒ±nda hata olu≈ütu: ' + e.message);
            }
        }

        function handleImportSystemRulesFile(evt) {
            const file = evt?.target?.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    if (!parsed || typeof parsed !== 'object') throw new Error('Ge√ßersiz JSON');
                    
                    let freq, dep;
                    
                    // Format 1: systemRulesArchive formatƒ± (localStorage export)
                    if (parsed.rules) {
                        freq = parsed.rules.frequency;
                        dep = parsed.rules.dependency;
                    }
                    // Format 2: saveRulesHierarchyToJSON formatƒ± 
                    else if (parsed.rulesArchive) {
                        freq = parsed.rulesArchive.frequencyRules;
                        dep = parsed.rulesArchive.dependencyRules;
                    }
                    // Format 3: Legacy/direkt format
                    else if (Array.isArray(parsed)) {
                        freq = parsed; // Sadece frequency rules array'i
                        dep = [];
                    }
                    else {
                        throw new Error('Tanƒ±nmayan JSON formatƒ±');
                    }
                    
                    if (!Array.isArray(freq)) throw new Error('Eksik/Ge√ßersiz: frequency rules');
                    // Dependency rules isteƒüe baƒülƒ±
                    if (dep && !Array.isArray(dep)) throw new Error('Ge√ßersiz: dependency rules');
                    
                    // systemRulesArchive formatƒ±nda normalize et
                    systemRulesArchive = {
                        version: parsed.version || '2.0',
                        lastUpdated: new Date().toISOString(),
                        rules: {
                            frequency: freq,
                            dependency: Array.isArray(dep) ? dep : []
                        }
                    };
                    
                    // UI state senkronize et
                    frequencyRules = [...freq];
                    dependencyRules = Array.isArray(dep) ? [...dep] : [];
                    // Kalƒ±cƒ±la≈ütƒ±r
                    localStorage.setItem('systemRulesArchive', JSON.stringify(systemRulesArchive));
                    // Legacy anahtarlarƒ± da g√ºncelle
                    localStorage.setItem('frequencyRules', JSON.stringify(frequencyRules));
                    localStorage.setItem('dependencyRules', JSON.stringify(dependencyRules));
                    renderFrequencyRulesTable();
                    renderRulesHierarchyList();
                    enableRulesDragAndDrop();
                    if (typeof logToConsole === 'function') logToConsole('üì• Sistem kural ar≈üivi JSON‚Äôdan y√ºklendi');
                    alert(`Kurallar ba≈üarƒ±yla i√ße aktarƒ±ldƒ±: ${frequencyRules.length} sƒ±klƒ±k, ${dependencyRules.length} baƒüƒ±mlƒ±lƒ±k`);
                } catch (e) {
                    alert('ƒ∞√ße aktarma hatasƒ±: ' + e.message);
                } finally {
                    // input‚Äôu sƒ±fƒ±rla
                    try { evt.target.value = ''; } catch {}
                }
            };
            reader.onerror = () => {
                alert('Dosya okunamadƒ±');
            };
            reader.readAsText(file, 'utf-8');
        }

        // Sistem Ayarlarƒ±: Dƒ±≈üa/I√ße Aktar
        function exportSystemSettings() {
            try {
                // √ñncelik: localStorage v2; yoksa embedded
                const raw = localStorage.getItem('systemSettings_v2');
                const data = raw ? JSON.parse(raw) : EMBEDDED_DATA.systemSettings;
                if (!data || !data.systemDefaults) throw new Error('Sistem ayarlarƒ± bulunamadƒ±');
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_settings_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
                if (typeof logToConsole === 'function') logToConsole('üì§ Sistem ayarlarƒ± JSON olarak indirildi');
                showToast('Sistem ayarlarƒ± dƒ±≈üa aktarƒ±ldƒ±', 'success');
            } catch (e) {
                showToast('Dƒ±≈üa aktarma hatasƒ±: ' + e.message, 'error');
                if (typeof logToConsole === 'function') logToConsole('‚ùå Dƒ±≈üa aktarma hatasƒ±', e);
            }
        }

        // Uyarƒ±-toplayƒ±cƒ±: ≈ûema doƒürulama (sadece uyarƒ±, d√ºzeltme yok)
        function validateSystemDefaults(sysDef) {
            const warnings = [];
            try {
                if (!sysDef || typeof sysDef !== 'object') {
                    warnings.push('Ge√ßersiz sistemDefaults yapƒ±sƒ±');
                    return warnings;
                }
                // dietType
                if (!sysDef.dietType || typeof sysDef.dietType !== 'string') warnings.push('dietType eksik veya ge√ßersiz');
                // defaultCalorieMethod
                const allowedMethods = ['custom', 'harris', 'mifflin'];
                if (sysDef.defaultCalorieMethod && !allowedMethods.includes(sysDef.defaultCalorieMethod)) warnings.push(`defaultCalorieMethod ge√ßersiz: ${sysDef.defaultCalorieMethod}`);
                // userSettings
                const us = sysDef.userSettings || {};
                if (us.age != null && (!Number.isFinite(+us.age) || +us.age <= 0)) warnings.push('userSettings.age ge√ßersiz');
                if (us.weight != null && (!Number.isFinite(+us.weight) || +us.weight <= 0)) warnings.push('userSettings.weight ge√ßersiz');
                if (us.targetCalories != null && (!Number.isFinite(+us.targetCalories) || +us.targetCalories <= 0)) warnings.push('userSettings.targetCalories ge√ßersiz');
                const allowedActivities = ['1.2','1.375','1.55','1.725','1.9'];
                if (us.activity && !allowedActivities.includes(String(us.activity))) warnings.push(`userSettings.activity deƒüeri beklenen aralƒ±kta deƒüil: ${us.activity}`);
                // mealPercentages (yeni)
                if (sysDef.mealPercentages) {
                    const mp = sysDef.mealPercentages || {};
                    const keys = ['breakfast','snack1','lunch','snack2','dinner'];
                    let total = 0;
                    keys.forEach(k => { const v = +mp[k] || 0; total += v; if (v < 0 || v > 100) warnings.push(`${k} y√ºzdesi 0-100 aralƒ±ƒüƒ±nda olmalƒ±`); });
                    if (total !== 100) warnings.push(`√ñƒü√ºn y√ºzdeleri toplamƒ± 100 olmalƒ± (≈üu an: ${total})`);
                }
                // macroDistribution (legacy destek)
                const md = sysDef.macroDistribution || {};
                Object.keys(md).forEach(meal => {
                    const m = md[meal] || {};
                    const c = +m.carbs || 0;
                    const p = +m.protein || 0;
                    const f = +m.fat || 0;
                    const sum = c + p + f;
                    if (sum !== 100) warnings.push(`${meal} makro toplamƒ± 100 olmalƒ± (≈üu an: ${sum})`);
                    if ([c,p,f].some(v => v < 0 || v > 100 || !Number.isFinite(v))) warnings.push(`${meal} makro deƒüerleri 0-100 aralƒ±ƒüƒ±nda olmalƒ±`);
                });
                // mealSettings
                const ms = sysDef.mealSettings || {};
                Object.keys(ms).forEach(meal => {
                    const s = ms[meal];
                    if (!s) return;
                    const min = +s.min; const max = +s.max; const fixed = s.fixed != null ? +s.fixed : null;
                    if (Number.isFinite(min) && Number.isFinite(max) && min > max) warnings.push(`${meal} i√ßin min, max'tan b√ºy√ºk`);
                    if (fixed != null && Number.isFinite(min) && Number.isFinite(max) && (fixed < min || fixed > max)) warnings.push(`${meal} i√ßin fixed (${fixed}) aralƒ±k dƒ±≈üƒ±nda [${min}, ${max}]`);
                });
            } catch (e) {
                warnings.push('Doƒürulama sƒ±rasƒ±nda hata: ' + e.message);
            }
            return warnings;
        }

        function importSystemSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json,.json';
            input.addEventListener('change', (evt) => {
                const file = evt.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const parsed = JSON.parse(reader.result);
                        // Beklenen yapƒ±: { version, systemDefaults: { ... } }
                        const sysDef = parsed?.systemDefaults || parsed; // esneklik: d√ºz systemDefaults da olabilir
                        if (!sysDef || typeof sysDef !== 'object') throw new Error('Ge√ßersiz sistem ayarlarƒ± JSON');
                        // ≈ûema doƒürulama ‚Äì sadece uyar (d√ºzeltme yapma)
                        const warnings = validateSystemDefaults(sysDef);
                        if (warnings.length) {
                            console.warn('‚ö†Ô∏è ƒ∞√ße aktarƒ±lan sistem ayarlarƒ± uyarƒ±larƒ±:', warnings);
                            showToast(`ƒ∞√ße aktarƒ±ldƒ±, ${warnings.length} uyarƒ± var (detay konsolda)`, 'warning');
                        }
                        // Tam yapƒ± haline getir (deƒüerleri deƒüi≈ütirmeden)
                        const v2 = parsed?.version ? parsed : { version: '2.1.0', lastUpdated: new Date().toISOString(), systemDefaults: sysDef };
                        localStorage.setItem('systemSettings_v2', JSON.stringify(v2));
                        // UI'yi g√ºncelle
                        loadSavedSystemSettings();
                        if (typeof logToConsole === 'function') logToConsole('üì• Sistem ayarlarƒ± JSON‚Äôdan y√ºklendi');
                        showToast('Sistem ayarlarƒ± i√ße aktarƒ±ldƒ±', 'success');
                    } catch (e) {
                        showToast('ƒ∞√ße aktarma hatasƒ±: ' + e.message, 'error');
                    } finally {
                        try { evt.target.value = ''; } catch {}
                    }
                };
                reader.onerror = () => showToast('Dosya okunamadƒ±', 'error');
                reader.readAsText(file, 'utf-8');
            }, { once: true });
            input.click();
        }

        // Y√ºkle (sayfa a√ßƒ±lƒ±≈üƒ±nda ar≈üiv ‚Üí UI)
        (function bootRules() {
            loadSystemRulesArchive();
            renderFrequencyRulesTable();
            // ƒ∞lk y√ºklemede kurallar hiyerar≈üisi g√∂r√ºn√ºm√º hazƒ±r olsun
            try { renderRulesHierarchyList(); } catch {}
        })();

        // UI helper: sadece frequencyRules deƒüi≈üimini kalƒ±cƒ± hale getir
        function persistFrequencyRules() {
            persistSystemRulesArchive();
        }

        function persistDependencyRules() {
            persistSystemRulesArchive();
        }

        function persistLockRules() {
            persistSystemRulesArchive();
        }

        // Yardƒ±mcƒ±lar
        function parseTerms(input) {
            return (input || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
        }

        function parseWeeks(input) {
            const parts = parseTerms(input);
            const out = new Set();
            for (const p of parts) {
                const m = p.match(/^(\d+)\s*-\s*(\d+)$/);
                if (m) {
                    const a = parseInt(m[1], 10), b = parseInt(m[2], 10);
                    if (!isNaN(a) && !isNaN(b)) {
                        const s = Math.min(a, b), e = Math.max(a, b);
                        for (let i = s; i <= e; i++) out.add(i);
                    }
                } else {
                    const n = parseInt(p, 10);
                    if (!isNaN(n)) out.add(n);
                }
            }
            return Array.from(out).sort((a,b)=>a-b);
        }

        function collectSelectedOptions(selectEl) {
            return Array.from(selectEl.selectedOptions).map(o => o.value);
        }

        function clearFrequencyRuleForm() {
            document.getElementById('frequency-rule-form').reset();
            document.getElementById('fr-id').value = '';
            // √áoklu selectleri da temizle
            document.getElementById('fr-categories').selectedIndex = -1;
            document.getElementById('fr-roles').selectedIndex = -1;
            // √ñƒü√ºn kutucuklarƒ±
            ['fr-meal-breakfast','fr-meal-lunch','fr-meal-dinner','fr-meal-snack'].forEach(id=>{
                const el = document.getElementById(id); if (el) el.checked = false;
            });
        }

    function saveFrequencyRuleFromForm() {
            const id = document.getElementById('fr-id').value || (Date.now().toString(36) + Math.random().toString(36).slice(2,6));
            const names = parseTerms(document.getElementById('fr-name-terms').value);
            const nameMode = document.getElementById('fr-name-mode').value; // AND/OR
            const tags = parseTerms(document.getElementById('fr-tag-terms').value);
            const tagMode = document.getElementById('fr-tag-mode').value;   // AND/OR
            const categories = collectSelectedOptions(document.getElementById('fr-categories'));
            const roles = collectSelectedOptions(document.getElementById('fr-roles')).map(normalizeRole);
            const scope = (document.querySelector('input[name="fr-scope"]:checked')?.value) || 'meal';
            const meals = ['fr-meal-breakfast','fr-meal-lunch','fr-meal-dinner','fr-meal-snack']
                .map(id=>document.getElementById(id))
                .filter(el=>el && el.checked)
                .map(el=>el.value);
            const countType = document.getElementById('fr-count-type').value; // min|max|fixed
            const count = parseInt(document.getElementById('fr-count').value, 10);
            const weeks = parseWeeks(document.getElementById('fr-weeks').value);

            // basit validasyon
            if (isNaN(count)) { alert('Sƒ±klƒ±k adetini girin'); return; }
            if (scope === 'meal' && meals.length === 0) { alert('√ñƒü√ºn kapsamƒ± i√ßin en az bir √∂ƒü√ºn se√ßin'); return; }

            const rule = { id, filters:{ names, nameMode, tags, tagMode, categories, roles }, scope, meals, countType, count, weeks };
            const idx = frequencyRules.findIndex(r => r.id === id);
            if (idx >= 0) frequencyRules[idx] = rule; else frequencyRules.push(rule);
            persistFrequencyRules();
            if (typeof logToConsole === 'function') {
                const action = (idx >= 0) ? 'g√ºncellendi' : 'eklendi';
                logToConsole(`üß© Sƒ±klƒ±k kuralƒ± ${action}: id=${id}, kapsam=${scope}, adet=${countType}:${count}`);
            }
            renderFrequencyRulesTable();
            renderRulesHierarchyList();
            enableRulesDragAndDrop();
            clearFrequencyRuleForm();
            alert('Sƒ±klƒ±k kuralƒ± kaydedildi');
        }

        function renderFrequencyRulesTable() {
            const tbody = document.getElementById('frequency-rules-table-body');
            if (!tbody) return;
            if (frequencyRules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">Hen√ºz kural eklenmemi≈ü</td></tr>';
                return;
            }
            const rows = frequencyRules.map(r => {
                const f = r.filters || {};
                const fParts = [];
                if (f.names?.length) fParts.push(`Ad: [${f.names.join(', ')}] (${f.nameMode})`);
                if (f.tags?.length) fParts.push(`Tag: [${f.tags.join(', ')}] (${f.tagMode})`);
                if (f.categories?.length) fParts.push(`Kategori: [${f.categories.join(', ')}]`);
                if (f.roles?.length) fParts.push(`Rol: [${f.roles.map(getFoodRoleLabel).join(', ')}]`);
                const filterStr = fParts.join(' | ');

                const scopeStr = r.scope === 'meal' ? `√ñƒü√ºn (${(r.meals||[]).map(m=>({breakfast:'Kahvaltƒ±',lunch:'√ñƒüle',dinner:'Ak≈üam',snack:'Ara √ñƒü√ºn'}[m]||m)).join(', ')})`
                              : r.scope === 'day' ? 'G√ºn' : 'Hafta';
                const countStr = (r.countType === 'min' ? 'En az' : r.countType === 'max' ? 'En √ßok' : 'Sabit') + ` ${r.count}`;
                const weeksStr = (r.weeks && r.weeks.length) ? r.weeks.join(', ') : 'T√ºm√º';
                return `<tr>
                    <td><span class="badge bg-primary">Sƒ±klƒ±k</span></td>
                    <td>${filterStr || '-'}</td>
                    <td>${scopeStr}</td>
                    <td>${countStr}</td>
                    <td>${weeksStr}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editFrequencyRule('${r.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteFrequencyRule('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = rows.join('');
        }

        function editFrequencyRule(id) {
            const r = frequencyRules.find(x => x.id === id);
            if (!r) return;
            document.getElementById('fr-id').value = r.id;
            document.getElementById('fr-name-terms').value = (r.filters?.names || []).join(', ');
            document.getElementById('fr-name-mode').value = r.filters?.nameMode || 'AND';
            document.getElementById('fr-tag-terms').value = (r.filters?.tags || []).join(', ');
            document.getElementById('fr-tag-mode').value = r.filters?.tagMode || 'AND';
            // categories
            const catSel = document.getElementById('fr-categories');
            Array.from(catSel.options).forEach(o => o.selected = (r.filters?.categories || []).includes(o.value));
            // roles
            const roleSel = document.getElementById('fr-roles');
            const roleVals = (r.filters?.roles || []).map(normalizeRole);
            Array.from(roleSel.options).forEach(o => o.selected = roleVals.includes(normalizeRole(o.value)));
            // scope
            const scopeVal = r.scope || 'meal';
            (document.getElementById('fr-scope-meal').checked = scopeVal === 'meal');
            (document.getElementById('fr-scope-day').checked = scopeVal === 'day');
            (document.getElementById('fr-scope-week').checked = scopeVal === 'week');
            // meals
            const meals = r.meals || [];
            ['fr-meal-breakfast','fr-meal-lunch','fr-meal-dinner','fr-meal-snack'].forEach(id=>{
                const el = document.getElementById(id);
                if (el) el.checked = meals.includes(el.value);
            });
            // count
            document.getElementById('fr-count-type').value = r.countType || 'max';
            document.getElementById('fr-count').value = r.count || 0;
            // weeks
            document.getElementById('fr-weeks').value = (r.weeks || []).join(', ');
        }

        function editDependencyRule(id) {
            const r = dependencyRules.find(x => x.id === id);
            if (!r) return;
            
            // Temel bilgiler
            document.getElementById('dr-id').value = r.id;
            document.getElementById('dr-ratio').value = r.ratio || 40;
            
            // Baƒüƒ±mlƒ± olan (dependent) filtreleri
            const dep = r.dependent || {};
            document.getElementById('dr-dependent-name-terms').value = (dep.names || []).join(', ');
            document.getElementById('dr-dependent-name-mode').value = dep.nameMode || 'AND';
            document.getElementById('dr-dependent-tag-terms').value = (dep.tags || []).join(', ');
            document.getElementById('dr-dependent-tag-mode').value = dep.tagMode || 'AND';
            
            // Dependent categories
            const depCatSel = document.getElementById('dr-dependent-categories');
            Array.from(depCatSel.options).forEach(o => o.selected = (dep.categories || []).includes(o.value));
            
            // Dependent roles
            const depRoleSel = document.getElementById('dr-dependent-roles');
            const depRoleVals = (dep.roles || []).map(normalizeRole);
            Array.from(depRoleSel.options).forEach(o => o.selected = depRoleVals.includes(normalizeRole(o.value)));
            
            // Baƒüƒ±mlƒ± olunan (target) filtreleri
            const target = r.target || {};
            document.getElementById('dr-target-name-terms').value = (target.names || []).join(', ');
            document.getElementById('dr-target-name-mode').value = target.nameMode || 'AND';
            document.getElementById('dr-target-tag-terms').value = (target.tags || []).join(', ');
            document.getElementById('dr-target-tag-mode').value = target.tagMode || 'AND';
            
            // Target categories
            const targetCatSel = document.getElementById('dr-target-categories');
            Array.from(targetCatSel.options).forEach(o => o.selected = (target.categories || []).includes(o.value));
            
            // Target roles
            const targetRoleSel = document.getElementById('dr-target-roles');
            const targetRoleVals = (target.roles || []).map(normalizeRole);
            Array.from(targetRoleSel.options).forEach(o => o.selected = targetRoleVals.includes(normalizeRole(o.value)));
            
            // Dependency tab'ƒ±nƒ± aktifle≈ütir
            const depTab = document.getElementById('dependency-tab');
            if (depTab) {
                depTab.click();
            }
            
            if (typeof logToConsole === 'function') {
                logToConsole(`‚úèÔ∏è Baƒüƒ±mlƒ±lƒ±k kuralƒ± d√ºzenleniyor: id=${id}`);
            }
        }

        function deleteDependencyRule(id) {
            if (!confirm('Bu baƒüƒ±mlƒ±lƒ±k kuralƒ±nƒ± silmek istiyor musunuz?')) return;
            dependencyRules = dependencyRules.filter(r => r.id !== id);
            persistDependencyRules();
            if (typeof logToConsole === 'function') {
                logToConsole(`üóëÔ∏è Baƒüƒ±mlƒ±lƒ±k kuralƒ± silindi: id=${id}`);
            }
            renderRulesHierarchyList();
            enableRulesDragAndDrop();
        }

    function deleteFrequencyRule(id) {
            if (!confirm('Bu sƒ±klƒ±k kuralƒ±nƒ± silmek istiyor musunuz?')) return;
            frequencyRules = frequencyRules.filter(r => r.id !== id);
            persistFrequencyRules();
            if (typeof logToConsole === 'function') {
                logToConsole(`üóëÔ∏è Sƒ±klƒ±k kuralƒ± silindi: id=${id}`);
            }
            renderFrequencyRulesTable();
        }

        // üîí Lock Rules Edit/Delete Functions
        function editLockRule(id) {
            const r = lockRules.find(x => x.id === id);
            if (!r) return;
            
            document.getElementById('lr-id').value = r.id;
            document.getElementById('lr-name').value = r.name || '';
            document.getElementById('lr-category').value = r.category || '';
            document.getElementById('lr-role').value = r.role || '';
            document.getElementById('lr-period').value = r.period || '';
            document.getElementById('lr-scope').value = r.scope || 'meal';
            document.getElementById('lr-description').value = r.description || '';
            document.getElementById('lr-active').checked = r.active !== false;
            
            // Hedef bilgisini g√ºncelle
            updateLockTargetInfo();
            // A√ßƒ±klama yoksa otomatik olu≈ütur
            if (!r.description) {
                updateLockDescription();
            }
            
            // Lock tab'ƒ±nƒ± aktifle≈ütir
            const lockTab = document.getElementById('lock-tab');
            if (lockTab) {
                lockTab.click();
            }
            
            console.log('‚úèÔ∏è Kategori kilidi kuralƒ± d√ºzenleniyor:', id);
        }

        function deleteLockRule(id) {
            if (!confirm('Bu kategori kilidi kuralƒ±nƒ± silmek istiyor musunuz?')) return;
            lockRules = lockRules.filter(r => r.id !== id);
            persistSystemRulesArchive();
            console.log('üóëÔ∏è Kategori kilidi kuralƒ± silindi:', id);
            renderRulesHierarchyList();
            enableRulesDragAndDrop();
        }
    </script>

    <!-- Yemek Ekleme/D√ºzenleme Modal -->
    <div class="modal fade" id="foodEditModal" tabindex="-1" aria-labelledby="foodEditModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title" id="foodEditModalLabel">Yemek D√ºzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-3">
                    <form id="foodEditForm">
                        <input type="hidden" id="originalFoodName">
                        
                        <!-- Temel Bilgiler -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label for="foodName" class="form-label mb-1">Yemek Adƒ± *</label>
                                <input type="text" class="form-control form-control-sm" id="foodName" required>
                            </div>
                            <div class="col-md-3">
                                <label for="foodCategory" class="form-label mb-1">Kategori *</label>
                                <select class="form-select form-select-sm" id="foodCategory" required>
                                    <option value="">Kategori Se√ßin</option>
                                    <option value="KAHVALTI">Kahvaltƒ±</option>
                                    <option value="OGLE">√ñƒüle</option>
                                    <option value="AKSAM">Ak≈üam</option>
                                    <option value="KURUYEMISLER">Kuruyemi≈üler</option>
                                    <option value="TATLILAR">Tatlƒ±lar</option>
                                    <option value="SALATALAR">Salatalar</option>
                                    <option value="CORBALAR">√áorbalar</option>
                                    <option value="EKMEKLER">Ekmekler</option>
                                    <option value="MEYVELER">Meyveler</option>
                                    <option value="TOSTLAR">Tostlar</option>
                                    <option value="KOLLAJEN">Kollajen</option>
                                    <option value="ATISTIRMALIK">Atƒ±≈ütƒ±rmalƒ±k</option>
                                    <option value="ICECEK">ƒ∞√ßecek</option>
                                    <option value="DIGER">Diƒüer</option>
                                    <option value="APERATIF">Aperatif</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="foodRole" class="form-label mb-1">Rol</label>
                                <select class="form-select form-select-sm" id="foodRole">
                                    <option value="">Rol Se√ßin</option>
                                    <option value="mainDish">Ana Yemek</option>
                                    <option value="side">Yan Yemek</option>
                                    <option value="drink">ƒ∞√ßecek</option>
                                    <option value="soup">√áorba</option>
                                    <option value="dessert">Tatlƒ±</option>
                                    <option value="fruit">Meyve</option>
                                    <option value="bread">Ekmek</option>
                                    <option value="snack">Atƒ±≈ütƒ±rmalƒ±k</option>
                                    <option value="supplement">Ek</option>
                                    <option value="vegetable">Sebze</option>
                                    <option value="fat">Yaƒü</option>
                                </select>
                            </div>
                        </div>

                        <!-- Besin Deƒüerleri -->
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <label class="form-label mb-1"><strong>Besin Deƒüerleri (100g)</strong></label>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label for="foodCalories" class="form-label mb-1">Kalori</label>
                                <input type="number" class="form-control form-control-sm" id="foodCalories" min="0" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label for="foodProtein" class="form-label mb-1">Protein (g)</label>
                                <input type="number" class="form-control form-control-sm" id="foodProtein" min="0" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label for="foodCarbs" class="form-label mb-1">Karbonhidrat (g)</label>
                                <input type="number" class="form-control form-control-sm" id="foodCarbs" min="0" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label for="foodFat" class="form-label mb-1">Yaƒü (g)</label>
                                <input type="number" class="form-control form-control-sm" id="foodFat" min="0" step="0.1">
                            </div>
                        </div>

                        <!-- Porsiyon Bilgileri -->
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <label class="form-label mb-1"><strong>Porsiyon Ayarlarƒ±</strong></label>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-2">
                                <label for="foodMinQuantity" class="form-label mb-1">Min</label>
                                <input type="number" class="form-control form-control-sm" id="foodMinQuantity" min="0" step="0.1">
                            </div>
                            <div class="col-md-2">
                                <label for="foodMaxQuantity" class="form-label mb-1">Max</label>
                                <input type="number" class="form-control form-control-sm" id="foodMaxQuantity" min="0" step="0.1">
                            </div>
                            <div class="col-md-2">
                                <label for="foodStep" class="form-label mb-1">Artƒ±≈ü</label>
                                <input type="number" class="form-control form-control-sm" id="foodStep" min="0.1" step="0.1">
                            </div>
                            <div class="col-md-2">
                                <label for="foodMultiplier" class="form-label mb-1">√áarpan</label>
                                <input type="number" class="form-control form-control-sm" id="foodMultiplier" min="0.1" step="0.1" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label mb-1">&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="foodPortionFixed">
                                    <label class="form-check-label" for="foodPortionFixed">Sabit Porsiyon</label>
                                </div>
                            </div>
                        </div>

                        <!-- √ñƒü√ºn Tipleri -->
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label class="form-label mb-1"><strong>√ñƒü√ºn Tipleri</strong></label>
                            </div>
                            <div class="col-md-9">
                                <div class="form-check-group d-flex gap-3 align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mealBreakfast" value="breakfast">
                                        <label class="form-check-label" for="mealBreakfast">Kahvaltƒ±</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mealLunch" value="lunch">
                                        <label class="form-check-label" for="mealLunch">√ñƒüle</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mealDinner" value="dinner">
                                        <label class="form-check-label" for="mealDinner">Ak≈üam</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mealSnack" value="snack">
                                        <label class="form-check-label" for="mealSnack">Ara √ñƒü√ºn</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Diyet Uyumluluƒüu -->
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label class="form-label mb-1"><strong>Diyet Uyumluluƒüu</strong></label>
                            </div>
                            <div class="col-md-9">
                                <div class="d-flex gap-3 align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="foodKeto">
                                        <label class="form-check-label" for="foodKeto">Keto</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="foodLowCarb">
                                        <label class="form-check-label" for="foodLowCarb">D√º≈ü√ºk Karb</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="foodFillerLunch">
                                        <label class="form-check-label" for="foodFillerLunch">√ñƒüle Dolduru</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="foodFillerDinner">
                                        <label class="form-check-label" for="foodFillerDinner">Ak≈üam Dolduru</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mevsim ve Etiketler -->
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <label for="foodSeasonRange" class="form-label mb-1">Mevsim Aralƒ±ƒüƒ±</label>
                                <input type="text" class="form-control form-control-sm" id="foodSeasonRange" placeholder="[1,12]" value="[1,12]">
                                <small class="text-muted">√ñrn: [3,8] = Mart-Aƒüustos</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label mb-1">&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="foodReversedSeason">
                                    <label class="form-check-label" for="foodReversedSeason">Ters Mevsim</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="foodTags" class="form-label mb-1">Etiketler</label>
                                <input type="text" class="form-control form-control-sm" id="foodTags" placeholder="tavuk, protein, ƒ±zgara">
                                <small class="text-muted">Virg√ºlle ayƒ±rƒ±n</small>
                            </div>
                        </div>

                        <!-- Uyumluluk -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label for="foodCompatibilityTags" class="form-label mb-1">Uyumlu Yiyecekler</label>
                                <input type="text" class="form-control form-control-sm" id="foodCompatibilityTags" placeholder="salata, sebze, pirin√ß">
                            </div>
                            <div class="col-md-6">
                                <label for="foodIncompatibilityTags" class="form-label mb-1">Uyumsuz Yiyecekler</label>
                                <input type="text" class="form-control form-control-sm" id="foodIncompatibilityTags" placeholder="s√ºt √ºr√ºnleri, fƒ±ndƒ±k">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary btn-sm" id="saveFoodBtn" onclick="saveFoodEdit()">
                        üíæ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Genel Onay Modalƒ± -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="confirmModalTitle">Onay</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage" class="mb-0">Bu i≈ülemi onaylƒ±yor musunuz?</p>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" id="confirmModalCancelBtn" data-bs-dismiss="modal">Vazge√ß</button>
                    <button type="button" class="btn btn-danger btn-sm" id="confirmModalConfirmBtn">Evet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // GitHub ile senkronizasyon fonksiyonlarƒ±
        async function saveToGitHub(filePath, data, message = 'Update data') {
            if (!GITHUB_CONFIG.token) {
                showNotification('GitHub token bulunamadƒ±!', 'error');
                return false;
            }

            try {
                // √ñnce dosyanƒ±n mevcut SHA'sƒ±nƒ± al
                const getResponse = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }

                // Dosyayƒ± g√ºncelle veya olu≈ütur
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const updateData = {
                    message: message,
                    content: content
                };

                if (sha) {
                    updateData.sha = sha;
                }

                const response = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    console.log(`‚úÖ ${filePath} GitHub'a kaydedildi`);
                    return true;
                } else {
                    const error = await response.json();
                    console.error(`‚ùå ${filePath} GitHub'a kaydedilemedi:`, error);
                    return false;
                }
            } catch (error) {
                console.error(`‚ùå GitHub kayƒ±t hatasƒ± (${filePath}):`, error);
                return false;
            }
        }

        // Verileri GitHub'a kaydetme wrapper fonksiyonlarƒ±
        async function savePatientDataToGitHub() {
            if (window.patients) {
                return await saveToGitHub('data/patients_list.json', window.patients, 'Update patients data');
            }
            return false;
        }

        async function saveMealDataToGitHub() {
            if (window.meals) {
                return await saveToGitHub('meals_new.json', window.meals, 'Update meals data');
            }
            return false;
        }

        async function saveRulesToGitHub() {
            if (window.systemRules) {
                return await saveToGitHub('data/rules.json', window.systemRules, 'Update system rules');
            }
            return false;
        }

        // T√ºm verileri GitHub'a kaydet
        async function saveAllDataToGitHub() {
            if (!GITHUB_CONFIG.token) {
                showNotification('GitHub token gerekli!', 'error');
                return;
            }

            const results = [];
            showNotification('T√ºm veriler GitHub\'a kaydediliyor...', 'info');

            try {
                if (window.patients) {
                    results.push(await savePatientDataToGitHub());
                }
                if (window.meals) {
                    results.push(await saveMealDataToGitHub());
                }
                if (window.systemRules) {
                    results.push(await saveRulesToGitHub());
                }
                if (window.doctors) {
                    results.push(await saveToGitHub('data/doctors_list.json', window.doctors, 'Update doctors data'));
                }
                if (window.dietitians) {
                    results.push(await saveToGitHub('data/dietitians_list.json', window.dietitians, 'Update dietitians data'));
                }

                const successCount = results.filter(r => r).length;
                const totalCount = results.length;

                if (successCount === totalCount && totalCount > 0) {
                    showNotification(`T√ºm veriler (${successCount}/${totalCount}) ba≈üarƒ±yla kaydedildi!`, 'success');
                    localStorage.setItem('lastSync', new Date().toLocaleString('tr-TR'));
                    updateLastSyncTime();
                } else {
                    showNotification(`Kƒ±smi kayƒ±t: ${successCount}/${totalCount} dosya kaydedildi`, 'warning');
                }
            } catch (error) {
                showNotification('Kayƒ±t hatasƒ±: ' + error.message, 'error');
            }
        }

        // GitHub dosya listesini g√∂ster
        async function showGitHubFileList() {
            if (!GITHUB_CONFIG.token) {
                showNotification('GitHub token gerekli!', 'error');
                return;
            }

            try {
                const response = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const files = await response.json();
                    const fileList = files.map(f => `‚Ä¢ ${f.name} (${f.type})`).join('\n');
                    alert(`GitHub Repository Dosyalarƒ±:\n\n${fileList}`);
                } else {
                    showNotification('Dosya listesi alƒ±namadƒ±', 'error');
                }
            } catch (error) {
                showNotification('Dosya listesi hatasƒ±: ' + error.message, 'error');
            }
        }

        // Son senkronizasyon zamanƒ±nƒ± g√ºncelle
        function updateLastSyncTime() {
            const lastSync = localStorage.getItem('lastSync');
            const lastSyncElement = document.getElementById('lastSync');
            if (lastSyncElement) {
                lastSyncElement.textContent = lastSync || '-';
            }
        }

        // Baƒülantƒ± durumunu g√ºncelle
        function updateConnectionStatusDisplay() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (GITHUB_CONFIG.token) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Baƒülƒ±';
                } else {
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = 'Baƒülƒ± Deƒüil';
                }
            }
        }

        // GitHub y√∂netim panelini g√∂ster
        function showGitHubManager() {
            if (!GITHUB_CONFIG.token) {
                showNotification('√ñnce GitHub token girin!', 'warning');
                document.getElementById('githubLoginOverlay').classList.remove('hidden');
                return;
            }
            
            alert(`GitHub Y√∂netimi
            
Repository: ${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}
Token: ‚úÖ Aktif
Baƒülantƒ±: ‚úÖ Ba≈üarƒ±lƒ±
            
Mevcut Fonksiyonlar:
‚Ä¢ Verileri Yenile (Dashboard'dan)
‚Ä¢ T√ºm Verileri Kaydet (Dashboard'dan)  
‚Ä¢ Dosya Listesi G√∂r√ºnt√ºle (Dashboard'dan)
‚Ä¢ Otomatik Senkronizasyon: Aktif
            
Desteklenen Dosyalar:
‚Ä¢ meals_new.json
‚Ä¢ data/patients_list.json
‚Ä¢ data/doctors_list.json
‚Ä¢ data/dietitians_list.json
‚Ä¢ data/rules.json
‚Ä¢ data/system_settings.json
‚Ä¢ data/diet_config.json`);
        }

        // Sayfa y√ºklendiƒüinde baƒülantƒ± durumunu g√ºncelle
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatusDisplay();
            updateLastSyncTime();
            
            // GitHub token kontrol√º mevcut fonksiyona entegre ediyoruz
            setTimeout(() => {
                updateConnectionStatusDisplay();
            }, 1000);
        });

        // Enter tu≈üu ile token giri≈üi
        async function saveToGitHub(filePath, data, message = 'Update data', retryCount = 0) {
            if (!GITHUB_CONFIG.token) {
                showNotification('GitHub token bulunamadƒ±!', 'error');
                return false;
            }

            try {
                // √ñnce dosyanƒ±n mevcut SHA'sƒ±nƒ± al
                const getResponse = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    console.log(`üîç [GITHUB-RETRY-${retryCount}] Mevcut SHA alƒ±ndƒ±: ${sha.substring(0, 8)}...`);
                }

                // Dosyayƒ± g√ºncelle veya olu≈ütur
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const updateData = {
                    message: message,
                    content: content
                };

                if (sha) {
                    updateData.sha = sha;
                }

                const response = await fetch(
                    `${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    console.log(`‚úÖ ${filePath} GitHub'a kaydedildi`);
                    return true;
                } else {
                    const error = await response.json();
                    console.error(`‚ùå ${filePath} GitHub'a kaydedilemedi:`, error);
                    return false;
                }
            } catch (error) {
                console.error(`‚ùå GitHub kayƒ±t hatasƒ± (${filePath}):`, error);
                return false;
            }
        }

        // Verileri GitHub'a kaydetme wrapper fonksiyonlarƒ±
        async function savePatientDataToGitHub() {
            if (window.patients) {
                return await saveToGitHub('data/patients_list.json', window.patients, 'Update patients data');
            }
            return false;
        }

        async function saveMealDataToGitHub() {
            if (window.meals) {
                return await saveToGitHub('meals_new.json', window.meals, 'Update meals data');
            }
            return false;
        }

        async function saveRulesToGitHub() {
            if (window.systemRules) {
                return await saveToGitHub('data/rules.json', window.systemRules, 'Update system rules');
            }
            return false;
        }

        // GitHub verilerini kontrol etme
        async function syncWithGitHub() {
            if (!GITHUB_CONFIG.token) {
                showNotification('GitHub token gerekli!', 'error');
                return;
            }

            try {
                showNotification('GitHub ile senkronizasyon ba≈ülƒ±yor...', 'info');
                
                // Verileri yeniden y√ºkle
                await loadSystemDataFromGitHub();
                
                showNotification('GitHub senkronizasyonu tamamlandƒ±!', 'success');
            } catch (error) {
                showNotification('Senkronizasyon hatasƒ±: ' + error.message, 'error');
            }
        }

        // Enter tu≈üu ile token giri≈üi
        document.addEventListener('DOMContentLoaded', function() {
            const tokenInput = document.getElementById('githubToken');
            if (tokenInput) {
                tokenInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        connectGitHub();
                    }
                });
            }
        });
    </script>
</body>
</html>
