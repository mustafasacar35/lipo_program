/**
 * GELI≈ûMI≈û PLANLAMA FAKT√ñRLERƒ∞ Sƒ∞STEMƒ∞ v2.0
 * Hiyerar≈üik √∂ncelik sistemi ile akƒ±llƒ± plan olu≈üturma
 */

class AdvancedPlanningFactors {
    constructor() {
        this.factorHierarchy = this.initializeFactorHierarchy();
        this.planningRules = this.initializePlanningRules();
        this.scoringWeights = this.initializeScoringWeights();
        console.log('üéØ Geli≈ümi≈ü Planlama Fakt√∂rleri sistemi ba≈ülatƒ±ldƒ±');
    }

    // üî• FAKT√ñR Hƒ∞YERAR≈ûƒ∞Sƒ∞ (En √∂nemli -> En az √∂nemli)
    initializeFactorHierarchy() {
        return {
            // =====================================
            // 1Ô∏è‚É£ KRƒ∞Tƒ∞K FAKT√ñRLER (90-100 puan)
            // =====================================
            CRITICAL: {
                allergyRestrictions: {
                    priority: 100,
                    weight: 1.0,
                    type: 'BLOCKING', // Bu fail olursa plan iptal
                    description: 'Alerji ve intolerans kƒ±sƒ±tlamalarƒ±',
                    checkMethod: 'checkAllergyCompliance'
                },
                mealTypeCompliance: {
                    priority: 98,
                    weight: 0.98,
                    type: 'BLOCKING',
                    description: '√ñƒü√ºn tipi uyumluluƒüu (kahvaltƒ±lƒ±k yemek √∂ƒüleye gidemez)',
                    checkMethod: 'checkMealTypeCompliance'
                },
                dietTypeCompliance: {
                    priority: 96,
                    weight: 0.96,
                    type: 'BLOCKING',
                    description: 'Diyet tipi uyumluluƒüu (keto yemeƒüi lowcarb diyetine gidemez)',
                    checkMethod: 'checkDietTypeCompliance'
                },
                seasonCompliance: {
                    priority: 94,
                    weight: 0.94,
                    type: 'BLOCKING',
                    description: 'Sezon uyumluluƒüu (mevsim dƒ±≈üƒ± yemek verilemez)',
                    checkMethod: 'checkSeasonCompliance'
                },
                medicalDiet: {
                    priority: 92,
                    weight: 0.92,
                    type: 'STRICT',
                    description: 'Medikal diyet gereklilikleri (diyabet, kalp vb.)',
                    checkMethod: 'checkMedicalCompliance'
                },
                calorieConstraints: {
                    priority: 90,
                    weight: 0.90,
                    type: 'STRICT',
                    tolerance: 0.15, // %15 tolerans
                    description: 'G√ºnl√ºk kalori hedefleri',
                    checkMethod: 'checkCalorieCompliance'
                }
            },

            // =====================================
            // 2Ô∏è‚É£ TEMEL FAKT√ñRLER (70-89 puan)
            // =====================================
            PRIMARY: {
                macroBalance: {
                    priority: 85,
                    weight: 0.85,
                    type: 'HIGH_PRIORITY',
                    tolerance: 0.20, // %20 tolerans
                    description: 'Makro besin dengeleri (P/C/F oranlarƒ±)',
                    checkMethod: 'checkMacroBalance'
                },
                mealDistribution: {
                    priority: 80,
                    weight: 0.80,
                    type: 'HIGH_PRIORITY',
                    description: '√ñƒü√ºn daƒüƒ±lƒ±mƒ± ve kalori oranlarƒ±',
                    checkMethod: 'checkMealDistribution'
                },
                dietTypeCompliance: {
                    priority: 75,
                    weight: 0.75,
                    type: 'HIGH_PRIORITY',
                    description: 'Diyet tipi uyumluluƒüu (keto, vegan vb.)',
                    checkMethod: 'checkDietTypeCompliance'
                },
                nutritionalCompleteness: {
                    priority: 72,
                    weight: 0.72,
                    type: 'HIGH_PRIORITY',
                    description: 'Besinsel tamlƒ±k (vitamin, mineral)',
                    checkMethod: 'checkNutritionalCompleteness'
                }
            },

            // =====================================
            // 3Ô∏è‚É£ OPTƒ∞Mƒ∞ZASYON FAKT√ñRLERƒ∞ (50-69 puan)
            // =====================================
            OPTIMIZATION: {
                varietyScore: {
                    priority: 68,
                    weight: 0.68,
                    type: 'MEDIUM_PRIORITY',
                    description: '√áe≈üitlilik ve tekrar √∂nleme',
                    checkMethod: 'calculateVarietyScore'
                },
                favoriteBoost: {
                    priority: 65,
                    weight: 0.65,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Sevilen yemeklerin pozitif ayrƒ±mcƒ±lƒ±ƒüƒ±',
                    checkMethod: 'calculateFavoriteBoost'
                },
                compatibilityMagnetism: {
                    priority: 62,
                    weight: 0.62,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Yemekler arasƒ± uyumluluk manyetizmasƒ±',
                    checkMethod: 'checkMealCompatibility'
                },
                fillerOptimization: {
                    priority: 60,
                    weight: 0.60,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Dolgu yemekler ile makro a√ßƒ±k kapatma',
                    checkMethod: 'checkFillerOptimization'
                },
                seasonalPreference: {
                    priority: 58,
                    weight: 0.58,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Mevsimsel uygunluk tercihi',
                    checkMethod: 'checkSeasonalPreference'
                },
                portionOptimization: {
                    priority: 55,
                    weight: 0.55,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Porsiyon katsayƒ±larƒ± optimizasyonu',
                    checkMethod: 'checkPortionOptimization'
                },
                cookingComplexity: {
                    priority: 52,
                    weight: 0.52,
                    type: 'MEDIUM_PRIORITY',
                    description: 'Pi≈üirme zorluƒüu dengesi',
                    checkMethod: 'checkCookingComplexity'
                }
            },

            // =====================================
            // 4Ô∏è‚É£ TERCƒ∞H FAKT√ñRLERƒ∞ (20-49 puan)
            // =====================================
            PREFERENCE: {
                personalTastes: {
                    priority: 45,
                    weight: 0.45,
                    type: 'LOW_PRIORITY',
                    description: 'Ki≈üisel tat tercihleri',
                    checkMethod: 'checkPersonalTastes'
                },
                culturalPreference: {
                    priority: 40,
                    weight: 0.40,
                    type: 'LOW_PRIORITY',
                    description: 'K√ºlt√ºrel yemek tercihleri',
                    checkMethod: 'checkCulturalPreference'
                },
                budgetConstraints: {
                    priority: 35,
                    weight: 0.35,
                    type: 'LOW_PRIORITY',
                    description: 'B√ºt√ße kƒ±sƒ±tlamalarƒ±',
                    checkMethod: 'checkBudgetConstraints'
                },
                preparationTime: {
                    priority: 30,
                    weight: 0.30,
                    type: 'LOW_PRIORITY',
                    description: 'Hazƒ±rlama s√ºresi tercihleri',
                    checkMethod: 'checkPreparationTime'
                }
            }
        };
    }

    // üéØ PLANLAMA KURALLARI
    initializePlanningRules() {
        return {
            // Kalori daƒüƒ±lƒ±m kurallarƒ±
            calorieDistribution: {
                breakfast: { min: 20, max: 30, ideal: 25 }, // %25
                lunch: { min: 30, max: 40, ideal: 35 },     // %35  
                dinner: { min: 25, max: 35, ideal: 30 },    // %30
                snack: { min: 5, max: 15, ideal: 10 }       // %10
            },

            // Makro besin kurallarƒ±
            macroRatios: {
                balanced: { protein: 20, carbs: 50, fat: 30 },
                lowcarb: { protein: 25, carbs: 30, fat: 45 },
                keto: { protein: 20, carbs: 10, fat: 70 },
                highprotein: { protein: 35, carbs: 35, fat: 30 },
                vegan: { protein: 15, carbs: 60, fat: 25 }
            },

            // √áe≈üitlilik kurallarƒ±
            varietyRules: {
                maxSameCategory: 2,      // Aynƒ± kategoriden max 2 yemek/g√ºn
                maxSameMeal: 1,          // Aynƒ± yemek max 1 kez/g√ºn  
                weeklyVariety: 70,       // Haftalƒ±k %70 farklƒ± yemek
                avoidConsecutive: true   // Aynƒ± yemek ard arda g√ºn gelmesin
            },

            // Uyumluluk kurallarƒ±
            compatibilityRules: {
                avoidConflicts: true,           // √áeli≈üen yemekleri √∂nle
                enforceComplements: true,       // Tamamlayƒ±cƒ± yemekleri te≈üvik et
                respectMealStructure: true      // √ñƒü√ºn yapƒ±sƒ±na uy (√ßorba+ana+yan)
            }
        };
    }

    // üìä SKORLAMA AƒûIRLIKLARI
    initializeScoringWeights() {
        return {
            // Toplam skor hesaplama aƒüƒ±rlƒ±klarƒ±
            CRITICAL: 0.5,      // %50 - Kritik fakt√∂rler
            PRIMARY: 0.3,       // %30 - Temel fakt√∂rler  
            OPTIMIZATION: 0.15, // %15 - Optimizasyon fakt√∂rleri
            PREFERENCE: 0.05,   // %5  - Tercih fakt√∂rleri
            
            // Bonus/ceza √ßarpanlarƒ±
            bonusMultipliers: {
                perfectMatch: 1.2,      // M√ºkemmel e≈üle≈üme %20 bonus
                goodVariety: 1.1,       // ƒ∞yi √ße≈üitlilik %10 bonus
                seasonalMatch: 1.05     // Mevsimsel uyum %5 bonus
            },
            
            penaltyMultipliers: {
                allergyViolation: 0,    // Alerji ihlali = 0 puan
                medicalViolation: 0.1,  // Medikal ihlal %90 ceza
                calorieMismatch: 0.7,   // Kalori uyumsuzluƒüu %30 ceza
                poorVariety: 0.8        // K√∂t√º √ße≈üitlilik %20 ceza
            }
        };
    }

    // üéØ ANA DEƒûERLENDƒ∞RME FONKSƒ∞YONU
    evaluatePlanCandidate(planCandidate, patientProfile, planningContext) {
        const evaluation = {
            totalScore: 0,
            categoryScores: {},
            violations: [],
            recommendations: [],
            isValid: true
        };

        try {
            // 1. Kritik fakt√∂rleri deƒüerlendir (BLOCKING)
            const criticalScore = this.evaluateCriticalFactors(planCandidate, patientProfile);
            if (criticalScore.hasBlockingViolations) {
                evaluation.isValid = false;
                evaluation.violations.push(...criticalScore.violations);
                return evaluation; // Kritik hata varsa diƒüerlerini kontrol etme
            }
            evaluation.categoryScores.CRITICAL = criticalScore.score;

            // 2. Temel fakt√∂rleri deƒüerlendir
            const primaryScore = this.evaluatePrimaryFactors(planCandidate, patientProfile);
            evaluation.categoryScores.PRIMARY = primaryScore.score;
            evaluation.violations.push(...primaryScore.violations);

            // 3. Optimizasyon fakt√∂rlerini deƒüerlendir
            const optimizationScore = this.evaluateOptimizationFactors(planCandidate, planningContext);
            evaluation.categoryScores.OPTIMIZATION = optimizationScore.score;

            // 4. Tercih fakt√∂rlerini deƒüerlendir
            const preferenceScore = this.evaluatePreferenceFactors(planCandidate, patientProfile);
            evaluation.categoryScores.PREFERENCE = preferenceScore.score;

            // 5. Toplam skoru hesapla
            evaluation.totalScore = this.calculateTotalScore(evaluation.categoryScores);

            // 6. √ñnerileri olu≈ütur
            evaluation.recommendations = this.generateRecommendations(evaluation);

            console.log('üìä Plan adayƒ± deƒüerlendirildi:', {
                totalScore: evaluation.totalScore.toFixed(2),
                isValid: evaluation.isValid,
                violations: evaluation.violations.length
            });

            return evaluation;

        } catch (error) {
            console.error('‚ùå Plan deƒüerlendirme hatasƒ±:', error);
            evaluation.isValid = false;
            evaluation.violations.push({
                type: 'SYSTEM_ERROR',
                severity: 'CRITICAL',
                message: 'Plan deƒüerlendirme sistemi hatasƒ±: ' + error.message
            });
            return evaluation;
        }
    }

    // üö® KRƒ∞Tƒ∞K FAKT√ñR DEƒûERLENDƒ∞RMESƒ∞
    evaluateCriticalFactors(planCandidate, patientProfile) {
        const result = {
            score: 0,
            violations: [],
            hasBlockingViolations: false
        };

        const criticalFactors = this.factorHierarchy.CRITICAL;
        let totalWeight = 0;
        let weightedScore = 0;

        for (const [factorName, factor] of Object.entries(criticalFactors)) {
            try {
                // Her kritik fakt√∂r√º kontrol et
                const factorResult = this[factor.checkMethod](planCandidate, patientProfile, factor);
                
                if (factorResult.isBlocking) {
                    result.hasBlockingViolations = true;
                    result.violations.push({
                        type: 'BLOCKING',
                        factor: factorName,
                        severity: 'CRITICAL',
                        message: factorResult.message,
                        details: factorResult.details
                    });
                }

                weightedScore += factorResult.score * factor.weight;
                totalWeight += factor.weight;

            } catch (error) {
                console.error(`‚ùå Kritik fakt√∂r hatasƒ± [${factorName}]:`, error);
                result.hasBlockingViolations = true;
                result.violations.push({
                    type: 'SYSTEM_ERROR',
                    factor: factorName,
                    severity: 'CRITICAL',
                    message: `Sistem hatasƒ±: ${error.message}`
                });
            }
        }

        result.score = totalWeight > 0 ? (weightedScore / totalWeight) * 100 : 0;
        return result;
    }

    // üéØ TEMEL FAKT√ñR DEƒûERLENDƒ∞RMESƒ∞  
    evaluatePrimaryFactors(planCandidate, patientProfile) {
        const result = {
            score: 0,
            violations: []
        };

        const primaryFactors = this.factorHierarchy.PRIMARY;
        let totalWeight = 0;
        let weightedScore = 0;

        for (const [factorName, factor] of Object.entries(primaryFactors)) {
            try {
                const factorResult = this[factor.checkMethod](planCandidate, patientProfile, factor);
                
                if (factorResult.violations && factorResult.violations.length > 0) {
                    result.violations.push(...factorResult.violations.map(v => ({
                        ...v,
                        factor: factorName,
                        severity: 'HIGH'
                    })));
                }

                weightedScore += factorResult.score * factor.weight;
                totalWeight += factor.weight;

            } catch (error) {
                console.error(`‚ùå Temel fakt√∂r hatasƒ± [${factorName}]:`, error);
                result.violations.push({
                    type: 'SYSTEM_ERROR',
                    factor: factorName,
                    severity: 'HIGH',
                    message: `Sistem hatasƒ±: ${error.message}`
                });
            }
        }

        result.score = totalWeight > 0 ? (weightedScore / totalWeight) * 100 : 0;
        return result;
    }

    // üéØ OPTƒ∞Mƒ∞ZASYON FAKT√ñR DEƒûERLENDƒ∞RMESƒ∞
    evaluateOptimizationFactors(planCandidate, planningContext) {
        const result = { score: 0 };
        // Implementation will be added
        return result;
    }

    // üéØ TERCƒ∞H FAKT√ñR DEƒûERLENDƒ∞RMESƒ∞
    evaluatePreferenceFactors(planCandidate, patientProfile) {
        const result = { score: 0 };
        // Implementation will be added  
        return result;
    }

    // üìä TOPLAM SKOR HESAPLAMA
    calculateTotalScore(categoryScores) {
        const weights = this.scoringWeights;
        
        const critical = (categoryScores.CRITICAL || 0) * weights.CRITICAL;
        const primary = (categoryScores.PRIMARY || 0) * weights.PRIMARY;
        const optimization = (categoryScores.OPTIMIZATION || 0) * weights.OPTIMIZATION;
        const preference = (categoryScores.PREFERENCE || 0) * weights.PREFERENCE;

        return critical + primary + optimization + preference;
    }

    // üí° √ñNERƒ∞ OLU≈ûTURMA
    generateRecommendations(evaluation) {
        const recommendations = [];
        
        if (evaluation.totalScore < 60) {
            recommendations.push({
                type: 'WARNING',
                message: 'Plan kalitesi d√º≈ü√ºk. Daha iyi alternatifler aranmalƒ±.',
                priority: 'HIGH'
            });
        }

        if (evaluation.violations.length > 0) {
            recommendations.push({
                type: 'IMPROVEMENT',
                message: `${evaluation.violations.length} kural ihlali tespit edildi.`,
                priority: 'MEDIUM',
                details: evaluation.violations
            });
        }

        return recommendations;
    }

    // ======================================================================
    // üîç KRƒ∞Tƒ∞K FAKT√ñR KONTROL METODLARƒ∞
    // ======================================================================

    checkAllergyCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            details: {}
        };

        // Alerji/ƒ∞stememe listesi kontrol√º (LEVEL 1 - MUTLAK KURAL)
        const allergies = patientProfile.allergies || [];
        const dislikes = patientProfile.dislikes || [];
        const forbiddenItems = [...allergies, ...dislikes];

        if (forbiddenItems.length === 0) {
            result.message = 'Alerji/ƒ∞stememe kƒ±sƒ±tlamasƒ± yok';
            return result;
        }

        // Plan i√ßindeki t√ºm yemekleri kontrol et
        const violations = [];
        
        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    // üîç YENƒ∞: Geli≈ümi≈ü alerji kontrol√º
                    const foodViolations = this.checkFoodForViolations(food, forbiddenItems);
                    
                    if (foodViolations.length > 0) {
                        violations.push({
                            day: day.dayNumber,
                            meal: meal.type,
                            food: food.name || food.adi,
                            violations: foodViolations,
                            foodTags: food.tags || [],
                            reason: 'Alerji/ƒ∞stememe listesinde'
                        });
                    }
                }
            }
        }

        if (violations.length > 0) {
            result.score = 0;
            result.isBlocking = true; // MUTLAK ENGELLEME
            result.message = `${violations.length} alerji/istememe ihlali tespit edildi`;
            result.details = { violations };
        } else {
            result.message = 'Alerji/ƒ∞stememe kontrol√º ba≈üarƒ±lƒ±';
        }

        return result;
    }

    // üîç YENƒ∞: Yemekte yasak madde kontrol√º
    checkFoodForViolations(food, forbiddenItems) {
        const violations = [];
        const foodName = (food.name || food.adi || '').toLowerCase();
        const foodTags = (food.tags || []).map(tag => tag.toLowerCase());
        
        for (const forbidden of forbiddenItems) {
            const forbiddenLower = forbidden.toLowerCase();
            
            // 1. Yemek adƒ±nda ge√ßiyor mu?
            if (foodName.includes(forbiddenLower)) {
                violations.push({
                    type: 'NAME_MATCH',
                    forbidden: forbidden,
                    matched: 'name'
                });
            }
            
            // 2. Tags i√ßinde ge√ßiyor mu?
            const matchedTag = foodTags.find(tag => 
                tag.includes(forbiddenLower) || forbiddenLower.includes(tag)
            );
            
            if (matchedTag) {
                violations.push({
                    type: 'TAG_MATCH',
                    forbidden: forbidden,
                    matched: matchedTag
                });
            }
        }
        
        return violations;
    }

    checkMedicalCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            details: {}
        };

        if (!patientProfile.medicalConditions || patientProfile.medicalConditions.length === 0) {
            result.message = 'Medikal kƒ±sƒ±tlama yok';
            return result;
        }

        // Medikal kƒ±sƒ±tlamalarƒ± kontrol et
        const medicalViolations = [];

        // √ñrnek: Diyabet hastasƒ± i√ßin ≈üeker kƒ±sƒ±tlamasƒ±
        if (patientProfile.medicalConditions.includes('diabetes')) {
            const sugarViolations = this.checkSugarRestrictions(planCandidate);
            if (sugarViolations.length > 0) {
                medicalViolations.push(...sugarViolations);
            }
        }

        // √ñrnek: Kalp hastasƒ± i√ßin sodyum kƒ±sƒ±tlamasƒ±
        if (patientProfile.medicalConditions.includes('heart_disease')) {
            const sodiumViolations = this.checkSodiumRestrictions(planCandidate);
            if (sodiumViolations.length > 0) {
                medicalViolations.push(...sodiumViolations);
            }
        }

        if (medicalViolations.length > 0) {
            result.score = 20; // %80 ceza ama tamamen bloklamƒ±yor
            result.isBlocking = false;
            result.message = `${medicalViolations.length} medikal kƒ±sƒ±tlama ihlali`;
            result.details = { violations: medicalViolations };
        } else {
            result.message = 'Medikal kƒ±sƒ±tlama kontrol√º ba≈üarƒ±lƒ±';
        }

        return result;
    }

    checkCalorieCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            details: {}
        };

        const targetCalories = patientProfile.targetCalories || 2000;
        const tolerance = factor.tolerance || 0.15; // %15 tolerans
        const minCalories = targetCalories * (1 - tolerance);
        const maxCalories = targetCalories * (1 + tolerance);

        let totalCaloriesViolations = 0;
        const dailyCalories = [];

        // Her g√ºn√ºn toplam kalorisini hesapla
        for (const day of planCandidate.days) {
            let dayTotalCalories = 0;
            
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    dayTotalCalories += food.calories || 0;
                }
            }
            
            dailyCalories.push({
                day: day.dayNumber,
                calories: dayTotalCalories,
                target: targetCalories,
                inRange: dayTotalCalories >= minCalories && dayTotalCalories <= maxCalories
            });

            if (!dailyCalories[dailyCalories.length - 1].inRange) {
                totalCaloriesViolations++;
            }
        }

        // Skorlama
        const violationRatio = totalCaloriesViolations / planCandidate.days.length;
        
        if (violationRatio > 0.5) { // %50'den fazla g√ºn ihlal
            result.score = 30;
            result.isBlocking = false;
            result.message = `Kalori hedefi ${totalCaloriesViolations} g√ºnde ihlal edildi`;
        } else if (violationRatio > 0.2) { // %20'den fazla g√ºn ihlal
            result.score = 70;
            result.message = `Kalori hedefi bazƒ± g√ºnlerde ihlal edildi`;
        } else {
            result.message = 'Kalori hedefi uygun aralƒ±kta';
        }

        result.details = {
            targetCalories,
            toleranceRange: [minCalories, maxCalories],
            dailyCalories,
            violationDays: totalCaloriesViolations
        };

        return result;
    }

    // Yardƒ±mcƒ± metodlar
    checkSugarRestrictions(planCandidate) {
        // Diyabet hastasƒ± i√ßin ≈üeker kontrol√º implementasyonu
        return [];
    }

    checkSodiumRestrictions(planCandidate) {
        // Kalp hastasƒ± i√ßin sodyum kontrol√º implementasyonu  
        return [];
    }

    // Diƒüer kontrol metodlarƒ± buraya eklenecek...
    checkMacroBalance(planCandidate, patientProfile, factor) {
        return { score: 80, violations: [] };
    }

    checkMealDistribution(planCandidate, patientProfile, factor) {
        return { score: 85, violations: [] };
    }

    checkDietTypeCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            violations: [],
            details: {}
        };

        const patientDietType = patientProfile.dietType;
        if (!patientDietType) {
            result.message = 'Diyet tipi belirtilmemi≈ü';
            return result;
        }

        const violations = [];

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    // üéØ YENƒ∞: Diyet uyumluluk kontrol√º (veritabanƒ± yapƒ±sƒ±na g√∂re)
                    const isDietCompliant = this.checkFoodDietCompliance(food, patientDietType);
                    
                    if (!isDietCompliant.isCompliant) {
                        violations.push({
                            day: day.dayNumber,
                            meal: meal.type,
                            food: food.name || food.adi,
                            dietType: patientDietType,
                            reason: isDietCompliant.reason,
                            availableDiets: isDietCompliant.availableDiets
                        });
                    }
                }
            }
        }

        if (violations.length > 0) {
            result.score = 20; // Aƒüƒ±r ceza ama bloklamƒ±yor
            result.isBlocking = false;
            result.message = `${violations.length} diyet uyumsuzluƒüu tespit edildi`;
            result.violations = violations.map(v => ({
                type: 'DIET_VIOLATION',
                severity: 'HIGH',
                message: `${v.food} yemeƒüi ${v.dietType} diyetine uygun deƒüil`,
                details: v
            }));
        } else {
            result.message = `${patientDietType} diyet uyumluluƒüu ba≈üarƒ±lƒ±`;
        }

        return result;
    }

    // üéØ YENƒ∞: Yemek diyet uyumluluƒüu kontrol√º
    checkFoodDietCompliance(food, requiredDietType) {
        const result = {
            isCompliant: false,
            reason: '',
            availableDiets: []
        };

        // Mevcut diyet t√ºrlerine g√∂re kontrol et
        const dietFields = ['keto', 'lowcarb']; // Geni≈ületilebilir
        
        for (const diet of dietFields) {
            if (food[diet] === true) {
                result.availableDiets.push(diet);
            }
        }

        // Gerekli diyet tipine uygun mu?
        switch (requiredDietType.toLowerCase()) {
            case 'keto':
            case 'ketogenic':
                result.isCompliant = food.keto === true;
                break;
            case 'lowcarb':
            case 'low-carb':
                result.isCompliant = food.lowcarb === true;
                break;
            default:
                result.isCompliant = true; // Genel beslenme i√ßin t√ºm yemekler uygun
                break;
        }

        if (!result.isCompliant) {
            result.reason = `Yemek ${requiredDietType} diyeti i√ßin i≈üaretlenmemi≈ü`;
        }

        return result;
    }

    checkNutritionalCompleteness(planCandidate, patientProfile, factor) {
        return { score: 75, violations: [] };
    }

    // üéØ YENƒ∞: MealType uyumluluƒüu kontrol√º (LEVEL 1 - MUTLAK KURAL)
    checkMealTypeCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            details: {}
        };

        const violations = [];

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                const mealTypeName = meal.type; // breakfast, lunch, dinner
                
                for (const food of meal.foods) {
                    const allowedMealTypes = food.mealType || [];
                    
                    // üö´ MUTLAK KURAL: Yemek bu √∂ƒü√ºne verilebilir mi?
                    if (!this.isMealTypeAllowed(mealTypeName, allowedMealTypes)) {
                        violations.push({
                            day: day.dayNumber,
                            meal: mealTypeName,
                            food: food.name || food.adi,
                            allowedMealTypes: allowedMealTypes,
                            reason: `${food.name} sadece ${allowedMealTypes.join(', ')} √∂ƒü√ºnlerinde verilebilir`
                        });
                    }
                }
            }
        }

        if (violations.length > 0) {
            result.score = 0;
            result.isBlocking = true; // MUTLAK ENGELLEME
            result.message = `${violations.length} √∂ƒü√ºn tipi ihlali tespit edildi`;
            result.details = { violations };
        } else {
            result.message = '√ñƒü√ºn tipi uyumluluƒüu ba≈üarƒ±lƒ±';
        }

        return result;
    }

    // Yardƒ±mcƒ± method: MealType izin kontrol√º
    isMealTypeAllowed(currentMealType, allowedMealTypes) {
        if (!allowedMealTypes || allowedMealTypes.length === 0) {
            return true; // Kƒ±sƒ±tlama yoksa her √∂ƒü√ºne verilebilir
        }

        // T√ºrk√ße-ƒ∞ngilizce √ßeviri mapping
        const mealTypeMapping = {
            'breakfast': ['breakfast', 'kahvaltƒ±'],
            'lunch': ['lunch', '√∂ƒüle', '√ñƒûLEN'],
            'dinner': ['dinner', 'ak≈üam', 'AK≈ûAM'],
            'snack': ['snack', 'ara √∂ƒü√ºn']
        };

        const currentVariants = mealTypeMapping[currentMealType.toLowerCase()] || [currentMealType];
        
        return allowedMealTypes.some(allowed => 
            currentVariants.includes(allowed.toLowerCase()) ||
            currentVariants.some(variant => allowed.toLowerCase().includes(variant))
        );
    }

    // üéØ YENƒ∞: Sezon uyumluluƒüu kontrol√º (LEVEL 1 - MUTLAK KURAL)
    checkSeasonCompliance(planCandidate, patientProfile, factor) {
        const result = {
            score: 100,
            isBlocking: false,
            message: '',
            details: {}
        };

        const currentMonth = new Date().getMonth() + 1; // 1-12
        const violations = [];

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    const seasonCompliance = this.checkFoodSeasonCompliance(food, currentMonth);
                    
                    if (!seasonCompliance.isCompliant) {
                        violations.push({
                            day: day.dayNumber,
                            meal: meal.type,
                            food: food.name || food.adi,
                            currentMonth: currentMonth,
                            allowedRange: seasonCompliance.allowedRange,
                            reason: seasonCompliance.reason
                        });
                    }
                }
            }
        }

        if (violations.length > 0) {
            result.score = 0;
            result.isBlocking = true; // MUTLAK ENGELLEME
            result.message = `${violations.length} sezon uyumsuzluƒüu tespit edildi`;
            result.details = { violations };
        } else {
            result.message = 'Sezon uyumluluƒüu ba≈üarƒ±lƒ±';
        }

        return result;
    }

    // Yardƒ±mcƒ± method: Sezon uyumluluk kontrol√º
    checkFoodSeasonCompliance(food, currentMonth) {
        const result = {
            isCompliant: true,
            reason: '',
            allowedRange: []
        };

        let seasonRange = food.seasonRange;
        if (!seasonRange) {
            return result; // Sezon kƒ±sƒ±tlamasƒ± yoksa her zaman uygun
        }

        // JSON string format kontrol√º "[1,12]" -> [1,12]
        if (typeof seasonRange === 'string') {
            try {
                seasonRange = JSON.parse(seasonRange);
            } catch (e) {
                console.warn('Sezon aralƒ±ƒüƒ± parse edilemedi:', seasonRange);
                return result;
            }
        }

        if (!Array.isArray(seasonRange) || seasonRange.length !== 2) {
            return result;
        }

        const [startMonth, endMonth] = seasonRange;
        result.allowedRange = seasonRange;

        // Tersine sezon kontrol√º (isReversedSeason)
        if (food.isReversedSeason) {
            // Ters sezon: belirtilen aralƒ±k Dƒ±≈üINDA uygun
            if (currentMonth >= startMonth && currentMonth <= endMonth) {
                result.isCompliant = false;
                result.reason = `Ters sezon yemeƒüi - ${startMonth}-${endMonth} aylarƒ± arasƒ±nda verilemez`;
            }
        } else {
            // Normal sezon: belirtilen aralƒ±k ƒ∞√áƒ∞NDE uygun
            if (currentMonth < startMonth || currentMonth > endMonth) {
                result.isCompliant = false;
                result.reason = `Sadece ${startMonth}-${endMonth} aylarƒ± arasƒ±nda verilebilir`;
            }
        }

        return result;
    }

    calculateVarietyScore(planCandidate, planningContext, factor) {
        return { score: 70 };
    }

    // üåü YENƒ∞: Sevilen yemeklerin pozitif ayrƒ±mcƒ±lƒ±k hesabƒ±
    calculateFavoriteBoost(planCandidate, patientProfile, factor) {
        const result = { score: 50 }; // Baseline score

        const favorites = patientProfile.favorites || [];
        if (favorites.length === 0) {
            result.message = 'Sevilen yemek listesi bo≈ü';
            return result;
        }

        const favoriteBoostRatio = patientProfile.favoriteBoostRatio || 0.20; // Default %20
        let totalFoods = 0;
        let favoriteFoods = 0;

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    totalFoods++;
                    
                    // Sevilen yemek kontrol√º
                    if (this.isFavoriteFood(food, favorites)) {
                        favoriteFoods++;
                    }
                }
            }
        }

        if (totalFoods === 0) {
            return result;
        }

        const favoriteRatio = favoriteFoods / totalFoods;
        const expectedRatio = favoriteBoostRatio;
        
        // Sevilen yemek oranƒ±na g√∂re skorlama
        if (favoriteRatio >= expectedRatio) {
            result.score = 80 + (favoriteRatio * 20); // 80-100 arasƒ±
            result.message = `Sevilen yemek oranƒ± iyi: %${(favoriteRatio*100).toFixed(1)}`;
        } else {
            result.score = 50 + (favoriteRatio / expectedRatio) * 30; // 50-80 arasƒ±
            result.message = `Sevilen yemek oranƒ± d√º≈ü√ºk: %${(favoriteRatio*100).toFixed(1)}`;
        }

        result.details = {
            favoriteFoods,
            totalFoods,
            ratio: favoriteRatio,
            expectedRatio
        };

        return result;
    }

    // Yardƒ±mcƒ±: Sevilen yemek kontrol√º
    isFavoriteFood(food, favorites) {
        const foodName = (food.name || food.adi || '').toLowerCase();
        const foodTags = (food.tags || []).map(tag => tag.toLowerCase());
        
        return favorites.some(favorite => {
            const favLower = favorite.toLowerCase();
            return foodName.includes(favLower) || 
                   foodTags.some(tag => tag.includes(favLower) || favLower.includes(tag));
        });
    }

    checkSeasonalPreference(planCandidate, planningContext, factor) {
        return { score: 65 };
    }

    checkMealCompatibility(planCandidate, planningContext, factor) {
        const result = { score: 50 };

        let totalMeals = 0;
        let compatibleMeals = 0;

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                totalMeals++;
                
                // Ana yemekleri bul (mainDish role)
                const mainDishes = meal.foods.filter(food => food.role === 'mainDish');
                
                if (mainDishes.length === 0) {
                    continue; // Ana yemek yoksa uyumluluk kontrol√º yapma
                }

                // Her ana yemek i√ßin uyumluluk kontrol√º
                for (const mainDish of mainDishes) {
                    const compatibilityScore = this.calculateMealCompatibilityScore(meal, mainDish);
                    if (compatibilityScore > 0.5) { // %50'den y√ºksek uyumluluk
                        compatibleMeals++;
                    }
                }
            }
        }

        if (totalMeals > 0) {
            const compatibilityRatio = compatibleMeals / totalMeals;
            result.score = 30 + (compatibilityRatio * 70); // 30-100 arasƒ±
            result.message = `Uyumluluk oranƒ±: %${(compatibilityRatio*100).toFixed(1)}`;
        }

        return result;
    }

    // üß≤ YENƒ∞: Uyumluluk manyetizmasƒ± hesabƒ±
    calculateMealCompatibilityScore(meal, mainDish) {
        let compatibilityScore = 0;
        let totalChecks = 0;

        const compatibilityTags = mainDish.compatibilityTags || [];
        const incompatibilityTags = mainDish.incompatibilityTags || [];
        
        // Diƒüer yemeklerle uyumluluƒüu kontrol et
        for (const otherFood of meal.foods) {
            if (otherFood === mainDish) continue;
            
            const otherTags = otherFood.tags || [];
            totalChecks++;

            // Pozitif uyumluluk kontrol√º
            const hasPositiveMatch = compatibilityTags.some(compTag => 
                otherTags.some(tag => tag.toLowerCase().includes(compTag.toLowerCase()))
            );

            // Negatif uyumsuzluk kontrol√º  
            const hasNegativeMatch = incompatibilityTags.some(incompTag =>
                otherTags.some(tag => tag.toLowerCase().includes(incompTag.toLowerCase()))
            );

            if (hasPositiveMatch) {
                compatibilityScore += 1;
            } else if (hasNegativeMatch) {
                compatibilityScore -= 1;
            }
        }

        return totalChecks > 0 ? Math.max(0, compatibilityScore / totalChecks) : 0;
    }

    // ü•Ñ YENƒ∞: Dolgu yemek optimizasyonu
    checkFillerOptimization(planCandidate, patientProfile, factor) {
        const result = { score: 60 };

        const targetMacros = patientProfile.targetMacros || {};
        if (!targetMacros.protein && !targetMacros.fat) {
            result.message = 'Hedef makrolar belirtilmemi≈ü';
            return result;
        }

        let fillerUsageScore = 0;
        let totalDays = planCandidate.days.length;

        for (const day of planCandidate.days) {
            const dayMacros = this.calculateDayMacros(day);
            const macroGaps = this.calculateMacroGaps(dayMacros, targetMacros);
            const fillerUsage = this.calculateFillerUsage(day, macroGaps);
            
            fillerUsageScore += fillerUsage.score;
        }

        result.score = Math.min(100, 40 + (fillerUsageScore / totalDays) * 60);
        result.message = `Dolgu yemek optimizasyonu skoru: ${result.score.toFixed(0)}`;

        return result;
    }

    // Yardƒ±mcƒ±: G√ºnl√ºk makro hesaplama
    calculateDayMacros(day) {
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;

        for (const meal of day.meals) {
            for (const food of meal.foods) {
                const multiplier = food.multiplier || 1;
                totalCalories += (food.calories || 0) * multiplier;
                totalProtein += (food.protein || 0) * multiplier;
                totalCarbs += (food.carbs || 0) * multiplier;
                totalFat += (food.fat || 0) * multiplier;
            }
        }

        return { calories: totalCalories, protein: totalProtein, carbs: totalCarbs, fat: totalFat };
    }

    // Yardƒ±mcƒ±: Makro a√ßƒ±k hesaplama
    calculateMacroGaps(actualMacros, targetMacros) {
        return {
            protein: (targetMacros.protein || 0) - actualMacros.protein,
            carbs: (targetMacros.carbs || 0) - actualMacros.carbs,
            fat: (targetMacros.fat || 0) - actualMacros.fat
        };
    }

    // Yardƒ±mcƒ±: Dolgu yemek kullanƒ±m skoru
    calculateFillerUsage(day, macroGaps) {
        const result = { score: 0, used: 0 };
        
        for (const meal of day.meals) {
            for (const food of meal.foods) {
                // Dolgu yemek mi kontrol et
                const isFillerLunch = food.fillerLunch === true;
                const isFillerDinner = food.fillerDinner === true;
                
                if (isFillerLunch || isFillerDinner) {
                    result.used++;
                    
                    // Doƒüru makro a√ßƒ±ƒüƒ±na g√∂re kullanƒ±lmƒ±≈ü mƒ±?
                    if (macroGaps.protein > 10 && (food.protein || 0) > 10) {
                        result.score += 20; // Protein a√ßƒ±ƒüƒ± i√ßin protein yoƒüun dolgu
                    }
                    if (macroGaps.fat > 5 && (food.fat || 0) > 5) {
                        result.score += 20; // Yaƒü a√ßƒ±ƒüƒ± i√ßin yaƒü yoƒüun dolgu
                    }
                }
            }
        }

        return result;
    }

    // ü•ó YENƒ∞: Porsiyon optimizasyonu
    checkPortionOptimization(planCandidate, patientProfile, factor) {
        const result = { score: 70 };

        let totalOptimizations = 0;
        let successfulOptimizations = 0;

        for (const day of planCandidate.days) {
            for (const meal of day.meals) {
                for (const food of meal.foods) {
                    const multiplier = food.multiplier || 1;
                    const minQuantity = food.minQuantity || 0.5;
                    const maxQuantity = food.maxQuantity || 2.0;
                    
                    totalOptimizations++;
                    
                    // Porsiyon range i√ßinde mi?
                    if (multiplier >= minQuantity && multiplier <= maxQuantity) {
                        successfulOptimizations++;
                        
                        // √ñƒü√ºn ba≈üƒ±na en fazla 1 optimizasyon yapƒ±lmƒ±≈ü mƒ±?
                        // (Bu kontrol geli≈ütirilmeli - mealƒ±n ka√ß yemeƒüinin optimize edildiƒüi)
                    }
                }
            }
        }

        if (totalOptimizations > 0) {
            const optimizationRatio = successfulOptimizations / totalOptimizations;
            result.score = 50 + (optimizationRatio * 50);
            result.message = `Porsiyon optimizasyon oranƒ±: %${(optimizationRatio*100).toFixed(1)}`;
        }

        return result;
    }

    checkCookingComplexity(planCandidate, planningContext, factor) {
        return { score: 60 };
    }

    checkPersonalTastes(planCandidate, patientProfile, factor) {
        return { score: 50 };
    }

    checkCulturalPreference(planCandidate, patientProfile, factor) {
        return { score: 55 };
    }

    checkBudgetConstraints(planCandidate, patientProfile, factor) {
        return { score: 45 };
    }

    checkPreparationTime(planCandidate, patientProfile, factor) {
        return { score: 40 };
    }
}

// Export
window.AdvancedPlanningFactors = AdvancedPlanningFactors;
console.log('üéØ AdvancedPlanningFactors sistemi y√ºklendi');
